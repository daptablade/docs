
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Chaining component analyses &#8212; dapta docs</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css?digest=5115cc725059bd94278eecd172e13a965bf8f5a9" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.b7bb847fb20b106c3d81b95245e65545.min.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=9c920249402e914e316237a7dbc6769907cce411"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <link rel="canonical" href="https://daptadocs.com/index.com/Tutorials/Chaining component analyses.html" />
    <link rel="shortcut icon" href="../_static/favicon.png"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Automating parametric studies" href="Automating%20parametric%20studies.html" />
    <link rel="prev" title="Simple optimisation problem" href="Simple%20optimisation%20problem.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay overlay-navbar" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input type="checkbox" class="sidebar-toggle" name="__page-toc" id="__page-toc" aria-label="Toggle in-page Table of Contents">
<label class="overlay overlay-pagetoc" for="__page-toc">
    <div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"></div>
<div class="header header-item noprint"></div>

    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
    <div class="bd-sidebar__content">
        <div class="bd-sidebar__top"><div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="../_static/logo.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">dapta docs</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../intro.html">
                    Overview
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Tutorials
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="Simple%20component%20analysis.html">
   Simple component analysis
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Simple%20optimisation%20problem.html">
   Simple optimisation problem
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Chaining component analyses
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Automating%20parametric%20studies.html">
   Automating parametric studies
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Reference Guide
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../Reference/The%20dashboard.html">
   The dashboard
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Reference/FAQs.html">
   FAQs
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Reference/Glossary.html">
   Glossary
  </a>
 </li>
</ul>

    </div>
</nav></div>
        <div class="bd-sidebar__bottom">
             <!-- To handle the deprecated key -->
            
            <div class="navbar_extra_footer">
            Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
            </div>
            
        </div>
    </div>
    <div id="rtd-footer-container"></div>
</div>


          


          
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
    
    <div class="header-article row sticky-top noprint">
        



<div class="col py-1 d-flex header-article-main">
    <div class="header-article__left">
        
        <label for="__navigation"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="right"
title="Toggle navigation"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-bars"></i>
  </span>

</label>

        
    </div>
    <div class="header-article__right">
<button onclick="toggleFullScreen()"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="bottom"
title="Fullscreen mode"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>

<div class="menu-dropdown menu-dropdown-download-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Download this page">
      <i class="fas fa-download"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="../_sources/Tutorials/Chaining component analyses.md"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Download source file"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="headerbtn__text-container">.md</span>
</a>

      </li>
      
      <li>
        
<button onclick="printPdf(this)"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="left"
title="Print to PDF"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="headerbtn__text-container">.pdf</span>
</button>

      </li>
      
    </ul>
  </div>
</div>
<label for="__page-toc"
  class="headerbtn headerbtn-page-toc"
  
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-list"></i>
  </span>

</label>

    </div>
</div>

<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
    <div class="tocsection onthispage pt-5 pb-3">
        <i class="fas fa-list"></i> Contents
    </div>
    <nav id="bd-toc-nav" aria-label="Page">
        <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#create-the-components">
   Create the Components
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#parametric-model-component">
     Parametric-model component
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#calculix-fea-component">
     Calculix-fea component
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#results-processor-component">
     Results processor component
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#create-the-connections">
   Create the Connections
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#first-connection">
     First connection
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#more-connections">
     More connections
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#execute-the-workflow">
   Execute the workflow
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#inspect-the-outputs">
   Inspect the outputs
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#clean-up">
   Clean-up
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#references">
   References:
  </a>
 </li>
</ul>

    </nav>
</div>
    </div>
    <div class="article row">
        <div class="col pl-md-3 pl-lg-5 content-container">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>Chaining component analyses</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#create-the-components">
   Create the Components
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#parametric-model-component">
     Parametric-model component
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#calculix-fea-component">
     Calculix-fea component
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#results-processor-component">
     Results processor component
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#create-the-connections">
   Create the Connections
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#first-connection">
     First connection
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#more-connections">
     More connections
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#execute-the-workflow">
   Execute the workflow
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#inspect-the-outputs">
   Inspect the outputs
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#clean-up">
   Clean-up
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#references">
   References:
  </a>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            <main id="main-content" role="main">
                
              <div>
                
  <section class="tex2jax_ignore mathjax_ignore" id="chaining-component-analyses">
<h1>Chaining component analyses<a class="headerlink" href="#chaining-component-analyses" title="Permalink to this headline">#</a></h1>
<p><strong>Duration: 30 min</strong></p>
<p>In this tutorial we explore the usage of Connections to chain the execution of Components.
The example also introduces a finite element analysis specific ‘calculix-fea-comp’ component API.</p>
<a class="bg-primary mb-1 reference internal image-reference" href="../_images/parametric-model-1.png"><img alt="chained process" class="bg-primary mb-1 align-center" src="../_images/parametric-model-1.png" style="width: 700px;" /></a>
<section id="create-the-components">
<h2>Create the Components<a class="headerlink" href="#create-the-components" title="Permalink to this headline">#</a></h2>
<p>This example replicates the chained analyses described in Parts 1 and 2 of our <a class="reference external" href="https://youtube.com/playlist?list=PL3ZV4Vo-Sjze6-DaoPgJcIvU-uAYB7KpZ">Parametric wing model series</a> that make use of python and the open source finite element analysis software <a class="reference external" href="http://www.dhondt.de/">CalculiX GraphiX and CrunchiX</a> to create and analyse a parametric composite wing model.</p>
<p>This tutorial doesn’t go into the details of the python code, since this was already covered in the videos and associated blog posts (see [References]{tutorials-Chaining_component_analyses-references}).
Our main focus here is to show how the previously monolithic python code can be split into discrete and potentially re-usable Components.</p>
<p>We group the parametric model analysis processes into three distinct Components as shown in the figure below.</p>
<a class="bg-primary mb-1 reference internal image-reference" href="../_images/parametric-model-2.png"><img alt="chained-process-components" class="bg-primary mb-1 align-center" src="../_images/parametric-model-2.png" style="width: 700px;" /></a>
<section id="parametric-model-component">
<h3>Parametric-model component<a class="headerlink" href="#parametric-model-component" title="Permalink to this headline">#</a></h3>
<p>The parametric-model component defines a parametric three-dimensional wing geometry in python. It also outputs meshing instructions for Calculix GraphiX in the .fdb file format.</p>
<p>The component Parameters include the span and chord of the wing, as well as the aerofoil wing cross-section, which is defined by uploading a CSV input file with x and y section coordinates.</p>
<p>Create the component:</p>
<ul class="simple">
<li><p>Right-click in the workspace and select <code class="docutils literal notranslate"><span class="pre">Add</span> <span class="pre">Empty</span> <span class="pre">Node</span></code>. Select the empty component to edit it.</p></li>
<li><p>In the <code class="docutils literal notranslate"><span class="pre">Properties</span></code> tab, fill in the component name, <code class="docutils literal notranslate"><span class="pre">parametric-model</span></code>, and select the generic python component API <code class="docutils literal notranslate"><span class="pre">generic-python3-comp:latest</span></code>.</p></li>
<li><p>Copy the contents of the <code class="docutils literal notranslate"><span class="pre">setup.py</span></code>, <code class="docutils literal notranslate"><span class="pre">compute.py</span></code>, <code class="docutils literal notranslate"><span class="pre">requirements.txt</span></code> and <code class="docutils literal notranslate"><span class="pre">naca0012.csv</span></code> files from below into a text editor, save them locally.
Then upload the first 3 files under the <code class="docutils literal notranslate"><span class="pre">Properties</span></code> tab and upload the <code class="docutils literal notranslate"><span class="pre">naca0012.csv</span></code> under the <code class="docutils literal notranslate"><span class="pre">Parameters</span></code> tab by selecting <code class="docutils literal notranslate"><span class="pre">upload</span> <span class="pre">user</span> <span class="pre">input</span> <span class="pre">files</span></code>.</p></li>
<li><p>In the <code class="docutils literal notranslate"><span class="pre">Properties</span></code> tab check the box next to the <code class="docutils literal notranslate"><span class="pre">Start</span> <span class="pre">Node</span></code> option.</p></li>
<li><p>Copy the contents of the parameters JSON object below into the <code class="docutils literal notranslate"><span class="pre">Parameters</span></code> tab text box.</p></li>
<li><p>Copy the following JSON object into the <code class="docutils literal notranslate"><span class="pre">Outputs</span></code> tab text box:</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="s2">&quot;files.cgx_file&quot;</span><span class="p">:</span> <span class="s2">&quot;default&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Select <code class="docutils literal notranslate"><span class="pre">Save</span> <span class="pre">data</span></code> to save and close the component.</p></li>
</ul>
<div class="sd-tab-set docutils">
<input checked="checked" id="f1ab9f07-c4f2-4fb1-aa1d-e4828a48c30b" name="18093d11-a75a-4d98-8c44-600006960ca4" type="radio">
</input><label class="sd-tab-label" for="f1ab9f07-c4f2-4fb1-aa1d-e4828a48c30b">
setup</label><div class="sd-tab-content docutils">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>


<span class="k">def</span> <span class="nf">setup</span><span class="p">(</span>
    <span class="n">inputs</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">outputs</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">partials</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">parameters</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Editable setup function.&quot;&quot;&quot;</span>

    <span class="c1"># initalise setup_data keys</span>
    <span class="n">response</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;output_files.cgx_file&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>

    <span class="c1"># set default inputs</span>
    <span class="k">if</span> <span class="n">inputs</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">input_key</span><span class="p">,</span> <span class="n">input_value</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;design&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">input_value</span> <span class="o">==</span> <span class="s2">&quot;default&quot;</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;design&quot;</span><span class="p">][</span><span class="n">input_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="n">input_key</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not find </span><span class="si">{</span><span class="n">input_key</span><span class="si">}</span><span class="s2"> in the input parameters.&quot;</span><span class="p">)</span>
        <span class="n">response</span><span class="p">[</span><span class="s2">&quot;inputs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">inputs</span>

    <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">-%H%M%S&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">: Setup completed.&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
    <span class="n">response</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">message</span>

    <span class="k">return</span> <span class="n">response</span>
</pre></div>
</div>
</div>
<input id="9f53d72d-52ea-4e38-8d27-559ac85a9534" name="18093d11-a75a-4d98-8c44-600006960ca4" type="radio">
</input><label class="sd-tab-label" for="9f53d72d-52ea-4e38-8d27-559ac85a9534">
compute</label><div class="sd-tab-content docutils">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span> <span class="nn">csv</span>
<span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">ceil</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="n">PLOT_FLAG</span> <span class="o">=</span> <span class="kc">True</span>


<span class="k">def</span> <span class="nf">compute</span><span class="p">(</span>
    <span class="n">inputs</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">outputs</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">partials</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">options</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">parameters</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>

    <span class="sd">&quot;&quot;&quot;Editable compute function.&quot;&quot;&quot;</span>

    <span class="c1"># check input files have been uploaded</span>
    <span class="n">inputs_folder</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;inputs_folder_path&quot;</span><span class="p">])</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">inputs_folder</span> <span class="o">/</span> <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;airfoil_csv_file&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;airfoil_csv_file&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> needs to be uploaded by the user.&quot;</span>
        <span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Starting user function evaluation.&quot;</span><span class="p">)</span>
    <span class="n">component_inputs</span> <span class="o">=</span> <span class="n">parameters</span>  <span class="c1"># default values</span>
    <span class="n">run_folder</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;outputs_folder_path&quot;</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">inputs</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">input_key</span><span class="p">,</span> <span class="n">input_value</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;design&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">component_inputs</span><span class="p">[</span><span class="n">input_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">input_value</span>

    <span class="n">geometry</span> <span class="o">=</span> <span class="n">get_geometry</span><span class="p">(</span>
        <span class="n">component_inputs</span><span class="p">,</span> <span class="n">run_folder</span><span class="p">,</span> <span class="n">inputs_folder</span><span class="p">,</span> <span class="n">plot_flag</span><span class="o">=</span><span class="n">PLOT_FLAG</span>
    <span class="p">)</span>
    <span class="n">cgx_fdb_path</span> <span class="o">=</span> <span class="n">get_cgx_input_file</span><span class="p">(</span><span class="n">geometry</span><span class="p">,</span> <span class="n">component_inputs</span><span class="p">,</span> <span class="n">run_folder</span><span class="p">)</span>

    <span class="c1"># check output has been saved</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">cgx_fdb_path</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
        <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">cgx_fdb_path</span><span class="p">)</span><span class="si">}</span><span class="s2"> is not a file.&quot;</span><span class="p">)</span>

    <span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;implicit&quot;</span><span class="p">][</span><span class="s2">&quot;files.cgx_file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cgx_fdb_path</span><span class="o">.</span><span class="n">name</span>

    <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">-%H%M%S&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">: Created cgx fdb file </span><span class="si">{</span><span class="n">cgx_fdb_path</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> with span </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">component_inputs</span><span class="p">[</span><span class="s1">&#39;span&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2">m.&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="n">message</span><span class="p">,</span> <span class="s2">&quot;outputs&quot;</span><span class="p">:</span> <span class="n">outputs</span><span class="p">}</span>


<span class="k">def</span> <span class="nf">get_geometry</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">run_folder</span><span class="p">,</span> <span class="n">inputs_folder</span><span class="p">,</span> <span class="n">plot_flag</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Translate parameters into geometry description that CGX can understand,</span>
<span class="sd">    that&#39;s points, lines and surfaces.&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="s2">&quot;airfoil_cut_chord_percentages&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">:</span>
        <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;airfoil_cut_chord_percentages&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">aerofoil</span> <span class="o">=</span> <span class="n">_get_aerofoil_from_file</span><span class="p">(</span>
        <span class="n">Path</span><span class="p">(</span><span class="n">inputs_folder</span><span class="p">,</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;airfoil_csv_file&quot;</span><span class="p">]),</span>
        <span class="n">plot_flag</span><span class="o">=</span><span class="n">plot_flag</span><span class="p">,</span>
        <span class="n">splitpc</span><span class="o">=</span><span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;airfoil_cut_chord_percentages&quot;</span><span class="p">],</span>
        <span class="n">run_folder</span><span class="o">=</span><span class="n">run_folder</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">points</span><span class="p">,</span> <span class="n">seqa</span><span class="p">,</span> <span class="n">split_points</span> <span class="o">=</span> <span class="n">_get_cgx_points_3d</span><span class="p">(</span>
        <span class="n">aerofoil</span><span class="p">,</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;chord&quot;</span><span class="p">],</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;span&quot;</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="n">lines</span><span class="p">,</span> <span class="n">rib_surfaces</span><span class="p">,</span> <span class="n">aero_surfaces</span><span class="p">,</span> <span class="n">bodies</span><span class="p">,</span> <span class="n">aero_surfaces_flip</span> <span class="o">=</span> <span class="n">_get_cgx_lines_3d</span><span class="p">(</span>
        <span class="n">seqa</span><span class="p">,</span>
        <span class="n">nele_foil</span><span class="o">=</span><span class="n">rint</span><span class="p">(</span><span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;nele_foil&quot;</span><span class="p">]),</span>
        <span class="n">nele_span</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;nele_span&quot;</span><span class="p">]),</span>
        <span class="n">split_points</span><span class="o">=</span><span class="n">split_points</span><span class="p">,</span>
        <span class="n">filled_sections</span><span class="o">=</span><span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;filled_sections_flags&quot;</span><span class="p">],</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;aerofoil&quot;</span><span class="p">:</span> <span class="n">aerofoil</span><span class="p">,</span>
        <span class="s2">&quot;points&quot;</span><span class="p">:</span> <span class="n">points</span><span class="p">,</span>
        <span class="s2">&quot;point_seqa&quot;</span><span class="p">:</span> <span class="n">seqa</span><span class="p">,</span>
        <span class="s2">&quot;lines&quot;</span><span class="p">:</span> <span class="n">lines</span><span class="p">,</span>
        <span class="s2">&quot;surfaces&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;ribs&quot;</span><span class="p">:</span> <span class="n">rib_surfaces</span><span class="p">,</span>
            <span class="s2">&quot;aero&quot;</span><span class="p">:</span> <span class="n">aero_surfaces</span><span class="p">,</span>
            <span class="s2">&quot;aero_surfaces_flip&quot;</span><span class="p">:</span> <span class="n">aero_surfaces_flip</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s2">&quot;bodies&quot;</span><span class="p">:</span> <span class="n">bodies</span><span class="p">,</span>
    <span class="p">}</span>


<span class="k">def</span> <span class="nf">get_cgx_input_file</span><span class="p">(</span><span class="n">geometry</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">folder</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Write CGX batch commands to file.&quot;&quot;&quot;</span>

    <span class="n">fdb_geom_file</span> <span class="o">=</span> <span class="n">folder</span> <span class="o">/</span> <span class="s2">&quot;cgx_infile.fdb&quot;</span>

    <span class="k">if</span> <span class="s2">&quot;boundary_conditions&quot;</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">:</span>
        <span class="n">fix_lines</span> <span class="o">=</span> <span class="n">rint</span><span class="p">(</span><span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;boundary_conditions&quot;</span><span class="p">][</span><span class="s2">&quot;fix_lines&quot;</span><span class="p">])</span>
        <span class="n">loaded_lines</span> <span class="o">=</span> <span class="n">rint</span><span class="p">(</span><span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;boundary_conditions&quot;</span><span class="p">][</span><span class="s2">&quot;loaded_lines&quot;</span><span class="p">])</span>
        <span class="k">if</span> <span class="s2">&quot;loaded_surfaces&quot;</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;boundary_conditions&quot;</span><span class="p">]:</span>
            <span class="n">loaded_surfaces</span> <span class="o">=</span> <span class="n">rint</span><span class="p">(</span><span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;boundary_conditions&quot;</span><span class="p">][</span><span class="s2">&quot;loaded_surfaces&quot;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">loaded_surfaces</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">fix_lines</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">loaded_lines</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">loaded_surfaces</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># create string of all input commands</span>
    <span class="n">cgx_commands</span> <span class="o">=</span> <span class="n">_get_commands</span><span class="p">(</span>
        <span class="n">geometry</span><span class="p">,</span>
        <span class="n">fix_lines</span><span class="p">,</span>
        <span class="n">loaded_lines</span><span class="p">,</span>
        <span class="n">loaded_surfaces</span><span class="o">=</span><span class="n">loaded_surfaces</span><span class="p">,</span>
        <span class="n">merge_tol</span><span class="o">=</span><span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;node_merge_tol&quot;</span><span class="p">],</span>
        <span class="n">cgx_ele_type</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;cgx_ele_type&quot;</span><span class="p">]),</span>
        <span class="n">solver</span><span class="o">=</span><span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;cgx_solver&quot;</span><span class="p">],</span>
    <span class="p">)</span>

    <span class="c1"># write string of commands to file</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fdb_geom_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cgx_commands</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">fdb_geom_file</span>


<span class="c1">########### Private functions that do not get called directly</span>


<span class="k">def</span> <span class="nf">rint</span><span class="p">(</span><span class="n">items</span><span class="p">):</span>
    <span class="c1"># cover integer values after json import</span>
    <span class="k">return</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">_get_aerofoil_from_file</span><span class="p">(</span>
    <span class="n">file</span><span class="p">,</span> <span class="n">plot_flag</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">splitpc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pt_offset</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">run_folder</span><span class="o">=</span><span class="kc">None</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function reads an aerofoil geometry from csv and calculates tc_max.</span>

<span class="sd">    Args:</span>
<span class="sd">        file: file with xy-positions of the airfoil outline in Selig format.</span>
<span class="sd">              For example http://airfoiltools.com/airfoil/seligdatfile?airfoil=n0012-il</span>

<span class="sd">    Returns:</span>
<span class="sd">        airfoil data</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># read aerofoil input file</span>
    <span class="n">airfoil</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">infile</span><span class="p">:</span>
        <span class="n">reader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">infile</span><span class="p">,</span> <span class="n">skipinitialspace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">reader</span><span class="p">:</span>
            <span class="n">airfoil</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">airfoil</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">coordinates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">string</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span> <span class="k">for</span> <span class="n">string</span> <span class="ow">in</span> <span class="n">airfoil</span><span class="p">[</span><span class="mi">1</span><span class="p">:]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

    <span class="c1"># replace the last coordinate to close the airfoil at the trailing-edge</span>
    <span class="n">coordinates</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">coordinates</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># we assume that there is a [0.0, 0.0] point in the airfoil</span>
    <span class="n">LE_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">coordinates</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">leading_edge_pt</span> <span class="o">=</span> <span class="n">LE_index</span>

    <span class="n">splits</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">splitpc</span><span class="p">:</span>
        <span class="c1"># check that there are enough points to split the section</span>
        <span class="n">min_points</span> <span class="o">=</span> <span class="mi">100</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">coordinates</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">min_points</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;The parameter &#39;airfoil_cut_chord_percentages&#39; requires &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;at least </span><span class="si">{</span><span class="n">min_points</span><span class="si">:</span><span class="s2">d</span><span class="si">}</span><span class="s2"> airfoil spline points in &#39;airfoil_csv_file&#39;&quot;</span>
            <span class="p">)</span>

        <span class="c1"># re-order the pc from TE to LE</span>
        <span class="n">splitpc</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># trim points that are within min number of points form leading or trailing edge</span>
        <span class="n">trimmed_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span>
            <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">coordinates</span><span class="p">))])</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">coordinates</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">trimmed_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">trimmed_coords</span><span class="p">[</span><span class="n">pt_offset</span> <span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">LE_index</span> <span class="o">-</span> <span class="n">ceil</span><span class="p">(</span><span class="n">pt_offset</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)),</span> <span class="p">:],</span>
                <span class="n">trimmed_coords</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">LE_index</span> <span class="o">+</span> <span class="n">ceil</span><span class="p">(</span><span class="n">pt_offset</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span> <span class="p">:</span> <span class="o">-</span><span class="n">pt_offset</span><span class="p">,</span> <span class="p">:],</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="c1"># find two points that match the percentage chord closely</span>
        <span class="k">for</span> <span class="n">split_number</span><span class="p">,</span> <span class="n">split</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">splitpc</span><span class="p">):</span>
            <span class="n">point_distances_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">trimmed_coords</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">split</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>
            <span class="n">pt</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;top&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;bot&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
            <span class="n">dist_top</span> <span class="o">=</span> <span class="n">point_distances_x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">dist_bot</span> <span class="o">=</span> <span class="n">point_distances_x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">dist</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">point_distances_x</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">dist</span> <span class="o">&lt;</span> <span class="n">dist_top</span> <span class="ow">and</span> <span class="n">trimmed_coords</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">pt</span><span class="p">[</span><span class="s2">&quot;top&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">trimmed_coords</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
                    <span class="n">dist_top</span> <span class="o">=</span> <span class="n">dist</span>
                <span class="k">if</span> <span class="n">dist</span> <span class="o">&lt;</span> <span class="n">dist_bot</span> <span class="ow">and</span> <span class="n">trimmed_coords</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">pt</span><span class="p">[</span><span class="s2">&quot;bot&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">trimmed_coords</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
                    <span class="n">dist_bot</span> <span class="o">=</span> <span class="n">dist</span>

            <span class="k">if</span> <span class="n">split_number</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># check number of points separating splits</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">pt</span><span class="p">[</span><span class="s2">&quot;top&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">splits</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;top&quot;</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">pt_offset</span>
                    <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">pt</span><span class="p">[</span><span class="s2">&quot;bot&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">splits</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;bot&quot;</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">pt_offset</span>
                <span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Values </span><span class="si">{</span><span class="n">splitpc</span><span class="p">[</span><span class="n">split_number</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2"> and </span><span class="si">{</span><span class="n">split</span><span class="si">:</span><span class="s2">f</span><span class="si">}</span><span class="s2"> in &quot;</span>
                        <span class="s2">&quot;&#39;airfoil_cut_chord_percentages&#39; are too close together.&quot;</span>
                    <span class="p">)</span>
            <span class="n">splits</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pt</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">plot_flag</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">coordinates</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">coordinates</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;-xr&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">splitpc</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">split</span> <span class="ow">in</span> <span class="n">splits</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">coordinates</span><span class="p">[</span><span class="n">split</span><span class="p">[</span><span class="s2">&quot;top&quot;</span><span class="p">],</span> <span class="mi">0</span><span class="p">],</span> <span class="n">coordinates</span><span class="p">[</span><span class="n">split</span><span class="p">[</span><span class="s2">&quot;bot&quot;</span><span class="p">],</span> <span class="mi">0</span><span class="p">]],</span>
                    <span class="p">[</span><span class="n">coordinates</span><span class="p">[</span><span class="n">split</span><span class="p">[</span><span class="s2">&quot;top&quot;</span><span class="p">],</span> <span class="mi">1</span><span class="p">],</span> <span class="n">coordinates</span><span class="p">[</span><span class="n">split</span><span class="p">[</span><span class="s2">&quot;bot&quot;</span><span class="p">],</span> <span class="mi">1</span><span class="p">]],</span>
                    <span class="s2">&quot;-b&quot;</span><span class="p">,</span>
                <span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">run_folder</span> <span class="o">/</span> <span class="s2">&quot;airfoil_coordinates.png&quot;</span><span class="p">))</span>

    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
        <span class="n">coordinates</span><span class="o">=</span><span class="n">coordinates</span><span class="p">,</span>
        <span class="n">splits</span><span class="o">=</span><span class="n">splits</span><span class="p">,</span>
        <span class="n">leading_edge_pt</span><span class="o">=</span><span class="n">leading_edge_pt</span><span class="p">,</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">_get_cgx_points_3d</span><span class="p">(</span><span class="n">aerofoil</span><span class="p">,</span> <span class="n">chord</span><span class="p">,</span> <span class="n">span</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This function generates the CGX input file points and point sequences.&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">span</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">span</span> <span class="o">=</span> <span class="p">[</span><span class="n">span</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">chord</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">chord</span> <span class="o">=</span> <span class="p">[</span><span class="n">chord</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">wing_with_splits</span><span class="p">(</span><span class="n">aerofoil</span><span class="p">,</span> <span class="n">chord</span><span class="p">,</span> <span class="n">span</span><span class="p">):</span>
        <span class="n">seqa</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">starting_y</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">pt_counter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">split_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">aerofoil</span><span class="p">[</span><span class="s2">&quot;splits&quot;</span><span class="p">]),</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">section_index</span><span class="p">,</span> <span class="n">length_y</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">span</span><span class="p">):</span>

            <span class="n">x</span> <span class="o">=</span> <span class="n">aerofoil</span><span class="p">[</span><span class="s2">&quot;coordinates&quot;</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">chord</span><span class="p">[</span><span class="n">section_index</span><span class="p">]</span>
            <span class="n">z</span> <span class="o">=</span> <span class="n">aerofoil</span><span class="p">[</span><span class="s2">&quot;coordinates&quot;</span><span class="p">][:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">chord</span><span class="p">[</span><span class="n">section_index</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">section_index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># only needed at the root of the wing</span>
                <span class="n">y_root</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">size</span><span class="p">)</span> <span class="o">*</span> <span class="n">starting_y</span>
                <span class="n">points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">y_root</span><span class="p">,</span> <span class="n">z</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>

            <span class="c1"># section tip</span>
            <span class="n">y_tip</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">size</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">starting_y</span> <span class="o">+</span> <span class="n">length_y</span><span class="p">)</span>
            <span class="n">points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">y_tip</span><span class="p">,</span> <span class="n">z</span><span class="p">])</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

            <span class="k">def</span> <span class="nf">airfoil_seqa</span><span class="p">(</span><span class="n">pt_counter</span><span class="p">,</span> <span class="n">seqa</span><span class="p">,</span> <span class="n">all_split_points</span><span class="p">,</span> <span class="n">x_size</span><span class="p">):</span>
                <span class="c1"># SEQA for first airfoil top splines</span>
                <span class="n">pt</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">split_points</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">split</span> <span class="ow">in</span> <span class="n">aerofoil</span><span class="p">[</span><span class="s2">&quot;splits&quot;</span><span class="p">]:</span>
                    <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">pt_counter</span> <span class="o">+</span> <span class="n">pt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">pt_counter</span> <span class="o">+</span> <span class="n">split</span><span class="p">[</span><span class="s2">&quot;top&quot;</span><span class="p">])</span>
                    <span class="n">seqa</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span>
                    <span class="n">pt</span> <span class="o">=</span> <span class="n">split</span><span class="p">[</span><span class="s2">&quot;top&quot;</span><span class="p">]</span>
                    <span class="n">split_points</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pt_counter</span> <span class="o">+</span> <span class="n">split</span><span class="p">[</span><span class="s2">&quot;top&quot;</span><span class="p">])</span>
                <span class="c1"># SEQA for first airfoil LE spline</span>
                <span class="n">seqa</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span>
                        <span class="n">pt_counter</span> <span class="o">+</span> <span class="n">pt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                        <span class="n">pt_counter</span> <span class="o">+</span> <span class="n">aerofoil</span><span class="p">[</span><span class="s2">&quot;leading_edge_pt&quot;</span><span class="p">],</span>
                    <span class="p">)</span>
                <span class="p">)</span>

                <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">aerofoil</span><span class="p">[</span><span class="s2">&quot;splits&quot;</span><span class="p">]):</span>
                    <span class="n">seqa</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span>
                            <span class="n">pt_counter</span> <span class="o">+</span> <span class="n">aerofoil</span><span class="p">[</span><span class="s2">&quot;leading_edge_pt&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                            <span class="n">pt_counter</span> <span class="o">+</span> <span class="n">aerofoil</span><span class="p">[</span><span class="s2">&quot;splits&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;bot&quot;</span><span class="p">],</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                    <span class="c1"># SEQA for first airfoil bot spline</span>
                    <span class="n">pt</span> <span class="o">=</span> <span class="n">x_size</span> <span class="o">-</span> <span class="mi">1</span>
                    <span class="n">bot_seqa</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">split</span> <span class="ow">in</span> <span class="n">aerofoil</span><span class="p">[</span><span class="s2">&quot;splits&quot;</span><span class="p">]:</span>
                        <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flipud</span><span class="p">(</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span>
                                <span class="n">pt_counter</span> <span class="o">+</span> <span class="n">pt</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">pt_counter</span> <span class="o">+</span> <span class="n">split</span><span class="p">[</span><span class="s2">&quot;bot&quot;</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span>
                            <span class="p">)</span>
                        <span class="p">)</span>
                        <span class="n">bot_seqa</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span>
                        <span class="n">pt</span> <span class="o">=</span> <span class="n">split</span><span class="p">[</span><span class="s2">&quot;bot&quot;</span><span class="p">]</span>
                        <span class="n">split_points</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pt_counter</span> <span class="o">+</span> <span class="n">split</span><span class="p">[</span><span class="s2">&quot;bot&quot;</span><span class="p">])</span>
                    <span class="n">bot_seqa</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
                    <span class="n">seqa</span> <span class="o">+=</span> <span class="n">bot_seqa</span>
                    <span class="c1"># all_split_point is nested list of dim 3: aerofoil -&gt; split -&gt; point</span>
                    <span class="n">all_split_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dstack</span><span class="p">(</span>
                        <span class="p">[</span>
                            <span class="n">all_split_points</span><span class="p">,</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">split_points</span><span class="p">,</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">aerofoil</span><span class="p">[</span><span class="s2">&quot;splits&quot;</span><span class="p">]),</span> <span class="mi">2</span><span class="p">))</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
                        <span class="p">]</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">seqa</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span>
                            <span class="n">pt_counter</span> <span class="o">+</span> <span class="n">aerofoil</span><span class="p">[</span><span class="s2">&quot;leading_edge_pt&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                            <span class="n">pt_counter</span> <span class="o">+</span> <span class="n">x_size</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                    <span class="n">all_split_points</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="k">return</span> <span class="n">seqa</span><span class="p">,</span> <span class="n">all_split_points</span>

            <span class="n">seqa</span><span class="p">,</span> <span class="n">split_points</span> <span class="o">=</span> <span class="n">airfoil_seqa</span><span class="p">(</span>
                <span class="n">pt_counter</span><span class="o">=</span><span class="n">pt_counter</span><span class="p">,</span>
                <span class="n">seqa</span><span class="o">=</span><span class="n">seqa</span><span class="p">,</span>
                <span class="n">all_split_points</span><span class="o">=</span><span class="n">split_points</span><span class="p">,</span>
                <span class="n">x_size</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">size</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">section_index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># only needed at the root of the wing</span>
                <span class="n">seqa</span><span class="p">,</span> <span class="n">split_points</span> <span class="o">=</span> <span class="n">airfoil_seqa</span><span class="p">(</span>
                    <span class="n">pt_counter</span><span class="o">=</span><span class="n">pt_counter</span> <span class="o">+</span> <span class="n">x</span><span class="o">.</span><span class="n">size</span><span class="p">,</span>
                    <span class="n">seqa</span><span class="o">=</span><span class="n">seqa</span><span class="p">,</span>
                    <span class="n">all_split_points</span><span class="o">=</span><span class="n">split_points</span><span class="p">,</span>
                    <span class="n">x_size</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">size</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="n">starting_y</span> <span class="o">+=</span> <span class="n">length_y</span>
            <span class="n">pt_counter</span> <span class="o">=</span> <span class="n">seqa</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span>

        <span class="k">return</span> <span class="n">points</span><span class="p">,</span> <span class="n">seqa</span><span class="p">,</span> <span class="n">split_points</span>

    <span class="n">points</span><span class="p">,</span> <span class="n">seqa</span><span class="p">,</span> <span class="n">split_points</span> <span class="o">=</span> <span class="n">wing_with_splits</span><span class="p">(</span><span class="n">aerofoil</span><span class="p">,</span> <span class="n">chord</span><span class="p">,</span> <span class="n">span</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">points</span><span class="p">,</span> <span class="n">seqa</span><span class="p">,</span> <span class="n">split_points</span>


<span class="k">def</span> <span class="nf">_get_cgx_lines_3d</span><span class="p">(</span>
    <span class="n">seqa</span><span class="p">,</span>
    <span class="n">nele_foil</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
    <span class="n">nele_span</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span>
    <span class="n">nele_split</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
    <span class="n">split_points</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">filled_sections</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This function creates the aerofoil section splines and the spanwise bounding lines in CGX.&quot;&quot;&quot;</span>

    <span class="n">nele_multiplier</span> <span class="o">=</span> <span class="mi">2</span>  <span class="c1"># =2 to account for quadratic elements</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">aero_surfaces</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">aero_surfaces_flip</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">rib_surfaces</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">nele_span</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">nele_span</span> <span class="o">=</span> <span class="p">[</span><span class="n">nele_span</span><span class="p">]</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">nele_foil</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">nele_foil</span> <span class="o">=</span> <span class="p">[</span><span class="n">nele_foil</span><span class="p">]</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">filled_sections</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">filled_sections</span> <span class="o">=</span> <span class="p">[</span><span class="n">filled_sections</span><span class="p">]</span>

    <span class="n">splits</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">seqas_per_aerofoil</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">split_points</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="n">splits</span> <span class="o">=</span> <span class="n">split_points</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">seqas_per_aerofoil</span> <span class="o">=</span> <span class="n">splits</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span>
    <span class="n">aerofoils</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">seqa</span><span class="p">)</span> <span class="o">/</span> <span class="n">seqas_per_aerofoil</span><span class="p">)</span>

    <span class="n">airfoil_index</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">lcounter</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">seqa_id</span><span class="p">,</span> <span class="n">seq</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">seqa</span><span class="p">):</span>

        <span class="c1"># aerofoil lines</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">seq</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
                <span class="n">seq</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                <span class="n">seqa_id</span><span class="p">,</span>
                <span class="nb">int</span><span class="p">(</span><span class="n">nele_foil</span><span class="p">[</span><span class="n">seqa_id</span> <span class="o">%</span> <span class="n">seqas_per_aerofoil</span><span class="p">]</span> <span class="o">*</span> <span class="n">nele_multiplier</span><span class="p">),</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="n">lcounter</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">seqa_id</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">seqas_per_aerofoil</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">split_points</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">split_index</span><span class="p">,</span> <span class="n">split</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">split_points</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">airfoil_index</span><span class="p">]):</span>

                    <span class="c1"># aerofoil split lines</span>
                    <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="p">[</span><span class="n">split</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">split</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">int</span><span class="p">(</span><span class="n">nele_split</span> <span class="o">*</span> <span class="n">nele_multiplier</span><span class="p">)]</span>
                    <span class="p">)</span>
                    <span class="n">lcounter</span> <span class="o">+=</span> <span class="mi">1</span>

                    <span class="k">if</span> <span class="n">split_index</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="c1"># prepare rib surfaces definition</span>
                        <span class="n">rib_surfaces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="p">[</span>
                                <span class="n">lcounter</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">seqas_per_aerofoil</span><span class="p">,</span>
                                <span class="n">lcounter</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
                                <span class="n">lcounter</span> <span class="o">-</span> <span class="n">split_index</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span>
                                <span class="o">-</span><span class="p">(</span><span class="n">lcounter</span> <span class="o">-</span> <span class="mi">2</span><span class="p">),</span>
                            <span class="p">]</span>
                        <span class="p">)</span>

            <span class="c1"># spanwise lines at trailing edge</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">seqa_id</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">seqas_per_aerofoil</span> <span class="o">&lt;</span> <span class="n">aerofoils</span><span class="p">:</span>

                <span class="k">for</span> <span class="n">te_line_inc</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">seqas_per_aerofoil</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">te_line_inc</span> <span class="o">&lt;</span> <span class="n">seqas_per_aerofoil</span><span class="p">:</span>
                        <span class="n">start_id</span> <span class="o">=</span> <span class="n">seqa_id</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">seqas_per_aerofoil</span> <span class="o">+</span> <span class="n">te_line_inc</span>
                        <span class="n">end_id</span> <span class="o">=</span> <span class="n">seqa_id</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">te_line_inc</span>
                        <span class="n">side</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="n">pt_offset</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">start_id</span> <span class="o">=</span> <span class="n">seqa_id</span> <span class="o">-</span> <span class="n">seqas_per_aerofoil</span> <span class="o">+</span> <span class="n">te_line_inc</span>
                        <span class="n">end_id</span> <span class="o">=</span> <span class="n">seqa_id</span> <span class="o">+</span> <span class="n">te_line_inc</span>
                        <span class="n">side</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                        <span class="n">pt_offset</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="p">[</span>
                            <span class="n">seqa</span><span class="p">[</span><span class="n">start_id</span><span class="p">][</span><span class="n">side</span><span class="p">]</span> <span class="o">+</span> <span class="n">pt_offset</span><span class="p">,</span>
                            <span class="n">seqa</span><span class="p">[</span><span class="n">end_id</span><span class="p">][</span><span class="n">side</span><span class="p">]</span> <span class="o">+</span> <span class="n">pt_offset</span><span class="p">,</span>
                            <span class="nb">int</span><span class="p">(</span><span class="n">nele_span</span><span class="p">[</span><span class="n">airfoil_index</span><span class="p">]</span> <span class="o">*</span> <span class="n">nele_multiplier</span><span class="p">),</span>
                        <span class="p">]</span>
                    <span class="p">)</span>
                    <span class="n">lcounter</span> <span class="o">+=</span> <span class="mi">1</span>

                    <span class="k">if</span> <span class="n">te_line_inc</span> <span class="o">&lt;</span> <span class="n">seqas_per_aerofoil</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">te_line_inc</span> <span class="o">&lt;</span> <span class="n">seqas_per_aerofoil</span> <span class="o">/</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># top surface</span>
                            <span class="n">aero_surfaces_flip</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>  <span class="c1"># bot surface</span>
                            <span class="n">aero_surfaces_flip</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
                        <span class="c1"># prepare aero surfaces definition</span>
                        <span class="n">aero_surfaces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="p">[</span>
                                <span class="n">lcounter</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">splits</span> <span class="o">-</span> <span class="n">seqas_per_aerofoil</span><span class="p">,</span>
                                <span class="n">lcounter</span><span class="p">,</span>
                                <span class="o">-</span><span class="p">(</span><span class="n">lcounter</span> <span class="o">+</span> <span class="n">seqas_per_aerofoil</span><span class="p">),</span>
                                <span class="o">-</span><span class="p">(</span><span class="n">lcounter</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span>
                            <span class="p">]</span>
                        <span class="p">)</span>

            <span class="n">airfoil_index</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="c1"># check that ptB_id &gt; ptA_id</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">([</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">]):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;something has gone wrong in the line definition.&quot;</span><span class="p">)</span>

    <span class="c1"># solid bodies</span>
    <span class="n">bodies</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">surf_id</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">rib_surfaces</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
        <span class="k">if</span> <span class="n">filled_sections</span><span class="p">[</span><span class="n">surf_id</span><span class="p">]:</span>
            <span class="n">bodies</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">surf_id</span><span class="p">,</span> <span class="n">surf_id</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">lines</span><span class="p">,</span> <span class="n">rib_surfaces</span><span class="p">,</span> <span class="n">aero_surfaces</span><span class="p">,</span> <span class="n">bodies</span><span class="p">,</span> <span class="n">aero_surfaces_flip</span>


<span class="k">def</span> <span class="nf">_get_commands</span><span class="p">(</span>
    <span class="n">geometry</span><span class="p">,</span>
    <span class="n">fix_lines</span><span class="p">,</span>
    <span class="n">loaded_lines</span><span class="p">,</span>
    <span class="n">loaded_surfaces</span><span class="p">,</span>
    <span class="n">merge_tol</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span>
    <span class="n">cgx_ele_type</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
    <span class="n">solver</span><span class="o">=</span><span class="s2">&quot;abq&quot;</span><span class="p">,</span>
    <span class="n">max_entries_per_line</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span>
<span class="p">):</span>
    <span class="k">def</span> <span class="nf">divide_chunks</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
        <span class="c1"># looping till length l</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">l</span><span class="p">),</span> <span class="n">n</span><span class="p">):</span>
            <span class="k">yield</span> <span class="n">l</span><span class="p">[</span><span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="n">n</span><span class="p">]</span>

    <span class="n">commands</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># points</span>
    <span class="k">for</span> <span class="n">entity_id</span><span class="p">,</span> <span class="n">point</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">geometry</span><span class="p">[</span><span class="s2">&quot;points&quot;</span><span class="p">]):</span>
        <span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;PNT P</span><span class="si">{</span><span class="n">entity_id</span><span class="si">:</span><span class="s2">05d</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">point</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">e</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">point</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">e</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">point</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">:</span><span class="s2">e</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="p">)</span>

    <span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;# =============== </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="c1"># point sequences</span>
    <span class="k">for</span> <span class="n">entity_id</span><span class="p">,</span> <span class="n">points</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">geometry</span><span class="p">[</span><span class="s2">&quot;point_seqa&quot;</span><span class="p">]):</span>
        <span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SEQA A</span><span class="si">{</span><span class="n">entity_id</span><span class="si">:</span><span class="s2">05d</span><span class="si">}</span><span class="s2"> pnt &quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">points</span><span class="p">),</span> <span class="mi">8</span><span class="p">):</span>
            <span class="n">line_end</span> <span class="o">=</span> <span class="s2">&quot; = </span><span class="se">\n</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">ii</span> <span class="o">+</span> <span class="mi">8</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">points</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;P</span><span class="si">{</span><span class="n">point</span><span class="si">:</span><span class="s2">05d</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="n">points</span><span class="p">[</span><span class="n">ii</span> <span class="p">:</span> <span class="n">ii</span> <span class="o">+</span> <span class="mi">8</span><span class="p">]])</span> <span class="o">+</span> <span class="n">line_end</span>
            <span class="p">)</span>

    <span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;# =============== </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="c1"># lines</span>
    <span class="k">for</span> <span class="n">entity_id</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">geometry</span><span class="p">[</span><span class="s2">&quot;lines&quot;</span><span class="p">]):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>  <span class="c1"># straight line</span>
            <span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;LINE L</span><span class="si">{</span><span class="n">entity_id</span><span class="si">:</span><span class="s2">05d</span><span class="si">}</span><span class="s2"> P</span><span class="si">{</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">05d</span><span class="si">}</span><span class="s2"> P</span><span class="si">{</span><span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">05d</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">line</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">:</span><span class="s2">d</span><span class="si">}</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>  <span class="c1"># spline</span>
            <span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;LINE L</span><span class="si">{</span><span class="n">entity_id</span><span class="si">:</span><span class="s2">05d</span><span class="si">}</span><span class="s2"> P</span><span class="si">{</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">05d</span><span class="si">}</span><span class="s2"> P</span><span class="si">{</span><span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">05d</span><span class="si">}</span><span class="s2"> A</span><span class="si">{</span><span class="n">line</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">:</span><span class="s2">05d</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">line</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="si">:</span><span class="s2">d</span><span class="si">}</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="p">)</span>

    <span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;# =============== </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="c1"># surfaces</span>
    <span class="n">rib_ids</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">entity_id</span><span class="p">,</span> <span class="n">surf</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">geometry</span><span class="p">[</span><span class="s2">&quot;surfaces&quot;</span><span class="p">][</span><span class="s2">&quot;ribs&quot;</span><span class="p">]):</span>
        <span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;GSUR V</span><span class="si">{</span><span class="n">entity_id</span><span class="si">:</span><span class="s2">05d</span><span class="si">}</span><span class="s2"> + BLEND &quot;</span>
            <span class="o">+</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="sa">f</span><span class="s2">&quot;+ L</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">line</span><span class="p">)</span><span class="si">:</span><span class="s2">05d</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span>
                    <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;- L</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">line</span><span class="p">)</span><span class="si">:</span><span class="s2">05d</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">surf</span>
                <span class="p">]</span>
            <span class="p">)</span>
            <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="n">rib_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entity_id</span><span class="p">)</span>

    <span class="n">aero_ids</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">flip_surfaces</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">counter</span><span class="p">,</span> <span class="n">surf</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">geometry</span><span class="p">[</span><span class="s2">&quot;surfaces&quot;</span><span class="p">][</span><span class="s2">&quot;aero&quot;</span><span class="p">]):</span>
        <span class="n">entity_id</span> <span class="o">=</span> <span class="n">counter</span> <span class="o">+</span> <span class="p">(</span><span class="n">rib_ids</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">rib_ids</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;GSUR V</span><span class="si">{</span><span class="n">entity_id</span><span class="si">:</span><span class="s2">05d</span><span class="si">}</span><span class="s2"> + BLEND &quot;</span>
            <span class="o">+</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="sa">f</span><span class="s2">&quot;+ L</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">line</span><span class="p">)</span><span class="si">:</span><span class="s2">05d</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span>
                    <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;- L</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">line</span><span class="p">)</span><span class="si">:</span><span class="s2">05d</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">surf</span>
                <span class="p">]</span>
            <span class="p">)</span>
            <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">geometry</span><span class="p">[</span><span class="s2">&quot;surfaces&quot;</span><span class="p">][</span><span class="s2">&quot;aero_surfaces_flip&quot;</span><span class="p">][</span><span class="n">counter</span><span class="p">]:</span>
            <span class="n">flip_surfaces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;FLIP V</span><span class="si">{</span><span class="n">entity_id</span><span class="si">:</span><span class="s2">05d</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">aero_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entity_id</span><span class="p">)</span>

    <span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;# =============== </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="c1"># bodies</span>
    <span class="k">for</span> <span class="n">entity_id</span><span class="p">,</span> <span class="n">body</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">geometry</span><span class="p">[</span><span class="s2">&quot;bodies&quot;</span><span class="p">]):</span>
        <span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;BODY B</span><span class="si">{</span><span class="n">entity_id</span><span class="si">:</span><span class="s2">05d</span><span class="si">}</span><span class="s2"> V</span><span class="si">{</span><span class="n">body</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">05d</span><span class="si">}</span><span class="s2"> V</span><span class="si">{</span><span class="n">body</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">05d</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;# =============== </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="c1"># SPC and load sets</span>
    <span class="k">if</span> <span class="n">fix_lines</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">divide_chunks</span><span class="p">(</span><span class="n">fix_lines</span><span class="p">,</span> <span class="n">max_entries_per_line</span><span class="p">):</span>
            <span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="s2">&quot;SETA SPC l &quot;</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;L</span><span class="si">{</span><span class="n">line</span><span class="si">:</span><span class="s2">05d</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">chunk</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="p">)</span>
    <span class="k">if</span> <span class="n">loaded_lines</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">divide_chunks</span><span class="p">(</span><span class="n">loaded_lines</span><span class="p">,</span> <span class="n">max_entries_per_line</span><span class="p">):</span>
            <span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="s2">&quot;SETA LAST l &quot;</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;L</span><span class="si">{</span><span class="n">line</span><span class="si">:</span><span class="s2">05d</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">chunk</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="p">)</span>
    <span class="k">if</span> <span class="n">loaded_surfaces</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">divide_chunks</span><span class="p">(</span><span class="n">loaded_surfaces</span><span class="p">,</span> <span class="n">max_entries_per_line</span><span class="p">):</span>
            <span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="s2">&quot;SETA TOP s &quot;</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;V</span><span class="si">{</span><span class="nb">id</span><span class="si">:</span><span class="s2">05d</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">chunk</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="p">)</span>

    <span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;# =============== </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="c1"># surface meshes</span>
    <span class="n">surfaces</span> <span class="o">=</span> <span class="n">geometry</span><span class="p">[</span><span class="s2">&quot;surfaces&quot;</span><span class="p">][</span><span class="s2">&quot;ribs&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">geometry</span><span class="p">[</span><span class="s2">&quot;surfaces&quot;</span><span class="p">][</span><span class="s2">&quot;aero&quot;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">entity_id</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">surfaces</span><span class="p">):</span>
        <span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;MSHP V</span><span class="si">{</span><span class="n">entity_id</span><span class="si">:</span><span class="s2">05d</span><span class="si">}</span><span class="s2"> s </span><span class="si">{</span><span class="n">cgx_ele_type</span><span class="si">:</span><span class="s2">d</span><span class="si">}</span><span class="s2"> 0 1.000000e+00</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="c1"># sets of surfaces</span>
    <span class="k">if</span> <span class="n">rib_ids</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">divide_chunks</span><span class="p">(</span><span class="n">rib_ids</span><span class="p">,</span> <span class="n">max_entries_per_line</span><span class="p">):</span>
            <span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="s2">&quot;SETA RIBS s &quot;</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;V</span><span class="si">{</span><span class="nb">id</span><span class="si">:</span><span class="s2">05d</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">chunk</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="p">)</span>
    <span class="k">if</span> <span class="n">aero_ids</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">divide_chunks</span><span class="p">(</span><span class="n">aero_ids</span><span class="p">,</span> <span class="n">max_entries_per_line</span><span class="p">):</span>
            <span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="s2">&quot;SETA AERO s &quot;</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;V</span><span class="si">{</span><span class="nb">id</span><span class="si">:</span><span class="s2">05d</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">chunk</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="p">)</span>

    <span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;# =============== </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="c1"># body meshes</span>
    <span class="k">if</span> <span class="n">geometry</span><span class="p">[</span><span class="s2">&quot;bodies&quot;</span><span class="p">]:</span>
        <span class="k">for</span> <span class="n">entity_id</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">geometry</span><span class="p">[</span><span class="s2">&quot;bodies&quot;</span><span class="p">]):</span>
            <span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;MSHP B</span><span class="si">{</span><span class="n">entity_id</span><span class="si">:</span><span class="s2">05d</span><span class="si">}</span><span class="s2"> b 4 0 1.000000e+00</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;# =============== </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="c1"># custom export statement</span>
    <span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;mesh all</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;merg n all </span><span class="si">{</span><span class="n">merge_tol</span><span class="si">:</span><span class="s2">6f</span><span class="si">}</span><span class="s2"> &#39;nolock&#39;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;comp nodes d</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">flip_surfaces</span><span class="p">:</span>
        <span class="n">commands</span> <span class="o">+=</span> <span class="n">flip_surfaces</span>
    <span class="k">if</span> <span class="n">fix_lines</span><span class="p">:</span>
        <span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;comp SPC d</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;send SPC </span><span class="si">{</span><span class="n">solver</span><span class="si">}</span><span class="s2"> spc 123456</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">loaded_lines</span><span class="p">:</span>
        <span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;comp LAST d</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;send LAST </span><span class="si">{</span><span class="n">solver</span><span class="si">}</span><span class="s2"> names</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">loaded_surfaces</span><span class="p">:</span>
        <span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;comp TOP d</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;send TOP </span><span class="si">{</span><span class="n">solver</span><span class="si">}</span><span class="s2"> names</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">rib_ids</span><span class="p">:</span>
        <span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;comp RIBS d</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;send RIBS </span><span class="si">{</span><span class="n">solver</span><span class="si">}</span><span class="s2"> names</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">aero_ids</span><span class="p">:</span>
        <span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;comp AERO d</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;send AERO </span><span class="si">{</span><span class="n">solver</span><span class="si">}</span><span class="s2"> names</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;send all </span><span class="si">{</span><span class="n">solver</span><span class="si">}</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;quit</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">commands</span>
</pre></div>
</div>
</div>
<input id="49cf55ac-8a07-4d08-ad69-4d0d7713e5be" name="18093d11-a75a-4d98-8c44-600006960ca4" type="radio">
</input><label class="sd-tab-label" for="49cf55ac-8a07-4d08-ad69-4d0d7713e5be">
requirements</label><div class="sd-tab-content docutils">
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>matplotlib == 3.5.2
numpy == 1.21.5
scipy == 1.7.3
</pre></div>
</div>
</div>
<input id="dbdd299d-8d6d-4941-95d5-ad5a5501025f" name="18093d11-a75a-4d98-8c44-600006960ca4" type="radio">
</input><label class="sd-tab-label" for="dbdd299d-8d6d-4941-95d5-ad5a5501025f">
naca0012</label><div class="sd-tab-content docutils">
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span># NACA 0012 from http://airfoiltools.com/
  1.000000  0.001260
  0.999416  0.001342
  0.997666  0.001587
  0.994753  0.001994
  0.990685  0.002560
  0.985471  0.003280
  0.979123  0.004152
  0.971656  0.005169
  0.963087  0.006324
  0.953437  0.007611
  0.942728  0.009022
  0.930985  0.010549
  0.918235  0.012182
  0.904509  0.013914
  0.889837  0.015735
  0.874255  0.017635
  0.857800  0.019605
  0.840508  0.021635
  0.822421  0.023714
  0.803581  0.025834
  0.784032  0.027983
  0.763820  0.030152
  0.742992  0.032329
  0.721596  0.034506
  0.699682  0.036670
  0.677303  0.038811
  0.654509  0.040917
  0.631354  0.042978
  0.607892  0.044980
  0.584179  0.046912
  0.560268  0.048762
  0.536217  0.050516
  0.512082  0.052162
  0.487918  0.053687
  0.463783  0.055077
  0.439732  0.056320
  0.415822  0.057403
  0.392108  0.058314
  0.368646  0.059042
  0.345492  0.059575
  0.322698  0.059903
  0.300318  0.060017
  0.278404  0.059910
  0.257008  0.059576
  0.236180  0.059008
  0.215968  0.058205
  0.196419  0.057164
  0.177579  0.055886
  0.159492  0.054372
  0.142201  0.052625
  0.125745  0.050651
  0.110163  0.048457
  0.095492  0.046049
  0.081765  0.043437
  0.069015  0.040631
  0.057272  0.037641
  0.046563  0.034479
  0.036913  0.031156
  0.028344  0.027683
  0.020877  0.024071
  0.014529  0.020330
  0.009315  0.016471
  0.005247  0.012501
  0.002334  0.008429
  0.000584  0.004260
  0.000000  0.000000
  0.000584 -0.004260
  0.002334 -0.008429
  0.005247 -0.012501
  0.009315 -0.016471
  0.014529 -0.020330
  0.020877 -0.024071
  0.028344 -0.027683
  0.036913 -0.031156
  0.046563 -0.034479
  0.057272 -0.037641
  0.069015 -0.040631
  0.081765 -0.043437
  0.095492 -0.046049
  0.110163 -0.048457
  0.125745 -0.050651
  0.142201 -0.052625
  0.159492 -0.054372
  0.177579 -0.055886
  0.196419 -0.057164
  0.215968 -0.058205
  0.236180 -0.059008
  0.257008 -0.059576
  0.278404 -0.059910
  0.300318 -0.060017
  0.322698 -0.059903
  0.345492 -0.059575
  0.368646 -0.059042
  0.392108 -0.058314
  0.415822 -0.057403
  0.439732 -0.056320
  0.463783 -0.055077
  0.487918 -0.053687
  0.512082 -0.052162
  0.536217 -0.050516
  0.560268 -0.048762
  0.584179 -0.046912
  0.607892 -0.044980
  0.631354 -0.042978
  0.654509 -0.040917
  0.677303 -0.038811
  0.699682 -0.036670
  0.721596 -0.034506
  0.742992 -0.032329
  0.763820 -0.030152
  0.784032 -0.027983
  0.803581 -0.025834
  0.822421 -0.023714
  0.840508 -0.021635
  0.857800 -0.019605
  0.874255 -0.017635
  0.889837 -0.015735
  0.904509 -0.013914
  0.918235 -0.012182
  0.930985 -0.010549
  0.942728 -0.009022
  0.953437 -0.007611
  0.963087 -0.006324
  0.971656 -0.005169
  0.979123 -0.004152
  0.985471 -0.003280
  0.990685 -0.002560
  0.994753 -0.001994
  0.997666 -0.001587
  0.999416 -0.001342
  1.000000 -0.001260
</pre></div>
</div>
</div>
<input id="02365dae-576c-4e22-be32-3c420992db88" name="18093d11-a75a-4d98-8c44-600006960ca4" type="radio">
</input><label class="sd-tab-label" for="02365dae-576c-4e22-be32-3c420992db88">
parameters</label><div class="sd-tab-content docutils">
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;span&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">2.0</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;chord&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">0.2</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;filled_sections_flags&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;airfoil_csv_file&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;naca0012.csv&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;nele_foil&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">        </span><span class="mi">10</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="mi">10</span><span class="w"></span>
<span class="w">    </span><span class="p">],</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;nele_span&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">40</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;node_merge_tol&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">0.002</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;cgx_ele_type&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;cgx_solver&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;abq&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;boundary_conditions&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nt">&quot;fix_lines&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">            </span><span class="mi">0</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="mi">1</span><span class="w"></span>
<span class="w">        </span><span class="p">],</span><span class="w"></span>
<span class="w">        </span><span class="nt">&quot;loaded_lines&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">            </span><span class="mi">5</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="mi">6</span><span class="w"></span>
<span class="w">        </span><span class="p">]</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="calculix-fea-component">
<h3>Calculix-fea component<a class="headerlink" href="#calculix-fea-component" title="Permalink to this headline">#</a></h3>
<p>This component first executes CalculiX GraphiX in batch mode on the .fdb file from the parametric-model component to generate the finite element model mesh file (all.msh).
Then, the composite material shell section properties are generated in python and written to file (composite_shell.inp), before the finite element analysis (FEA) of the model is executed with CalculiX CrunchiX.</p>
<p>The component outputs the mesh node deflections at the tip of the wing (FEA output file ‘ccx_static_tip_shear.dat’), as well as the model mesh file and a node set definition file, which will be needed for post-processing of the FEA results in the next component.</p>
<p>Here we use an application-specific component API called ‘calculix-fea-comp’, which ensures Calculix is installed in the local compute environment.
It also allows us to execute CalculiX from python, by importing the <code class="docutils literal notranslate"><span class="pre">execute_cgx</span></code> and <code class="docutils literal notranslate"><span class="pre">execute_fea</span></code> methods from the <code class="docutils literal notranslate"><span class="pre">calculix</span></code> module in the compute function.
In all other respects, this API is identical to the generic python component API <code class="docutils literal notranslate"><span class="pre">generic-python3-comp</span></code>.</p>
<p>Create the component:</p>
<ul class="simple">
<li><p>Right-click in the workspace and select <code class="docutils literal notranslate"><span class="pre">Add</span> <span class="pre">Empty</span> <span class="pre">Node</span></code>. Select the empty component to edit it.</p></li>
<li><p>In the <code class="docutils literal notranslate"><span class="pre">Properties</span></code> tab, fill in the component name, <code class="docutils literal notranslate"><span class="pre">calculix-fea</span></code>, and select the component API <code class="docutils literal notranslate"><span class="pre">calculix-fea-comp:latest</span></code>.</p></li>
<li><p>Copy the contents of the <code class="docutils literal notranslate"><span class="pre">setup.py</span></code>, <code class="docutils literal notranslate"><span class="pre">compute.py</span></code>, <code class="docutils literal notranslate"><span class="pre">requirements.txt</span></code> and <code class="docutils literal notranslate"><span class="pre">ccx_static_tip_shear.inp</span></code> files from below into a text editor, save them locally.
Then upload the first 3 files under the <code class="docutils literal notranslate"><span class="pre">Properties</span></code> tab and upload the last one under the <code class="docutils literal notranslate"><span class="pre">Parameters</span></code> tab by selecting <code class="docutils literal notranslate"><span class="pre">upload</span> <span class="pre">user</span> <span class="pre">input</span> <span class="pre">files</span></code>.</p></li>
<li><p>Copy the contents of the parameters JSON object below into the <code class="docutils literal notranslate"><span class="pre">Parameters</span></code> tab text box.</p></li>
<li><p>Copy the following JSON object into the <code class="docutils literal notranslate"><span class="pre">Inputs</span></code> tab text box:</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="s2">&quot;files.cgx_file&quot;</span><span class="p">:</span> <span class="s2">&quot;default&quot;</span><span class="p">,</span>
  <span class="s2">&quot;fibre_rotation_angle.ORI_0.1&quot;</span><span class="p">:</span> <span class="mi">0</span>
<span class="p">}</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Copy the following JSON object into the <code class="docutils literal notranslate"><span class="pre">Outputs</span></code> tab text box:</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="s2">&quot;files.analysis_output_file&quot;</span><span class="p">:</span> <span class="s2">&quot;default&quot;</span><span class="p">,</span>
  <span class="s2">&quot;files.mesh_file&quot;</span><span class="p">:</span> <span class="s2">&quot;default&quot;</span><span class="p">,</span>
  <span class="s2">&quot;files.nodeset_file&quot;</span><span class="p">:</span> <span class="s2">&quot;default&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Select <code class="docutils literal notranslate"><span class="pre">Save</span> <span class="pre">data</span></code> to save and close the component.</p></li>
</ul>
<div class="sd-tab-set docutils">
<input checked="checked" id="3ee42579-e816-4103-9dc0-7d22f5dc7667" name="8b6f5ad7-9dca-484f-807c-738ee29e70f3" type="radio">
</input><label class="sd-tab-label" for="3ee42579-e816-4103-9dc0-7d22f5dc7667">
setup</label><div class="sd-tab-content docutils">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>


<span class="k">def</span> <span class="nf">setup</span><span class="p">(</span>
    <span class="n">inputs</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">outputs</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">partials</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">parameters</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Editable setup function.&quot;&quot;&quot;</span>

    <span class="c1"># declare default parameter inputs - overriden by connection data if available</span>
    <span class="k">if</span> <span class="s2">&quot;files.cgx_file&quot;</span> <span class="ow">in</span> <span class="n">parameters</span><span class="p">:</span>
        <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;implicit&quot;</span><span class="p">][</span><span class="s2">&quot;files.cgx_file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;files.cgx_file&quot;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;implicit&quot;</span><span class="p">][</span><span class="s2">&quot;files.cgx_file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;default&quot;</span>

    <span class="n">fibre_rotation_angles</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">key</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;design&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;fibre_rotation_angle&quot;</span><span class="p">)</span>
    <span class="p">]</span>
    <span class="k">for</span> <span class="n">angle</span> <span class="ow">in</span> <span class="n">fibre_rotation_angles</span><span class="p">:</span>
        <span class="c1"># set to float</span>
        <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;design&quot;</span><span class="p">][</span><span class="n">angle</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;design&quot;</span><span class="p">][</span><span class="n">angle</span><span class="p">])</span>

    <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">-%H%M%S&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">: Setup completed.&quot;</span>

    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="n">message</span><span class="p">,</span> <span class="s2">&quot;inputs&quot;</span><span class="p">:</span> <span class="n">inputs</span><span class="p">}</span>
</pre></div>
</div>
</div>
<input id="83329f17-36c7-4f43-8b2e-10148a5dbe10" name="8b6f5ad7-9dca-484f-807c-738ee29e70f3" type="radio">
</input><label class="sd-tab-label" for="83329f17-36c7-4f43-8b2e-10148a5dbe10">
compute</label><div class="sd-tab-content docutils">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">shutil</span> <span class="kn">import</span> <span class="n">copy2</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">scipy.spatial.transform</span> <span class="kn">import</span> <span class="n">Rotation</span>

<span class="kn">from</span> <span class="nn">calculix</span> <span class="kn">import</span> <span class="n">execute_cgx</span><span class="p">,</span> <span class="n">execute_fea</span>

<span class="n">PLOT_FLAG</span> <span class="o">=</span> <span class="kc">True</span>


<span class="k">def</span> <span class="nf">compute</span><span class="p">(</span>
    <span class="n">inputs</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">outputs</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">partials</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">options</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">parameters</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>

    <span class="sd">&quot;&quot;&quot;Editable compute function.&quot;&quot;&quot;</span>

    <span class="c1"># check input files have been uploaded</span>
    <span class="n">inputs_folder</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;inputs_folder_path&quot;</span><span class="p">])</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">inputs_folder</span> <span class="o">/</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;implicit&quot;</span><span class="p">][</span><span class="s2">&quot;files.cgx_file&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;implicit&#39;</span><span class="p">][</span><span class="s1">&#39;files.cgx_file&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> param file connection needed from parametric-model component.&quot;</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">inputs_folder</span> <span class="o">/</span> <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;analysis_file&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;analysis_file&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> needs to be uploaded by the user.&quot;</span>
        <span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Starting user function evaluation.&quot;</span><span class="p">)</span>

    <span class="n">run_folder</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;outputs_folder_path&quot;</span><span class="p">])</span>
    <span class="c1"># Generate the ccx input mesh with cgx</span>
    <span class="n">infile</span> <span class="o">=</span> <span class="n">copy2</span><span class="p">(</span>
        <span class="n">inputs_folder</span> <span class="o">/</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;implicit&quot;</span><span class="p">][</span><span class="s2">&quot;files.cgx_file&quot;</span><span class="p">],</span>
        <span class="n">run_folder</span> <span class="o">/</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;implicit&quot;</span><span class="p">][</span><span class="s2">&quot;files.cgx_file&quot;</span><span class="p">],</span>
    <span class="p">)</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="n">execute_cgx</span><span class="p">(</span><span class="n">infile</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">run_folder</span><span class="o">=</span><span class="n">run_folder</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">run_folder</span> <span class="o">/</span> <span class="s2">&quot;cgx.log&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">resp</span><span class="p">)</span>

    <span class="c1"># check output has been saved</span>
    <span class="n">mesh_file_path</span> <span class="o">=</span> <span class="n">run_folder</span> <span class="o">/</span> <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;mesh_file&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">mesh_file_path</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
        <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">mesh_file_path</span><span class="p">)</span><span class="si">}</span><span class="s2"> is not a file.&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Created CCX analysis mesh file with CGX.&quot;</span><span class="p">)</span>

    <span class="c1"># define composite material properties</span>
    <span class="k">if</span> <span class="s2">&quot;composite_layup&quot;</span> <span class="ow">in</span> <span class="n">parameters</span><span class="p">:</span>

        <span class="n">fibre_rotation_angles</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">key</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;design&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;fibre_rotation_angle&quot;</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="k">for</span> <span class="n">angle</span> <span class="ow">in</span> <span class="n">fibre_rotation_angles</span><span class="p">:</span>
            <span class="c1"># rotate a fibre direction in the orientations parameter</span>
            <span class="n">tree</span> <span class="o">=</span> <span class="n">angle</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
            <span class="nb">id</span> <span class="o">=</span> <span class="n">tree</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">direction</span> <span class="o">=</span> <span class="n">tree</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">ori_index</span> <span class="o">=</span> <span class="p">[</span><span class="n">ori</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="nb">id</span> <span class="k">for</span> <span class="n">ori</span> <span class="ow">in</span> <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;orientations&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span>
                <span class="kc">True</span>
            <span class="p">)</span>
            <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;orientations&quot;</span><span class="p">][</span><span class="n">ori_index</span><span class="p">][</span><span class="n">direction</span><span class="p">]</span> <span class="o">=</span> <span class="n">_rotate_vector</span><span class="p">(</span>
                <span class="n">angle</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;design&quot;</span><span class="p">][</span><span class="n">angle</span><span class="p">]),</span>
                <span class="n">starting</span><span class="o">=</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;orientations&quot;</span><span class="p">][</span><span class="n">ori_index</span><span class="p">][</span><span class="n">direction</span><span class="p">],</span>
                <span class="n">axis</span><span class="o">=</span><span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">],</span>
            <span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Orientation </span><span class="si">{</span><span class="nb">id</span><span class="si">}</span><span class="s2"> direction </span><span class="si">{</span><span class="n">direction</span><span class="si">}</span><span class="s2"> set to </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;orientations&#39;</span><span class="p">][</span><span class="n">ori_index</span><span class="p">][</span><span class="n">direction</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="n">get_composite_properties_input</span><span class="p">(</span><span class="n">parameters</span><span class="p">,</span> <span class="n">run_folder</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Created CCX composite properties file.&quot;</span><span class="p">)</span>

    <span class="c1"># run the FEM model analysis</span>
    <span class="n">infile</span> <span class="o">=</span> <span class="n">copy2</span><span class="p">(</span>
        <span class="n">inputs_folder</span> <span class="o">/</span> <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;analysis_file&quot;</span><span class="p">],</span>
        <span class="n">run_folder</span> <span class="o">/</span> <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;analysis_file&quot;</span><span class="p">],</span>
    <span class="p">)</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="n">execute_fea</span><span class="p">(</span><span class="n">infile</span><span class="o">.</span><span class="n">stem</span><span class="p">,</span> <span class="n">run_folder</span><span class="o">=</span><span class="n">run_folder</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">run_folder</span> <span class="o">/</span> <span class="s2">&quot;ccx.log&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">resp</span><span class="p">)</span>

    <span class="c1"># check output has been saved</span>
    <span class="n">outfile</span> <span class="o">=</span> <span class="n">run_folder</span> <span class="o">/</span> <span class="p">(</span><span class="n">infile</span><span class="o">.</span><span class="n">stem</span> <span class="o">+</span> <span class="s2">&quot;.dat&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">outfile</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
        <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">outfile</span><span class="p">)</span><span class="si">}</span><span class="s2"> is not a file.&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Executed CCX FEM analysis.&quot;</span><span class="p">)</span>

    <span class="c1"># set outputs</span>
    <span class="c1"># outputs = {&quot;output_files&quot;: [outfile.name]}</span>
    <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">-%H%M%S&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">: Executed Calculix finite element analysis.&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

    <span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;implicit&quot;</span><span class="p">][</span><span class="s2">&quot;files.analysis_output_file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">outfile</span><span class="o">.</span><span class="n">name</span>
    <span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;implicit&quot;</span><span class="p">][</span><span class="s2">&quot;files.mesh_file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;all.msh&quot;</span>
    <span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;implicit&quot;</span><span class="p">][</span><span class="s2">&quot;files.nodeset_file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;LAST.nam&quot;</span>

    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="n">message</span><span class="p">,</span> <span class="s2">&quot;outputs&quot;</span><span class="p">:</span> <span class="n">outputs</span><span class="p">}</span>


<span class="k">def</span> <span class="nf">get_composite_properties_input</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">run_folder</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;write an FEA input file with the composite properties.&quot;&quot;&quot;</span>

    <span class="c1"># check and update the element type in the mesh input file</span>
    <span class="n">str_find</span> <span class="o">=</span> <span class="s2">&quot;*ELEMENT, TYPE=S8,&quot;</span>
    <span class="n">str_replace</span> <span class="o">=</span> <span class="s2">&quot;*ELEMENT, TYPE=S8R,&quot;</span>
    <span class="n">_file_find_replace</span><span class="p">(</span>
        <span class="n">file</span><span class="o">=</span><span class="p">(</span><span class="n">run_folder</span> <span class="o">/</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;mesh_file&quot;</span><span class="p">]),</span>
        <span class="n">find</span><span class="o">=</span><span class="n">str_find</span><span class="p">,</span>
        <span class="n">replace_with</span><span class="o">=</span><span class="n">str_replace</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="s2">&quot;filled_sections_flags&quot;</span> <span class="ow">in</span> <span class="n">inputs</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span>
        <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;filled_sections_flags&quot;</span><span class="p">],</span> <span class="nb">list</span>
    <span class="p">):</span>
        <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;filled_sections_flags&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;filled_sections_flags&quot;</span><span class="p">]]</span>

    <span class="n">shell_set_name</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;shell_set_name&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="s2">&quot;filled_sections_flags&quot;</span> <span class="ow">in</span> <span class="n">inputs</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;filled_sections_flags&quot;</span><span class="p">]):</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span>
            <span class="nb">isinstance</span><span class="p">(</span><span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;airfoil_cut_chord_percentages&quot;</span><span class="p">],</span> <span class="nb">list</span><span class="p">)</span>
            <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;airfoil_cut_chord_percentages&quot;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">2</span>
        <span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;if &#39;filled_sections_flags&#39; is switched on, &#39;airfoil_cut_chord_percentages&#39;&quot;</span>
                <span class="s2">&quot;should be a list of length 2.&quot;</span>
            <span class="p">)</span>

        <span class="c1"># create separate element sets for shells and solids</span>
        <span class="n">str_find</span> <span class="o">=</span> <span class="s2">&quot;*ELEMENT, TYPE=S8R, ELSET=Eall&quot;</span>
        <span class="n">str_replace</span> <span class="o">=</span> <span class="s2">&quot;*ELEMENT, TYPE=S8R, ELSET=SURF&quot;</span>
        <span class="n">_file_find_replace</span><span class="p">(</span>
            <span class="n">file</span><span class="o">=</span><span class="p">(</span><span class="n">run_folder</span> <span class="o">/</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;mesh_file&quot;</span><span class="p">]),</span>
            <span class="n">find</span><span class="o">=</span><span class="n">str_find</span><span class="p">,</span>
            <span class="n">replace_with</span><span class="o">=</span><span class="n">str_replace</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">str_find</span> <span class="o">=</span> <span class="s2">&quot;*ELEMENT, TYPE=C3D20, ELSET=Eall&quot;</span>
        <span class="n">str_replace</span> <span class="o">=</span> <span class="s2">&quot;*ELEMENT, TYPE=C3D20, ELSET=CORE&quot;</span>
        <span class="n">_file_find_replace</span><span class="p">(</span>
            <span class="n">file</span><span class="o">=</span><span class="p">(</span><span class="n">run_folder</span> <span class="o">/</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;mesh_file&quot;</span><span class="p">]),</span>
            <span class="n">find</span><span class="o">=</span><span class="n">str_find</span><span class="p">,</span>
            <span class="n">replace_with</span><span class="o">=</span><span class="n">str_replace</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="c1"># get input file cards for this solver</span>
    <span class="n">ccx_commands</span> <span class="o">=</span> <span class="n">_get_ccx_composite_shell_props</span><span class="p">(</span>
        <span class="n">plies</span><span class="o">=</span><span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;composite_plies&quot;</span><span class="p">],</span>
        <span class="n">orientations</span><span class="o">=</span><span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;orientations&quot;</span><span class="p">],</span>
        <span class="n">layup</span><span class="o">=</span><span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;composite_layup&quot;</span><span class="p">],</span>
        <span class="n">shell_set_name</span><span class="o">=</span><span class="n">shell_set_name</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># write string of commands to file</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">run_folder</span> <span class="o">/</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;composite_props_file&quot;</span><span class="p">],</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ccx_commands</span><span class="p">))</span>


<span class="c1">########### Private functions that do not get called directly</span>


<span class="k">def</span> <span class="nf">_file_find_replace</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">find</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">replace_with</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">contents</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">contents</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">find</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
            <span class="n">contents</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">find</span><span class="p">,</span> <span class="n">replace_with</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Find &amp; Replace edited file &#39;</span><span class="si">{</span><span class="n">file</span><span class="si">}</span><span class="s2">&#39; at line </span><span class="si">{</span><span class="n">index</span><span class="si">:</span><span class="s2">d</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
            <span class="k">break</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">contents</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_get_ccx_composite_shell_props</span><span class="p">(</span>
    <span class="n">plies</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">orientations</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">layup</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">shell_set_name</span><span class="o">=</span><span class="kc">None</span>
<span class="p">):</span>

    <span class="n">commands</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">shell_set_name</span><span class="p">:</span>
        <span class="n">shell_set_name</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;ribs&quot;</span><span class="p">:</span> <span class="s2">&quot;ERIBS&quot;</span><span class="p">,</span> <span class="s2">&quot;aero&quot;</span><span class="p">:</span> <span class="s2">&quot;EAERO&quot;</span><span class="p">}</span>

    <span class="c1"># orientation cards</span>
    <span class="k">for</span> <span class="n">ori</span> <span class="ow">in</span> <span class="n">orientations</span><span class="p">:</span>
        <span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;*ORIENTATION,NAME=</span><span class="si">{</span><span class="n">ori</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span><span class="o">*</span><span class="n">ori</span><span class="p">[</span><span class="s2">&quot;1&quot;</span><span class="p">],</span> <span class="o">*</span><span class="n">ori</span><span class="p">[</span><span class="s2">&quot;2&quot;</span><span class="p">]])</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;** =============== </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="c1"># shell property</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">section_name</span><span class="p">)</span> <span class="ow">in</span> <span class="n">shell_set_name</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;*SHELL SECTION,ELSET=</span><span class="si">{</span><span class="n">section_name</span><span class="si">}</span><span class="s2">,COMPOSITE</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ply</span> <span class="ow">in</span> <span class="n">layup</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span>
            <span class="n">props</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">plies</span> <span class="k">if</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">ply</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">props</span><span class="p">[</span><span class="s1">&#39;thickness&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">6f</span><span class="si">}</span><span class="s2">,,</span><span class="si">{</span><span class="n">props</span><span class="p">[</span><span class="s1">&#39;material&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">props</span><span class="p">[</span><span class="s1">&#39;orientation&#39;</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="p">)</span>

    <span class="k">return</span> <span class="n">commands</span>


<span class="k">def</span> <span class="nf">_rotate_vector</span><span class="p">(</span><span class="n">angle</span><span class="p">,</span> <span class="n">starting</span><span class="p">,</span> <span class="n">axis</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Rotate a vector about an axis by an angle in degrees.&quot;&quot;&quot;</span>

    <span class="n">r</span> <span class="o">=</span> <span class="n">Rotation</span><span class="o">.</span><span class="n">from_rotvec</span><span class="p">(</span><span class="n">angle</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">axis</span><span class="p">),</span> <span class="n">degrees</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">r</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">starting</span><span class="p">)</span>
</pre></div>
</div>
</div>
<input id="61c0cd85-7962-4c70-8d3a-b55c7bc46782" name="8b6f5ad7-9dca-484f-807c-738ee29e70f3" type="radio">
</input><label class="sd-tab-label" for="61c0cd85-7962-4c70-8d3a-b55c7bc46782">
requirements</label><div class="sd-tab-content docutils">
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>matplotlib == 3.5.2
numpy == 1.21.5
scipy == 1.7.3
</pre></div>
</div>
</div>
<input id="c50093a1-e863-4347-adb3-b6fcb266e7e1" name="8b6f5ad7-9dca-484f-807c-738ee29e70f3" type="radio">
</input><label class="sd-tab-label" for="c50093a1-e863-4347-adb3-b6fcb266e7e1">
ccx_static_tip_shear</label><div class="sd-tab-content docutils">
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>*HEADING
Model: Cantilevered composite box with tip shear
**********************
** NODES AND ELEMENTS
*INCLUDE,INPUT=all.msh
**********************
** COMPOSITE PROPERTIES
*MATERIAL,NAME=EL
*ELASTIC, TYPE =ENGINEERING CONSTANTS
128.0E9,11.0E9,11.0E9,0.28,0.3,0.3,4.5E9,4.5E9,
4.5E9,20.0
*DENSITY
1520.0
*INCLUDE,INPUT=composite_shell.inp
**********************
** BOUNDARY CONDITIONS AND LOAD SET
*BOUNDARY
*INCLUDE,INPUT=SPC_123456.bou
*INCLUDE,INPUT=LAST.nam
**********************
*STEP
*STATIC
*CLOAD
NLAST,3,1.0
*NODE FILE 
U
*NODE PRINT,NSET=NLAST
U
*END STEP
</pre></div>
</div>
</div>
<input id="4ed3a820-99bb-4cf2-a88b-e54d10a2ea1f" name="8b6f5ad7-9dca-484f-807c-738ee29e70f3" type="radio">
</input><label class="sd-tab-label" for="4ed3a820-99bb-4cf2-a88b-e54d10a2ea1f">
parameters</label><div class="sd-tab-content docutils">
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;analysis_file&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;ccx_static_tip_shear.inp&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;mesh_file&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;all.msh&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;filled_sections_flags&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;shell_set_name&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;aero&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Eall&quot;</span><span class="w"></span>
<span class="w">  </span><span class="p">},</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;composite_plies&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;p_0&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="nt">&quot;thickness&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">0.0002</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="nt">&quot;material&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;EL&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="nt">&quot;orientation&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;ORI_0&quot;</span><span class="w"></span>
<span class="w">    </span><span class="p">},</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;p_90&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="nt">&quot;thickness&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">0.0002</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="nt">&quot;material&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;EL&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="nt">&quot;orientation&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;ORI_90&quot;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">],</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;orientations&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;ORI_0&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="nt">&quot;1&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">        </span><span class="mf">0.0</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="mf">1.0</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="mf">0.0</span><span class="w"></span>
<span class="w">      </span><span class="p">],</span><span class="w"></span>
<span class="w">      </span><span class="nt">&quot;2&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">        </span><span class="mf">-1.0</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="mf">0.0</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="mf">0.0</span><span class="w"></span>
<span class="w">      </span><span class="p">]</span><span class="w"></span>
<span class="w">    </span><span class="p">},</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;ORI_90&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="nt">&quot;1&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">        </span><span class="mf">1.0</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="mf">0.0</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="mf">0.0</span><span class="w"></span>
<span class="w">      </span><span class="p">],</span><span class="w"></span>
<span class="w">      </span><span class="nt">&quot;2&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">        </span><span class="mf">0.0</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="mf">1.0</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="mf">0.0</span><span class="w"></span>
<span class="w">      </span><span class="p">]</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">],</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;composite_layup&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;aero&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">      </span><span class="s2">&quot;p_90&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="s2">&quot;p_0&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="s2">&quot;p_0&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="s2">&quot;p_0&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="s2">&quot;p_90&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="s2">&quot;p_90&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="s2">&quot;p_0&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="s2">&quot;p_0&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="s2">&quot;p_0&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="s2">&quot;p_90&quot;</span><span class="w"></span>
<span class="w">    </span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="p">},</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;composite_props_file&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;composite_shell.inp&quot;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="results-processor-component">
<h3>Results processor component<a class="headerlink" href="#results-processor-component" title="Permalink to this headline">#</a></h3>
<p>The last component in the execution chain reads the FEA analysis outputs at the mesh nodes at the tip of the wing and calculates average wing tip deflections and rotations.
This data is output as a python dictionary with six entries: the 3 deflections (“U”) in global x, y and z, and the 3 rotations (“R”) about x, y, z.</p>
<p>Create the component:</p>
<ul class="simple">
<li><p>Right-click in the workspace and select <code class="docutils literal notranslate"><span class="pre">Add</span> <span class="pre">Empty</span> <span class="pre">Node</span></code>. Select the empty component to edit it.</p></li>
<li><p>In the <code class="docutils literal notranslate"><span class="pre">Properties</span></code> tab, fill in the component name, <code class="docutils literal notranslate"><span class="pre">fea-results-processor</span></code>, and select the component API <code class="docutils literal notranslate"><span class="pre">generic-python3-comp:latest</span></code>.</p></li>
<li><p>Copy the contents of the <code class="docutils literal notranslate"><span class="pre">setup.py</span></code>, <code class="docutils literal notranslate"><span class="pre">compute.py</span></code>, <code class="docutils literal notranslate"><span class="pre">requirements.txt</span></code> files from below into a text editor, save them locally.
Then upload them under the <code class="docutils literal notranslate"><span class="pre">Properties</span></code> tab.</p></li>
<li><p>In the <code class="docutils literal notranslate"><span class="pre">Properties</span></code> tab check the box next to the <code class="docutils literal notranslate"><span class="pre">End</span> <span class="pre">Node</span></code> option.</p></li>
<li><p>Copy the following JSON object into the <code class="docutils literal notranslate"><span class="pre">Inputs</span></code> tab text box:</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="s2">&quot;files.analysis_output_file&quot;</span><span class="p">:</span> <span class="s2">&quot;default&quot;</span><span class="p">,</span>
  <span class="s2">&quot;files.mesh_file&quot;</span><span class="p">:</span> <span class="s2">&quot;default&quot;</span><span class="p">,</span>
  <span class="s2">&quot;files.nodeset_file&quot;</span><span class="p">:</span> <span class="s2">&quot;default&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Copy the following JSON object into the <code class="docutils literal notranslate"><span class="pre">Outputs</span></code> tab text box:</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="s2">&quot;Ux&quot;</span><span class="p">:</span> <span class="s2">&quot;default&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Uy&quot;</span><span class="p">:</span> <span class="s2">&quot;default&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Uz&quot;</span><span class="p">:</span> <span class="s2">&quot;default&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Rx&quot;</span><span class="p">:</span> <span class="s2">&quot;default&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Ry&quot;</span><span class="p">:</span> <span class="s2">&quot;default&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Rz&quot;</span><span class="p">:</span> <span class="s2">&quot;default&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Select <code class="docutils literal notranslate"><span class="pre">Save</span> <span class="pre">data</span></code> to save and close the component.</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Remember to save the session data now by selecting <code class="docutils literal notranslate"><span class="pre">Download</span></code> from the interface controls.</p>
</div>
<div class="sd-tab-set docutils">
<input checked="checked" id="81c57321-484a-4891-8275-7eeefda45469" name="27256940-5b60-4a72-b251-0cde4f488988" type="radio">
</input><label class="sd-tab-label" for="81c57321-484a-4891-8275-7eeefda45469">
setup</label><div class="sd-tab-content docutils">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>


<span class="k">def</span> <span class="nf">setup</span><span class="p">(</span>
    <span class="n">inputs</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">outputs</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">partials</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">parameters</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Editable setup function.&quot;&quot;&quot;</span>

    <span class="c1"># declare default parameter inputs - overriden by connection data if available</span>
    <span class="k">if</span> <span class="s2">&quot;files.analysis_output_file&quot;</span> <span class="ow">in</span> <span class="n">parameters</span><span class="p">:</span>
        <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;implicit&quot;</span><span class="p">][</span><span class="s2">&quot;files.analysis_output_file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span>
            <span class="s2">&quot;files.analysis_output_file&quot;</span>
        <span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;implicit&quot;</span><span class="p">][</span><span class="s2">&quot;files.analysis_output_file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;default&quot;</span>

    <span class="k">if</span> <span class="s2">&quot;files.mesh_file&quot;</span> <span class="ow">in</span> <span class="n">parameters</span><span class="p">:</span>
        <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;implicit&quot;</span><span class="p">][</span><span class="s2">&quot;files.mesh_file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;files.mesh_file&quot;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;implicit&quot;</span><span class="p">][</span><span class="s2">&quot;files.mesh_file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;default&quot;</span>

    <span class="k">if</span> <span class="s2">&quot;files.nodeset_file&quot;</span> <span class="ow">in</span> <span class="n">parameters</span><span class="p">:</span>
        <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;implicit&quot;</span><span class="p">][</span><span class="s2">&quot;files.nodeset_file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;files.nodeset_file&quot;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;implicit&quot;</span><span class="p">][</span><span class="s2">&quot;files.nodeset_file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;default&quot;</span>

    <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">-%H%M%S&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">: Setup completed.&quot;</span>

    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="n">message</span><span class="p">,</span> <span class="s2">&quot;inputs&quot;</span><span class="p">:</span> <span class="n">inputs</span><span class="p">}</span>
</pre></div>
</div>
</div>
<input id="64bca59d-161d-4b24-96f8-0ddf7b3cbc04" name="27256940-5b60-4a72-b251-0cde4f488988" type="radio">
</input><label class="sd-tab-label" for="64bca59d-161d-4b24-96f8-0ddf7b3cbc04">
compute</label><div class="sd-tab-content docutils">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>


<span class="k">def</span> <span class="nf">compute</span><span class="p">(</span>
    <span class="n">inputs</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">outputs</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">partials</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">options</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">parameters</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>

    <span class="sd">&quot;&quot;&quot;Editable compute function.&quot;&quot;&quot;</span>

    <span class="n">datfile</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;implicit&quot;</span><span class="p">][</span><span class="s2">&quot;files.analysis_output_file&quot;</span><span class="p">]</span>
    <span class="n">mesh_file</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;implicit&quot;</span><span class="p">][</span><span class="s2">&quot;files.mesh_file&quot;</span><span class="p">]</span>
    <span class="n">node_set_file</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;implicit&quot;</span><span class="p">][</span><span class="s2">&quot;files.nodeset_file&quot;</span><span class="p">]</span>

    <span class="c1"># check input files have been uploaded</span>
    <span class="n">inputs_folder</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;inputs_folder_path&quot;</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="p">[</span><span class="n">datfile</span><span class="p">,</span> <span class="n">mesh_file</span><span class="p">,</span> <span class="n">node_set_file</span><span class="p">]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">inputs_folder</span> <span class="o">/</span> <span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">f</span><span class="si">}</span><span class="s2"> param file connection needed from calculix-fea component.&quot;</span>
            <span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Starting user function evaluation.&quot;</span><span class="p">)</span>

    <span class="c1"># recover the analysis results</span>
    <span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;design&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_fea_outputs</span><span class="p">(</span>
        <span class="n">datfile</span><span class="o">=</span><span class="n">datfile</span><span class="p">,</span>
        <span class="n">mesh_file</span><span class="o">=</span><span class="n">mesh_file</span><span class="p">,</span>
        <span class="n">node_set_file</span><span class="o">=</span><span class="n">node_set_file</span><span class="p">,</span>
        <span class="n">folder</span><span class="o">=</span><span class="n">inputs_folder</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">-%H%M%S&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">: Completed fea output processing: </span><span class="se">\n</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">outputs</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="n">message</span><span class="p">,</span> <span class="s2">&quot;outputs&quot;</span><span class="p">:</span> <span class="n">outputs</span><span class="p">}</span>


<span class="k">def</span> <span class="nf">get_fea_outputs</span><span class="p">(</span><span class="n">datfile</span><span class="p">,</span> <span class="n">mesh_file</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="n">node_set_file</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Recover the analysis outputs and process them for plotting.&quot;&quot;&quot;</span>

    <span class="c1"># read file and recover node displacements</span>
    <span class="n">output_file</span> <span class="o">=</span> <span class="n">folder</span> <span class="o">/</span> <span class="n">datfile</span>
    <span class="c1"># all_disp : [nodeid, vx, vy, vz]</span>
    <span class="n">all_disps</span> <span class="o">=</span> <span class="n">_get_from_dat</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="s2">&quot;displacements&quot;</span><span class="p">)</span>

    <span class="c1"># get node ids for displacement output &gt; read from LAST.nam file</span>
    <span class="n">node_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
        <span class="n">_get_from_inp</span><span class="p">(</span><span class="n">file</span><span class="o">=</span><span class="n">Path</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">node_set_file</span><span class="p">),</span> <span class="n">keyword</span><span class="o">=</span><span class="s2">&quot;NSET,NSET=&quot;</span><span class="p">),</span>
        <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># filter all_disp by node ids</span>
    <span class="n">disp_filter</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">all_disps</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">node_ids</span><span class="p">)</span>
    <span class="n">tip_disps</span> <span class="o">=</span> <span class="n">all_disps</span><span class="p">[</span><span class="n">disp_filter</span><span class="p">,</span> <span class="p">:]</span>

    <span class="c1"># average the deflections</span>
    <span class="n">v_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">disp</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
        <span class="n">v_mean</span><span class="p">[</span><span class="n">disp</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">tip_disps</span><span class="p">[:,</span> <span class="n">disp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>

    <span class="c1"># calculate the average rotations</span>
    <span class="n">rotations_mean</span> <span class="o">=</span> <span class="n">_get_average_rotation</span><span class="p">(</span>
        <span class="n">all_disps</span><span class="o">=</span><span class="n">tip_disps</span><span class="p">,</span> <span class="n">mesh_file</span><span class="o">=</span><span class="n">folder</span> <span class="o">/</span> <span class="n">mesh_file</span>
    <span class="p">)</span>

    <span class="n">outputs</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;Ux&quot;</span><span class="p">:</span> <span class="n">v_mean</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="s2">&quot;Uy&quot;</span><span class="p">:</span> <span class="n">v_mean</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
        <span class="s2">&quot;Uz&quot;</span><span class="p">:</span> <span class="n">v_mean</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
        <span class="s2">&quot;Rx&quot;</span><span class="p">:</span> <span class="n">rotations_mean</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="s2">&quot;Ry&quot;</span><span class="p">:</span> <span class="n">rotations_mean</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
        <span class="s2">&quot;Rz&quot;</span><span class="p">:</span> <span class="n">rotations_mean</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">outputs</span>


<span class="c1">########### Private functions that do not get called directly</span>


<span class="k">def</span> <span class="nf">_get_from_dat</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">contents</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>

    <span class="c1"># extract data assuming this is the only output</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">contents</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
            <span class="n">data_values</span> <span class="o">=</span> <span class="n">contents</span><span class="p">[</span><span class="n">index</span> <span class="o">+</span> <span class="mi">2</span> <span class="p">:]</span>
            <span class="k">break</span>

    <span class="c1"># parse data</span>
    <span class="k">if</span> <span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;displacements&quot;</span><span class="p">:</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()]</span>
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">data_values</span>
                <span class="k">if</span> <span class="n">line</span>
            <span class="p">],</span>
            <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">output</span>


<span class="k">def</span> <span class="nf">_get_from_inp</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">keyword</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">contents</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>

    <span class="c1"># extract data</span>
    <span class="n">read_flag</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">contents</span><span class="p">:</span>
        <span class="k">if</span> <span class="s2">&quot;*&quot;</span> <span class="ow">in</span> <span class="n">line</span> <span class="ow">and</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
            <span class="n">read_flag</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="s2">&quot;**&quot;</span> <span class="ow">in</span> <span class="n">line</span> <span class="ow">and</span> <span class="s2">&quot;*&quot;</span> <span class="ow">in</span> <span class="n">line</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="k">if</span> <span class="n">read_flag</span><span class="p">:</span>
            <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">data</span>


<span class="k">def</span> <span class="nf">_get_average_rotation</span><span class="p">(</span>
    <span class="n">all_disps</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">mesh_file</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">axes</span><span class="p">:</span> <span class="nb">tuple</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span>
        <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span>
        <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">],</span>
    <span class="p">),</span>  <span class="c1"># basic x, y, z axes</span>
<span class="p">):</span>
    <span class="c1"># for each output node, recover the node undeformed mesh position</span>
    <span class="c1"># node_positions : [nodeid, x, y, z]</span>
    <span class="n">node_positions</span> <span class="o">=</span> <span class="n">_get_nodes_from_inp</span><span class="p">(</span><span class="n">mesh_file</span><span class="p">,</span> <span class="n">ref_nodes</span><span class="o">=</span><span class="n">all_disps</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span>

    <span class="n">origin_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">node_positions</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># LE</span>
    <span class="c1"># calculate the approximate rotation from each node</span>
    <span class="n">rotations</span> <span class="o">=</span> <span class="n">_get_rot_from_disp</span><span class="p">(</span><span class="n">all_disps</span><span class="p">,</span> <span class="n">node_positions</span><span class="p">,</span> <span class="n">axes</span><span class="p">,</span> <span class="n">origin_index</span><span class="p">)</span>

    <span class="c1"># average the rotation values</span>
    <span class="n">rotations_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">rot</span> <span class="ow">in</span> <span class="n">rotations</span><span class="p">:</span>
        <span class="n">rotations_mean</span><span class="p">[</span><span class="n">rot</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">rotations</span><span class="p">[</span><span class="n">rot</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">rotations_mean</span>


<span class="k">def</span> <span class="nf">_get_nodes_from_inp</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">ref_nodes</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">contents</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>

    <span class="c1"># find node definitions in the file</span>
    <span class="n">start</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">nodes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">contents</span><span class="p">):</span>
        <span class="k">if</span> <span class="s2">&quot;*NODE&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">index</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">start</span> <span class="ow">and</span> <span class="s2">&quot;*&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>  <span class="c1"># marks the next keyword</span>
            <span class="k">break</span>
        <span class="k">elif</span> <span class="n">start</span> <span class="ow">and</span> <span class="n">index</span> <span class="o">&gt;=</span> <span class="n">start</span><span class="p">:</span>
            <span class="n">nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

    <span class="c1"># parse to array</span>
    <span class="n">nodes_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
        <span class="p">[[</span><span class="nb">float</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)]</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">nodes</span> <span class="k">if</span> <span class="n">line</span><span class="p">],</span>
        <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># filter reference nodes</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">ref_nodes</span><span class="p">):</span>
        <span class="n">nodes_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span><span class="n">line</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">nodes_vals</span> <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">ref_nodes</span><span class="p">)],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">nodes_vals</span>


<span class="k">def</span> <span class="nf">_get_rot_from_disp</span><span class="p">(</span><span class="n">all_disps</span><span class="p">,</span> <span class="n">node_positions</span><span class="p">,</span> <span class="n">axes</span><span class="p">,</span> <span class="n">origin_index</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return an array of rotations in radians. Using small deflection assumptions.&quot;&quot;&quot;</span>

    <span class="n">all_rots</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">axes</span><span class="p">))}</span>
    <span class="n">origin_displacements</span> <span class="o">=</span> <span class="n">all_disps</span><span class="p">[</span><span class="n">origin_index</span><span class="p">,</span> <span class="mi">1</span><span class="p">:]</span>
    <span class="n">origin_location</span> <span class="o">=</span> <span class="n">node_positions</span><span class="p">[</span><span class="n">origin_index</span><span class="p">,</span> <span class="mi">1</span><span class="p">:]</span>
    <span class="c1"># loop throught the nodes and y rotation axes</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">node_positions</span><span class="p">):</span>
        <span class="c1"># vector from origin to node position</span>
        <span class="n">v_op</span> <span class="o">=</span> <span class="n">node</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">origin_location</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">v_op</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># skip the origin</span>
            <span class="k">for</span> <span class="n">col</span><span class="p">,</span> <span class="n">axis</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">axes</span><span class="p">):</span>
                <span class="c1"># calculate local rotation unit vector</span>
                <span class="n">v_r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="n">v_op</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">v_r</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
                    <span class="n">v_r</span> <span class="o">=</span> <span class="n">v_r</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">v_r</span><span class="p">)</span>
                    <span class="n">d_vect</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">v_r</span><span class="p">,</span> <span class="n">axis</span><span class="p">)</span>  <span class="c1"># this should already be a unit vector</span>
                    <span class="n">dist_from_axis</span> <span class="o">=</span> <span class="n">v_op</span> <span class="o">@</span> <span class="n">d_vect</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">d_vect</span><span class="p">)</span>
                    <span class="c1"># calculate local rotation at the centroid</span>
                    <span class="n">rot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan</span><span class="p">(</span>
                        <span class="p">((</span><span class="n">all_disps</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">origin_displacements</span><span class="p">)</span> <span class="o">@</span> <span class="n">v_r</span><span class="p">)</span>
                        <span class="o">/</span> <span class="n">dist_from_axis</span>
                    <span class="p">)</span>
                    <span class="n">all_rots</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rot</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Skip point [</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">node</span><span class="p">)</span><span class="si">}</span><span class="s2">] on the local rotation axis </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">axis</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span>
                    <span class="p">)</span>

    <span class="k">return</span> <span class="n">all_rots</span>
</pre></div>
</div>
</div>
<input id="9d911e45-774e-4f61-85cd-35bdd40bb9f5" name="27256940-5b60-4a72-b251-0cde4f488988" type="radio">
</input><label class="sd-tab-label" for="9d911e45-774e-4f61-85cd-35bdd40bb9f5">
requirements</label><div class="sd-tab-content docutils">
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>numpy == 1.21.5
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="create-the-connections">
<h2>Create the Connections<a class="headerlink" href="#create-the-connections" title="Permalink to this headline">#</a></h2>
<p>We can now connect the Components we created to ensure that outputs and inputs are passed between them as expected. A Connection is defined as a data link from a Component output handle to another Component input handle.</p>
<section id="first-connection">
<h3>First connection<a class="headerlink" href="#first-connection" title="Permalink to this headline">#</a></h3>
<p>Create a first connection by selecting the output handle of the parametric-model component and dragging a line to the ‘files.cgx_file’ input handle of the calculix-fea component.
Hover the mouse pointer over a handle to see the name of the associated input or output data appear below the component.</p>
<p>By default, a new connection is a ‘Design variable’ type connection (black line), that is not valid for transferring files (see the TODO Reference entry for details).</p>
<p>Edit the Connection by selecting it in the workspace.
In the <code class="docutils literal notranslate"><span class="pre">Properties</span></code> tab change the Connection Type option from the default ‘Design variable’ to the ‘Implicit variable or file’ option by selecting the corresponding radio button.</p>
<p>Select <code class="docutils literal notranslate"><span class="pre">Save</span> <span class="pre">data</span></code> to save the change and close the connection interface.
Verify that the connection line colour has become green, which indicates an ‘implicit’ type data connection.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>By default the connection label is set to the name of the associated output handle data.
Indeed, there is no requirement for the input and output data names to match - so we could easily connect output ‘apples’ to input ‘oranges’ if we are not careful!</p>
</div>
</section>
<section id="more-connections">
<h3>More connections<a class="headerlink" href="#more-connections" title="Permalink to this headline">#</a></h3>
<p>In the same way, create 3 more connections between the calculix-fea component and the fea-results-processor component, linking the handles with matching data names.</p>
<p>Edit all 3 connections to modify them to ‘implicit’ type data connections, since we are again transferring files and not design variables.</p>
<p>Check that all 3 components have green tick marks appearing next to the component name to indicate that they are valid.</p>
<p>Save the session data now by selecting <code class="docutils literal notranslate"><span class="pre">Download</span></code> from the interface controls.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The four connection objects should appear under the ‘connections’ key in the session data file.</p>
</div>
</section>
</section>
<section id="execute-the-workflow">
<h2>Execute the workflow<a class="headerlink" href="#execute-the-workflow" title="Permalink to this headline">#</a></h2>
<p>We can now execute the chained component analysis Run by selecting the play symbol ▶ in the Run controls interface.</p>
<p>Once the run has started, each component with setup and then execute one at a time.
The setup order is arbitrary, but the compute functions will always be executed from the ‘Start Node’ to the ‘End Node’ (see TODO Reference manual section on valid workflows).</p>
<p>The Run should complete once the fea-results-component compute has completed.</p>
</section>
<section id="inspect-the-outputs">
<h2>Inspect the outputs<a class="headerlink" href="#inspect-the-outputs" title="Permalink to this headline">#</a></h2>
<p>The Run log summarises the output of the components. Open the log by selecting <code class="docutils literal notranslate"><span class="pre">View</span> <span class="pre">Log</span></code> in the interface controls.</p>
<p>Scroll down to the “run_output” section to see that this contains the compute function output messages from all three components in the order of execution as shown below.
The last message contains the wing tip deflection and rotation data as expected.</p>
<p>Also inspect the <code class="docutils literal notranslate"><span class="pre">Log</span></code> tab of all 3 components and download the file snapshots to view the input, connection and output files of all components.</p>
<p>Save the session data and the Run log now by selecting <code class="docutils literal notranslate"><span class="pre">Download</span></code> from the interface controls.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The ‘connections’ folder that appears in the ‘files snapshot’ zip folder contains any incoming connection files. This is to differentiate them from parametric and API input files in the user file storage system, where these files exist as symbolic links to the upstream component file to improve efficiency. However, the connection files are copied into the <code class="docutils literal notranslate"><span class="pre">parameters[&quot;inputs_folder_path&quot;]</span></code> before the compute function starts.</p>
</div>
<a class="bg-primary mb-1 reference internal image-reference" href="../_images/parametric-model-3.png"><img alt="run log" class="bg-primary mb-1 align-center" src="../_images/parametric-model-3.png" style="width: 700px;" /></a>
</section>
<section id="clean-up">
<h2>Clean-up<a class="headerlink" href="#clean-up" title="Permalink to this headline">#</a></h2>
<p>Delete your session by selecting <code class="docutils literal notranslate"><span class="pre">New</span></code> in the interface.
It may take a minute or so for the Cloud session to be reset.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>You should see a warning message whenever you are about to delete a Run. If you select to continue, then all the Run data (session data, inputs and outputs) will be permanently deleted.</p>
</div>
</section>
<section id="references">
<span id="tutorials-chaining-component-analyses-references"></span><h2>References:<a class="headerlink" href="#references" title="Permalink to this headline">#</a></h2>
<ol class="simple">
<li><p><a class="reference external" href="https://www.dapta.com/parametric-fem-model-creation-with-python-and-calculix-graphix-cgx/">Parametric FEM model creation with Python and CalculiX GraphiX (cgx)</a></p></li>
<li><p><a class="reference external" href="https://www.dapta.com/automated-fem-analysis-and-output-processing-with-python-and-calculix-crunchix-ccx/">Automated FEM analysis and output processing with Python and CalculiX CrunchiX (ccx)</a></p></li>
</ol>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./Tutorials"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
            </main>
            <footer class="footer-article noprint">
                
    <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="Simple%20optimisation%20problem.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Simple optimisation problem</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="Automating%20parametric%20studies.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Automating parametric studies</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            </footer>
        </div>
    </div>
    <div class="footer-content row">
        <footer class="col footer"><p>
  
    By Dapta Ltd<br/>
  
      &copy; Copyright 2022.<br/>
</p>
        </footer>
    </div>
    
</div>


      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>


  </body>
</html>