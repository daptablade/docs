
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>8. Using OpenVSP for aircraft performance analysis &#8212; dapta docs</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css?digest=5115cc725059bd94278eecd172e13a965bf8f5a9" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.b7bb847fb20b106c3d81b95245e65545.min.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=9c920249402e914e316237a7dbc6769907cce411"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <link rel="canonical" href="https://daptadocs.com/index.com/Tutorials/Using OpenVSP for aircraft performance analysis.html" />
    <link rel="shortcut icon" href="../_static/favicon.png"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="9. A simple Rescale simulation example" href="A%20simple%20Rescale%20simulation%20example.html" />
    <link rel="prev" title="7. Example of a variable stiffness plate in compression" href="Example%20of%20a%20variable%20stiffness%20plate%20in%20compression.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en">
    

    <!-- Google Analytics -->
    
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-KD6ZCS0VXN"></script>
<script>
                    window.dataLayer = window.dataLayer || [];
                    function gtag(){ dataLayer.push(arguments); }
                    gtag('js', new Date());
                    gtag('config', 'G-KD6ZCS0VXN');
                </script>

  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay overlay-navbar" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input type="checkbox" class="sidebar-toggle" name="__page-toc" id="__page-toc" aria-label="Toggle in-page Table of Contents">
<label class="overlay overlay-pagetoc" for="__page-toc">
    <div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"></div>
<div class="header header-item noprint"></div>

    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
    <div class="bd-sidebar__content">
        <div class="bd-sidebar__top"><div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="../_static/logo.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">dapta docs</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../intro.html">
                    Welcome!
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Tutorials
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="Simple%20component%20analysis.html">
   1. Simple component analysis
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Simple%20optimisation%20problem.html">
   2. Simple optimisation problem
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Chaining%20component%20analyses.html">
   3. Chaining component analyses
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Automating%20parametric%20studies.html">
   4. Automating the composite wing model parametric study
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Automating%20design%20optimisations.html">
   5. Automating the design optimisation of the composite wing model
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Working%20with%20spreadsheets.html">
   6. Working with spreadsheets
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Example%20of%20a%20variable%20stiffness%20plate%20in%20compression.html">
   7. Example of a variable stiffness plate in compression
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   8. Using OpenVSP for aircraft performance analysis
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="A%20simple%20Rescale%20simulation%20example.html">
   9. A simple Rescale simulation example
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Reference Guide
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../Reference/The%20dashboard.html">
   The dashboard
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Reference/FAQs.html">
   FAQs
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Reference/Glossary.html">
   Glossary
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Reference/Support.html">
   Support
  </a>
 </li>
</ul>

    </div>
</nav></div>
        <div class="bd-sidebar__bottom">
             <!-- To handle the deprecated key -->
            
            <div class="navbar_extra_footer">
            Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
            </div>
            
        </div>
    </div>
    <div id="rtd-footer-container"></div>
</div>


          


          
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
    
    <div class="header-article row sticky-top noprint">
        



<div class="col py-1 d-flex header-article-main">
    <div class="header-article__left">
        
        <label for="__navigation"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="right"
title="Toggle navigation"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-bars"></i>
  </span>

</label>

        
    </div>
    <div class="header-article__right">
<button onclick="toggleFullScreen()"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="bottom"
title="Fullscreen mode"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>

<div class="menu-dropdown menu-dropdown-repository-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Source repositories">
      <i class="fab fa-github"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://github.com/daptablade/docs"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Source repository"
>
  

<span class="headerbtn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="headerbtn__text-container">repository</span>
</a>

      </li>
      
      <li>
        <a href="https://github.com/daptablade/docs/issues/new?title=Issue%20on%20page%20%2FTutorials/Using OpenVSP for aircraft performance analysis.html&body=Your%20issue%20content%20here."
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Open an issue"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="headerbtn__text-container">open issue</span>
</a>

      </li>
      
    </ul>
  </div>
</div>

<div class="menu-dropdown menu-dropdown-download-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Download this page">
      <i class="fas fa-download"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="../_sources/Tutorials/Using OpenVSP for aircraft performance analysis.md"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Download source file"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="headerbtn__text-container">.md</span>
</a>

      </li>
      
      <li>
        
<button onclick="printPdf(this)"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="left"
title="Print to PDF"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="headerbtn__text-container">.pdf</span>
</button>

      </li>
      
    </ul>
  </div>
</div>
<label for="__page-toc"
  class="headerbtn headerbtn-page-toc"
  
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-list"></i>
  </span>

</label>

    </div>
</div>

<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
    <div class="tocsection onthispage pt-5 pb-3">
        <i class="fas fa-list"></i> Contents
    </div>
    <nav id="bd-toc-nav" aria-label="Page">
        <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#problem-description">
   8.1. Problem description
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#create-the-components">
   8.2. Create the components
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#vspaero-component">
     8.2.1. VSPAERO component
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#trim-component">
     8.2.2. Trim component
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#openmdao-driver-component">
     8.2.3. OpenMDAO driver component
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#connections">
     8.2.4. Connections
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#execute-the-workflow">
   8.3. Execute the workflow
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#inspect-the-outputs">
   8.4. Inspect the outputs
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#increase-the-number-of-design-points-and-re-run">
   8.5. Increase the number of design points and re-run
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#clean-up">
   8.6. Clean-up
  </a>
 </li>
</ul>

    </nav>
</div>
    </div>
    <div class="article row">
        <div class="col pl-md-3 pl-lg-5 content-container">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>Using OpenVSP for aircraft performance analysis</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#problem-description">
   8.1. Problem description
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#create-the-components">
   8.2. Create the components
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#vspaero-component">
     8.2.1. VSPAERO component
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#trim-component">
     8.2.2. Trim component
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#openmdao-driver-component">
     8.2.3. OpenMDAO driver component
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#connections">
     8.2.4. Connections
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#execute-the-workflow">
   8.3. Execute the workflow
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#inspect-the-outputs">
   8.4. Inspect the outputs
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#increase-the-number-of-design-points-and-re-run">
   8.5. Increase the number of design points and re-run
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#clean-up">
   8.6. Clean-up
  </a>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            <main id="main-content" role="main">
                
              <div>
                
  <section class="tex2jax_ignore mathjax_ignore" id="using-openvsp-for-aircraft-performance-analysis">
<h1><span class="section-number">8. </span>Using OpenVSP for aircraft performance analysis<a class="headerlink" href="#using-openvsp-for-aircraft-performance-analysis" title="Permalink to this headline">#</a></h1>
<p><a class="reference external" href="https://app.daptaflow.com/tutorial/8"><img alt="dapta" height="25px" src="../_images/Dapta-Brandmark-RGB.svg" width="25px" /> Load tutorial into dapta app</a>.
<a class="reference external" href="https://github.com/daptablade/docs/tree/master/mynewbook/Tutorials/openvsp-aircraft-aircraft-performance"><img alt="github" height="25px" src="../_images/github.svg" width="25px" /> View files on Github</a>.</p>
<a class="bg-primary mb-1 reference internal image-reference" href="../_images/openvsp-performance-1.png"><img alt="vsp3 model of a Cessna 210" class="bg-primary mb-1 align-right" src="../_images/openvsp-performance-1.png" style="width: 400px;" /></a>
<p><strong>Duration: 60 min</strong></p>
<p>In this example we create a simple aircraft performance analysis workflow using <a class="reference external" href="https://openvsp.org/">OpenVSP</a> and <a class="reference external" href="https://openmdao.org/">OpenMDAO</a>.</p>
<p>We also demonstrate how to execute components in parallel to speed up large parametric studies.</p>
<section id="problem-description">
<h2><span class="section-number">8.1. </span>Problem description<a class="headerlink" href="#problem-description" title="Permalink to this headline">#</a></h2>
<p>Theory tells us that an aircraft’s optimal cruise velocity for minimum thrust is where its lift to drag ratio (L/D) is maximised, which also corresponds to the flight velocity where the total drag (including lift-induced drag) is minimised.
In this example, we wish to graphically determine this optimal cruise velocity for a Cessna 210 for a range of different wing aspect ratios, given a certain flight altitude and fixed aircraft total mass.</p>
<p>We use a representative OpenVSP aircraft model (Cessna-210_metric.vsp3) as shown above.
The aircraft’s aerodynamic lift, drag and pitching moment coefficients are calculated using the vortex lattice method (VLM) implemented in the VSPAERO solver that comes with OpenVSP.
The model is in SI units (m/s/kg).
Only the wing and the horizontal tailplane (HTP) are modelled in the VLM analysis, with the input mesh and a example output pressure distribution shown below.</p>
<p>It is not necessary to install OpenVSP on your machine for this example, since most of the analysis input and output data can also be accessed by opening the files in a simple text editor.
However, you will need to install OpenVSP if you want to run the component code locally since we will be using the OpenVSP python API in the next section.</p>
<a class="bg-primary mb-1 reference internal image-reference" href="../_images/openvsp-performance-2.png"><img alt="VLM mesh and pressure distribution" class="bg-primary mb-1 align-center" src="../_images/openvsp-performance-2.png" style="width: 700px;" /></a>
<p>To determine the optimum flight velocity, we need to be able to perform multiple trimmed aircraft analyses for different cruise velocities and wing aspect ratios.
The aircraft is trimmed in level flight when all forces and moments about the aircraft’s centre of gravity (CG) cancel out.</p>
<p>Unfortunately, VSPAERO only does part of the job for us.
It allows us to calculate the aircraft’s aerodynamic coefficients for a certain configuration, but it can’t calculate the aircraft trim angle of attack (AoA) or the HTP angle required to balance the aero forces and moments out with the aircraft’s weight (assuming that thrust can be set to cancel out drag).</p>
<p>To solve this problem we can add a trim component to our simulation workflow as shown below. The trim component introduces a feedback cycle that adjusts the trim variables (AoA and HTP angles) based on the forces and moments at the aircraft’s CG.
We can use Newton’s method to converge the cycle to a trimmed solution.</p>
<a class="bg-primary mb-1 reference internal image-reference" href="../_images/openvsp-performance-3.png"><img alt="trim analysis cycle" class="bg-primary mb-1 align-center" src="../_images/openvsp-performance-3.png" style="width: 700px;" /></a>
<p>Finally, we choose to use OpenMDAO as the driver component for our workflow for 3 main reasons:</p>
<ol class="simple">
<li><p>It allows us to easily implement the trim analysis cycle mentioned above by using an ‘implicit’ component and variable promotion (where normal dapta design variable connections can only go forwards).</p></li>
<li><p>It includes nonlinear solvers, including a versatile <a class="reference external" href="https://openmdao.org/newdocs/versions/latest/features/building_blocks/solvers/newton.html">Newton solver</a> which can be used to converge the trim solution.</p></li>
<li><p>It allows us to set up a design of experiments workflow to iteratively solve the aircraft trim problem for different flight conditions and aircraft designs.</p></li>
</ol>
</section>
<section id="create-the-components">
<h2><span class="section-number">8.2. </span>Create the components<a class="headerlink" href="#create-the-components" title="Permalink to this headline">#</a></h2>
<p>The following sections will guide you through the creation of the simulation workflow starting from an empty workspace.
<strong>Already signed-up?</strong>
<a class="reference external" href="https://app.daptaflow.com/">Access your workspace here.</a></p>
<section id="vspaero-component">
<h3><span class="section-number">8.2.1. </span>VSPAERO component<a class="headerlink" href="#vspaero-component" title="Permalink to this headline">#</a></h3>
<p>The purpose of this component is to calculate the aerodynamic forces and moments about the aircraft’s CG for a given set of inputs and parameters.
The inputs include the aircraft angle of attack (AoA), the HTP angle (HTP_RY) and the half-wing aspect ratio (desvars_PONPNSVRANE).
Multiply the half-wing aspect ratio by 2 to recover an approximate full wing aspect ratio value (with the error due to dihedral angle).</p>
<p>Parameters include the OpenVSP model input file (Cessna-210_metric.vsp3), an OpenVSP design variables file (Cessna-210_metric.des) and a “HTP_RY_ID” lookup  parameter.
Note that the wing aspect ratio variable name and the value of the “HTP_RY_ID” parameter both refer to 11 character IDs from the OpenVPS design variables file instead of being hard-coded in the python script.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">compute.py</span></code> module makes use of the <a class="reference external" href="https://openvsp.org/api_docs/latest/">OpenVSP python API</a> to read the model files, to apply the input values to the model, to setup and execute the VSPAERO analysis and to recover the analysis outputs.<br />
The API is contained in the <code class="docutils literal notranslate"><span class="pre">vsp</span></code> object that is imported at the top of the file (<code class="docutils literal notranslate"><span class="pre">import</span> <span class="pre">openvsp</span> <span class="pre">as</span> <span class="pre">vsp</span></code>).</p>
<p><strong>Parallel execution:</strong> We use the “replicas” option on the <code class="docutils literal notranslate"><span class="pre">Properties</span></code> tab to create 4 independent copies of this component. This number should match the number of python threads set up in the OpenMDAO DOE driver.</p>
<p>Create the component:</p>
<ul class="simple">
<li><p>Right-click in the workspace and select <code class="docutils literal notranslate"><span class="pre">Add</span> <span class="pre">Empty</span> <span class="pre">Node</span></code>. Select the empty component to edit it.</p></li>
<li><p>In the <code class="docutils literal notranslate"><span class="pre">Properties</span></code> tab, fill in the component name, <code class="docutils literal notranslate"><span class="pre">vspaero</span></code>, and select the OpenVSP component API <code class="docutils literal notranslate"><span class="pre">openvsp-comp:latest</span></code>.</p></li>
<li><p>Copy the contents of the <code class="docutils literal notranslate"><span class="pre">setup.py</span></code>, <code class="docutils literal notranslate"><span class="pre">compute.py</span></code>, <code class="docutils literal notranslate"><span class="pre">Cessna-210_metric.vsp3</span></code> and <code class="docutils literal notranslate"><span class="pre">Cessna-210_metric.des</span></code> files from below into a text editor, save them locally.
Then upload the first 2 files under the <code class="docutils literal notranslate"><span class="pre">Properties</span></code> tab and upload the <code class="docutils literal notranslate"><span class="pre">.vsp3</span></code> and <code class="docutils literal notranslate"><span class="pre">.des</span></code> files under the <code class="docutils literal notranslate"><span class="pre">Parameters</span></code> tab by selecting <code class="docutils literal notranslate"><span class="pre">upload</span> <span class="pre">user</span> <span class="pre">input</span> <span class="pre">files</span></code>.</p></li>
<li><p>In the <code class="docutils literal notranslate"><span class="pre">Properties</span></code> tab copy the following JSON object into the <code class="docutils literal notranslate"><span class="pre">Options</span></code> text box:</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="s2">&quot;replicas&quot;</span><span class="p">:</span> <span class="mi">4</span>
<span class="p">}</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Also in the <code class="docutils literal notranslate"><span class="pre">Properties</span></code> tab check the box next to the <code class="docutils literal notranslate"><span class="pre">Start</span> <span class="pre">Node</span></code> option.</p></li>
<li><p>Insert the following JSON object into the <code class="docutils literal notranslate"><span class="pre">Parameters</span></code> tab text box (below the “user_input_files” entry):</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="s2">&quot;HTP_RY_ID&quot;</span><span class="p">:</span> <span class="s2">&quot;ABCVDMNNBOE&quot;</span><span class="p">,</span>
    <span class="s2">&quot;vsp3_file&quot;</span><span class="p">:</span> <span class="s2">&quot;Cessna-210_metric.vsp3&quot;</span><span class="p">,</span>
    <span class="s2">&quot;des_file&quot;</span><span class="p">:</span> <span class="s2">&quot;Cessna-210_metric.des&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Copy the following JSON object into the <code class="docutils literal notranslate"><span class="pre">Inputs</span></code> tab text box:</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="s2">&quot;AoA&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="s2">&quot;HTP_RY&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="s2">&quot;desvars_PONPNSVRANE&quot;</span><span class="p">:</span> <span class="mf">3.86</span>
<span class="p">}</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Copy the following JSON object into the <code class="docutils literal notranslate"><span class="pre">Outputs</span></code> tab text box:</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="s2">&quot;CL&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="s2">&quot;CMy&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="s2">&quot;CDtot&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="s2">&quot;L2D&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="s2">&quot;E&quot;</span><span class="p">:</span> <span class="mi">0</span>
<span class="p">}</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Select <code class="docutils literal notranslate"><span class="pre">Save</span> <span class="pre">data</span></code> to save and close the component.</p></li>
</ul>
<div class="sd-tab-set docutils">
<input checked="checked" id="78a346e5-0738-40b0-b37d-d2a8a6839ba6" name="20262cea-0ff6-4057-bfec-e0a9b5524acc" type="radio">
</input><label class="sd-tab-label" for="78a346e5-0738-40b0-b37d-d2a8a6839ba6">
setup</label><div class="sd-tab-content docutils">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="n">HOSTNAME</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;HOSTNAME&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">setup</span><span class="p">(</span>
    <span class="n">inputs</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;design&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;implicit&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;setup&quot;</span><span class="p">:</span> <span class="p">{}},</span>
    <span class="n">outputs</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;design&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;implicit&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;setup&quot;</span><span class="p">:</span> <span class="p">{}},</span>
    <span class="n">parameters</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;user_input_files&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s2">&quot;inputs_folder_path&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;outputs_folder_path&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="p">},</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;A user editable setup function.&quot;&quot;&quot;</span>

    <span class="c1"># initalise setup_data keys</span>
    <span class="n">response</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># delete previous run log</span>
    <span class="n">run_log</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;outputs_folder_path&quot;</span><span class="p">])</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;run_</span><span class="si">{</span><span class="n">HOSTNAME</span><span class="si">}</span><span class="s2">.log&quot;</span>
    <span class="k">if</span> <span class="n">run_log</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">run_log</span><span class="p">)</span>

    <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">-%H%M%S&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">: Setup completed on host </span><span class="si">{</span><span class="n">HOSTNAME</span><span class="si">}</span><span class="s2">.&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
    <span class="n">response</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">message</span>

    <span class="k">return</span> <span class="n">response</span>
</pre></div>
</div>
</div>
<input id="4873e701-4ac6-47f8-9568-5f9ac61c88ad" name="20262cea-0ff6-4057-bfec-e0a9b5524acc" type="radio">
</input><label class="sd-tab-label" for="4873e701-4ac6-47f8-9568-5f9ac61c88ad">
compute</label><div class="sd-tab-content docutils">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">shutil</span> <span class="kn">import</span> <span class="n">copy2</span>

<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">wraps</span>
<span class="kn">from</span> <span class="nn">contextlib</span> <span class="kn">import</span> <span class="n">redirect_stdout</span>

<span class="kn">import</span> <span class="nn">openvsp</span> <span class="k">as</span> <span class="nn">vsp</span>

<span class="n">stdout</span> <span class="o">=</span> <span class="n">vsp</span><span class="o">.</span><span class="n">cvar</span><span class="o">.</span><span class="n">cstdout</span>
<span class="n">errorMgr</span> <span class="o">=</span> <span class="n">vsp</span><span class="o">.</span><span class="n">ErrorMgrSingleton_getInstance</span><span class="p">()</span>

<span class="n">HOSTNAME</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;HOSTNAME&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">timeit</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="nd">@wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">wrapper_timer</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">tic</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">toc</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
        <span class="n">elapsed_time</span> <span class="o">=</span> <span class="n">toc</span> <span class="o">-</span> <span class="n">tic</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Elapsed time for function &#39;</span><span class="si">{</span><span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">elapsed_time</span><span class="si">:</span><span class="s2">0.4f</span><span class="si">}</span><span class="s2"> seconds&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">value</span>

    <span class="k">return</span> <span class="n">wrapper_timer</span>


<span class="k">def</span> <span class="nf">compute</span><span class="p">(</span>
    <span class="n">inputs</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;design&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;implicit&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;setup&quot;</span><span class="p">:</span> <span class="p">{}},</span>
    <span class="n">outputs</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;design&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;implicit&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;setup&quot;</span><span class="p">:</span> <span class="p">{}},</span>
    <span class="n">partials</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{},</span>
    <span class="n">options</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{},</span>
    <span class="n">parameters</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;user_input_files&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s2">&quot;inputs_folder_path&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;outputs_folder_path&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="p">},</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Wrapper around main function.&quot;&quot;&quot;</span>

    <span class="n">run_log</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;outputs_folder_path&quot;</span><span class="p">])</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;run_</span><span class="si">{</span><span class="n">HOSTNAME</span><span class="si">}</span><span class="s2">.log&quot;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">run_log</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">redirect_stdout</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="n">main</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">outputs</span><span class="p">,</span> <span class="n">partials</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="n">parameters</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">resp</span>


<span class="nd">@timeit</span>
<span class="k">def</span> <span class="nf">main</span><span class="p">(</span>
    <span class="n">inputs</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;design&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;implicit&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;setup&quot;</span><span class="p">:</span> <span class="p">{}},</span>
    <span class="n">outputs</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;design&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;implicit&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;setup&quot;</span><span class="p">:</span> <span class="p">{}},</span>
    <span class="n">partials</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{},</span>
    <span class="n">options</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{},</span>
    <span class="n">parameters</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;user_input_files&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s2">&quot;inputs_folder_path&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;outputs_folder_path&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="p">},</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;A user editable compute function.&quot;&quot;&quot;</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Starting VSPAERO run on </span><span class="si">{</span><span class="n">HOSTNAME</span><span class="si">}</span><span class="s2"> with: &quot;</span><span class="p">,</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;design&quot;</span><span class="p">])</span>

    <span class="c1"># check that input files have been uploaded</span>
    <span class="n">inputs_folder</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;inputs_folder_path&quot;</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;vsp3_file&quot;</span><span class="p">,</span> <span class="s2">&quot;des_file&quot;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">inputs_folder</span> <span class="o">/</span> <span class="n">parameters</span><span class="p">[</span><span class="n">file</span><span class="p">])</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">parameters</span><span class="p">[</span><span class="n">file</span><span class="p">]</span><span class="si">}</span><span class="s2"> needs to be uploaded by the user.&quot;</span>
            <span class="p">)</span>

    <span class="c1"># copy input files to run folder</span>
    <span class="n">run_folder</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;outputs_folder_path&quot;</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;user_input_files&quot;</span><span class="p">]:</span>  <span class="c1"># .vsp3 and .des files</span>
        <span class="n">src</span> <span class="o">=</span> <span class="n">inputs_folder</span> <span class="o">/</span> <span class="n">file</span><span class="p">[</span><span class="s2">&quot;filename&quot;</span><span class="p">]</span>
        <span class="n">copy2</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">run_folder</span> <span class="o">/</span> <span class="n">file</span><span class="p">[</span><span class="s2">&quot;filename&quot;</span><span class="p">])</span>
    <span class="n">vsp_file</span> <span class="o">=</span> <span class="n">run_folder</span> <span class="o">/</span> <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;vsp3_file&quot;</span><span class="p">]</span>
    <span class="n">des_file</span> <span class="o">=</span> <span class="n">run_folder</span> <span class="o">/</span> <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;des_file&quot;</span><span class="p">]</span>

    <span class="c1"># get inputs</span>
    <span class="n">desvars</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">k</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]:</span> <span class="n">v</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;design&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;desvars_&quot;</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="n">AoA</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;design&quot;</span><span class="p">][</span><span class="s2">&quot;AoA&quot;</span><span class="p">]</span>
    <span class="c1"># dynamically update trim desvars with input values</span>
    <span class="n">desvars</span><span class="p">[</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;HTP_RY_ID&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;design&quot;</span><span class="p">][</span><span class="s2">&quot;HTP_RY&quot;</span><span class="p">])</span>

    <span class="n">vsp</span><span class="o">.</span><span class="n">ClearVSPModel</span><span class="p">()</span>
    <span class="n">vsp</span><span class="o">.</span><span class="n">Update</span><span class="p">()</span>

    <span class="c1"># read vsp3 input file</span>
    <span class="n">vsp</span><span class="o">.</span><span class="n">ReadVSPFile</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">vsp_file</span><span class="p">))</span>
    <span class="n">vsp</span><span class="o">.</span><span class="n">Update</span><span class="p">()</span>

    <span class="c1"># load the default OpenVSP design variables</span>
    <span class="n">vsp</span><span class="o">.</span><span class="n">ReadApplyDESFile</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">des_file</span><span class="p">))</span>
    <span class="n">vsp</span><span class="o">.</span><span class="n">Update</span><span class="p">()</span>

    <span class="c1"># get / set specific parameters by id - optional</span>
    <span class="k">if</span> <span class="n">desvars</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">desvars</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># vsp.GetParmVal(k)</span>
            <span class="n">vsp</span><span class="o">.</span><span class="n">SetParmValUpdate</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>

    <span class="c1"># create _DegenGeom.csv file input for VLM</span>
    <span class="n">analysis_name</span> <span class="o">=</span> <span class="s2">&quot;VSPAEROComputeGeometry&quot;</span>
    <span class="n">vsp</span><span class="o">.</span><span class="n">SetAnalysisInputDefaults</span><span class="p">(</span><span class="n">analysis_name</span><span class="p">)</span>
    <span class="n">method</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">vsp</span><span class="o">.</span><span class="n">GetIntAnalysisInput</span><span class="p">(</span><span class="n">analysis_name</span><span class="p">,</span> <span class="s2">&quot;AnalysisMethod&quot;</span><span class="p">))</span>
    <span class="n">method</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">vsp</span><span class="o">.</span><span class="n">VORTEX_LATTICE</span>
    <span class="n">vsp</span><span class="o">.</span><span class="n">SetIntAnalysisInput</span><span class="p">(</span><span class="n">analysis_name</span><span class="p">,</span> <span class="s2">&quot;AnalysisMethod&quot;</span><span class="p">,</span> <span class="n">method</span><span class="p">)</span>
    <span class="c1"># vsp.PrintAnalysisInputs(analysis_name)</span>
    <span class="n">vsp</span><span class="o">.</span><span class="n">ExecAnalysis</span><span class="p">(</span><span class="n">analysis_name</span><span class="p">)</span>
    <span class="c1"># vsp.PrintResults(resp)</span>

    <span class="c1"># setup VSPAERO - preconfigure everything else in the vsp3 file</span>
    <span class="n">analysis_name</span> <span class="o">=</span> <span class="s2">&quot;VSPAEROSweep&quot;</span>
    <span class="n">vsp</span><span class="o">.</span><span class="n">SetAnalysisInputDefaults</span><span class="p">(</span><span class="n">analysis_name</span><span class="p">)</span>
    <span class="n">wid</span> <span class="o">=</span> <span class="n">vsp</span><span class="o">.</span><span class="n">FindGeomsWithName</span><span class="p">(</span><span class="s2">&quot;NormalWing&quot;</span><span class="p">)</span>
    <span class="n">vsp</span><span class="o">.</span><span class="n">SetStringAnalysisInput</span><span class="p">(</span><span class="n">analysis_name</span><span class="p">,</span> <span class="s2">&quot;WingID&quot;</span><span class="p">,</span> <span class="n">wid</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">vsp</span><span class="o">.</span><span class="n">SetDoubleAnalysisInput</span><span class="p">(</span><span class="n">analysis_name</span><span class="p">,</span> <span class="s2">&quot;AlphaStart&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">AoA</span><span class="p">),),</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">vsp</span><span class="o">.</span><span class="n">SetIntAnalysisInput</span><span class="p">(</span><span class="n">analysis_name</span><span class="p">,</span> <span class="s2">&quot;AlphaNpts&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,),</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">vsp</span><span class="o">.</span><span class="n">SetDoubleAnalysisInput</span><span class="p">(</span><span class="n">analysis_name</span><span class="p">,</span> <span class="s2">&quot;MachStart&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,),</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">vsp</span><span class="o">.</span><span class="n">SetIntAnalysisInput</span><span class="p">(</span><span class="n">analysis_name</span><span class="p">,</span> <span class="s2">&quot;MachNpts&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,),</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">vsp</span><span class="o">.</span><span class="n">Update</span><span class="p">()</span>
    <span class="c1"># # vsp.PrintAnalysisInputs(analysis_name)</span>
    <span class="n">vsp</span><span class="o">.</span><span class="n">ExecAnalysis</span><span class="p">(</span><span class="n">analysis_name</span><span class="p">)</span>
    <span class="c1"># vsp.PrintResults(resp)</span>

    <span class="c1"># process outputs</span>
    <span class="n">history_res</span> <span class="o">=</span> <span class="n">vsp</span><span class="o">.</span><span class="n">FindLatestResultsID</span><span class="p">(</span><span class="s2">&quot;VSPAERO_History&quot;</span><span class="p">)</span>
    <span class="c1"># load_res = vsp.FindLatestResultsID(&quot;VSPAERO_Load&quot;)</span>
    <span class="n">CL</span> <span class="o">=</span> <span class="n">vsp</span><span class="o">.</span><span class="n">GetDoubleResults</span><span class="p">(</span><span class="n">history_res</span><span class="p">,</span> <span class="s2">&quot;CL&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">CDtot</span> <span class="o">=</span> <span class="n">vsp</span><span class="o">.</span><span class="n">GetDoubleResults</span><span class="p">(</span><span class="n">history_res</span><span class="p">,</span> <span class="s2">&quot;CDtot&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">L2D</span> <span class="o">=</span> <span class="n">vsp</span><span class="o">.</span><span class="n">GetDoubleResults</span><span class="p">(</span><span class="n">history_res</span><span class="p">,</span> <span class="s2">&quot;L/D&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">E</span> <span class="o">=</span> <span class="n">vsp</span><span class="o">.</span><span class="n">GetDoubleResults</span><span class="p">(</span><span class="n">history_res</span><span class="p">,</span> <span class="s2">&quot;E&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="c1"># cl = vsp.GetDoubleResults( load_res, &quot;cl&quot;, 0 )</span>
    <span class="n">CMy</span> <span class="o">=</span> <span class="n">vsp</span><span class="o">.</span><span class="n">GetDoubleResults</span><span class="p">(</span><span class="n">history_res</span><span class="p">,</span> <span class="s2">&quot;CMy&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="k">while</span> <span class="n">errorMgr</span><span class="o">.</span><span class="n">GetNumTotalErrors</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">errorMgr</span><span class="o">.</span><span class="n">PopErrorAndPrint</span><span class="p">(</span><span class="n">stdout</span><span class="p">)</span>

    <span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;design&quot;</span><span class="p">][</span><span class="s2">&quot;CL&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">CL</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;design&quot;</span><span class="p">][</span><span class="s2">&quot;CMy&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">CMy</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;design&quot;</span><span class="p">][</span><span class="s2">&quot;CDtot&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">CDtot</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;design&quot;</span><span class="p">][</span><span class="s2">&quot;L2D&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">L2D</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;design&quot;</span><span class="p">][</span><span class="s2">&quot;E&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">E</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">-%H%M%S&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">: VSPAERO Compute completed on host </span><span class="si">{</span><span class="n">HOSTNAME</span><span class="si">}</span><span class="s2">.&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;with:</span><span class="se">\n</span><span class="s2">INPUTS: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span><span class="si">}</span><span class="s2">,</span><span class="se">\n</span><span class="s2">OUTPUTS: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">outputs</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="n">message</span><span class="p">,</span> <span class="s2">&quot;outputs&quot;</span><span class="p">:</span> <span class="n">outputs</span><span class="p">}</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="c1"># for local testing only</span>
    <span class="n">design_inputs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;AoA&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s2">&quot;HTP_RY&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s2">&quot;desvars_PONPNSVRANE&quot;</span><span class="p">:</span> <span class="mf">3.86</span><span class="p">}</span>
    <span class="n">outputs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;CL&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s2">&quot;CMy&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s2">&quot;CDtot&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s2">&quot;L2D&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s2">&quot;E&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">}</span>
    <span class="n">options</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">parameters</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;desvars&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;PONPNSVRANE&quot;</span><span class="p">:</span> <span class="mf">3.86</span><span class="p">},</span>
        <span class="s2">&quot;AoA&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="s2">&quot;HTP_RY&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="s2">&quot;HTP_RY_ID&quot;</span><span class="p">:</span> <span class="s2">&quot;ABCVDMNNBOE&quot;</span><span class="p">,</span>
        <span class="s2">&quot;vsp3_file&quot;</span><span class="p">:</span> <span class="s2">&quot;Cessna-210_metric.vsp3&quot;</span><span class="p">,</span>
        <span class="s2">&quot;des_file&quot;</span><span class="p">:</span> <span class="s2">&quot;.des&quot;</span><span class="p">,</span>
        <span class="s2">&quot;outputs_folder_path&quot;</span><span class="p">:</span> <span class="s2">&quot;../outputs&quot;</span><span class="p">,</span>
        <span class="s2">&quot;inputs_folder_path&quot;</span><span class="p">:</span> <span class="s2">&quot;../inputs&quot;</span><span class="p">,</span>
        <span class="s2">&quot;user_input_files&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;.des&quot;</span><span class="p">,</span> <span class="s2">&quot;Cessna-210_metric.vsp3&quot;</span><span class="p">],</span>
    <span class="p">}</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">main</span><span class="p">(</span>
        <span class="n">inputs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;design&quot;</span><span class="p">:</span> <span class="n">design_inputs</span><span class="p">},</span>
        <span class="n">outputs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;design&quot;</span><span class="p">:</span> <span class="n">outputs</span><span class="p">},</span>
        <span class="n">partials</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">,</span>
        <span class="n">parameters</span><span class="o">=</span><span class="n">parameters</span><span class="p">,</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
<input id="e66c3197-d6ec-4284-947e-2a3ea322960d" name="20262cea-0ff6-4057-bfec-e0a9b5524acc" type="radio">
</input><label class="sd-tab-label" for="e66c3197-d6ec-4284-947e-2a3ea322960d">
Cessna-210_metric.vsp3</label><div class="sd-tab-content docutils">
<p><a class="reference external" href="https://github.com/daptablade/docs/tree/master/mynewbook/Tutorials/openvsp-aircraft-aircraft-performance/vspaero/Cessna-210_metric.vsp3">Download Cessna-210_metric.vsp3 from Github</a></p>
</div>
<input id="ec4526df-5143-4848-a74b-e1f9bbbb86a2" name="20262cea-0ff6-4057-bfec-e0a9b5524acc" type="radio">
</input><label class="sd-tab-label" for="ec4526df-5143-4848-a74b-e1f9bbbb86a2">
Cessna-210_metric.des</label><div class="sd-tab-content docutils">
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>3
BMZJCENVRIX:Default:VSPAERO:NCPU: 1
ABCVDMNNBOE:Horz:XForm:Y_Rel_Rotation: -2.5
PONPNSVRANE:NormalWing:XSec_1:Aspect: 3.86435
</pre></div>
</div>
</div>
</div>
</section>
<section id="trim-component">
<h3><span class="section-number">8.2.2. </span>Trim component<a class="headerlink" href="#trim-component" title="Permalink to this headline">#</a></h3>
<p>This is a simple analytical implicit component that calculates the force and pitching moment residuals at the aircraft CG.
The inputs are the lift and pitching moment coefficients from the vspaero component and the flight velocity (Vinfinity).
Fixed parameters include the aircraft total mass, flight altitude and wing reference area (S).</p>
<p>Note that OpenMDAO implicit components don’t usually have a compute function.
By inspecting the OM_component.py file in the OpenMDAO component below, we can see that the trim component’s <code class="docutils literal notranslate"><span class="pre">compute</span></code> function is actually called from within the implicit component’s <code class="docutils literal notranslate"><span class="pre">apply_nonlinear</span></code> method.<br />
The <a class="reference external" href="https://openmdao.org/newdocs/versions/latest/advanced_user_guide/models_implicit_components/models_with_solvers_implicit.html">OpenMDAO Advanced user guide</a> explains the structure and purpose of implicit components in more detail.</p>
<p><strong>Parallel execution:</strong> This component is not parallelised as it executes quickly compared to the vspaero analysis.</p>
<p>Create the component:</p>
<ul class="simple">
<li><p>Right-click in the workspace and select <code class="docutils literal notranslate"><span class="pre">Add</span> <span class="pre">Empty</span> <span class="pre">Node</span></code>. Select the empty component to edit it.</p></li>
<li><p>In the <code class="docutils literal notranslate"><span class="pre">Properties</span></code> tab, fill in the component name, <code class="docutils literal notranslate"><span class="pre">trim</span></code>, and select the generic python component API <code class="docutils literal notranslate"><span class="pre">generic-python3-comp:latest</span></code>.</p></li>
<li><p>Copy the contents of the <code class="docutils literal notranslate"><span class="pre">setup.py</span></code>, <code class="docutils literal notranslate"><span class="pre">compute.py</span></code> and <code class="docutils literal notranslate"><span class="pre">requirements.txt</span></code> files from below into a text editor, save them locally.
Then upload them under the <code class="docutils literal notranslate"><span class="pre">Properties</span></code> tab.</p></li>
<li><p>Also in the <code class="docutils literal notranslate"><span class="pre">Properties</span></code> tab check the box next to the <code class="docutils literal notranslate"><span class="pre">End</span> <span class="pre">Node</span></code> option.</p></li>
<li><p>Insert the following JSON object into the <code class="docutils literal notranslate"><span class="pre">Parameters</span></code> tab text box (below the “user_input_files” entry):</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="s2">&quot;Mass&quot;</span><span class="p">:</span> <span class="mi">1111</span><span class="p">,</span>
    <span class="s2">&quot;Altitude&quot;</span><span class="p">:</span> <span class="mi">3000</span><span class="p">,</span>
    <span class="s2">&quot;S&quot;</span><span class="p">:</span> <span class="mf">16.234472</span>
<span class="p">}</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Copy the following JSON object into the <code class="docutils literal notranslate"><span class="pre">Inputs</span></code> tab text box:</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="s2">&quot;CL&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="s2">&quot;CMy&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="s2">&quot;Vinfinity&quot;</span><span class="p">:</span> <span class="mi">40</span>
<span class="p">}</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Copy the following JSON object into the <code class="docutils literal notranslate"><span class="pre">Outputs</span></code> tab text box:</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="s2">&quot;AoA&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="s2">&quot;HTP_RY&quot;</span><span class="p">:</span> <span class="mi">0</span>
<span class="p">}</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Select <code class="docutils literal notranslate"><span class="pre">Save</span> <span class="pre">data</span></code> to save and close the component.</p></li>
</ul>
<div class="sd-tab-set docutils">
<input checked="checked" id="967b9a18-f5fd-4deb-995c-7e90927bd59e" name="fe2fa62b-bf10-4f8b-b336-a6c888a52add" type="radio">
</input><label class="sd-tab-label" for="967b9a18-f5fd-4deb-995c-7e90927bd59e">
setup</label><div class="sd-tab-content docutils">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>


<span class="k">def</span> <span class="nf">setup</span><span class="p">(</span>
    <span class="n">inputs</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;design&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;implicit&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;setup&quot;</span><span class="p">:</span> <span class="p">{}},</span>
    <span class="n">outputs</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;design&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;implicit&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;setup&quot;</span><span class="p">:</span> <span class="p">{}},</span>
    <span class="n">parameters</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;user_input_files&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s2">&quot;inputs_folder_path&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;outputs_folder_path&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="p">},</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;A user editable setup function.&quot;&quot;&quot;</span>

    <span class="c1"># initalise setup_data keys</span>
    <span class="n">response</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">-%H%M%S&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">: Setup completed.&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
    <span class="n">response</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">message</span>

    <span class="k">return</span> <span class="n">response</span>
</pre></div>
</div>
</div>
<input id="1eae4c0a-8377-4ad4-b71e-290a735f5f96" name="fe2fa62b-bf10-4f8b-b336-a6c888a52add" type="radio">
</input><label class="sd-tab-label" for="1eae4c0a-8377-4ad4-b71e-290a735f5f96">
compute</label><div class="sd-tab-content docutils">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">fluids.atmosphere</span> <span class="kn">import</span> <span class="n">ATMOSPHERE_1976</span>


<span class="k">def</span> <span class="nf">compute</span><span class="p">(</span>
    <span class="n">inputs</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;design&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;implicit&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;setup&quot;</span><span class="p">:</span> <span class="p">{}},</span>
    <span class="n">outputs</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;design&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;implicit&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;setup&quot;</span><span class="p">:</span> <span class="p">{}},</span>
    <span class="n">partials</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{},</span>
    <span class="n">options</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{},</span>
    <span class="n">parameters</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;user_input_files&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s2">&quot;inputs_folder_path&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;outputs_folder_path&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="p">},</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;A user editable compute function.&quot;&quot;&quot;</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Starting residuals check.&quot;</span><span class="p">)</span>

    <span class="n">g</span> <span class="o">=</span> <span class="mf">9.81</span>  <span class="c1"># gravity acceleration in m/s**2</span>
    <span class="n">rho</span> <span class="o">=</span> <span class="n">ATMOSPHERE_1976</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;Altitude&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">rho</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;Mass&quot;</span><span class="p">]</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;S&quot;</span><span class="p">]</span>

    <span class="n">v</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;design&quot;</span><span class="p">][</span><span class="s2">&quot;Vinfinity&quot;</span><span class="p">]</span>

    <span class="n">CL_target</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">m</span> <span class="o">*</span> <span class="n">g</span> <span class="o">/</span> <span class="p">(</span><span class="n">rho</span> <span class="o">*</span> <span class="n">v</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">s</span><span class="p">)</span>

    <span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;design&quot;</span><span class="p">][</span><span class="s2">&quot;AoA&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;design&quot;</span><span class="p">][</span><span class="s2">&quot;CL&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">CL_target</span>
    <span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;design&quot;</span><span class="p">][</span><span class="s2">&quot;HTP_RY&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;design&quot;</span><span class="p">][</span><span class="s2">&quot;CMy&quot;</span><span class="p">]</span>

    <span class="n">message</span> <span class="o">=</span> <span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">-%H%M%S&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">: Trim residual compute completed.&quot;</span>
    <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;with:</span><span class="se">\n</span><span class="s2">INPUTS: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span><span class="si">}</span><span class="s2">,</span><span class="se">\n</span><span class="s2">OUTPUTS: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">outputs</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="n">message</span><span class="p">,</span> <span class="s2">&quot;outputs&quot;</span><span class="p">:</span> <span class="n">outputs</span><span class="p">}</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="c1"># for local testing only</span>
    <span class="n">design_inputs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;CL&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s2">&quot;CMy&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s2">&quot;Vinfinity&quot;</span><span class="p">:</span> <span class="mf">40.0</span><span class="p">}</span>
    <span class="n">outputs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;AoA&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s2">&quot;HTP_RY&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">}</span>
    <span class="n">options</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">parameters</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Mass&quot;</span><span class="p">:</span> <span class="mf">1111.0</span><span class="p">,</span> <span class="s2">&quot;Altitude&quot;</span><span class="p">:</span> <span class="mf">3000.0</span><span class="p">,</span> <span class="s2">&quot;Vinfinity&quot;</span><span class="p">:</span> <span class="mf">40.0</span><span class="p">,</span> <span class="s2">&quot;S&quot;</span><span class="p">:</span> <span class="mf">16.234472</span><span class="p">}</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">compute</span><span class="p">(</span>
        <span class="n">inputs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;design&quot;</span><span class="p">:</span> <span class="n">design_inputs</span><span class="p">},</span>
        <span class="n">outputs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;design&quot;</span><span class="p">:</span> <span class="n">outputs</span><span class="p">},</span>
        <span class="n">partials</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">,</span>
        <span class="n">parameters</span><span class="o">=</span><span class="n">parameters</span><span class="p">,</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
<input id="be38f4d2-7eaf-4ebb-99f2-d13f670fffd9" name="fe2fa62b-bf10-4f8b-b336-a6c888a52add" type="radio">
</input><label class="sd-tab-label" for="be38f4d2-7eaf-4ebb-99f2-d13f670fffd9">
requirements.txt</label><div class="sd-tab-content docutils">
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>fluids==1.0.22
</pre></div>
</div>
</div>
</div>
</section>
<section id="openmdao-driver-component">
<h3><span class="section-number">8.2.3. </span>OpenMDAO driver component<a class="headerlink" href="#openmdao-driver-component" title="Permalink to this headline">#</a></h3>
<p>The driver component is identical to the OpenMDAO component used in the <a class="reference internal" href="Simple%20optimisation%20problem.html"><span class="doc std std-doc">Simple optimisation problem</span></a> example, except for the driver parameters (defined on the <code class="docutils literal notranslate"><span class="pre">Parameters</span></code> tab), which have been adjusted for this problem:</p>
<ul class="simple">
<li><p>The driver type is set to “doe” instead of “optimisation” to request a sweep of the design space. In the <code class="docutils literal notranslate"><span class="pre">compute.py</span></code> module, this selects the use of the <a class="reference external" href="https://openmdao.org/newdocs/versions/latest/features/building_blocks/drivers/doe_driver.html">OpenMDAO “FullFactorialGenerator”</a> to define the design points to evaluate. The number of design points can be increased via the {“driver”:{“kwargs”:{“levels”:{“Vinfinity”: 2, “desvars_PONPNSVRANE”: 2}}}} parameter values (minimum of 2 points per design variable).</p></li>
<li><p>The design space is defined by the “input_variables” object, listing upper and lower values for the flight velocity range (Vinfinity) and for the wing aspect ratio range (desvars_PONPNSVRANE).</p></li>
<li><p>We define a OpenMDAO group object named “cycle”, which has both a nonlinear solver and linear solver attached.
By referencing this group by name in the vspaero and trim component entries (under “ExplicitComponents” and “ImplicitComponents”), these components are automatically included in the cycle group.</p></li>
<li><p>The trim variables (“AoA” and “HTP_RY”) feedback connection is implemented by promotion of the variables as inputs in the vspaero component and as outputs in the trim component.</p></li>
<li><p>The {“visualise”:”plot_history”} option here is used to call a custom plotting function imported from the <code class="docutils literal notranslate"><span class="pre">post.py</span></code> user file.</p></li>
</ul>
<p><strong>Parallel execution:</strong> We use the {“driver”:{“nb_threads”:4}} parameter to create 4 python execution threads, each launching a quarter of the design cases (using a modified OpenMDAO DOEDriver class, defined in the <code class="docutils literal notranslate"><span class="pre">compute.py</span></code> module). The number of doe threads should match the number of vspaero replicas set up earlier.</p>
<p>To create the driver component:</p>
<ul class="simple">
<li><p>Right-click in the workspace and select <code class="docutils literal notranslate"><span class="pre">Add</span> <span class="pre">Empty</span> <span class="pre">Node</span></code>. Select the empty component to edit it.</p></li>
<li><p>In the <code class="docutils literal notranslate"><span class="pre">Properties</span></code> tab, fill in the component name, <code class="docutils literal notranslate"><span class="pre">open-mdao</span></code>, and select the component API <code class="docutils literal notranslate"><span class="pre">generic-python3-driver:latest</span></code>.</p></li>
<li><p>Copy the contents of the <code class="docutils literal notranslate"><span class="pre">setup.py</span></code>, <code class="docutils literal notranslate"><span class="pre">compute.py</span></code>, <code class="docutils literal notranslate"><span class="pre">requirements.txt</span></code> files from below into a text editor, save them locally.
Then upload them under the <code class="docutils literal notranslate"><span class="pre">Properties</span></code> tab.</p></li>
<li><p>In the <code class="docutils literal notranslate"><span class="pre">Properties</span></code> tab check the box next to the <code class="docutils literal notranslate"><span class="pre">Driver</span></code> option.</p></li>
<li><p>Copy the contents of the parameters JSON object below into the <code class="docutils literal notranslate"><span class="pre">Parameters</span></code> tab text box.</p></li>
<li><p>Copy the contents of the <code class="docutils literal notranslate"><span class="pre">om_component.py</span></code> and <code class="docutils literal notranslate"><span class="pre">post.py</span></code> files from below into a text editor and save them locally.
Then upload them under the <code class="docutils literal notranslate"><span class="pre">Parameters</span></code> tab by selecting <code class="docutils literal notranslate"><span class="pre">upload</span> <span class="pre">user</span> <span class="pre">input</span> <span class="pre">files</span></code>.</p></li>
<li><p>Select <code class="docutils literal notranslate"><span class="pre">Save</span> <span class="pre">data</span></code> to save and close the component.</p></li>
</ul>
<div class="sd-tab-set docutils">
<input checked="checked" id="e188e01d-abc2-4bf8-a323-255aa69b329d" name="73cab7ea-a93d-4d1e-9d62-da4b60596841" type="radio">
</input><label class="sd-tab-label" for="e188e01d-abc2-4bf8-a323-255aa69b329d">
setup</label><div class="sd-tab-content docutils">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>


<span class="k">def</span> <span class="nf">setup</span><span class="p">(</span>
    <span class="n">inputs</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;design&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;implicit&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;setup&quot;</span><span class="p">:</span> <span class="p">{}},</span>
    <span class="n">outputs</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;design&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;implicit&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;setup&quot;</span><span class="p">:</span> <span class="p">{}},</span>
    <span class="n">parameters</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;user_input_files&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s2">&quot;inputs_folder_path&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;outputs_folder_path&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="p">},</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Editable setup function.&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="s2">&quot;driver&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">parameters</span><span class="p">:</span>
        <span class="c1"># assume we want to run an optimisation with default settings</span>
        <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;driver&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;optimisation&quot;</span><span class="p">}</span>

    <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">-%H%M%S&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">: Setup completed.&quot;</span>

    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="n">message</span><span class="p">,</span> <span class="s2">&quot;parameters&quot;</span><span class="p">:</span> <span class="n">parameters</span><span class="p">}</span>
</pre></div>
</div>
</div>
<input id="c778df24-2881-4c51-941a-9979dfd27fd0" name="73cab7ea-a93d-4d1e-9d62-da4b60596841" type="radio">
</input><label class="sd-tab-label" for="c778df24-2881-4c51-941a-9979dfd27fd0">
compute</label><div class="sd-tab-content docutils">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">from</span> <span class="nn">contextlib</span> <span class="kn">import</span> <span class="n">redirect_stdout</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>
<span class="kn">from</span> <span class="nn">concurrent.futures</span> <span class="kn">import</span> <span class="n">ThreadPoolExecutor</span>

<span class="kn">import</span> <span class="nn">openmdao.api</span> <span class="k">as</span> <span class="nn">om</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>  <span class="c1"># type: ignore</span>

<span class="kn">from</span> <span class="nn">om_component</span> <span class="kn">import</span> <span class="n">OMexplicitComp</span><span class="p">,</span> <span class="n">OMimplicitComp</span>  <span class="c1"># type: ignore</span>

<span class="n">OM_DEFAULTS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;nonlinear_solver&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;class&quot;</span><span class="p">:</span> <span class="n">om</span><span class="o">.</span><span class="n">NewtonSolver</span><span class="p">,</span>
        <span class="s2">&quot;kwargs&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;solve_subsystems&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">},</span>
    <span class="p">},</span>
    <span class="s2">&quot;linear_solver&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;class&quot;</span><span class="p">:</span> <span class="n">om</span><span class="o">.</span><span class="n">DirectSolver</span><span class="p">,</span>
        <span class="s2">&quot;kwargs&quot;</span><span class="p">:</span> <span class="p">{},</span>
    <span class="p">},</span>
<span class="p">}</span>


<span class="k">def</span> <span class="nf">compute</span><span class="p">(</span>
    <span class="n">inputs</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;design&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;implicit&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;setup&quot;</span><span class="p">:</span> <span class="p">{}},</span>
    <span class="n">outputs</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;design&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;implicit&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;setup&quot;</span><span class="p">:</span> <span class="p">{}},</span>
    <span class="n">partials</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{},</span>
    <span class="n">options</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{},</span>
    <span class="n">parameters</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;user_input_files&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s2">&quot;inputs_folder_path&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;outputs_folder_path&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="p">},</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>

    <span class="sd">&quot;&quot;&quot;Editable compute function.&quot;&quot;&quot;</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;OpenMDAO problem setup started.&quot;</span><span class="p">)</span>

    <span class="n">workflow</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;workflow&quot;</span><span class="p">]</span>
    <span class="n">run_folder</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;outputs_folder_path&quot;</span><span class="p">])</span>
    <span class="n">all_connections</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;all_connections&quot;</span><span class="p">,</span> <span class="p">[])</span>

    <span class="c1"># 1) define the simulation components</span>
    <span class="n">prob</span> <span class="o">=</span> <span class="n">om</span><span class="o">.</span><span class="n">Problem</span><span class="p">()</span>

    <span class="c1"># add groups</span>
    <span class="n">groups</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="s2">&quot;Groups&quot;</span> <span class="ow">in</span> <span class="n">parameters</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;Groups&quot;</span><span class="p">]:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">reformat_compname</span><span class="p">(</span><span class="n">group</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">])</span>
            <span class="n">kwargs</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;kwargs&quot;</span><span class="p">,</span> <span class="p">{})</span>
            <span class="n">groups</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">prob</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add_subsystem</span><span class="p">(</span>
                <span class="n">name</span><span class="p">,</span>
                <span class="n">om</span><span class="o">.</span><span class="n">Group</span><span class="p">(),</span>
                <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="s2">&quot;solvers&quot;</span> <span class="ow">in</span> <span class="n">group</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">solver</span> <span class="ow">in</span> <span class="n">group</span><span class="p">[</span><span class="s2">&quot;solvers&quot;</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">solver</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;nonlinear_solver&quot;</span><span class="p">:</span>
                        <span class="n">groups</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">nonlinear_solver</span> <span class="o">=</span> <span class="n">OM_DEFAULTS</span><span class="p">[</span><span class="s2">&quot;nonlinear_solver&quot;</span><span class="p">][</span>
                            <span class="s2">&quot;class&quot;</span>
                        <span class="p">](</span><span class="o">**</span><span class="n">OM_DEFAULTS</span><span class="p">[</span><span class="s2">&quot;nonlinear_solver&quot;</span><span class="p">][</span><span class="s2">&quot;kwargs&quot;</span><span class="p">])</span>
                        <span class="n">solver_obj</span> <span class="o">=</span> <span class="n">groups</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">nonlinear_solver</span>
                    <span class="k">elif</span> <span class="n">solver</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;linear_solver&quot;</span><span class="p">:</span>
                        <span class="n">groups</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">linear_solver</span> <span class="o">=</span> <span class="n">OM_DEFAULTS</span><span class="p">[</span><span class="s2">&quot;linear_solver&quot;</span><span class="p">][</span>
                            <span class="s2">&quot;class&quot;</span>
                        <span class="p">](</span><span class="o">**</span><span class="n">OM_DEFAULTS</span><span class="p">[</span><span class="s2">&quot;linear_solver&quot;</span><span class="p">][</span><span class="s2">&quot;kwargs&quot;</span><span class="p">])</span>
                        <span class="n">solver_obj</span> <span class="o">=</span> <span class="n">groups</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">nonlinear_solver</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Solver of type </span><span class="si">{</span><span class="n">solver</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> is not implemented.&quot;</span>
                        <span class="p">)</span>
                    <span class="k">if</span> <span class="s2">&quot;options&quot;</span> <span class="ow">in</span> <span class="n">solver</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">option</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">solver</span><span class="p">[</span><span class="s2">&quot;options&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                            <span class="k">if</span> <span class="n">option</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;iprint&quot;</span><span class="p">,</span> <span class="s2">&quot;maxiter&quot;</span><span class="p">]:</span>
                                <span class="n">solver_obj</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="n">option</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">solver_obj</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="n">option</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>

    <span class="c1"># add components</span>
    <span class="k">def</span> <span class="nf">get_comp_by_name</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">objs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>

        <span class="n">comp_type_lookup</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;ExplicitComponents&quot;</span><span class="p">:</span> <span class="n">OMexplicitComp</span><span class="p">,</span>
            <span class="s2">&quot;ImplicitComponents&quot;</span><span class="p">:</span> <span class="n">OMimplicitComp</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">objs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">filtered</span> <span class="o">=</span> <span class="p">[</span><span class="n">comp_obj</span> <span class="k">for</span> <span class="n">comp_obj</span> <span class="ow">in</span> <span class="n">obj</span> <span class="k">if</span> <span class="n">comp_obj</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">name</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">filtered</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">[</span><span class="n">comp_type_lookup</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">filtered</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="k">return</span> <span class="n">OMexplicitComp</span><span class="p">,</span> <span class="kc">None</span>  <span class="c1"># default</span>

    <span class="n">model_lookup</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">component</span> <span class="ow">in</span> <span class="n">workflow</span><span class="p">:</span>
        <span class="c1"># defaults</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">fd_step</span> <span class="o">=</span> <span class="mf">0.1</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">prob</span><span class="o">.</span><span class="n">model</span>
        <span class="n">has_compute_partials</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># set this to False if fd gradients should be used</span>

        <span class="n">objs</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">k</span><span class="p">:</span> <span class="n">parameters</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;ExplicitComponents&quot;</span><span class="p">,</span> <span class="s2">&quot;ImplicitComponents&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">parameters</span>
        <span class="p">}</span>
        <span class="n">comp_type</span><span class="p">,</span> <span class="n">comp_obj</span> <span class="o">=</span> <span class="n">get_comp_by_name</span><span class="p">(</span><span class="n">component</span><span class="p">,</span> <span class="n">objs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">comp_obj</span><span class="p">:</span>
            <span class="n">kwargs</span> <span class="o">=</span> <span class="n">comp_obj</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;kwargs&quot;</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>
            <span class="n">fd_step</span> <span class="o">=</span> <span class="n">comp_obj</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fd_step&quot;</span><span class="p">,</span> <span class="n">fd_step</span><span class="p">)</span>
            <span class="n">has_compute_partials</span> <span class="o">=</span> <span class="n">comp_obj</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s2">&quot;has_compute_partials&quot;</span><span class="p">,</span> <span class="n">has_compute_partials</span>
            <span class="p">)</span>
            <span class="n">model</span> <span class="o">=</span> <span class="n">groups</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">comp_obj</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;group&quot;</span><span class="p">),</span> <span class="n">model</span><span class="p">)</span>

        <span class="n">model_lookup</span><span class="p">[</span><span class="n">component</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span>
        <span class="n">model</span><span class="o">.</span><span class="n">add_subsystem</span><span class="p">(</span>
            <span class="n">reformat_compname</span><span class="p">(</span><span class="n">component</span><span class="p">),</span>
            <span class="n">comp_type</span><span class="p">(</span>
                <span class="n">compname</span><span class="o">=</span><span class="n">component</span><span class="p">,</span>
                <span class="n">fd_step</span><span class="o">=</span><span class="n">fd_step</span><span class="p">,</span>
                <span class="n">has_compute_partials</span><span class="o">=</span><span class="n">has_compute_partials</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="s2">&quot;ExecComps&quot;</span> <span class="ow">in</span> <span class="n">parameters</span> <span class="ow">and</span> <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;ExecComps&quot;</span><span class="p">]:</span>
        <span class="k">for</span> <span class="n">component</span> <span class="ow">in</span> <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;ExecComps&quot;</span><span class="p">]:</span>
            <span class="n">prob</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add_subsystem</span><span class="p">(</span>
                <span class="n">reformat_compname</span><span class="p">(</span><span class="n">component</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]),</span>
                <span class="n">om</span><span class="o">.</span><span class="n">ExecComp</span><span class="p">(</span><span class="n">component</span><span class="p">[</span><span class="s2">&quot;exprs&quot;</span><span class="p">]),</span>
                <span class="o">**</span><span class="n">component</span><span class="p">[</span><span class="s2">&quot;kwargs&quot;</span><span class="p">],</span>
            <span class="p">)</span>

    <span class="c1"># 2) define the component connections</span>
    <span class="k">def</span> <span class="nf">get_var_str</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">reformat_compname</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span><span class="s1">&#39;-&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">for</span> <span class="n">connection</span> <span class="ow">in</span> <span class="n">all_connections</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">connection</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;design&quot;</span><span class="p">:</span>
            <span class="n">prob</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
                <span class="n">get_var_str</span><span class="p">(</span><span class="n">connection</span><span class="p">[</span><span class="s2">&quot;origin&quot;</span><span class="p">],</span> <span class="n">connection</span><span class="p">[</span><span class="s2">&quot;name_origin&quot;</span><span class="p">]),</span>
                <span class="n">get_var_str</span><span class="p">(</span><span class="n">connection</span><span class="p">[</span><span class="s2">&quot;target&quot;</span><span class="p">],</span> <span class="n">connection</span><span class="p">[</span><span class="s2">&quot;name_target&quot;</span><span class="p">]),</span>
            <span class="p">)</span>

    <span class="k">if</span> <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;driver&quot;</span><span class="p">][</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;optimisation&quot;</span><span class="p">:</span>
        <span class="c1"># 3) setup the optimisation driver options</span>
        <span class="n">prob</span><span class="o">.</span><span class="n">driver</span> <span class="o">=</span> <span class="n">om</span><span class="o">.</span><span class="n">ScipyOptimizeDriver</span><span class="p">()</span>
        <span class="n">prob</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;optimizer&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;optimizer&quot;</span><span class="p">]</span>
        <span class="n">prob</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;maxiter&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;max_iter&quot;</span><span class="p">]</span>
        <span class="n">prob</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;tol&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;tol&quot;</span><span class="p">]</span>
        <span class="n">prob</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">opt_settings</span><span class="p">[</span><span class="s2">&quot;disp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;disp&quot;</span><span class="p">]</span>
        <span class="n">prob</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;debug_print&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;debug_print&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="s2">&quot;approx_totals&quot;</span> <span class="ow">in</span> <span class="n">parameters</span> <span class="ow">and</span> <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;approx_totals&quot;</span><span class="p">]:</span>
            <span class="c1"># ensure FD gradients are used</span>
            <span class="n">prob</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">approx_totals</span><span class="p">(</span>
                <span class="n">method</span><span class="o">=</span><span class="s2">&quot;fd&quot;</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;fd_step&quot;</span><span class="p">],</span> <span class="n">form</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">step_calc</span><span class="o">=</span><span class="kc">None</span>
            <span class="p">)</span>

    <span class="k">elif</span> <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;driver&quot;</span><span class="p">][</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;doe&quot;</span><span class="p">:</span>
        <span class="c1"># 3) alternative: setup a design of experiments</span>

        <span class="n">levels</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;driver&quot;</span><span class="p">][</span><span class="s2">&quot;kwargs&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;levels&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">levels</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>  <span class="c1"># All have the same number of levels</span>
            <span class="n">levels</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">levels</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">levels</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>  <span class="c1"># Different DVs have different number of levels</span>
            <span class="n">levels</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">levels</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

        <span class="n">prob</span><span class="o">.</span><span class="n">driver</span> <span class="o">=</span> <span class="n">DOEDriver</span><span class="p">(</span>
            <span class="n">om</span><span class="o">.</span><span class="n">FullFactorialGenerator</span><span class="p">(</span><span class="n">levels</span><span class="o">=</span><span class="n">levels</span><span class="p">),</span>
            <span class="n">reset_vars</span><span class="o">=</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;driver&quot;</span><span class="p">][</span><span class="s2">&quot;kwargs&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;reset_vars&quot;</span><span class="p">,</span> <span class="p">{}),</span>
            <span class="n">store_case_data</span><span class="o">=</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;driver&quot;</span><span class="p">][</span><span class="s2">&quot;kwargs&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;store_case_data&quot;</span><span class="p">,</span> <span class="p">{}),</span>
            <span class="n">store_parameters</span><span class="o">=</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;driver&quot;</span><span class="p">][</span><span class="s2">&quot;kwargs&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;store_parameters&quot;</span><span class="p">,</span> <span class="p">{}),</span>
            <span class="n">run_folder</span><span class="o">=</span><span class="n">run_folder</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="c1"># 4) add design variables</span>
    <span class="k">if</span> <span class="s2">&quot;input_variables&quot;</span> <span class="ow">in</span> <span class="n">parameters</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;input_variables&quot;</span><span class="p">]:</span>
            <span class="n">upper</span> <span class="o">=</span> <span class="n">var</span><span class="p">[</span><span class="s2">&quot;upper&quot;</span><span class="p">]</span>
            <span class="n">lower</span> <span class="o">=</span> <span class="n">var</span><span class="p">[</span><span class="s2">&quot;lower&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s2">&quot;component&quot;</span> <span class="ow">in</span> <span class="n">var</span><span class="p">:</span>
                <span class="n">comp_obj</span> <span class="o">=</span> <span class="n">reformat_compname</span><span class="p">(</span><span class="n">var</span><span class="p">[</span><span class="s2">&quot;component&quot;</span><span class="p">])</span>
                <span class="n">prob</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add_design_var</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">comp_obj</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">var</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">lower</span><span class="o">=</span><span class="n">lower</span><span class="p">,</span>
                    <span class="n">upper</span><span class="o">=</span><span class="n">upper</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">prob</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add_design_var</span><span class="p">(</span>
                    <span class="n">var</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">),</span> <span class="n">lower</span><span class="o">=</span><span class="n">lower</span><span class="p">,</span> <span class="n">upper</span><span class="o">=</span><span class="n">upper</span>
                <span class="p">)</span>
                <span class="n">val_default</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;value&quot;</span><span class="p">,</span> <span class="n">lower</span><span class="p">)</span>
                <span class="n">prob</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">set_input_defaults</span><span class="p">(</span>
                    <span class="n">var</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">),</span> <span class="n">val_default</span>
                <span class="p">)</span>

    <span class="c1"># 5) add an objective and constraints</span>
    <span class="k">if</span> <span class="s2">&quot;output_variables&quot;</span> <span class="ow">in</span> <span class="n">parameters</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;output_variables&quot;</span><span class="p">]:</span>
            <span class="n">comp_obj</span> <span class="o">=</span> <span class="n">reformat_compname</span><span class="p">(</span><span class="n">var</span><span class="p">[</span><span class="s2">&quot;component&quot;</span><span class="p">])</span>
            <span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">comp_obj</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">var</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>

            <span class="c1"># set scaling from parameter input file</span>
            <span class="n">scaler</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;scaler&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">adder</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;adder&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">var</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;objective&quot;</span><span class="p">:</span>
                <span class="n">prob</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add_objective</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">scaler</span><span class="o">=</span><span class="n">scaler</span><span class="p">,</span> <span class="n">adder</span><span class="o">=</span><span class="n">adder</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">var</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;constraint&quot;</span><span class="p">:</span>
                <span class="n">lower</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;lower&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">upper</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;upper&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">prob</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add_constraint</span><span class="p">(</span>
                    <span class="n">name</span><span class="p">,</span> <span class="n">lower</span><span class="o">=</span><span class="n">lower</span><span class="p">,</span> <span class="n">upper</span><span class="o">=</span><span class="n">upper</span><span class="p">,</span> <span class="n">scaler</span><span class="o">=</span><span class="n">scaler</span><span class="p">,</span> <span class="n">adder</span><span class="o">=</span><span class="n">adder</span>
                <span class="p">)</span>

    <span class="n">prob</span><span class="o">.</span><span class="n">setup</span><span class="p">()</span>  <span class="c1"># required to generate the n2 diagram</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;OpenMDAO problem setup completed.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="s2">&quot;visualise&quot;</span> <span class="ow">in</span> <span class="n">parameters</span> <span class="ow">and</span> <span class="s2">&quot;n2_diagram&quot;</span> <span class="ow">in</span> <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;visualise&quot;</span><span class="p">]:</span>
        <span class="c1"># save n2 diagram in html format</span>
        <span class="n">om</span><span class="o">.</span><span class="n">n2</span><span class="p">(</span>
            <span class="n">prob</span><span class="p">,</span>
            <span class="n">outfile</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">run_folder</span> <span class="o">/</span> <span class="s2">&quot;n2.html&quot;</span><span class="p">),</span>
            <span class="n">show_browser</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;driver&quot;</span><span class="p">][</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;optimisation&quot;</span><span class="p">:</span>
        <span class="n">dict_out</span> <span class="o">=</span> <span class="n">run_optimisation</span><span class="p">(</span><span class="n">prob</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">run_folder</span><span class="p">)</span>

    <span class="c1"># elif parameters[&quot;driver&quot;][&quot;type&quot;] == &quot;check_partials&quot;:</span>
    <span class="c1">#     dict_out = run_check_partials(prob, parameters)</span>

    <span class="c1"># elif parameters[&quot;driver&quot;][&quot;type&quot;] == &quot;check_totals&quot;:</span>
    <span class="c1">#     dict_out = run_check_totals(prob, parameters)</span>

    <span class="k">elif</span> <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;driver&quot;</span><span class="p">][</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;doe&quot;</span><span class="p">:</span>
        <span class="n">nb_threads</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;driver&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;nb_threads&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">dict_out</span> <span class="o">=</span> <span class="n">run_doe</span><span class="p">(</span><span class="n">prob</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">run_folder</span><span class="p">,</span> <span class="n">nb_threads</span><span class="o">=</span><span class="n">nb_threads</span><span class="p">)</span>

    <span class="c1"># elif parameters[&quot;driver&quot;][&quot;type&quot;] == &quot;post&quot;:</span>
    <span class="c1">#     dict_out = run_post(prob, parameters)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">run_folder</span> <span class="o">/</span> <span class="s2">&quot;trim_convergence.log&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">redirect_stdout</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
                <span class="n">prob</span><span class="o">.</span><span class="n">run_model</span><span class="p">()</span>
                <span class="n">dict_out</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">-%H%M%S&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">: OpenMDAO compute completed.&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">dict_out</span><span class="p">:</span>
        <span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;design&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dict_out</span>

    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="n">message</span><span class="p">,</span> <span class="s2">&quot;outputs&quot;</span><span class="p">:</span> <span class="n">outputs</span><span class="p">}</span>


<span class="k">def</span> <span class="nf">run_optimisation</span><span class="p">(</span><span class="n">prob</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">run_folder</span><span class="p">):</span>

    <span class="c1"># 6) add a data recorder to the optimisation problem</span>
    <span class="n">r_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span>
        <span class="n">run_folder</span>
        <span class="o">/</span> <span class="p">(</span>
            <span class="s2">&quot;om_problem_recorder_&quot;</span>
            <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">-%H%M%S&quot;</span><span class="p">)</span>
            <span class="o">+</span> <span class="s2">&quot;.sqlite&quot;</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">om</span><span class="o">.</span><span class="n">SqliteRecorder</span><span class="p">(</span><span class="n">r_name</span><span class="p">)</span>
    <span class="n">prob</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">add_recorder</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
    <span class="n">prob</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">recording_options</span><span class="p">[</span><span class="s2">&quot;record_derivatives&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1"># setup the problem again</span>
    <span class="n">prob</span><span class="o">.</span><span class="n">setup</span><span class="p">()</span>

    <span class="k">if</span> <span class="s2">&quot;visualise&quot;</span> <span class="ow">in</span> <span class="n">parameters</span> <span class="ow">and</span> <span class="s2">&quot;scaling_report&quot;</span> <span class="ow">in</span> <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;visualise&quot;</span><span class="p">]:</span>
        <span class="c1"># NOTE: running the model can generate large large amounts of stored data in orchestrator, which</span>
        <span class="c1"># can cause prob.setup() to fail if it is called again, so only execute</span>
        <span class="c1"># prob.run_model() after all setup has been completed</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">run_folder</span> <span class="o">/</span> <span class="s2">&quot;scaling_report.log&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">redirect_stdout</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
                <span class="n">prob</span><span class="o">.</span><span class="n">run_model</span><span class="p">()</span>
                <span class="n">prob</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">scaling_report</span><span class="p">(</span>
                    <span class="n">outfile</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">run_folder</span> <span class="o">/</span> <span class="s2">&quot;driver_scaling_report.html&quot;</span><span class="p">),</span>
                    <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">show_browser</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">jac</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="p">)</span>

    <span class="c1"># 7) execute the optimisation</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">run_folder</span> <span class="o">/</span> <span class="s2">&quot;run_driver.log&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">redirect_stdout</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
                <span class="n">prob</span><span class="o">.</span><span class="n">run_driver</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;run driver exited with error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">tb</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;OpenMDAO Optimisation error: &quot;</span> <span class="o">+</span> <span class="n">tb</span><span class="p">)</span>

    <span class="n">opt_output</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="c1"># print(&quot;Completed model optimisation - solution is: \n inputs= (&quot;)</span>
    <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;input_variables&quot;</span><span class="p">]:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">var</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
        <span class="c1"># print(</span>
        <span class="c1">#     f&quot;{comp}.{name}: &quot;</span>
        <span class="c1">#     + str(prob.get_val(f&quot;{comp}.{name.replace(&#39;.&#39;, &#39;-&#39;)}&quot;))</span>
        <span class="c1">#     + &quot; &quot;</span>
        <span class="c1"># )</span>
        <span class="k">if</span> <span class="s2">&quot;component&quot;</span> <span class="ow">in</span> <span class="n">var</span><span class="p">:</span>
            <span class="n">comp</span> <span class="o">=</span> <span class="n">var</span><span class="p">[</span><span class="s2">&quot;component&quot;</span><span class="p">]</span>
            <span class="n">opt_output</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">comp</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prob</span><span class="o">.</span><span class="n">get_val</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">reformat_compname</span><span class="p">(</span><span class="n">comp</span><span class="p">)</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">opt_output</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">prob</span><span class="o">.</span><span class="n">get_val</span><span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="c1"># print(&quot;), \n outputs = (&quot;)</span>
    <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;output_variables&quot;</span><span class="p">]:</span>
        <span class="n">comp</span> <span class="o">=</span> <span class="n">var</span><span class="p">[</span><span class="s2">&quot;component&quot;</span><span class="p">]</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">var</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
        <span class="c1"># print(</span>
        <span class="c1">#     f&quot;{comp}.{name}: &quot;</span>
        <span class="c1">#     + str(prob.get_val(f&quot;{comp}.{name.replace(&#39;.&#39;, &#39;-&#39;)}&quot;))</span>
        <span class="c1">#     + &quot; &quot;</span>
        <span class="c1"># )</span>
        <span class="n">opt_output</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">comp</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prob</span><span class="o">.</span><span class="n">get_val</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">reformat_compname</span><span class="p">(</span><span class="n">comp</span><span class="p">)</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="c1"># print(&quot;)&quot;)</span>

    <span class="nb">print</span><span class="p">(</span><span class="n">opt_output</span><span class="p">)</span>

    <span class="k">if</span> <span class="s2">&quot;visualise&quot;</span> <span class="ow">in</span> <span class="n">parameters</span> <span class="ow">and</span> <span class="s2">&quot;plot_history&quot;</span> <span class="ow">in</span> <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;visualise&quot;</span><span class="p">]:</span>
        <span class="n">post_process_optimisation</span><span class="p">(</span><span class="n">parameters</span><span class="p">,</span> <span class="n">run_folder</span><span class="p">,</span> <span class="n">r_name</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">opt_output</span>


<span class="k">def</span> <span class="nf">run_doe</span><span class="p">(</span><span class="n">prob</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">run_folder</span><span class="p">,</span> <span class="n">nb_threads</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>

    <span class="c1"># 7) execute the driver in parallel</span>
    <span class="k">def</span> <span class="nf">run_cases_thread</span><span class="p">(</span><span class="n">color</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Starting thread </span><span class="si">{</span><span class="n">color</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="n">prob_copy</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">prob</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;problem id for color </span><span class="si">{</span><span class="n">color</span><span class="si">}</span><span class="s2">: &quot;</span><span class="p">,</span> <span class="nb">id</span><span class="p">(</span><span class="n">prob_copy</span><span class="p">))</span>

        <span class="c1"># set driver instance properties</span>
        <span class="n">prob_copy</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">nb_threads</span> <span class="o">=</span> <span class="n">nb_threads</span>
        <span class="n">prob_copy</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">color</span> <span class="o">=</span> <span class="n">color</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">prob_copy</span><span class="o">.</span><span class="n">run_driver</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;run driver exited with error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">tb</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;OpenMDAO DOE error: </span><span class="si">{</span><span class="n">tb</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Completed thread </span><span class="si">{</span><span class="n">color</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">run_folder</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;run_driver.log&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">redirect_stdout</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
            <span class="k">with</span> <span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="n">nb_threads</span><span class="p">)</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
                <span class="n">msgs</span> <span class="o">=</span> <span class="n">executor</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">run_cases_thread</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="n">nb_threads</span><span class="p">))</span>
                <span class="n">errors</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">msgs</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">errors</span> <span class="ow">and</span> <span class="n">errors</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">errors</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;completed all threads&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="s2">&quot;visualise&quot;</span> <span class="ow">in</span> <span class="n">parameters</span> <span class="ow">and</span> <span class="s2">&quot;plot_history&quot;</span> <span class="ow">in</span> <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;visualise&quot;</span><span class="p">]:</span>
        <span class="kn">from</span> <span class="nn">post</span> <span class="kn">import</span> <span class="n">post_process_doe</span>

        <span class="n">post_process_doe</span><span class="p">(</span>
            <span class="n">parameters</span><span class="p">,</span>
            <span class="n">run_folder</span><span class="p">,</span>
            <span class="n">files</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;results_</span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s2">.json&quot;</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nb_threads</span><span class="p">)],</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="p">{}</span>


<span class="k">def</span> <span class="nf">reformat_compname</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="c1"># openmdao doesn&#39;t allow &quot;-&quot; character in component names</span>
    <span class="k">return</span> <span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">post_process_optimisation</span><span class="p">(</span>
    <span class="n">parameters</span><span class="p">,</span> <span class="n">run_folder</span><span class="p">,</span> <span class="n">r_name</span><span class="p">,</span> <span class="n">only_plot_major_iter</span><span class="o">=</span><span class="kc">True</span>
<span class="p">):</span>
    <span class="c1"># read database</span>
    <span class="c1"># Instantiate your CaseReader</span>
    <span class="n">cr</span> <span class="o">=</span> <span class="n">om</span><span class="o">.</span><span class="n">CaseReader</span><span class="p">(</span><span class="n">r_name</span><span class="p">)</span>
    <span class="c1"># Isolate &quot;problem&quot; as your source</span>
    <span class="n">driver_cases</span> <span class="o">=</span> <span class="n">cr</span><span class="o">.</span><span class="n">list_cases</span><span class="p">(</span><span class="s2">&quot;driver&quot;</span><span class="p">,</span> <span class="n">out_stream</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

    <span class="c1"># plot the iteration history from the recorder data</span>
    <span class="n">inputs_history</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">key</span><span class="p">:</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">reformat_compname</span><span class="p">(</span><span class="n">var</span><span class="p">[</span><span class="s1">&#39;component&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">var</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;input_variables&quot;</span><span class="p">]</span>
        <span class="p">]</span>
    <span class="p">}</span>
    <span class="n">outputs_history</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">key</span><span class="p">:</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">reformat_compname</span><span class="p">(</span><span class="n">var</span><span class="p">[</span><span class="s1">&#39;component&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">var</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;output_variables&quot;</span><span class="p">]</span>
        <span class="p">]</span>
    <span class="p">}</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">driver_cases</span><span class="p">:</span>
        <span class="n">case</span> <span class="o">=</span> <span class="n">cr</span><span class="o">.</span><span class="n">get_case</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">only_plot_major_iter</span> <span class="ow">and</span> <span class="n">case</span><span class="o">.</span><span class="n">derivatives</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">only_plot_major_iter</span><span class="p">:</span>
            <span class="c1"># get history of inputs</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">inputs_history</span><span class="p">:</span>
                <span class="n">inputs_history</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">case</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
            <span class="c1"># get history of outputs</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">outputs_history</span><span class="p">:</span>
                <span class="n">outputs_history</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">case</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>

    <span class="c1"># plot output in userfriendly fashion</span>
    <span class="n">_plot_iteration_histories</span><span class="p">(</span>
        <span class="n">inputs_history</span><span class="o">=</span><span class="n">inputs_history</span><span class="p">,</span>
        <span class="n">outputs_history</span><span class="o">=</span><span class="n">outputs_history</span><span class="p">,</span>
        <span class="n">run_folder</span><span class="o">=</span><span class="n">run_folder</span><span class="p">,</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">_plot_iteration_histories</span><span class="p">(</span>
    <span class="n">inputs_history</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">outputs_history</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">run_folder</span><span class="o">=</span><span class="kc">None</span>
<span class="p">):</span>
    <span class="c1"># plot input histories</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">inputs_history</span><span class="p">:</span>
        <span class="n">input_data</span> <span class="o">=</span> <span class="n">inputs_history</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="n">input_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">input_data</span><span class="p">)</span>
        <span class="n">iterations</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">input_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">data_series</span> <span class="ow">in</span> <span class="n">input_data</span><span class="o">.</span><span class="n">T</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">iterations</span><span class="p">,</span> <span class="n">data_series</span><span class="p">,</span> <span class="s2">&quot;-o&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">run_folder</span> <span class="o">/</span> <span class="p">(</span><span class="n">key</span> <span class="o">+</span> <span class="s2">&quot;.png&quot;</span><span class="p">)))</span>

    <span class="c1"># plot output histories</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">outputs_history</span><span class="p">:</span>
        <span class="n">output_data</span> <span class="o">=</span> <span class="n">outputs_history</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="n">output_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">output_data</span><span class="p">)</span>
        <span class="n">iterations</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">output_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">data_series</span> <span class="ow">in</span> <span class="n">output_data</span><span class="o">.</span><span class="n">T</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">iterations</span><span class="p">,</span> <span class="n">data_series</span><span class="p">,</span> <span class="s2">&quot;-o&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">run_folder</span> <span class="o">/</span> <span class="p">(</span><span class="n">key</span> <span class="o">+</span> <span class="s2">&quot;.png&quot;</span><span class="p">)))</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">DOEDriver</span><span class="p">(</span><span class="n">om</span><span class="o">.</span><span class="n">DOEDriver</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">generator</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">reset_vars</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">store_case_data</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">store_parameters</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">run_folder</span><span class="p">:</span> <span class="n">Path</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset_vars</span> <span class="o">=</span> <span class="n">reset_vars</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cases_store</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">store_case_data</span> <span class="o">=</span> <span class="n">store_case_data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">store_parameters</span> <span class="o">=</span> <span class="n">store_parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run_folder</span> <span class="o">=</span> <span class="n">run_folder</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nb_threads</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">color</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">generator</span><span class="o">=</span><span class="n">generator</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate cases and run the model for each set of generated input values.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bool</span>
<span class="sd">            Failure flag; True if failed to converge, False is successful.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iter_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_quantities</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># set driver name with current generator</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_name</span><span class="p">()</span>

        <span class="c1"># Add all design variables</span>
        <span class="n">dv_meta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_designvars</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_indep_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">dv_meta</span><span class="p">)</span>

        <span class="c1"># Add all objectives</span>
        <span class="n">objs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_objective_values</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">objs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_quantities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

        <span class="c1"># Add all constraints</span>
        <span class="n">con_meta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cons</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">con_meta</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_quantities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">case</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parallel_generator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_designvars</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_problem</span><span class="p">()</span><span class="o">.</span><span class="n">model</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Starting case on thread </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">color</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_custom_reset_variables</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_run_case</span><span class="p">(</span><span class="n">case</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">iter_count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_custom_store_to_json</span><span class="p">()</span>

        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">_custom_reset_variables</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># reset the initial variable guesses</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">reset_vars</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_problem</span><span class="p">()[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>

    <span class="k">def</span> <span class="nf">_custom_store_to_json</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># store the outputs to the json database</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cases_store</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">store_parameters</span><span class="p">,</span>
                <span class="o">**</span><span class="p">{</span>
                    <span class="n">k</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_problem</span><span class="p">()[</span><span class="n">k</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">store_case_data</span>
                <span class="p">},</span>
            <span class="p">}</span>
        <span class="p">)</span>
        <span class="c1"># dump to json file</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;results_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">color</span><span class="si">}</span><span class="s2">.json&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">run_folder</span> <span class="o">/</span> <span class="n">fname</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cases_store</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_parallel_generator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">design_vars</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate case for this thread.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        design_vars : dict</span>
<span class="sd">            Dictionary of design variables for which to generate values.</span>

<span class="sd">        model : Group</span>
<span class="sd">            The model containing the design variables (used by some generators).</span>

<span class="sd">        Yields</span>
<span class="sd">        ------</span>
<span class="sd">        list</span>
<span class="sd">            list of name, value tuples for the design variables.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nb_threads</span>
        <span class="n">color</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">color</span>

        <span class="n">generator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;generator&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">case</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">generator</span><span class="p">(</span><span class="n">design_vars</span><span class="p">,</span> <span class="n">model</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="n">size</span> <span class="o">==</span> <span class="n">color</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">case</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;open-mdao-driver/parameters.json&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">parameters</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;all_connections&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="s2">&quot;origin&quot;</span><span class="p">:</span> <span class="s2">&quot;vspaero&quot;</span><span class="p">,</span>
            <span class="s2">&quot;name_origin&quot;</span><span class="p">:</span> <span class="s2">&quot;CL&quot;</span><span class="p">,</span>
            <span class="s2">&quot;target&quot;</span><span class="p">:</span> <span class="s2">&quot;trim&quot;</span><span class="p">,</span>
            <span class="s2">&quot;name_target&quot;</span><span class="p">:</span> <span class="s2">&quot;CL&quot;</span><span class="p">,</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;design&quot;</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;origin&quot;</span><span class="p">:</span> <span class="s2">&quot;vspaero&quot;</span><span class="p">,</span>
            <span class="s2">&quot;name_origin&quot;</span><span class="p">:</span> <span class="s2">&quot;CMy&quot;</span><span class="p">,</span>
            <span class="s2">&quot;target&quot;</span><span class="p">:</span> <span class="s2">&quot;trim&quot;</span><span class="p">,</span>
            <span class="s2">&quot;name_target&quot;</span><span class="p">:</span> <span class="s2">&quot;CMy&quot;</span><span class="p">,</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;design&quot;</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">]</span>
    <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;workflow&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;vspaero&quot;</span><span class="p">,</span> <span class="s2">&quot;trim&quot;</span><span class="p">]</span>  <span class="c1"># defined by controller</span>
    <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;outputs_folder_path&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;outputs&quot;</span>  <span class="c1"># defined by component generic api</span>
    <span class="n">compute</span><span class="p">(</span>
        <span class="n">inputs</span><span class="o">=</span><span class="p">{},</span>
        <span class="n">outputs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;design&quot;</span><span class="p">:</span> <span class="p">{}},</span>
        <span class="n">partials</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">options</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">parameters</span><span class="o">=</span><span class="n">parameters</span><span class="p">,</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
<input id="5101a129-da3d-4ccc-aee8-d45e711ed01d" name="73cab7ea-a93d-4d1e-9d62-da4b60596841" type="radio">
</input><label class="sd-tab-label" for="5101a129-da3d-4ccc-aee8-d45e711ed01d">
requirements</label><div class="sd-tab-content docutils">
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>numpy==1.23.5
openmdao==3.16.0
matplotlib==3.7.0
fluids==1.0.22
pandas==1.5.3
</pre></div>
</div>
</div>
<input id="0ebacf7f-65e7-4b4b-bb41-2b7bd6ca9b5c" name="73cab7ea-a93d-4d1e-9d62-da4b60596841" type="radio">
</input><label class="sd-tab-label" for="0ebacf7f-65e7-4b4b-bb41-2b7bd6ca9b5c">
parameters</label><div class="sd-tab-content docutils">
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;Groups&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;cycle&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="nt">&quot;solvers&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">        </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;nonlinear_solver&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">          </span><span class="nt">&quot;options&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="nt">&quot;iprint&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="nt">&quot;maxiter&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="nt">&quot;rtol&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">0.001</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">},</span><span class="w"></span>
<span class="w">        </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;linear_solver&quot;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">],</span><span class="w"></span>
<span class="w">      </span><span class="nt">&quot;kwargs&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nt">&quot;promotes&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">          </span><span class="s2">&quot;*&quot;</span><span class="w"></span>
<span class="w">        </span><span class="p">]</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">],</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;ExplicitComponents&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;vspaero&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="nt">&quot;group&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;cycle&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="nt">&quot;kwargs&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nt">&quot;promotes_inputs&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">          </span><span class="s2">&quot;AoA&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">          </span><span class="s2">&quot;HTP_RY&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">          </span><span class="s2">&quot;desvars_PONPNSVRANE&quot;</span><span class="w"></span>
<span class="w">        </span><span class="p">]</span><span class="w"></span>
<span class="w">      </span><span class="p">},</span><span class="w"></span>
<span class="w">      </span><span class="nt">&quot;fd_step&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">0.01</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="nt">&quot;has_compute_partials&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">],</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;ImplicitComponents&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;trim&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="nt">&quot;group&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;cycle&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="nt">&quot;kwargs&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nt">&quot;promotes_inputs&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">          </span><span class="s2">&quot;Vinfinity&quot;</span><span class="w"></span>
<span class="w">        </span><span class="p">],</span><span class="w"></span>
<span class="w">        </span><span class="nt">&quot;promotes_outputs&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">          </span><span class="s2">&quot;AoA&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">          </span><span class="s2">&quot;HTP_RY&quot;</span><span class="w"></span>
<span class="w">        </span><span class="p">]</span><span class="w"></span>
<span class="w">      </span><span class="p">},</span><span class="w"></span>
<span class="w">      </span><span class="nt">&quot;fd_step&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">0.01</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">],</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;driver&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;doe&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;kwargs&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nt">&quot;reset_vars&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nt">&quot;cycle.vspaero.AoA&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">0.0</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="nt">&quot;cycle.vspaero.HTP_RY&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">0.0</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="nt">&quot;cycle.trim.CL&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">0.5</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="nt">&quot;cycle.trim.CMy&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">0.0</span><span class="w"></span>
<span class="w">      </span><span class="p">},</span><span class="w"></span>
<span class="w">      </span><span class="nt">&quot;levels&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nt">&quot;Vinfinity&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="nt">&quot;desvars_PONPNSVRANE&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="w"></span>
<span class="w">      </span><span class="p">},</span><span class="w"></span>
<span class="w">      </span><span class="nt">&quot;store_parameters&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nt">&quot;Mass&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1111</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="nt">&quot;Altitude&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">3000</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="nt">&quot;S&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">16.234472</span><span class="w"></span>
<span class="w">      </span><span class="p">},</span><span class="w"></span>
<span class="w">      </span><span class="nt">&quot;store_case_data&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">        </span><span class="s2">&quot;cycle.vspaero.AoA&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="s2">&quot;cycle.vspaero.HTP_RY&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="s2">&quot;cycle.vspaero.CDtot&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="s2">&quot;cycle.vspaero.L2D&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="s2">&quot;cycle.vspaero.E&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="s2">&quot;cycle.vspaero.desvars_PONPNSVRANE&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="s2">&quot;cycle.trim.CL&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="s2">&quot;cycle.trim.CMy&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="s2">&quot;cycle.trim.Vinfinity&quot;</span><span class="w"></span>
<span class="w">      </span><span class="p">]</span><span class="w"></span>
<span class="w">    </span><span class="p">},</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;post&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nt">&quot;case_outputs_keys&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">        </span><span class="s2">&quot;CL&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="s2">&quot;CMy&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="s2">&quot;CDtot&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="s2">&quot;L2D&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="s2">&quot;AoA&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="s2">&quot;E&quot;</span><span class="w"></span>
<span class="w">      </span><span class="p">],</span><span class="w"></span>
<span class="w">      </span><span class="nt">&quot;plt_x_label&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Vinfinity&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="nt">&quot;columns&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;desvars_PONPNSVRANE&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="nt">&quot;variable_names&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nt">&quot;Mass&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Mass, kg&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="nt">&quot;Altitude&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Altitude, m&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="nt">&quot;S&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Wing S, sqm&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="nt">&quot;Vinfinity&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Vinfinity, m/s&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="nt">&quot;desvars_PONPNSVRANE&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;H-Wing AR&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="nt">&quot;CL&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;CL&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="nt">&quot;CMy&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;CMy&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="nt">&quot;CDtot&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;CDtot&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="nt">&quot;L2D&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;L/D&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="nt">&quot;AoA&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;AoA, degrees&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="nt">&quot;E&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Oswald Efficiency Factor&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="nt">&quot;drag_tot&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Drag, N&quot;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">},</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;nb_threads&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">4</span><span class="w"></span>
<span class="w">  </span><span class="p">},</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;visualise&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">    </span><span class="s2">&quot;n2_diagram&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="s2">&quot;plot_history&quot;</span><span class="w"></span>
<span class="w">  </span><span class="p">],</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;input_variables&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Vinfinity&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="nt">&quot;lower&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">40</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="nt">&quot;upper&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">80</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="nt">&quot;value&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">65</span><span class="w"></span>
<span class="w">    </span><span class="p">},</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;desvars_PONPNSVRANE&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="nt">&quot;lower&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">3.86</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="nt">&quot;upper&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">4.64</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="nt">&quot;value&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">3.86</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">]</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
<input id="247c8ac1-0a7a-4433-9521-d6a2dc0878ce" name="73cab7ea-a93d-4d1e-9d62-da4b60596841" type="radio">
</input><label class="sd-tab-label" for="247c8ac1-0a7a-4433-9521-d6a2dc0878ce">
om_component</label><div class="sd-tab-content docutils">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot; Optimisation Component classes for OpenMDAO and associated utilities.&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">openmdao.api</span> <span class="k">as</span> <span class="nn">om</span>  <span class="c1"># type: ignore</span>

<span class="kn">from</span> <span class="nn">component_api2</span> <span class="kn">import</span> <span class="n">call_compute</span><span class="p">,</span> <span class="n">call_setup</span>
<span class="kn">import</span> <span class="nn">traceback</span>


<span class="k">class</span> <span class="nc">OMexplicitComp</span><span class="p">(</span><span class="n">om</span><span class="o">.</span><span class="n">ExplicitComponent</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;standard component that follows the OM conventions&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">compname</span><span class="p">,</span> <span class="n">fd_step</span><span class="p">,</span> <span class="n">has_compute_partials</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compname</span> <span class="o">=</span> <span class="n">compname</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_grads</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">partial_dict</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fd_step</span> <span class="o">=</span> <span class="n">fd_step</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_has_compute_partials</span> <span class="o">=</span> <span class="n">has_compute_partials</span>  <span class="c1"># overrides parent class attribute with user defined parameter</span>

    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;component&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">compname</span><span class="p">}</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">component_dict</span> <span class="o">=</span> <span class="n">call_setup</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="n">inputs</span> <span class="o">=</span> <span class="n">component_dict</span><span class="p">[</span><span class="s2">&quot;input_data&quot;</span><span class="p">][</span><span class="s2">&quot;design&quot;</span><span class="p">]</span>
        <span class="n">outputs</span> <span class="o">=</span> <span class="n">component_dict</span><span class="p">[</span><span class="s2">&quot;output_data&quot;</span><span class="p">][</span><span class="s2">&quot;design&quot;</span><span class="p">]</span>

        <span class="c1"># initialise the inputs</span>
        <span class="k">if</span> <span class="n">inputs</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">variable</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_input</span><span class="p">(</span><span class="n">variable</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">),</span> <span class="n">val</span><span class="o">=</span><span class="n">inputs</span><span class="p">[</span><span class="n">variable</span><span class="p">])</span>

        <span class="c1"># initialise the outputs</span>
        <span class="k">if</span> <span class="n">outputs</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">variable</span> <span class="ow">in</span> <span class="n">outputs</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_output</span><span class="p">(</span><span class="n">variable</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">),</span> <span class="n">val</span><span class="o">=</span><span class="n">outputs</span><span class="p">[</span><span class="n">variable</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">setup_partials</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Get the component partial derivative information</span>

        <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;component&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">compname</span><span class="p">}</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">component_dict</span> <span class="o">=</span> <span class="n">call_setup</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;partials&quot;</span> <span class="ow">in</span> <span class="n">component_dict</span> <span class="ow">and</span> <span class="n">component_dict</span><span class="p">[</span><span class="s2">&quot;partials&quot;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">partial_dict</span> <span class="o">=</span> <span class="n">component_dict</span><span class="p">[</span><span class="s2">&quot;partials&quot;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">resp</span><span class="p">,</span> <span class="nb">vars</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">partial_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">var</span><span class="p">,</span> <span class="n">vals</span> <span class="ow">in</span> <span class="nb">vars</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">declare_partials</span><span class="p">(</span>
                        <span class="n">resp</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">),</span> <span class="n">var</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">),</span> <span class="o">**</span><span class="n">vals</span>
                    <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># calculate all paritials using finite differencing</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">declare_partials</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;fd&quot;</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fd_step</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">compute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">outputs</span><span class="p">,</span> <span class="n">discrete_inputs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">discrete_outputs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Calling compute.&quot;</span><span class="p">)</span>
        <span class="c1"># calculate the outputs</span>
        <span class="c1"># Note: transform all np.ndarrays into nested lists to allow formatting to json</span>
        <span class="n">input_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;design&quot;</span><span class="p">:</span> <span class="n">reformat_inputs</span><span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">_copy_views</span><span class="p">())}</span>

        <span class="n">message</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;component&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">compname</span><span class="p">,</span>
            <span class="s2">&quot;inputs&quot;</span><span class="p">:</span> <span class="n">input_dict</span><span class="p">,</span>
            <span class="s2">&quot;get_grads&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;get_outputs&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;message: </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">message</span><span class="p">))</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">call_compute</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="s2">&quot;outputs&quot;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error: Compute output missing - output was: </span><span class="si">{</span><span class="n">data</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Compute of </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">compname</span><span class="si">}</span><span class="s2"> failed, input data was: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">message</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">tb</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">tb</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;OM Explicit component </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">compname</span><span class="si">}</span><span class="s2"> compute error: &quot;</span> <span class="o">+</span> <span class="n">tb</span>
            <span class="p">)</span>

        <span class="n">val_outputs</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;outputs&quot;</span><span class="p">][</span><span class="s2">&quot;design&quot;</span><span class="p">]</span>

        <span class="c1"># OpenMDAO doesn&#39;t like the outputs dictionary to be overwritten, so</span>
        <span class="c1"># assign individual outputs one at a time instead</span>
        <span class="k">for</span> <span class="n">output</span> <span class="ow">in</span> <span class="n">outputs</span><span class="p">:</span>
            <span class="n">outputs</span><span class="p">[</span><span class="n">output</span><span class="p">]</span> <span class="o">=</span> <span class="n">val_outputs</span><span class="p">[</span><span class="n">output</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot;.&quot;</span><span class="p">)]</span>

    <span class="k">def</span> <span class="nf">compute_partials</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">J</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Jacobian of partial derivatives.&quot;&quot;&quot;</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Calling compute_partials.&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">iter</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">input_dict</span> <span class="o">=</span> <span class="n">reformat_inputs</span><span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">_copy_views</span><span class="p">())</span>

        <span class="n">message</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;component&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">compname</span><span class="p">,</span>
            <span class="s2">&quot;inputs&quot;</span><span class="p">:</span> <span class="n">input_dict</span><span class="p">,</span>
            <span class="s2">&quot;get_grads&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;get_outputs&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;message: </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">message</span><span class="p">))</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">call_compute</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="s2">&quot;partials&quot;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Error: Compute partial derivatives missing - output was: </span><span class="si">{</span><span class="n">data</span><span class="si">}</span><span class="s2">.&quot;</span>
                <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">partial_dict</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;partials&quot;</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Compute partials of </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">compname</span><span class="si">}</span><span class="s2"> failed, input data was: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">message</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="n">tb</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">tb</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;OM Explicit component </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">compname</span><span class="si">}</span><span class="s2"> compute error: &quot;</span> <span class="o">+</span> <span class="n">tb</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">partial_dict</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">resp</span><span class="p">,</span> <span class="nb">vars</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">partial_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">var</span><span class="p">,</span> <span class="n">vals</span> <span class="ow">in</span> <span class="nb">vars</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="s2">&quot;val&quot;</span> <span class="ow">in</span> <span class="n">vals</span><span class="p">:</span>
                        <span class="n">J</span><span class="p">[</span><span class="n">resp</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">),</span> <span class="n">var</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">vals</span><span class="p">[</span><span class="s2">&quot;val&quot;</span><span class="p">]</span>
            <span class="c1"># print(dict(J))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Component </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">compname</span><span class="si">}</span><span class="s2"> has no Jacobian defined.&quot;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">OMimplicitComp</span><span class="p">(</span><span class="n">om</span><span class="o">.</span><span class="n">ImplicitComponent</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;standard implicit component that follows the OM conventions&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">compname</span><span class="p">,</span> <span class="n">fd_step</span><span class="p">,</span> <span class="n">has_compute_partials</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compname</span> <span class="o">=</span> <span class="n">compname</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_grads</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">partial_dict</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fd_step</span> <span class="o">=</span> <span class="n">fd_step</span>

    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;component&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">compname</span><span class="p">}</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">component_dict</span> <span class="o">=</span> <span class="n">call_setup</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="n">inputs</span> <span class="o">=</span> <span class="n">component_dict</span><span class="p">[</span><span class="s2">&quot;input_data&quot;</span><span class="p">][</span><span class="s2">&quot;design&quot;</span><span class="p">]</span>
        <span class="n">outputs</span> <span class="o">=</span> <span class="n">component_dict</span><span class="p">[</span><span class="s2">&quot;output_data&quot;</span><span class="p">][</span><span class="s2">&quot;design&quot;</span><span class="p">]</span>

        <span class="c1"># initialise the inputs</span>
        <span class="k">if</span> <span class="n">inputs</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">variable</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_input</span><span class="p">(</span><span class="n">variable</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">),</span> <span class="n">val</span><span class="o">=</span><span class="n">inputs</span><span class="p">[</span><span class="n">variable</span><span class="p">])</span>

        <span class="c1"># initialise the outputs</span>
        <span class="k">if</span> <span class="n">outputs</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">variable</span> <span class="ow">in</span> <span class="n">outputs</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_output</span><span class="p">(</span><span class="n">variable</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">),</span> <span class="n">val</span><span class="o">=</span><span class="n">outputs</span><span class="p">[</span><span class="n">variable</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">setup_partials</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;component&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">compname</span><span class="p">}</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">component_dict</span> <span class="o">=</span> <span class="n">call_setup</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;partials&quot;</span> <span class="ow">in</span> <span class="n">component_dict</span> <span class="ow">and</span> <span class="n">component_dict</span><span class="p">[</span><span class="s2">&quot;partials&quot;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">partial_dict</span> <span class="o">=</span> <span class="n">component_dict</span><span class="p">[</span><span class="s2">&quot;partials&quot;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">resp</span><span class="p">,</span> <span class="nb">vars</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">partial_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">var</span><span class="p">,</span> <span class="n">vals</span> <span class="ow">in</span> <span class="nb">vars</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">declare_partials</span><span class="p">(</span>
                        <span class="n">resp</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">),</span> <span class="n">var</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">),</span> <span class="o">**</span><span class="n">vals</span>
                    <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># calculate all paritials using finite differencing</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">declare_partials</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;fd&quot;</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fd_step</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">apply_nonlinear</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">outputs</span><span class="p">,</span> <span class="n">residuals</span><span class="p">):</span>

        <span class="n">input_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;design&quot;</span><span class="p">:</span> <span class="n">reformat_inputs</span><span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">_copy_views</span><span class="p">())}</span>

        <span class="n">message</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;component&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">compname</span><span class="p">,</span>
            <span class="s2">&quot;inputs&quot;</span><span class="p">:</span> <span class="n">input_dict</span><span class="p">,</span>
            <span class="s2">&quot;get_grads&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;get_outputs&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;message: </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">message</span><span class="p">))</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">call_compute</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="s2">&quot;outputs&quot;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error: Compute output missing - output was: </span><span class="si">{</span><span class="n">data</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Compute of </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">compname</span><span class="si">}</span><span class="s2"> failed, input data was: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">message</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">tb</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">tb</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;OM Explicit component </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">compname</span><span class="si">}</span><span class="s2"> compute error: &quot;</span> <span class="o">+</span> <span class="n">tb</span>
            <span class="p">)</span>

        <span class="n">val_outputs</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;outputs&quot;</span><span class="p">][</span><span class="s2">&quot;design&quot;</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">output</span> <span class="ow">in</span> <span class="n">outputs</span><span class="p">:</span>
            <span class="n">residuals</span><span class="p">[</span><span class="n">output</span><span class="p">]</span> <span class="o">=</span> <span class="n">val_outputs</span><span class="p">[</span><span class="n">output</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot;.&quot;</span><span class="p">)]</span>


<span class="k">def</span> <span class="nf">reformat_inputs</span><span class="p">(</span><span class="n">inputs</span><span class="p">):</span>
    <span class="n">input_dict</span> <span class="o">=</span> <span class="n">inputs</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="o">*</span><span class="n">input_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()]:</span>
        <span class="n">new_key</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot;.&quot;</span><span class="p">)</span>
        <span class="n">input_dict</span><span class="p">[</span><span class="n">new_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">input_dict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">input_dict</span><span class="p">[</span><span class="n">new_key</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="n">input_dict</span><span class="p">[</span><span class="n">new_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">input_dict</span><span class="p">[</span><span class="n">new_key</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">input_dict</span>
</pre></div>
</div>
</div>
<input id="6518a7e6-1f9b-4899-9302-b850cef490e0" name="73cab7ea-a93d-4d1e-9d62-da4b60596841" type="radio">
</input><label class="sd-tab-label" for="6518a7e6-1f9b-4899-9302-b850cef490e0">
post</label><div class="sd-tab-content docutils">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>  <span class="c1"># type: ignore</span>

<span class="kn">from</span> <span class="nn">fluids.atmosphere</span> <span class="kn">import</span> <span class="n">ATMOSPHERE_1976</span>


<span class="k">def</span> <span class="nf">post_process_doe</span><span class="p">(</span>
    <span class="n">parameters</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">run_folder</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">files</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;results.json&quot;</span><span class="p">],</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Plot VSPAERO outputs and save figures as pngs.&quot;&quot;&quot;</span>

    <span class="n">case_outputs_keys</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;driver&quot;</span><span class="p">][</span><span class="s2">&quot;post&quot;</span><span class="p">][</span><span class="s2">&quot;case_outputs_keys&quot;</span><span class="p">]</span>
    <span class="n">plt_x_label</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;driver&quot;</span><span class="p">][</span><span class="s2">&quot;post&quot;</span><span class="p">][</span><span class="s2">&quot;plt_x_label&quot;</span><span class="p">]</span>
    <span class="n">columns</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;driver&quot;</span><span class="p">][</span><span class="s2">&quot;post&quot;</span><span class="p">][</span><span class="s2">&quot;columns&quot;</span><span class="p">]</span>
    <span class="n">variable_names</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;driver&quot;</span><span class="p">][</span><span class="s2">&quot;post&quot;</span><span class="p">][</span><span class="s2">&quot;variable_names&quot;</span><span class="p">]</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">pd</span><span class="o">.</span><span class="n">read_json</span><span class="p">(</span><span class="n">run_folder</span> <span class="o">/</span> <span class="n">file</span><span class="p">)</span> <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">])</span>
    <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Vinfinity&quot;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># calculate derived properties</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;rho&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">ATMOSPHERE_1976</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;Altitude&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">rho</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;drag_tot&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;CDtot&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">1</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;rho&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Vinfinity&quot;</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;S&quot;</span><span class="p">]</span>
    <span class="n">case_outputs_keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;drag_tot&quot;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">output</span> <span class="ow">in</span> <span class="n">case_outputs_keys</span><span class="p">:</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">grp</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">columns</span><span class="p">):</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">grp</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;line&quot;</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">plt_x_label</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">output</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">key</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="n">variable_names</span><span class="p">[</span><span class="n">plt_x_label</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="n">variable_names</span><span class="p">[</span><span class="n">output</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="n">variable_names</span><span class="p">[</span><span class="n">columns</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">run_folder</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;results_</span><span class="si">{</span><span class="n">output</span><span class="si">}</span><span class="s2">.png&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="s2">&quot;all&quot;</span><span class="p">)</span>  <span class="c1"># avoid memory warning for repeated runs</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">parameters</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;driver&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;post&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;case_outputs_keys&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;CL&quot;</span><span class="p">,</span> <span class="s2">&quot;CMy&quot;</span><span class="p">,</span> <span class="s2">&quot;CDtot&quot;</span><span class="p">,</span> <span class="s2">&quot;L2D&quot;</span><span class="p">,</span> <span class="s2">&quot;AoA&quot;</span><span class="p">,</span> <span class="s2">&quot;E&quot;</span><span class="p">],</span>
                <span class="s2">&quot;plt_x_label&quot;</span><span class="p">:</span> <span class="s2">&quot;Vinfinity&quot;</span><span class="p">,</span>
                <span class="s2">&quot;columns&quot;</span><span class="p">:</span> <span class="s2">&quot;desvars_PONPNSVRANE&quot;</span><span class="p">,</span>
                <span class="s2">&quot;variable_names&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;Mass&quot;</span><span class="p">:</span> <span class="s2">&quot;Mass, kg&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Altitude&quot;</span><span class="p">:</span> <span class="s2">&quot;Altitude, m&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;S&quot;</span><span class="p">:</span> <span class="s2">&quot;Wing S, sqm&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Vinfinity&quot;</span><span class="p">:</span> <span class="s2">&quot;Vinfinity, m/s&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;desvars_PONPNSVRANE&quot;</span><span class="p">:</span> <span class="s2">&quot;Wing AR&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;CL&quot;</span><span class="p">:</span> <span class="s2">&quot;CL&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;CMy&quot;</span><span class="p">:</span> <span class="s2">&quot;CMy&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;CDtot&quot;</span><span class="p">:</span> <span class="s2">&quot;CDtot&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;L2D&quot;</span><span class="p">:</span> <span class="s2">&quot;L/D&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;AoA&quot;</span><span class="p">:</span> <span class="s2">&quot;AoA, degrees&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;E&quot;</span><span class="p">:</span> <span class="s2">&quot;Oswald Efficiency Factor&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;drag_tot&quot;</span><span class="p">:</span> <span class="s2">&quot;Drag, N&quot;</span><span class="p">,</span>
                <span class="p">},</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">run_folder</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;outputs&quot;</span><span class="p">)</span>
    <span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;results_0.json&quot;</span><span class="p">,</span> <span class="s2">&quot;results_1.json&quot;</span><span class="p">,</span> <span class="s2">&quot;results_2.json&quot;</span><span class="p">,</span> <span class="s2">&quot;results_3.json&quot;</span><span class="p">]</span>
    <span class="n">post_process_doe</span><span class="p">(</span><span class="n">run_folder</span><span class="o">=</span><span class="n">run_folder</span><span class="p">,</span> <span class="n">parameters</span><span class="o">=</span><span class="n">parameters</span><span class="p">,</span> <span class="n">files</span><span class="o">=</span><span class="n">files</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="connections">
<h3><span class="section-number">8.2.4. </span>Connections<a class="headerlink" href="#connections" title="Permalink to this headline">#</a></h3>
<p>Finally, we connect the outputs of the vspaero component to the inputs of the trim analysis component.</p>
<p>In the workspace view, create a connection by selecting the “CL” output handle of the vspaero component and dragging a line to the corresponding input handle of the trim component.
Repeat for the “CMy” handles.
Hover the mouse pointer over a handle to see the name of the associated input or output data appear below the component.<br />
Both connections are ‘Design variable’ type connections by default (black line), which is the type of connection we need in this case.</p>
<p>The workspace should now contain the 3 components and 2 connections as shown below.</p>
<a class="bg-primary mb-1 reference internal image-reference" href="../_images/openvsp-performance-4.png"><img alt="workspace view" class="bg-primary mb-1 align-center" src="../_images/openvsp-performance-4.png" style="width: 700px;" /></a>
</section>
</section>
<section id="execute-the-workflow">
<h2><span class="section-number">8.3. </span>Execute the workflow<a class="headerlink" href="#execute-the-workflow" title="Permalink to this headline">#</a></h2>
<p>We can now execute the <a class="reference internal" href="../Reference/Glossary.html#term-Run"><span class="xref std std-term">Run</span></a> by selecting the play symbol ▶ in the Run controls interface.
Once the run has started, each component will setup and then execute.</p>
<p>Open the vspaero component and select the <code class="docutils literal notranslate"><span class="pre">Log</span></code> tab as shown below.
Each log line lists a component event by time and iteration number.
Notice that the first 4 compute events happen practically simultaneously, indicating that the 4 replicas are active.
After that, new compute requests are executed as soon as a free replica is available, resulting in seemingly random series of “SLEEP” and “COMPUTE” events.</p>
<p>The <a class="reference internal" href="../Reference/Glossary.html#term-Run"><span class="xref std std-term">Run</span></a> should complete after a couple of minutes once the vspaero component compute has completed 44 iterations (1 iteration of the open-mdao component).</p>
<a class="bg-primary mb-1 reference internal image-reference" href="../_images/openvsp-performance-8.png"><img alt="vspaero log entries" class="bg-primary mb-1 align-center" src="../_images/openvsp-performance-8.png" style="width: 700px;" /></a>
</section>
<section id="inspect-the-outputs">
<span id="tutorials-openvsp-aircraft-performance-outputs"></span><h2><span class="section-number">8.4. </span>Inspect the outputs<a class="headerlink" href="#inspect-the-outputs" title="Permalink to this headline">#</a></h2>
<p>The <a class="reference internal" href="../Reference/Glossary.html#term-Run"><span class="xref std std-term">Run</span></a> log summarises the output of the components. Open the log by selecting <code class="docutils literal notranslate"><span class="pre">View</span> <span class="pre">Log</span></code> in the interface controls.
The first three “run_output” entries are setup messages from the vspaero component 4 replicas, the trim and open-mdao components.
Notice that the vspaero messages include the replica hostname, which is different for each replica and always starts with “vspaero-“.<br />
The last “run_output” entry should state that the “OpenMDAO compute completed”.</p>
<p>Next, close the <a class="reference internal" href="../Reference/Glossary.html#term-Run"><span class="xref std std-term">Run</span></a> log and select the <code class="docutils literal notranslate"><span class="pre">open-mdao</span></code> component.
Then select the <code class="docutils literal notranslate"><span class="pre">Log</span></code> tab and click on <code class="docutils literal notranslate"><span class="pre">download</span> <span class="pre">files</span> <span class="pre">snapshot</span></code>.
The outputs folder should include the n2 diagram (shown below), the driver log file (useful to check Newton solver convergence), one results file per driver thread in JSON format and results plots in .png format.</p>
<a class="bg-primary mb-1 reference internal image-reference" href="../_images/openvsp-performance-5.png"><img alt="n2 diagram" class="bg-primary mb-1 align-center" src="../_images/openvsp-performance-5.png" style="width: 700px;" /></a>
<p>Since we set the DOE driver “levels” values to 2 for both input variables, the driver only executed 4 cases in total (1 per thread), each case being a combination of the maximum / minimum variable values.
As a result, the plots show straight lines as shown below.</p>
<p>Clearly, we do not have enough data from this run to graphically determine the optimal cruise velocity.
We’ll resolve this problem in the next section.</p>
<a class="bg-primary mb-1 reference internal image-reference" href="../_images/openvsp-performance-6.png"><img alt="L/D from the first run" class="bg-primary mb-1 align-center" src="../_images/openvsp-performance-6.png" style="width: 500px;" /></a>
</section>
<section id="increase-the-number-of-design-points-and-re-run">
<h2><span class="section-number">8.5. </span>Increase the number of design points and re-run<a class="headerlink" href="#increase-the-number-of-design-points-and-re-run" title="Permalink to this headline">#</a></h2>
<p>Select the open-mdao component in the workspace to edit it:</p>
<ul class="simple">
<li><p>Select the <code class="docutils literal notranslate"><span class="pre">Parameters</span></code> tab and scroll to the “driver” object.</p></li>
<li><p>Update the existing {“driver”:{“kwargs”:{“levels”:{}}}} parameter values to:</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;levels&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;Vinfinity&quot;</span><span class="p">:</span> <span class="mi">21</span><span class="p">,</span>
    <span class="s2">&quot;desvars_PONPNSVRANE&quot;</span><span class="p">:</span> <span class="mi">3</span>
<span class="p">}</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Select <code class="docutils literal notranslate"><span class="pre">Save</span> <span class="pre">data</span></code> to save and close the component.</p></li>
</ul>
<p>Execute <a class="reference internal" href="../Reference/Glossary.html#term-Run"><span class="xref std std-term">Run</span></a> again by selecting the play symbol ▶ in the Run controls interface.
The DOE driver will execute 63 cases (21 velocities for 3 aspect ratios) and should complete within ~33min.</p>
<p>The figure below shows the L/D variation obtained.
The maximum L/D cruise velocity occurs between 55m/s and 60m/s.
As expected, the maximum L/D increases with increasing half-wing aspect ratio and the maximum L/D cruise velocity decreases.</p>
<a class="bg-primary mb-1 reference internal image-reference" href="../_images/openvsp-performance-7.png"><img alt="L/D from the second run" class="bg-primary mb-1 align-center" src="../_images/openvsp-performance-7.png" style="width: 500px;" /></a>
</section>
<section id="clean-up">
<h2><span class="section-number">8.6. </span>Clean-up<a class="headerlink" href="#clean-up" title="Permalink to this headline">#</a></h2>
<p>Delete your session by selecting <code class="docutils literal notranslate"><span class="pre">New</span></code> in the interface.
It may take a minute or so for the Cloud session to be reset.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>You should see a warning message whenever you are about to delete a <a class="reference internal" href="../Reference/Glossary.html#term-Run"><span class="xref std std-term">Run</span></a>. If you select to continue, then all the <a class="reference internal" href="../Reference/Glossary.html#term-Run"><span class="xref std std-term">Run</span></a> session data (Run log and component logs) will be permanently deleted.</p>
</div>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./Tutorials"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
            </main>
            <footer class="footer-article noprint">
                
    <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="Example%20of%20a%20variable%20stiffness%20plate%20in%20compression.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title"><span class="section-number">7. </span>Example of a variable stiffness plate in compression</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="A%20simple%20Rescale%20simulation%20example.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title"><span class="section-number">9. </span>A simple Rescale simulation example</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            </footer>
        </div>
    </div>
    <div class="footer-content row">
        <footer class="col footer"><p>
  
    By Dapta Ltd<br/>
  
      &copy; Copyright 2023.<br/>
</p>
        </footer>
    </div>
    
</div>


      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>


  </body>
</html>