
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Example of a variable stiffness plate in compression &#8212; dapta docs</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css?digest=5115cc725059bd94278eecd172e13a965bf8f5a9" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.b7bb847fb20b106c3d81b95245e65545.min.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=9c920249402e914e316237a7dbc6769907cce411"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="canonical" href="https://daptadocs.com/index.com/Tutorials/Example of a variable stiffness plate in compression.html" />
    <link rel="shortcut icon" href="../_static/favicon.png"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="The dashboard" href="../Reference/The%20dashboard.html" />
    <link rel="prev" title="Working with spreadsheets" href="Working%20with%20spreadsheets.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en">
    

    <!-- Google Analytics -->
    
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-KD6ZCS0VXN"></script>
<script>
                    window.dataLayer = window.dataLayer || [];
                    function gtag(){ dataLayer.push(arguments); }
                    gtag('js', new Date());
                    gtag('config', 'G-KD6ZCS0VXN');
                </script>

  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay overlay-navbar" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input type="checkbox" class="sidebar-toggle" name="__page-toc" id="__page-toc" aria-label="Toggle in-page Table of Contents">
<label class="overlay overlay-pagetoc" for="__page-toc">
    <div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"></div>
<div class="header header-item noprint"></div>

    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
    <div class="bd-sidebar__content">
        <div class="bd-sidebar__top"><div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="../_static/logo.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">dapta docs</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../intro.html">
                    Overview
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Tutorials
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="Simple%20component%20analysis.html">
   Simple component analysis
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Simple%20optimisation%20problem.html">
   Simple optimisation problem
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Chaining%20component%20analyses.html">
   Chaining component analyses
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Automating%20parametric%20studies.html">
   Automating the composite wing model parametric study
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Automating%20design%20optimisations.html">
   Automating the design optimisation of the composite wing model
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Working%20with%20spreadsheets.html">
   Working with spreadsheets
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Example of a variable stiffness plate in compression
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Reference Guide
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../Reference/The%20dashboard.html">
   The dashboard
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Reference/FAQs.html">
   FAQs
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Reference/Glossary.html">
   Glossary
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Reference/Support.html">
   Support
  </a>
 </li>
</ul>

    </div>
</nav></div>
        <div class="bd-sidebar__bottom">
             <!-- To handle the deprecated key -->
            
            <div class="navbar_extra_footer">
            Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
            </div>
            
        </div>
    </div>
    <div id="rtd-footer-container"></div>
</div>


          


          
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
    
    <div class="header-article row sticky-top noprint">
        



<div class="col py-1 d-flex header-article-main">
    <div class="header-article__left">
        
        <label for="__navigation"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="right"
title="Toggle navigation"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-bars"></i>
  </span>

</label>

        
    </div>
    <div class="header-article__right">
<button onclick="toggleFullScreen()"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="bottom"
title="Fullscreen mode"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>

<div class="menu-dropdown menu-dropdown-repository-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Source repositories">
      <i class="fab fa-github"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://github.com/daptablade/docs"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Source repository"
>
  

<span class="headerbtn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="headerbtn__text-container">repository</span>
</a>

      </li>
      
      <li>
        <a href="https://github.com/daptablade/docs/issues/new?title=Issue%20on%20page%20%2FTutorials/Example of a variable stiffness plate in compression.html&body=Your%20issue%20content%20here."
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Open an issue"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="headerbtn__text-container">open issue</span>
</a>

      </li>
      
    </ul>
  </div>
</div>

<div class="menu-dropdown menu-dropdown-download-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Download this page">
      <i class="fas fa-download"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="../_sources/Tutorials/Example of a variable stiffness plate in compression.md"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Download source file"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="headerbtn__text-container">.md</span>
</a>

      </li>
      
      <li>
        
<button onclick="printPdf(this)"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="left"
title="Print to PDF"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="headerbtn__text-container">.pdf</span>
</button>

      </li>
      
    </ul>
  </div>
</div>
<label for="__page-toc"
  class="headerbtn headerbtn-page-toc"
  
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-list"></i>
  </span>

</label>

    </div>
</div>

<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
    <div class="tocsection onthispage pt-5 pb-3">
        <i class="fas fa-list"></i> Contents
    </div>
    <nav id="bd-toc-nav" aria-label="Page">
        <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#model-overview">
   Model overview
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#variable-stiffness-rts-composites">
     Variable stiffness RTS composites
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#modelling-approach-in-calculix">
     Modelling approach in Calculix
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#modelling-the-boundary-conditions">
       Modelling the boundary conditions
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#modelling-the-applied-compression-load">
       Modelling the applied compression load
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#defining-the-design-variables">
       Defining the design variables
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#choosing-the-element-type">
       Choosing the element type
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#automating-the-design-optimisation">
   Automating the design optimisation
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#load-a-workflow-from-file">
     Load a workflow from file
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#update-the-plate-component">
     Update the plate component
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#update-the-driver-component">
     Update the driver component
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#execute-the-workflow">
     Execute the workflow
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#inspect-results">
     Inspect results
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#run-log">
       Run log
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#plate-component-analysis-outputs">
       Plate component analysis outputs
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#optimisation-driver-outputs">
       Optimisation driver outputs
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#clean-up">
   Clean-up
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#references">
   References
  </a>
 </li>
</ul>

    </nav>
</div>
    </div>
    <div class="article row">
        <div class="col pl-md-3 pl-lg-5 content-container">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>Example of a variable stiffness plate in compression</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#model-overview">
   Model overview
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#variable-stiffness-rts-composites">
     Variable stiffness RTS composites
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#modelling-approach-in-calculix">
     Modelling approach in Calculix
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#modelling-the-boundary-conditions">
       Modelling the boundary conditions
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#modelling-the-applied-compression-load">
       Modelling the applied compression load
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#defining-the-design-variables">
       Defining the design variables
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#choosing-the-element-type">
       Choosing the element type
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#automating-the-design-optimisation">
   Automating the design optimisation
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#load-a-workflow-from-file">
     Load a workflow from file
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#update-the-plate-component">
     Update the plate component
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#update-the-driver-component">
     Update the driver component
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#execute-the-workflow">
     Execute the workflow
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#inspect-results">
     Inspect results
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#run-log">
       Run log
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#plate-component-analysis-outputs">
       Plate component analysis outputs
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#optimisation-driver-outputs">
       Optimisation driver outputs
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#clean-up">
   Clean-up
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#references">
   References
  </a>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            <main id="main-content" role="main">
                
              <div>
                
  <section class="tex2jax_ignore mathjax_ignore" id="example-of-a-variable-stiffness-plate-in-compression">
<h1>Example of a variable stiffness plate in compression<a class="headerlink" href="#example-of-a-variable-stiffness-plate-in-compression" title="Permalink to this headline">#</a></h1>
<p><strong>Duration: 60 min</strong></p>
<p>We optimise the design of a variable stiffness RTS composite plate in compression.
We use CalculiX to model the plate and analyse the buckling behaviour, and OpenMDAO to minimise the mass of the plate, subject to a minimum buckling load constraint.</p>
<p>This example is based on <a class="reference internal" href="#tutorials-modelling-variable-stiffness-composite-plates-references"><span class="std std-ref">Reference 1</span></a> and results are compared to the reference data showing a good correlation.</p>
<p><strong>&gt;&gt; The files for this tutorial are now on <a class="reference external" href="https://github.com/daptablade/docs/tree/master/mynewbook/Tutorials/parametric-plate-buckling">Github</a>.</strong></p>
<a class="bg-primary mb-1 reference internal image-reference" href="../_images/parametric-plate-buckling-rts_1.png"><img alt="Buckling of an rts plate - mode 1" class="bg-primary mb-1 align-center" src="../_images/parametric-plate-buckling-rts_1.png" style="width: 500px;" /></a>
<section id="model-overview">
<h2>Model overview<a class="headerlink" href="#model-overview" title="Permalink to this headline">#</a></h2>
<section id="variable-stiffness-rts-composites">
<h3>Variable stiffness RTS composites<a class="headerlink" href="#variable-stiffness-rts-composites" title="Permalink to this headline">#</a></h3>
<p>With steered-fibre composites (also called variable-stiffness composites), engineers have the option to change the fibre directions within each ply, as well as stacking plies with different fibre orientations through the laminate thickness.</p>
<p>The use of steered-fibre composites opens-up the design space and has been shown to lead to lighter, more efficient designs in a number of applications, for example, by steering fibres around holes or cut-outs in complex parts <a class="reference internal" href="#tutorials-modelling-variable-stiffness-composite-plates-references"><span class="std std-ref">[2]</span></a>.
By steering the fibres, the number of stacked plies and their surface area can be optimised for structural efficiency, which leads to lighter designs.
The use of fewer plies and the increased control over ply shapes has another benefit: it could speed-up the manufacturing process and reduce material wastage.</p>
<p>Rapid tow shearing (RTS) is a new patented manufacturing method for steered-fibre composites that is being developed by iCOMAT (<a class="reference external" href="http://icomat.co.uk">icomat.co.uk</a>).
One of the main benefits of RTS is that the fibres can be steered to a tight radius (50mm), without generating fibre wrinkling, gaps or overlaps, which are defects that can significantly compromise the structural performance.
This is a key advantage compared to other steering methods, such as ATL, AFP or TFP.</p>
<p>With RTS the thickness of the ply changes as a function of the steering angle (or more precisely “shearing”-angle) as shown in the figure below. This means that thickened laminate regions can be introduced purely by locally shearing the fibres, potentially removing the need to add plies near joints or other high stress areas.</p>
<a class="bg-primary mb-1 reference internal image-reference" href="../_images/parametric-plate-buckling-rts_2.png"><img alt="rts composites link thickness and steering angle" class="bg-primary mb-1 align-center" src="../_images/parametric-plate-buckling-rts_2.png" style="width: 400px;" /></a>
</section>
<section id="modelling-approach-in-calculix">
<h3>Modelling approach in Calculix<a class="headerlink" href="#modelling-approach-in-calculix" title="Permalink to this headline">#</a></h3>
<p>Our objective is to optimise an RTS composite plate design for minimum mass, subject to a minimum buckling load constraint and to compare our results with data from <a class="reference internal" href="#tutorials-modelling-variable-stiffness-composite-plates-references"><span class="std std-ref">Reference 1</span></a>.
We reduce the size of the optimisation problem compared to Reference 1 by using a fixed composite ply stacking sequence and only optimising the outer RTS ply steering angles.</p>
<p>We create a parametric Calculix finite element model of the plate to perform a linear eigenvalue buckling analysis.
This type of analysis can be used to estimate the critical (bifurcation) loads of “stiff” structures.</p>
<section id="modelling-the-boundary-conditions">
<h4>Modelling the boundary conditions<a class="headerlink" href="#modelling-the-boundary-conditions" title="Permalink to this headline">#</a></h4>
<p>The rectangular plate (250x750mm) described in the reference is simply supported on all edges and loaded in the x-direction as shown below.
In the reference, the analytical boundary conditions are applied directly at the laminate neutral plane, the location of which is a function of the laminate properties.
There is normally no requirement for element nodes to coincide with the laminate neutral plane.
Therefore, it may be difficult to reproduce these boundary conditions in a finite element model - particularly with shell elements.
Instead we will be using a 5x larger model (750mmx1250mm) and boundary conditions shown in the second figure.
This allows us to model boundary conditions on the 250x750mm inner plate that closely resemble simply supported conditions.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>For a constant stiffness panel, we could have reduced the size of the model by assuming symmetric boundary conditions in the x and y directions.
However, the plate’s stiffness distributions here are not necessarily symmetric depending on the control point locations and fibre angle values.</p>
</div>
<a class="bg-primary mb-1 reference internal image-reference" href="../_images/parametric-plate-buckling-rts_3.png"><img alt="reference boundary conditions" class="bg-primary mb-1 align-center" src="../_images/parametric-plate-buckling-rts_3.png" style="width: 400px;" /></a>
<a class="bg-primary mb-1 reference internal image-reference" href="../_images/parametric-plate-buckling-rts_4.png"><img alt="new boundary conditions" class="bg-primary mb-1 align-center" src="../_images/parametric-plate-buckling-rts_4.png" style="width: 400px;" /></a>
</section>
<section id="modelling-the-applied-compression-load">
<h4>Modelling the applied compression load<a class="headerlink" href="#modelling-the-applied-compression-load" title="Permalink to this headline">#</a></h4>
<p>The compression load (750kN) shown in the second figure is the target load below which the panel should not buckle.
The compression load is applied to the model via a kinematic coupling (using the *KINEMATIC keyword), which distributes the load to the edge nodes and ensures that the edge remains straight.
A second kinematic coupling is applied to the top edge of the plate to keep it straight, whilst allowing nodes to slide in the x and y directions.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>We actually apply a lower load (10kN) to the model in Calculix Crunchix and constraint the minimum buckling factor to 75.0 in the OpenMDAO driver parameters.
This ensures that the compression load applied to the model is always lower than the expected buckling load factor during the design optimisation iterations, without which the solver may return erroneous buckling load factors. We also request the first 10 buckling modes as an output with the *BUCKLE keyword, to ensure that the lowest mode is calculated with sufficient accuracy.</p>
</div>
</section>
<section id="defining-the-design-variables">
<h4>Defining the design variables<a class="headerlink" href="#defining-the-design-variables" title="Permalink to this headline">#</a></h4>
<p>The design variables for the RTS panel are the outer ply shearing angles T0 and T1, which are defined at 7 equally spaced control points in the 90 degree ply reference direction (model y-direction) as shown in the next figure.
The location of the control points is also a variable in the component parameters, but we will not change these positions in this example.</p>
<p>For example, by defining angles of 0 and 69 degrees at T0 and T1 respectively, we can now model the fibre paths shown below in green and orange for the +/- RTS plies.
Note that the plate lower surface is flat, so that the thickness variation shown below due to the fibre shearing is only visible on the upper surface.</p>
<a class="bg-primary mb-1 reference internal image-reference" href="../_images/parametric-plate-buckling-rts_5.png"><img alt="control points" class="bg-primary mb-1 align-center" src="../_images/parametric-plate-buckling-rts_5.png" style="width: 400px;" /></a>
<a class="bg-primary mb-1 reference internal image-reference" href="../_images/parametric-plate-buckling-rts_5_1.png"><img alt="fibre paths example" class="bg-primary mb-1 align-center" src="../_images/parametric-plate-buckling-rts_5_1.png" style="width: 300px;" /></a>
<a class="bg-primary mb-1 reference internal image-reference" href="../_images/parametric-plate-buckling-rts_5_2.png"><img alt="thickness distribution" class="bg-primary mb-1 align-center" src="../_images/parametric-plate-buckling-rts_5_2.png" style="width: 350px;" /></a>
</section>
<section id="choosing-the-element-type">
<h4>Choosing the element type<a class="headerlink" href="#choosing-the-element-type" title="Permalink to this headline">#</a></h4>
<p>We choose to model the plate directly with solid C3D20R elements, as the alternative of using S8R shell elements with varying thicknesses in CalculiX would introduce undesired rigid body constraints at element interfaces <a class="reference internal" href="#tutorials-modelling-variable-stiffness-composite-plates-references"><span class="std std-ref">[3]</span></a>.
To reduce the number of elements through the thickness of the plate, we also choose to calculate homogenised material properties for +/- plies, so that the optimal 28-ply RTS laminate design <span class="math notranslate nohighlight">\([(90 \pm \langle 0|69 \rangle)_4 / 90 \pm \langle 0|67 \rangle / \pm 80 / 90_2]_s\)</span>  from Reference 1 can be approximated with only 3 element layers consisting of the following sub-laminates: <span class="math notranslate nohighlight">\([(90 \pm \langle 0|69 \rangle)_5]\)</span>, <span class="math notranslate nohighlight">\([90_8]\)</span> and <span class="math notranslate nohighlight">\([(90 \pm \langle 0|69 \rangle)_5]\)</span>.</p>
</section>
</section>
</section>
<section id="automating-the-design-optimisation">
<h2>Automating the design optimisation<a class="headerlink" href="#automating-the-design-optimisation" title="Permalink to this headline">#</a></h2>
<section id="load-a-workflow-from-file">
<h3>Load a workflow from file<a class="headerlink" href="#load-a-workflow-from-file" title="Permalink to this headline">#</a></h3>
<p>Copy the JSON object below into a text editor and save it locally, then select <code class="docutils literal notranslate"><span class="pre">Open</span></code> to load it.
Two components should appear in the workspace.
Since the second component is a driver we do not define any connections between components in this workflow.</p>
<details class="sd-sphinx-override sd-dropdown sd-card sd-mb-3">
<summary class="sd-summary-title sd-card-header">
dapta_input.json<div class="sd-summary-down docutils">
<svg version="1.1" width="1.5em" height="1.5em" class="sd-octicon sd-octicon-chevron-down" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M5.22 8.72a.75.75 0 000 1.06l6.25 6.25a.75.75 0 001.06 0l6.25-6.25a.75.75 0 00-1.06-1.06L12 14.44 6.28 8.72a.75.75 0 00-1.06 0z"></path></svg></div>
<div class="sd-summary-up docutils">
<svg version="1.1" width="1.5em" height="1.5em" class="sd-octicon sd-octicon-chevron-up" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M18.78 15.28a.75.75 0 000-1.06l-6.25-6.25a.75.75 0 00-1.06 0l-6.25 6.25a.75.75 0 101.06 1.06L12 9.56l5.72 5.72a.75.75 0 001.06 0z"></path></svg></div>
</summary><div class="sd-summary-content sd-card-body docutils">
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;components&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;parametric-plate-buckling&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="nt">&quot;api&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;calculix-fea-comp:latest&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="nt">&quot;options&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{},</span><span class="w"></span>
<span class="w">      </span><span class="nt">&quot;parameters&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nt">&quot;length_x&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">1.250</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="nt">&quot;width_y&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">0.75</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="nt">&quot;split_at_x&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">          </span><span class="mf">0.25</span><span class="p">,</span><span class="w"></span>
<span class="w">          </span><span class="mf">1.0</span><span class="w"></span>
<span class="w">        </span><span class="p">],</span><span class="w"></span>
<span class="w">        </span><span class="nt">&quot;split_at_y&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">          </span><span class="mf">0.25</span><span class="p">,</span><span class="w"></span>
<span class="w">          </span><span class="mf">0.5</span><span class="w"></span>
<span class="w">        </span><span class="p">],</span><span class="w"></span>
<span class="w">        </span><span class="nt">&quot;boundary_conditions&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="nt">&quot;fixed_y0&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="nt">&quot;lines&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">              </span><span class="mi">0</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="mi">1</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="mi">2</span><span class="w"></span>
<span class="w">            </span><span class="p">],</span><span class="w"></span>
<span class="w">            </span><span class="nt">&quot;SPC&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;23&quot;</span><span class="w"></span>
<span class="w">          </span><span class="p">},</span><span class="w"></span>
<span class="w">          </span><span class="nt">&quot;fixed_x0&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="nt">&quot;lines&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">              </span><span class="mi">9</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="mi">10</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="mi">11</span><span class="w"></span>
<span class="w">            </span><span class="p">],</span><span class="w"></span>
<span class="w">            </span><span class="nt">&quot;SPC&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;13&quot;</span><span class="w"></span>
<span class="w">          </span><span class="p">},</span><span class="w"></span>
<span class="w">          </span><span class="nt">&quot;support_z&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="nt">&quot;lines&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">              </span><span class="mi">12</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="mi">13</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="mi">14</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="mi">15</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="mi">16</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="mi">17</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="mi">18</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="mi">19</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="mi">20</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="mi">21</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="mi">22</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="mi">23</span><span class="w"></span>
<span class="w">            </span><span class="p">],</span><span class="w"></span>
<span class="w">            </span><span class="nt">&quot;SPC&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;3&quot;</span><span class="w"></span>
<span class="w">          </span><span class="p">},</span><span class="w"></span>
<span class="w">          </span><span class="nt">&quot;support_ymax&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="nt">&quot;lines&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">              </span><span class="mi">6</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="mi">7</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="mi">8</span><span class="w"></span>
<span class="w">            </span><span class="p">],</span><span class="w"></span>
<span class="w">            </span><span class="nt">&quot;kinematic&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;23&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="nt">&quot;ref_node_SPC&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;346&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="nt">&quot;surface_vector&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">              </span><span class="mf">0.0</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="mf">1.0</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="mf">0.0</span><span class="w"></span>
<span class="w">            </span><span class="p">]</span><span class="w"></span>
<span class="w">          </span><span class="p">},</span><span class="w"></span>
<span class="w">          </span><span class="nt">&quot;loaded_xmax&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="nt">&quot;lines&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">              </span><span class="mi">3</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="mi">4</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="mi">5</span><span class="w"></span>
<span class="w">            </span><span class="p">],</span><span class="w"></span>
<span class="w">            </span><span class="nt">&quot;kinematic&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;13&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="nt">&quot;ref_node_SPC&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;356&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="nt">&quot;surface_vector&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">              </span><span class="mf">1.0</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="mf">0.0</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="mf">0.0</span><span class="w"></span>
<span class="w">            </span><span class="p">],</span><span class="w"></span>
<span class="w">            </span><span class="nt">&quot;ref_node_forces&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">              </span><span class="mf">-10000.0</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="mf">0.0</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="mf">0.0</span><span class="w"></span>
<span class="w">            </span><span class="p">]</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">},</span><span class="w"></span>
<span class="w">        </span><span class="nt">&quot;edge_length&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">0.025</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="nt">&quot;material&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="nt">&quot;E1&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">163.0e9</span><span class="p">,</span><span class="w"></span>
<span class="w">          </span><span class="nt">&quot;E2&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">12.0e9</span><span class="p">,</span><span class="w"></span>
<span class="w">          </span><span class="nt">&quot;nu12&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">0.3</span><span class="p">,</span><span class="w"></span>
<span class="w">          </span><span class="nt">&quot;G12&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">5.0e9</span><span class="p">,</span><span class="w"></span>
<span class="w">          </span><span class="nt">&quot;thickness&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">0.000125</span><span class="p">,</span><span class="w"></span>
<span class="w">          </span><span class="nt">&quot;density&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">1571.0</span><span class="p">,</span><span class="w"></span>
<span class="w">          </span><span class="nt">&quot;tape_width&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">0.100</span><span class="p">,</span><span class="w"></span>
<span class="w">          </span><span class="nt">&quot;stress_allowables&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{},</span><span class="w"></span>
<span class="w">          </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;IM7_8552&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">          </span><span class="nt">&quot;description&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot; Units are: kg, m; data from Groh_2015.&quot;</span><span class="w"></span>
<span class="w">        </span><span class="p">},</span><span class="w"></span>
<span class="w">        </span><span class="nt">&quot;plies&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">          </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="nt">&quot;path_start&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">              </span><span class="mi">0</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="mi">0</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="mi">0</span><span class="w"></span>
<span class="w">            </span><span class="p">],</span><span class="w"></span>
<span class="w">            </span><span class="nt">&quot;path_end&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">              </span><span class="mi">0</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="mf">0.750</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="mi">0</span><span class="w"></span>
<span class="w">            </span><span class="p">],</span><span class="w"></span>
<span class="w">            </span><span class="nt">&quot;ply_ref_angle&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">90.0</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="nt">&quot;ply_ref_thickness_multiplier&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="nt">&quot;combine_plus_minus_plies&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="nt">&quot;control_pts&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">              </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="nt">&quot;d&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">-0.01</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="nt">&quot;inc_angle&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">69.0</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;T1&quot;</span><span class="w"></span>
<span class="w">              </span><span class="p">},</span><span class="w"></span>
<span class="w">              </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="nt">&quot;d&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">0.000</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="nt">&quot;inc_angle&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">69.0</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;T1&quot;</span><span class="w"></span>
<span class="w">              </span><span class="p">},</span><span class="w"></span>
<span class="w">              </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="nt">&quot;d&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">0.125</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="nt">&quot;inc_angle&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">0.0</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;T0&quot;</span><span class="w"></span>
<span class="w">              </span><span class="p">},</span><span class="w"></span>
<span class="w">              </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="nt">&quot;d&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">0.250</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="nt">&quot;inc_angle&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">69.0</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;T1&quot;</span><span class="w"></span>
<span class="w">              </span><span class="p">},</span><span class="w"></span>
<span class="w">              </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="nt">&quot;d&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">0.375</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="nt">&quot;inc_angle&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">0.0</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;T0&quot;</span><span class="w"></span>
<span class="w">              </span><span class="p">},</span><span class="w"></span>
<span class="w">              </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="nt">&quot;d&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">0.500</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="nt">&quot;inc_angle&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">69.0</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;T1&quot;</span><span class="w"></span>
<span class="w">              </span><span class="p">},</span><span class="w"></span>
<span class="w">              </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="nt">&quot;d&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">0.625</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="nt">&quot;inc_angle&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">0.0</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;T0&quot;</span><span class="w"></span>
<span class="w">              </span><span class="p">},</span><span class="w"></span>
<span class="w">              </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="nt">&quot;d&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">0.750</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="nt">&quot;inc_angle&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">69.0</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;T1&quot;</span><span class="w"></span>
<span class="w">              </span><span class="p">},</span><span class="w"></span>
<span class="w">              </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="nt">&quot;d&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">0.760</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="nt">&quot;inc_angle&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">69.0</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;T1&quot;</span><span class="w"></span>
<span class="w">              </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="p">]</span><span class="w"></span>
<span class="w">          </span><span class="p">},</span><span class="w"></span>
<span class="w">          </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="nt">&quot;path_start&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">              </span><span class="mi">0</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="mi">0</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="mi">0</span><span class="w"></span>
<span class="w">            </span><span class="p">],</span><span class="w"></span>
<span class="w">            </span><span class="nt">&quot;path_end&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">              </span><span class="mi">0</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="mf">0.750</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="mi">0</span><span class="w"></span>
<span class="w">            </span><span class="p">],</span><span class="w"></span>
<span class="w">            </span><span class="nt">&quot;ply_ref_angle&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">90.0</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="nt">&quot;ply_ref_thickness_multiplier&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">8</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="nt">&quot;combine_plus_minus_plies&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="nt">&quot;control_pts&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">              </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="nt">&quot;d&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">-0.01</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="nt">&quot;inc_angle&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">0.0</span><span class="w"></span>
<span class="w">              </span><span class="p">},</span><span class="w"></span>
<span class="w">              </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="nt">&quot;d&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">0.760</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="nt">&quot;inc_angle&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">0.0</span><span class="w"></span>
<span class="w">              </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="p">]</span><span class="w"></span>
<span class="w">          </span><span class="p">},</span><span class="w"></span>
<span class="w">          </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="nt">&quot;path_start&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">              </span><span class="mi">0</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="mi">0</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="mi">0</span><span class="w"></span>
<span class="w">            </span><span class="p">],</span><span class="w"></span>
<span class="w">            </span><span class="nt">&quot;path_end&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">              </span><span class="mi">0</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="mf">0.750</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="mi">0</span><span class="w"></span>
<span class="w">            </span><span class="p">],</span><span class="w"></span>
<span class="w">            </span><span class="nt">&quot;ply_ref_angle&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">90.0</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="nt">&quot;ply_ref_thickness_multiplier&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="nt">&quot;combine_plus_minus_plies&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="nt">&quot;control_pts&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">              </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="nt">&quot;d&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">-0.01</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="nt">&quot;inc_angle&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">69.0</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;T1&quot;</span><span class="w"></span>
<span class="w">              </span><span class="p">},</span><span class="w"></span>
<span class="w">              </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="nt">&quot;d&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">0.000</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="nt">&quot;inc_angle&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">69.0</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;T1&quot;</span><span class="w"></span>
<span class="w">              </span><span class="p">},</span><span class="w"></span>
<span class="w">              </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="nt">&quot;d&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">0.125</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="nt">&quot;inc_angle&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">0.0</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;T0&quot;</span><span class="w"></span>
<span class="w">              </span><span class="p">},</span><span class="w"></span>
<span class="w">              </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="nt">&quot;d&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">0.250</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="nt">&quot;inc_angle&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">69.0</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;T1&quot;</span><span class="w"></span>
<span class="w">              </span><span class="p">},</span><span class="w"></span>
<span class="w">              </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="nt">&quot;d&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">0.375</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="nt">&quot;inc_angle&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">0.0</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;T0&quot;</span><span class="w"></span>
<span class="w">              </span><span class="p">},</span><span class="w"></span>
<span class="w">              </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="nt">&quot;d&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">0.500</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="nt">&quot;inc_angle&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">69.0</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;T1&quot;</span><span class="w"></span>
<span class="w">              </span><span class="p">},</span><span class="w"></span>
<span class="w">              </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="nt">&quot;d&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">0.625</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="nt">&quot;inc_angle&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">0.0</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;T0&quot;</span><span class="w"></span>
<span class="w">              </span><span class="p">},</span><span class="w"></span>
<span class="w">              </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="nt">&quot;d&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">0.750</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="nt">&quot;inc_angle&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">69.0</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;T1&quot;</span><span class="w"></span>
<span class="w">              </span><span class="p">},</span><span class="w"></span>
<span class="w">              </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="nt">&quot;d&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">0.760</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="nt">&quot;inc_angle&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">69.0</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;T1&quot;</span><span class="w"></span>
<span class="w">              </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="p">]</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">],</span><span class="w"></span>
<span class="w">        </span><span class="nt">&quot;mesh_files&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="nt">&quot;mesh&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;all.msh&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">          </span><span class="nt">&quot;solid_mesh&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;solid_mesh.inp&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">          </span><span class="nt">&quot;materials&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;materials.inp&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">          </span><span class="nt">&quot;element_sets&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;element_sets.inp&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">          </span><span class="nt">&quot;solid_sections&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;solid_sections.inp&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">          </span><span class="nt">&quot;node_sets&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;node_sets.inp&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">          </span><span class="nt">&quot;surfaces&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;surfaces.inp&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">          </span><span class="nt">&quot;constraints&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;constraints.inp&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">          </span><span class="nt">&quot;loads&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;loads.inp&quot;</span><span class="w"></span>
<span class="w">        </span><span class="p">},</span><span class="w"></span>
<span class="w">        </span><span class="nt">&quot;analysis_file&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;ccx_compression_buckle.inp&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="nt">&quot;number_of_modes&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">10</span><span class="w"></span>
<span class="w">      </span><span class="p">},</span><span class="w"></span>
<span class="w">      </span><span class="nt">&quot;inputs&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nt">&quot;T0&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">70.0</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="nt">&quot;T1&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">70.0</span><span class="w"></span>
<span class="w">      </span><span class="p">},</span><span class="w"></span>
<span class="w">      </span><span class="nt">&quot;outputs&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nt">&quot;mass&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">0.0</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="nt">&quot;buckling_factors&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">          </span><span class="mf">0.0</span><span class="w"></span>
<span class="w">        </span><span class="p">]</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">},</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;open-mdao&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="nt">&quot;api&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;generic-python3-driver:latest&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="nt">&quot;options&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{},</span><span class="w"></span>
<span class="w">      </span><span class="nt">&quot;parameters&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nt">&quot;user_input_files&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w"></span>
<span class="w">        </span><span class="nt">&quot;optimizer&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;SLSQP&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="nt">&quot;max_iter&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">20</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="nt">&quot;tol&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">1e-6</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="nt">&quot;disp&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="nt">&quot;debug_print&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">          </span><span class="s2">&quot;desvars&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">          </span><span class="s2">&quot;ln_cons&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">          </span><span class="s2">&quot;nl_cons&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">          </span><span class="s2">&quot;objs&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">          </span><span class="s2">&quot;totals&quot;</span><span class="w"></span>
<span class="w">        </span><span class="p">],</span><span class="w"></span>
<span class="w">        </span><span class="nt">&quot;approx_totals&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="nt">&quot;fd_step&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">0.2</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="nt">&quot;input_variables&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">          </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="nt">&quot;component&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;parametric-plate-buckling&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;T0&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="nt">&quot;lower&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="nt">&quot;upper&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">75</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="nt">&quot;value&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">          </span><span class="p">},</span><span class="w"></span>
<span class="w">          </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="nt">&quot;component&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;parametric-plate-buckling&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;T1&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="nt">&quot;lower&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="nt">&quot;upper&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">75</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="nt">&quot;value&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">],</span><span class="w"></span>
<span class="w">        </span><span class="nt">&quot;output_variables&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">          </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="nt">&quot;component&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;parametric-plate-buckling&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;objective&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;mass&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="nt">&quot;value&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">          </span><span class="p">},</span><span class="w"></span>
<span class="w">          </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="nt">&quot;component&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;parametric-plate-buckling&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;constraint&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;buckling_factors&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="nt">&quot;value&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">              </span><span class="mi">0</span><span class="w"></span>
<span class="w">            </span><span class="p">],</span><span class="w"></span>
<span class="w">            </span><span class="nt">&quot;lower&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">0.95</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">],</span><span class="w"></span>
<span class="w">        </span><span class="nt">&quot;driver&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;optimisation&quot;</span><span class="w"></span>
<span class="w">        </span><span class="p">},</span><span class="w"></span>
<span class="w">        </span><span class="nt">&quot;visualise&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">          </span><span class="s2">&quot;n2_diagram&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">          </span><span class="s2">&quot;plot_history&quot;</span><span class="w"></span>
<span class="w">        </span><span class="p">]</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">],</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;connections&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;workflow&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;start&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;parametric-plate-buckling&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;end&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;parametric-plate-buckling&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;driver&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;open-mdao&quot;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
</details><p>The question marks next to the component names indicate that they are missing some data.
To fully define them, we need to upload all the components’ <code class="docutils literal notranslate"><span class="pre">setup.py</span></code>, <code class="docutils literal notranslate"><span class="pre">compute.py</span></code>, <code class="docutils literal notranslate"><span class="pre">requirements.txt</span></code> and user input files, as described in the next sections.</p>
</section>
<section id="update-the-plate-component">
<h3>Update the plate component<a class="headerlink" href="#update-the-plate-component" title="Permalink to this headline">#</a></h3>
<p>The parametric plate component performs 3 main tasks:</p>
<ol class="simple">
<li><p>It creates a set of analysis input files from the component parameters and design variable inputs;</p></li>
<li><p>It executes a CalculiX CrunchiX finite element analysis;</p></li>
<li><p>It then reads the analysis outputs and returns the model mass and buckling load factors as component outputs.</p></li>
</ol>
<p>To achieve the first task, we first use CalculiX GraphiX to create the plate 2D geometry and mesh this using second order S8 elements.
This 2D mesh is then used to extrude solid elements for each composite ply.
The extrusion thickness at each node is calculated from the local RTS shearing angle, which is linearly interpolated from the two closest control point values (determined by projecting the node onto the line of control points).</p>
<p>Note that this analysis workflow could be generalised by splitting it up into 3 components, one for each task.</p>
<p>To update the parametric plate component:</p>
<ul class="simple">
<li><p>Select the component in the workspace to edit it.</p></li>
<li><p>Copy the contents of the <code class="docutils literal notranslate"><span class="pre">setup.py</span></code>, <code class="docutils literal notranslate"><span class="pre">compute.py</span></code>, <code class="docutils literal notranslate"><span class="pre">requirements.txt</span></code> files from below into a text editor, save them locally.
Then upload them under the <code class="docutils literal notranslate"><span class="pre">Properties</span></code> tab.</p></li>
<li><p>Copy the contents of the <code class="docutils literal notranslate"><span class="pre">ccx_compression_buckle.inp</span></code> file from below into a text editor and save it locally.
Then upload it under the <code class="docutils literal notranslate"><span class="pre">Parameters</span></code> tab by selecting <code class="docutils literal notranslate"><span class="pre">upload</span> <span class="pre">user</span> <span class="pre">input</span> <span class="pre">files</span></code>.
The other parameters, inputs and outputs should have been pre-populated by loading the session file in the previous section.</p></li>
<li><p>Select <code class="docutils literal notranslate"><span class="pre">Save</span> <span class="pre">data</span></code> to save and close the component.</p></li>
</ul>
<div class="sd-tab-set docutils">
<input checked="checked" id="283d432b-5d0d-4edb-a68f-d3c2b838742f" name="2ae2c9aa-5009-4957-966a-cca78b0f0d81" type="radio">
</input><label class="sd-tab-label" for="283d432b-5d0d-4edb-a68f-d3c2b838742f">
setup</label><div class="sd-tab-content docutils">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>


<span class="k">def</span> <span class="nf">setup</span><span class="p">(</span>
    <span class="n">inputs</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;design&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;implicit&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;setup&quot;</span><span class="p">:</span> <span class="p">{}},</span>
    <span class="n">outputs</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;design&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;implicit&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;setup&quot;</span><span class="p">:</span> <span class="p">{}},</span>
    <span class="n">parameters</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;user_input_files&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s2">&quot;inputs_folder_path&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;outputs_folder_path&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="p">},</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Editable setup function.&quot;&quot;&quot;</span>

    <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">-%H%M%S&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">: Setup completed.&quot;</span>

    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="n">message</span><span class="p">}</span>
</pre></div>
</div>
</div>
<input id="531f1117-71ad-4e9c-b6e8-4b666b859701" name="2ae2c9aa-5009-4957-966a-cca78b0f0d81" type="radio">
</input><label class="sd-tab-label" for="531f1117-71ad-4e9c-b6e8-4b666b859701">
compute</label><div class="sd-tab-content docutils">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot; Create a 3D element mesh for the RTS panel buckling analysis. &quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">shutil</span> <span class="kn">import</span> <span class="n">copy2</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">sqrt</span><span class="p">,</span> <span class="n">floor</span><span class="p">,</span> <span class="n">ceil</span><span class="p">,</span> <span class="n">cos</span><span class="p">,</span> <span class="n">sin</span><span class="p">,</span> <span class="n">radians</span><span class="p">,</span> <span class="n">log10</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">itertools</span>

<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">wraps</span>
<span class="kn">from</span> <span class="nn">contextlib</span> <span class="kn">import</span> <span class="n">redirect_stdout</span>

<span class="kn">from</span> <span class="nn">calculix</span> <span class="kn">import</span> <span class="n">execute_cgx</span><span class="p">,</span> <span class="n">execute_fea</span>

<span class="n">PARAMS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;length_x&quot;</span><span class="p">:</span> <span class="mf">1.250</span><span class="p">,</span>
    <span class="s2">&quot;width_y&quot;</span><span class="p">:</span> <span class="mf">0.75</span><span class="p">,</span>
    <span class="s2">&quot;split_at_x&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.25</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">],</span>
    <span class="s2">&quot;split_at_y&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">],</span>
    <span class="s2">&quot;boundary_conditions&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;fixed_y0&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;lines&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="s2">&quot;SPC&quot;</span><span class="p">:</span> <span class="s2">&quot;23&quot;</span><span class="p">},</span>
        <span class="s2">&quot;fixed_x0&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;lines&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">],</span> <span class="s2">&quot;SPC&quot;</span><span class="p">:</span> <span class="s2">&quot;13&quot;</span><span class="p">},</span>
        <span class="s2">&quot;support_z&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;lines&quot;</span><span class="p">:</span> <span class="nb">range</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">24</span><span class="p">),</span>
            <span class="s2">&quot;SPC&quot;</span><span class="p">:</span> <span class="s2">&quot;3&quot;</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s2">&quot;support_ymax&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;lines&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">],</span>
            <span class="s2">&quot;kinematic&quot;</span><span class="p">:</span> <span class="s2">&quot;23&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ref_node_SPC&quot;</span><span class="p">:</span> <span class="s2">&quot;346&quot;</span><span class="p">,</span>
            <span class="s2">&quot;surface_vector&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span>
        <span class="p">},</span>
        <span class="s2">&quot;loaded_xmax&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;lines&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span>
            <span class="s2">&quot;kinematic&quot;</span><span class="p">:</span> <span class="s2">&quot;13&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ref_node_SPC&quot;</span><span class="p">:</span> <span class="s2">&quot;356&quot;</span><span class="p">,</span>
            <span class="s2">&quot;surface_vector&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span>
            <span class="s2">&quot;ref_node_forces&quot;</span><span class="p">:</span> <span class="p">[</span><span class="o">-</span><span class="mf">10000.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span>
        <span class="p">},</span>
    <span class="p">},</span>
    <span class="s2">&quot;edge_length&quot;</span><span class="p">:</span> <span class="mf">0.025</span><span class="p">,</span>
    <span class="s2">&quot;material&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;E1&quot;</span><span class="p">:</span> <span class="mf">163.0e9</span><span class="p">,</span>
        <span class="s2">&quot;E2&quot;</span><span class="p">:</span> <span class="mf">12.0e9</span><span class="p">,</span>
        <span class="s2">&quot;nu12&quot;</span><span class="p">:</span> <span class="mf">0.3</span><span class="p">,</span>
        <span class="s2">&quot;G12&quot;</span><span class="p">:</span> <span class="mf">5.0e9</span><span class="p">,</span>
        <span class="s2">&quot;thickness&quot;</span><span class="p">:</span> <span class="mf">0.000125</span><span class="p">,</span>
        <span class="s2">&quot;density&quot;</span><span class="p">:</span> <span class="mf">1571.0</span><span class="p">,</span>
        <span class="s2">&quot;tape_width&quot;</span><span class="p">:</span> <span class="mf">0.100</span><span class="p">,</span>
        <span class="s2">&quot;stress_allowables&quot;</span><span class="p">:</span> <span class="p">{},</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;IM7_8552&quot;</span><span class="p">,</span>
        <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot; Units are: kg, m; data from Groh_2015.&quot;</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="s2">&quot;plies&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="s2">&quot;combine_plus_minus_plies&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;control_pts&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span><span class="s2">&quot;d&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.01</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;T1&quot;</span><span class="p">,</span> <span class="s2">&quot;inc_angle&quot;</span><span class="p">:</span> <span class="mi">69</span><span class="p">},</span>
                <span class="p">{</span><span class="s2">&quot;d&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;T1&quot;</span><span class="p">,</span> <span class="s2">&quot;inc_angle&quot;</span><span class="p">:</span> <span class="mi">69</span><span class="p">},</span>
                <span class="p">{</span><span class="s2">&quot;d&quot;</span><span class="p">:</span> <span class="mf">0.125</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;T0&quot;</span><span class="p">,</span> <span class="s2">&quot;inc_angle&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span>
                <span class="p">{</span><span class="s2">&quot;d&quot;</span><span class="p">:</span> <span class="mf">0.25</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;T1&quot;</span><span class="p">,</span> <span class="s2">&quot;inc_angle&quot;</span><span class="p">:</span> <span class="mi">69</span><span class="p">},</span>
                <span class="p">{</span><span class="s2">&quot;d&quot;</span><span class="p">:</span> <span class="mf">0.375</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;T0&quot;</span><span class="p">,</span> <span class="s2">&quot;inc_angle&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span>
                <span class="p">{</span><span class="s2">&quot;d&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;T1&quot;</span><span class="p">,</span> <span class="s2">&quot;inc_angle&quot;</span><span class="p">:</span> <span class="mi">69</span><span class="p">},</span>
                <span class="p">{</span><span class="s2">&quot;d&quot;</span><span class="p">:</span> <span class="mf">0.625</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;T0&quot;</span><span class="p">,</span> <span class="s2">&quot;inc_angle&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span>
                <span class="p">{</span><span class="s2">&quot;d&quot;</span><span class="p">:</span> <span class="mf">0.75</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;T1&quot;</span><span class="p">,</span> <span class="s2">&quot;inc_angle&quot;</span><span class="p">:</span> <span class="mi">69</span><span class="p">},</span>
                <span class="p">{</span><span class="s2">&quot;d&quot;</span><span class="p">:</span> <span class="mf">0.76</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;T1&quot;</span><span class="p">,</span> <span class="s2">&quot;inc_angle&quot;</span><span class="p">:</span> <span class="mi">69</span><span class="p">},</span>
            <span class="p">],</span>
            <span class="s2">&quot;path_end&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.75</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
            <span class="s2">&quot;path_start&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
            <span class="s2">&quot;ply_ref_angle&quot;</span><span class="p">:</span> <span class="mi">90</span><span class="p">,</span>
            <span class="s2">&quot;ply_ref_thickness_multiplier&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;combine_plus_minus_plies&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;control_pts&quot;</span><span class="p">:</span> <span class="p">[{</span><span class="s2">&quot;d&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.01</span><span class="p">,</span> <span class="s2">&quot;inc_angle&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="s2">&quot;d&quot;</span><span class="p">:</span> <span class="mf">0.76</span><span class="p">,</span> <span class="s2">&quot;inc_angle&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}],</span>
            <span class="s2">&quot;path_end&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.75</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
            <span class="s2">&quot;path_start&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
            <span class="s2">&quot;ply_ref_angle&quot;</span><span class="p">:</span> <span class="mi">90</span><span class="p">,</span>
            <span class="s2">&quot;ply_ref_thickness_multiplier&quot;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;combine_plus_minus_plies&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;control_pts&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span><span class="s2">&quot;d&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.01</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;T1&quot;</span><span class="p">,</span> <span class="s2">&quot;inc_angle&quot;</span><span class="p">:</span> <span class="mi">69</span><span class="p">},</span>
                <span class="p">{</span><span class="s2">&quot;d&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;T1&quot;</span><span class="p">,</span> <span class="s2">&quot;inc_angle&quot;</span><span class="p">:</span> <span class="mi">69</span><span class="p">},</span>
                <span class="p">{</span><span class="s2">&quot;d&quot;</span><span class="p">:</span> <span class="mf">0.125</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;T0&quot;</span><span class="p">,</span> <span class="s2">&quot;inc_angle&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span>
                <span class="p">{</span><span class="s2">&quot;d&quot;</span><span class="p">:</span> <span class="mf">0.25</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;T1&quot;</span><span class="p">,</span> <span class="s2">&quot;inc_angle&quot;</span><span class="p">:</span> <span class="mi">69</span><span class="p">},</span>
                <span class="p">{</span><span class="s2">&quot;d&quot;</span><span class="p">:</span> <span class="mf">0.375</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;T0&quot;</span><span class="p">,</span> <span class="s2">&quot;inc_angle&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span>
                <span class="p">{</span><span class="s2">&quot;d&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;T1&quot;</span><span class="p">,</span> <span class="s2">&quot;inc_angle&quot;</span><span class="p">:</span> <span class="mi">69</span><span class="p">},</span>
                <span class="p">{</span><span class="s2">&quot;d&quot;</span><span class="p">:</span> <span class="mf">0.625</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;T0&quot;</span><span class="p">,</span> <span class="s2">&quot;inc_angle&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span>
                <span class="p">{</span><span class="s2">&quot;d&quot;</span><span class="p">:</span> <span class="mf">0.75</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;T1&quot;</span><span class="p">,</span> <span class="s2">&quot;inc_angle&quot;</span><span class="p">:</span> <span class="mi">69</span><span class="p">},</span>
                <span class="p">{</span><span class="s2">&quot;d&quot;</span><span class="p">:</span> <span class="mf">0.76</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;T1&quot;</span><span class="p">,</span> <span class="s2">&quot;inc_angle&quot;</span><span class="p">:</span> <span class="mi">69</span><span class="p">},</span>
            <span class="p">],</span>
            <span class="s2">&quot;path_end&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.75</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
            <span class="s2">&quot;path_start&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
            <span class="s2">&quot;ply_ref_angle&quot;</span><span class="p">:</span> <span class="mi">90</span><span class="p">,</span>
            <span class="s2">&quot;ply_ref_thickness_multiplier&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">],</span>
    <span class="s2">&quot;mesh_files&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;mesh&quot;</span><span class="p">:</span> <span class="s2">&quot;all.msh&quot;</span><span class="p">,</span>
        <span class="s2">&quot;solid_mesh&quot;</span><span class="p">:</span> <span class="s2">&quot;solid_mesh.inp&quot;</span><span class="p">,</span>
        <span class="s2">&quot;materials&quot;</span><span class="p">:</span> <span class="s2">&quot;materials.inp&quot;</span><span class="p">,</span>
        <span class="s2">&quot;element_sets&quot;</span><span class="p">:</span> <span class="s2">&quot;element_sets.inp&quot;</span><span class="p">,</span>
        <span class="s2">&quot;solid_sections&quot;</span><span class="p">:</span> <span class="s2">&quot;solid_sections.inp&quot;</span><span class="p">,</span>
        <span class="s2">&quot;node_sets&quot;</span><span class="p">:</span> <span class="s2">&quot;node_sets.inp&quot;</span><span class="p">,</span>
        <span class="s2">&quot;surfaces&quot;</span><span class="p">:</span> <span class="s2">&quot;surfaces.inp&quot;</span><span class="p">,</span>
        <span class="s2">&quot;constraints&quot;</span><span class="p">:</span> <span class="s2">&quot;constraints.inp&quot;</span><span class="p">,</span>
        <span class="s2">&quot;loads&quot;</span><span class="p">:</span> <span class="s2">&quot;loads.inp&quot;</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="s2">&quot;analysis_file&quot;</span><span class="p">:</span> <span class="s2">&quot;ccx_compression_buckle.inp&quot;</span><span class="p">,</span>
    <span class="s2">&quot;number_of_modes&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
    <span class="s2">&quot;user_input_files&quot;</span><span class="p">:</span> <span class="p">[],</span>
    <span class="s2">&quot;inputs_folder_path&quot;</span><span class="p">:</span> <span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span>
    <span class="s2">&quot;outputs_folder_path&quot;</span><span class="p">:</span> <span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="s2">&quot;outputs&quot;</span><span class="p">,</span>
<span class="p">}</span>


<span class="k">def</span> <span class="nf">timeit</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="nd">@wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">wrapper_timer</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">tic</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">toc</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
        <span class="n">elapsed_time</span> <span class="o">=</span> <span class="n">toc</span> <span class="o">-</span> <span class="n">tic</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Elapsed time for function &#39;</span><span class="si">{</span><span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">elapsed_time</span><span class="si">:</span><span class="s2">0.4f</span><span class="si">}</span><span class="s2"> seconds&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">value</span>

    <span class="k">return</span> <span class="n">wrapper_timer</span>


<span class="k">def</span> <span class="nf">compute</span><span class="p">(</span>
    <span class="n">inputs</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;design&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;implicit&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;setup&quot;</span><span class="p">:</span> <span class="p">{}},</span>
    <span class="n">outputs</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;design&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;implicit&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;setup&quot;</span><span class="p">:</span> <span class="p">{}},</span>
    <span class="n">partials</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{},</span>
    <span class="n">options</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{},</span>
    <span class="n">parameters</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;user_input_files&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s2">&quot;inputs_folder_path&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;outputs_folder_path&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="p">},</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>

    <span class="sd">&quot;&quot;&quot;Editable compute function.&quot;&quot;&quot;</span>
    <span class="n">run_folder</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;outputs_folder_path&quot;</span><span class="p">])</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">run_folder</span> <span class="o">/</span> <span class="s2">&quot;run.log&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">redirect_stdout</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="n">main</span><span class="p">(</span>
                <span class="n">inputs</span><span class="o">=</span><span class="n">inputs</span><span class="p">,</span>
                <span class="n">outputs</span><span class="o">=</span><span class="n">outputs</span><span class="p">,</span>
                <span class="n">partials</span><span class="o">=</span><span class="n">partials</span><span class="p">,</span>
                <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">,</span>
                <span class="n">parameters</span><span class="o">=</span><span class="n">parameters</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="k">return</span> <span class="n">resp</span>


<span class="k">def</span> <span class="nf">main</span><span class="p">(</span>
    <span class="n">inputs</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;design&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;implicit&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;setup&quot;</span><span class="p">:</span> <span class="p">{}},</span>
    <span class="n">outputs</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;design&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;implicit&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;setup&quot;</span><span class="p">:</span> <span class="p">{}},</span>
    <span class="n">partials</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{},</span>
    <span class="n">options</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{},</span>
    <span class="n">parameters</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;user_input_files&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s2">&quot;inputs_folder_path&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;outputs_folder_path&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="p">},</span>
<span class="p">):</span>

    <span class="n">inputs_folder</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;inputs_folder_path&quot;</span><span class="p">])</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">inputs_folder</span> <span class="o">/</span> <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;analysis_file&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;analysis_file&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> needs to be uploaded by the user.&quot;</span>
        <span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Starting user function evaluation.&quot;</span><span class="p">)</span>

    <span class="n">run_folder</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;outputs_folder_path&quot;</span><span class="p">])</span>

    <span class="c1"># set design variables</span>
    <span class="k">if</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;design&quot;</span><span class="p">]:</span>
        <span class="n">update_parameters_with_inputs</span><span class="p">(</span><span class="n">parameters</span><span class="p">,</span> <span class="n">inputs</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Applied design inputs.&quot;</span><span class="p">)</span>

    <span class="c1"># 1) Define a 2D mould surfaces in CGX and generate the 2D mesh</span>
    <span class="n">cgx_input_file</span> <span class="o">=</span> <span class="n">get_geometry</span><span class="p">(</span>
        <span class="n">length_x</span><span class="o">=</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;length_x&quot;</span><span class="p">],</span>
        <span class="n">width_y</span><span class="o">=</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;width_y&quot;</span><span class="p">],</span>
        <span class="n">split_at_x</span><span class="o">=</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;split_at_x&quot;</span><span class="p">],</span>
        <span class="n">split_at_y</span><span class="o">=</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;split_at_y&quot;</span><span class="p">],</span>
        <span class="n">boundary_conditions</span><span class="o">=</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;boundary_conditions&quot;</span><span class="p">],</span>
        <span class="n">edge_length</span><span class="o">=</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;edge_length&quot;</span><span class="p">],</span>
        <span class="n">run_folder</span><span class="o">=</span><span class="n">run_folder</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="n">execute_cgx</span><span class="p">(</span><span class="n">infile</span><span class="o">=</span><span class="n">cgx_input_file</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">run_folder</span><span class="o">=</span><span class="n">run_folder</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">run_folder</span> <span class="o">/</span> <span class="s2">&quot;cgx.log&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">resp</span><span class="p">[</span><span class="s2">&quot;stdout&quot;</span><span class="p">])</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">resp</span><span class="p">[</span><span class="s2">&quot;returncode&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ChildProcessError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;cgx returned non-zero exit status </span><span class="si">{</span><span class="n">resp</span><span class="p">[</span><span class="s2">&quot;returncode&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="p">)</span>

    <span class="c1"># read the 2D mesh from CGX output file</span>
    <span class="n">elements</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">constraints</span> <span class="o">=</span> <span class="n">get_2Dmesh</span><span class="p">(</span>
        <span class="n">mesh_files</span><span class="o">=</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;mesh_files&quot;</span><span class="p">],</span>
        <span class="n">run_folder</span><span class="o">=</span><span class="n">run_folder</span><span class="p">,</span>
        <span class="n">bcs</span><span class="o">=</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;boundary_conditions&quot;</span><span class="p">],</span>
    <span class="p">)</span>

    <span class="c1"># 2) Calculate the element normals, and then the node normal</span>
    <span class="n">corner_nodes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">set_element_normals</span><span class="p">(</span><span class="n">elements</span><span class="o">=</span><span class="n">elements</span><span class="p">,</span> <span class="n">nodes</span><span class="o">=</span><span class="n">nodes</span><span class="p">,</span> <span class="n">corner_nodes</span><span class="o">=</span><span class="n">corner_nodes</span><span class="p">)</span>
    <span class="n">set_node_normals</span><span class="p">(</span><span class="n">nodes</span><span class="o">=</span><span class="n">nodes</span><span class="p">,</span> <span class="n">elements</span><span class="o">=</span><span class="n">elements</span><span class="p">)</span>

    <span class="c1"># 3) Offset the 2D mesh nodes by local thickness distribution for each laminate substack</span>
    <span class="n">nid_offset</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">**</span> <span class="n">ceil</span><span class="p">(</span><span class="n">log10</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">nodes</span><span class="o">.</span><span class="n">keys</span><span class="p">())))</span>
    <span class="n">eid_offset</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">**</span> <span class="n">ceil</span><span class="p">(</span><span class="n">log10</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">elements</span><span class="o">.</span><span class="n">keys</span><span class="p">())))</span>

    <span class="n">materials</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">element_sets</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">set_name_format</span> <span class="o">=</span> <span class="s2">&quot;P</span><span class="si">{:d}</span><span class="s2">_A</span><span class="si">{:.3f}</span><span class="s2">&quot;</span>
    <span class="k">for</span> <span class="n">plyid</span><span class="p">,</span> <span class="n">ply</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;plies&quot;</span><span class="p">]):</span>
        <span class="c1"># define functions to interpolate rts ply local properties</span>
        <span class="n">f_inc_angle</span><span class="p">,</span> <span class="n">f_thickness</span><span class="p">,</span> <span class="n">upath</span> <span class="o">=</span> <span class="n">get_rts_distributions</span><span class="p">(</span>
            <span class="n">ply</span><span class="p">,</span> <span class="n">ref_thickness</span><span class="o">=</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;material&quot;</span><span class="p">][</span><span class="s2">&quot;thickness&quot;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">offset_nodes</span><span class="p">(</span>
            <span class="n">plyid</span><span class="p">,</span>
            <span class="n">nodes</span><span class="p">,</span>
            <span class="n">constraints</span><span class="p">,</span>
            <span class="n">f_inc_angle</span><span class="p">,</span>
            <span class="n">f_thickness</span><span class="p">,</span>
            <span class="n">upath</span><span class="p">,</span>
            <span class="n">set_of_corner_nodes</span><span class="o">=</span><span class="n">corner_nodes</span><span class="p">,</span>
            <span class="n">start</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ply</span><span class="p">[</span><span class="s2">&quot;path_start&quot;</span><span class="p">]),</span>
            <span class="n">nid_offset</span><span class="o">=</span><span class="n">nid_offset</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># 4) create 3D elements from 2D mesh and offset nodes</span>
        <span class="n">offset_elements</span><span class="p">(</span>
            <span class="n">plyid</span><span class="p">,</span>
            <span class="n">elements</span><span class="p">,</span>
            <span class="n">element_sets</span><span class="p">,</span>
            <span class="n">constraints</span><span class="p">,</span>
            <span class="n">f_inc_angle</span><span class="p">,</span>
            <span class="n">f_thickness</span><span class="p">,</span>
            <span class="n">upath</span><span class="p">,</span>
            <span class="n">start</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ply</span><span class="p">[</span><span class="s2">&quot;path_start&quot;</span><span class="p">]),</span>
            <span class="n">eid_offset</span><span class="o">=</span><span class="n">eid_offset</span><span class="p">,</span>
            <span class="n">nid_offset</span><span class="o">=</span><span class="n">nid_offset</span><span class="p">,</span>
            <span class="n">nodes</span><span class="o">=</span><span class="n">nodes</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># 5) calculate the local material properties for each group of elements from the reference angle and shearing angles</span>
        <span class="n">set_materials</span><span class="p">(</span>
            <span class="n">plyid</span><span class="p">,</span>
            <span class="n">materials</span><span class="p">,</span>
            <span class="nb">list</span><span class="p">(</span><span class="n">element_sets</span><span class="p">[</span><span class="n">plyid</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
            <span class="n">ply</span><span class="p">,</span>
            <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;material&quot;</span><span class="p">],</span>
            <span class="n">nformat</span><span class="o">=</span><span class="n">set_name_format</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="c1"># calculate reference node positions for the kinematic constraints</span>
    <span class="n">update_kinematic_constraints_ref_nodes</span><span class="p">(</span>
        <span class="n">constraints</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="n">nid_offset</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;plies&quot;</span><span class="p">])</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="c1"># calculate the plate mass from elements</span>
    <span class="n">volume</span> <span class="o">=</span> <span class="n">get_volume</span><span class="p">(</span><span class="n">elements</span><span class="p">)</span>
    <span class="n">mass</span> <span class="o">=</span> <span class="n">volume</span> <span class="o">*</span> <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;material&quot;</span><span class="p">][</span><span class="s2">&quot;density&quot;</span><span class="p">]</span>

    <span class="c1"># 6) output the mesh to file</span>
    <span class="n">fname</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;mesh_files&quot;</span><span class="p">]</span>
    <span class="n">write_solid_mesh</span><span class="p">(</span><span class="n">nodes</span><span class="p">,</span> <span class="n">elements</span><span class="p">,</span> <span class="n">run_folder</span><span class="o">=</span><span class="n">run_folder</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">fname</span><span class="p">[</span><span class="s2">&quot;solid_mesh&quot;</span><span class="p">])</span>
    <span class="n">write_materials</span><span class="p">(</span><span class="n">materials</span><span class="p">,</span> <span class="n">run_folder</span><span class="o">=</span><span class="n">run_folder</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">fname</span><span class="p">[</span><span class="s2">&quot;materials&quot;</span><span class="p">])</span>
    <span class="n">write_element_sets</span><span class="p">(</span>
        <span class="n">element_sets</span><span class="p">,</span> <span class="n">set_name_format</span><span class="p">,</span> <span class="n">run_folder</span><span class="o">=</span><span class="n">run_folder</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">fname</span><span class="p">[</span><span class="s2">&quot;element_sets&quot;</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="n">write_solid_sections</span><span class="p">(</span>
        <span class="n">materials</span><span class="p">,</span> <span class="n">set_name_format</span><span class="p">,</span> <span class="n">run_folder</span><span class="o">=</span><span class="n">run_folder</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">fname</span><span class="p">[</span><span class="s2">&quot;solid_sections&quot;</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="n">write_node_sets</span><span class="p">(</span><span class="n">constraints</span><span class="p">,</span> <span class="n">run_folder</span><span class="o">=</span><span class="n">run_folder</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">fname</span><span class="p">[</span><span class="s2">&quot;node_sets&quot;</span><span class="p">])</span>
    <span class="n">write_surface</span><span class="p">(</span><span class="n">constraints</span><span class="p">,</span> <span class="n">run_folder</span><span class="o">=</span><span class="n">run_folder</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">fname</span><span class="p">[</span><span class="s2">&quot;surfaces&quot;</span><span class="p">])</span>
    <span class="n">write_constraints</span><span class="p">(</span><span class="n">constraints</span><span class="p">,</span> <span class="n">run_folder</span><span class="o">=</span><span class="n">run_folder</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">fname</span><span class="p">[</span><span class="s2">&quot;constraints&quot;</span><span class="p">])</span>
    <span class="n">write_loading</span><span class="p">(</span><span class="n">constraints</span><span class="p">,</span> <span class="n">run_folder</span><span class="o">=</span><span class="n">run_folder</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">fname</span><span class="p">[</span><span class="s2">&quot;loads&quot;</span><span class="p">])</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Created CCX solid mesh files.&quot;</span><span class="p">)</span>

    <span class="c1"># 7) Perform ccx FEM analysis</span>
    <span class="n">infile</span> <span class="o">=</span> <span class="n">copy2</span><span class="p">(</span>
        <span class="n">inputs_folder</span> <span class="o">/</span> <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;analysis_file&quot;</span><span class="p">],</span>
        <span class="n">run_folder</span> <span class="o">/</span> <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;analysis_file&quot;</span><span class="p">],</span>
    <span class="p">)</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="n">execute_fea</span><span class="p">(</span><span class="n">infile</span><span class="o">.</span><span class="n">stem</span><span class="p">,</span> <span class="n">run_folder</span><span class="o">=</span><span class="n">run_folder</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">run_folder</span> <span class="o">/</span> <span class="s2">&quot;ccx.log&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">resp</span><span class="p">[</span><span class="s2">&quot;stdout&quot;</span><span class="p">])</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">resp</span><span class="p">[</span><span class="s2">&quot;returncode&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ChildProcessError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;ccx returned non-zero exit status </span><span class="si">{</span><span class="n">resp</span><span class="p">[</span><span class="s2">&quot;returncode&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="p">)</span>

    <span class="c1"># check output has been saved</span>
    <span class="n">outfile</span> <span class="o">=</span> <span class="n">run_folder</span> <span class="o">/</span> <span class="p">(</span><span class="n">infile</span><span class="o">.</span><span class="n">stem</span> <span class="o">+</span> <span class="s2">&quot;.dat&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">outfile</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">outfile</span><span class="p">)</span><span class="si">}</span><span class="s2"> is not a file.&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Executed CCX FEM analysis.&quot;</span><span class="p">)</span>

    <span class="n">buckling_factors</span> <span class="o">=</span> <span class="n">get_buckling_factors</span><span class="p">(</span>
        <span class="n">outfile</span><span class="p">,</span> <span class="n">number_modes</span><span class="o">=</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;number_of_modes&quot;</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;design&quot;</span><span class="p">][</span><span class="s2">&quot;mass&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mass</span>
    <span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;design&quot;</span><span class="p">][</span><span class="s2">&quot;buckling_factors&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">buckling_factors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">-%H%M%S&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">: Executed Calculix finite element analysis.&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="n">message</span><span class="p">,</span> <span class="s2">&quot;outputs&quot;</span><span class="p">:</span> <span class="n">outputs</span><span class="p">}</span>


<span class="nd">@timeit</span>
<span class="k">def</span> <span class="nf">update_parameters_with_inputs</span><span class="p">(</span><span class="n">parameters</span><span class="p">,</span> <span class="n">inputs</span><span class="p">):</span>
    <span class="n">input_data</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;design&quot;</span><span class="p">]</span>  <span class="c1"># [&quot;ply-ctrl_pt_id-inc_angle&quot;: value, ]</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">input_data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;T0&quot;</span><span class="p">,</span> <span class="s2">&quot;T1&quot;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Input key should be one of &quot;T0&quot;, &quot;T1&quot;&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ply</span> <span class="ow">in</span> <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;plies&quot;</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">pt</span> <span class="ow">in</span> <span class="n">ply</span><span class="p">[</span><span class="s2">&quot;control_pts&quot;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="s2">&quot;id&quot;</span> <span class="ow">in</span> <span class="n">pt</span> <span class="ow">and</span> <span class="n">pt</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">key</span><span class="p">:</span>
                    <span class="n">pt</span><span class="p">[</span><span class="s2">&quot;inc_angle&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
    <span class="k">return</span> <span class="kc">None</span>


<span class="nd">@timeit</span>
<span class="k">def</span> <span class="nf">get_geometry</span><span class="p">(</span>
    <span class="n">length_x</span><span class="p">,</span>
    <span class="n">width_y</span><span class="p">,</span>
    <span class="n">split_at_x</span><span class="p">,</span>
    <span class="n">split_at_y</span><span class="p">,</span>
    <span class="n">boundary_conditions</span><span class="p">,</span>
    <span class="n">edge_length</span><span class="p">,</span>
    <span class="n">fname</span><span class="o">=</span><span class="s2">&quot;cgx_2d_mesh.fdb&quot;</span><span class="p">,</span>
    <span class="n">run_folder</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>

    <span class="c1"># corner points 1-4</span>
    <span class="n">points</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span> <span class="p">[</span><span class="n">length_x</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span> <span class="p">[</span><span class="n">length_x</span><span class="p">,</span> <span class="n">width_y</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">width_y</span><span class="p">]]</span>

    <span class="c1"># side points</span>
    <span class="n">points</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="p">[</span><span class="n">split_at_x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mf">0.0</span><span class="p">],</span>
            <span class="p">[</span><span class="n">split_at_x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mf">0.0</span><span class="p">],</span>
            <span class="p">[</span><span class="n">length_x</span><span class="p">,</span> <span class="n">split_at_y</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
            <span class="p">[</span><span class="n">length_x</span><span class="p">,</span> <span class="n">split_at_y</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span>
            <span class="p">[</span><span class="n">split_at_x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">width_y</span><span class="p">],</span>
            <span class="p">[</span><span class="n">split_at_x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">width_y</span><span class="p">],</span>
            <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">split_at_y</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span>
            <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">split_at_y</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
        <span class="p">]</span>
    <span class="p">)</span>

    <span class="c1"># mid-panel nodes</span>
    <span class="n">points</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="p">[</span><span class="n">split_at_x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">split_at_y</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
            <span class="p">[</span><span class="n">split_at_x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">split_at_y</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
            <span class="p">[</span><span class="n">split_at_x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">split_at_y</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span>
            <span class="p">[</span><span class="n">split_at_x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">split_at_y</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span>
        <span class="p">]</span>
    <span class="p">)</span>
    <span class="c1"># all at z = 0</span>
    <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">points</span><span class="p">]</span>

    <span class="c1"># Lines 0 to 11 are the outside bounds defined by point indices</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span>  <span class="c1"># 0</span>
        <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span>
        <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
        <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">],</span>
        <span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">],</span>  <span class="c1"># 4</span>
        <span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
        <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">8</span><span class="p">],</span>
        <span class="p">[</span><span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">],</span>
        <span class="p">[</span><span class="mi">9</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>  <span class="c1"># 8</span>
        <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">10</span><span class="p">],</span>
        <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">],</span>
        <span class="p">[</span><span class="mi">11</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
    <span class="p">]</span>

    <span class="c1"># split lines 12 to 23 defined by point indices</span>
    <span class="n">lines</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">12</span><span class="p">],</span>  <span class="c1"># 12</span>
            <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">13</span><span class="p">],</span>
            <span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">13</span><span class="p">],</span>
            <span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="mi">14</span><span class="p">],</span>
            <span class="p">[</span><span class="mi">8</span><span class="p">,</span> <span class="mi">14</span><span class="p">],</span>  <span class="c1"># 16</span>
            <span class="p">[</span><span class="mi">9</span><span class="p">,</span> <span class="mi">15</span><span class="p">],</span>
            <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">15</span><span class="p">],</span>
            <span class="p">[</span><span class="mi">11</span><span class="p">,</span> <span class="mi">12</span><span class="p">],</span>
            <span class="p">[</span><span class="mi">12</span><span class="p">,</span> <span class="mi">13</span><span class="p">],</span>  <span class="c1"># 20</span>
            <span class="p">[</span><span class="mi">13</span><span class="p">,</span> <span class="mi">14</span><span class="p">],</span>
            <span class="p">[</span><span class="mi">14</span><span class="p">,</span> <span class="mi">15</span><span class="p">],</span>
            <span class="p">[</span><span class="mi">15</span><span class="p">,</span> <span class="mi">12</span><span class="p">],</span>
        <span class="p">]</span>
    <span class="p">)</span>
    <span class="c1"># add number of elements per edge</span>
    <span class="k">def</span> <span class="nf">nele</span><span class="p">(</span><span class="n">pt1</span><span class="p">,</span> <span class="n">pt2</span><span class="p">,</span> <span class="n">edge</span><span class="p">):</span>
        <span class="n">p1</span> <span class="o">=</span> <span class="n">points</span><span class="p">[</span><span class="n">pt1</span><span class="p">]</span>
        <span class="n">p2</span> <span class="o">=</span> <span class="n">points</span><span class="p">[</span><span class="n">pt2</span><span class="p">]</span>
        <span class="n">l</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">((</span><span class="n">p2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">p1</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">p2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">p1</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">p2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">p1</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">floor</span><span class="p">(</span><span class="n">l</span> <span class="o">/</span> <span class="n">edge</span><span class="p">)</span>

    <span class="p">[</span><span class="n">line</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nele</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">edge_length</span><span class="p">))</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">]</span>

    <span class="c1"># surfaces defined by line indices (negative for direction reversal)</span>
    <span class="n">surfaces</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="o">-</span><span class="mi">19</span><span class="p">,</span> <span class="mi">11</span><span class="p">],</span>
        <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="o">-</span><span class="mi">20</span><span class="p">,</span> <span class="o">-</span><span class="mi">12</span><span class="p">],</span>
        <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="o">-</span><span class="mi">13</span><span class="p">],</span>
        <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="o">-</span><span class="mi">21</span><span class="p">,</span> <span class="o">-</span><span class="mi">14</span><span class="p">],</span>
        <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="o">-</span><span class="mi">15</span><span class="p">],</span>
        <span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="o">-</span><span class="mi">22</span><span class="p">,</span> <span class="o">-</span><span class="mi">16</span><span class="p">],</span>
        <span class="p">[</span><span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="o">-</span><span class="mi">17</span><span class="p">],</span>
        <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="o">-</span><span class="mi">23</span><span class="p">,</span> <span class="o">-</span><span class="mi">18</span><span class="p">],</span>
        <span class="p">[</span><span class="mi">20</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">23</span><span class="p">],</span>
    <span class="p">]</span>

    <span class="n">commands</span> <span class="o">=</span> <span class="n">get_commands</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">lines</span><span class="p">,</span> <span class="n">surfaces</span><span class="p">,</span> <span class="n">boundary_conditions</span><span class="p">)</span>

    <span class="c1"># write string of commands to file</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">run_folder</span> <span class="o">/</span> <span class="n">fname</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">commands</span><span class="p">))</span>
    <span class="n">cgx_input_file</span> <span class="o">=</span> <span class="n">run_folder</span> <span class="o">/</span> <span class="n">fname</span>

    <span class="k">return</span> <span class="n">cgx_input_file</span>


<span class="k">def</span> <span class="nf">divide_chunks</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">l</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
    <span class="c1"># looping till length l</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">l</span><span class="p">),</span> <span class="n">n</span><span class="p">):</span>
        <span class="k">yield</span> <span class="n">l</span><span class="p">[</span><span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="n">n</span><span class="p">]</span>


<span class="nd">@timeit</span>
<span class="k">def</span> <span class="nf">get_commands</span><span class="p">(</span>
    <span class="n">points</span><span class="p">,</span>
    <span class="n">lines</span><span class="p">,</span>
    <span class="n">surfaces</span><span class="p">,</span>
    <span class="n">boundary_conditions</span><span class="p">,</span>
    <span class="n">max_entries_per_line</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span>
    <span class="n">cgx_ele_type</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>  <span class="c1"># s8 elements</span>
    <span class="n">nele_multiplier</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>  <span class="c1"># for s8 elements</span>
    <span class="n">merge_tol</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span>
    <span class="n">solver</span><span class="o">=</span><span class="s2">&quot;abq&quot;</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;create string of all cgx input commands&quot;&quot;&quot;</span>

    <span class="n">commands</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># points</span>
    <span class="k">for</span> <span class="n">entity_id</span><span class="p">,</span> <span class="n">point</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">points</span><span class="p">):</span>
        <span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;PNT P</span><span class="si">{</span><span class="n">entity_id</span><span class="si">:</span><span class="s2">05d</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">point</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">e</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">point</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">e</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">point</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">:</span><span class="s2">e</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="p">)</span>
    <span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;# =============== </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="c1"># lines</span>
    <span class="k">for</span> <span class="n">entity_id</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>  <span class="c1"># straight line</span>
            <span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;LINE L</span><span class="si">{</span><span class="n">entity_id</span><span class="si">:</span><span class="s2">05d</span><span class="si">}</span><span class="s2"> P</span><span class="si">{</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">05d</span><span class="si">}</span><span class="s2"> P</span><span class="si">{</span><span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">05d</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">line</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">nele_multiplier</span><span class="si">:</span><span class="s2">d</span><span class="si">}</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="p">)</span>
    <span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;# =============== </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="c1"># surfaces</span>
    <span class="k">for</span> <span class="n">entity_id</span><span class="p">,</span> <span class="n">surf</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">surfaces</span><span class="p">):</span>
        <span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;GSUR V</span><span class="si">{</span><span class="n">entity_id</span><span class="si">:</span><span class="s2">05d</span><span class="si">}</span><span class="s2"> + BLEND &quot;</span>
            <span class="o">+</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;+ L</span><span class="si">{</span><span class="n">line</span><span class="si">:</span><span class="s2">05d</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">line</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;- L</span><span class="si">{</span><span class="o">-</span><span class="n">line</span><span class="si">:</span><span class="s2">05d</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">surf</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="p">)</span>
    <span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;# =============== </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="c1"># SPC and load sets</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">bc</span> <span class="ow">in</span> <span class="n">boundary_conditions</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">divide_chunks</span><span class="p">(</span><span class="n">bc</span><span class="p">[</span><span class="s2">&quot;lines&quot;</span><span class="p">],</span> <span class="n">max_entries_per_line</span><span class="p">):</span>
            <span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;SETA </span><span class="si">{</span><span class="n">name</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2"> l &quot;</span>
                <span class="o">+</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;L</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="p">)</span><span class="si">:</span><span class="s2">05d</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">chunk</span><span class="p">])</span>
                <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="p">)</span>
    <span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;# =============== </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="c1"># surface meshes</span>
    <span class="k">for</span> <span class="n">entity_id</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">surfaces</span><span class="p">):</span>
        <span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;MSHP V</span><span class="si">{</span><span class="n">entity_id</span><span class="si">:</span><span class="s2">05d</span><span class="si">}</span><span class="s2"> s </span><span class="si">{</span><span class="n">cgx_ele_type</span><span class="si">:</span><span class="s2">d</span><span class="si">}</span><span class="s2"> 0 1.000000e+00</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;# =============== </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="c1"># custom export statement</span>
    <span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;mesh all</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;merg n all </span><span class="si">{</span><span class="n">merge_tol</span><span class="si">:</span><span class="s2">6f</span><span class="si">}</span><span class="s2"> &#39;nolock&#39;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;comp nodes d</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">bc</span> <span class="ow">in</span> <span class="n">boundary_conditions</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;comp </span><span class="si">{</span><span class="n">name</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2"> d</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># commands.append(f&quot;send {name.upper()} {solver} spc {bc[&#39;SPC&#39;]}\n&quot;)</span>
        <span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;send </span><span class="si">{</span><span class="n">name</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">solver</span><span class="si">}</span><span class="s2"> names</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;# =============== </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;send all </span><span class="si">{</span><span class="n">solver</span><span class="si">}</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;quit</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">commands</span>


<span class="nd">@timeit</span>
<span class="k">def</span> <span class="nf">get_2Dmesh</span><span class="p">(</span><span class="n">mesh_files</span><span class="p">,</span> <span class="n">run_folder</span><span class="p">,</span> <span class="n">bcs</span><span class="p">):</span>

    <span class="n">elements</span><span class="p">,</span> <span class="n">nodes</span> <span class="o">=</span> <span class="n">get_nodes_and_elements</span><span class="p">(</span><span class="n">run_folder</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">mesh_files</span><span class="p">[</span><span class="s2">&quot;mesh&quot;</span><span class="p">])</span>
    <span class="n">constraints</span> <span class="o">=</span> <span class="n">get_constraints</span><span class="p">(</span><span class="n">run_folder</span><span class="p">,</span> <span class="n">bcs</span><span class="o">=</span><span class="n">bcs</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">elements</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">constraints</span>


<span class="k">def</span> <span class="nf">get_nodes_and_elements</span><span class="p">(</span><span class="n">run_folder</span><span class="p">,</span> <span class="n">file</span><span class="p">):</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">run_folder</span> <span class="o">/</span> <span class="n">file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>

    <span class="n">read_nodes</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">read_elements</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">ele_type</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">nodes</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">elements</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;*NODE&quot;</span><span class="p">):</span>  <span class="c1"># all nodes in one set assumed</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;start reading nodes.&quot;</span><span class="p">)</span>
            <span class="n">read_nodes</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">read_elements</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">ele_type</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">continue</span>
        <span class="k">elif</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;*ELEMENT&quot;</span><span class="p">):</span>  <span class="c1"># all elements in one set assumed</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;start reading elements.&quot;</span><span class="p">)</span>
            <span class="n">read_nodes</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">read_elements</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">ele_type</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span> <span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="s2">&quot;=&quot;</span> <span class="ow">in</span> <span class="n">data</span>
            <span class="p">}[</span><span class="s2">&quot;TYPE&quot;</span><span class="p">]</span>
            <span class="k">continue</span>
        <span class="k">elif</span> <span class="n">read_nodes</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
            <span class="c1"># parse nodes into { ID: {&quot;global_xyz&quot;: [x,y,z]}}</span>
            <span class="n">nodes</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;global_xyz&quot;</span><span class="p">:</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]}</span>
        <span class="k">elif</span> <span class="n">read_elements</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
            <span class="c1"># parse elements into { ID: {&quot;type&quot;: S8, &quot;nodes&quot;: [1-8]}}</span>
            <span class="n">elements</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="n">ele_type</span><span class="p">,</span>
                <span class="s2">&quot;nodes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">:]],</span>
            <span class="p">}</span>

    <span class="k">return</span> <span class="n">elements</span><span class="p">,</span> <span class="n">nodes</span>


<span class="k">def</span> <span class="nf">get_constraints</span><span class="p">(</span><span class="n">run_folder</span><span class="p">,</span> <span class="n">bcs</span><span class="p">):</span>

    <span class="n">all_constrained_nodes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">get_constraint_starting_nodes</span><span class="p">(</span><span class="n">constraints</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">cname</span><span class="p">,</span> <span class="n">constraint</span> <span class="ow">in</span> <span class="n">constraints</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span>
                <span class="n">run_folder</span> <span class="o">/</span> <span class="p">(</span><span class="n">cname</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;.nam&quot;</span><span class="p">),</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span>
            <span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>

            <span class="n">read_nodes</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;*NSET&quot;</span><span class="p">):</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;start reading node set </span><span class="si">{</span><span class="n">cname</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
                    <span class="n">read_nodes</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">continue</span>
                <span class="k">elif</span> <span class="n">read_nodes</span><span class="p">:</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">all_constrained_nodes</span><span class="p">:</span>
                        <span class="n">constraint</span><span class="p">[</span><span class="s2">&quot;nodes&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                        <span class="n">all_constrained_nodes</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Node </span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="si">}</span><span class="s2"> is removed from constraint </span><span class="si">{</span><span class="n">cname</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2"> as it is already constrained.&quot;</span>
                        <span class="p">)</span>

    <span class="n">constraints</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;SPCs&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;kinematic_MPCs&quot;</span><span class="p">:</span> <span class="p">{}}</span>
    <span class="k">for</span> <span class="n">cname</span><span class="p">,</span> <span class="n">constraint</span> <span class="ow">in</span> <span class="n">bcs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>

        <span class="k">if</span> <span class="s2">&quot;SPC&quot;</span> <span class="ow">in</span> <span class="n">constraint</span><span class="p">:</span>
            <span class="n">ctype</span> <span class="o">=</span> <span class="s2">&quot;SPCs&quot;</span>
            <span class="n">constraints</span><span class="p">[</span><span class="n">ctype</span><span class="p">][</span><span class="n">cname</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;nodes&quot;</span><span class="p">:</span> <span class="nb">set</span><span class="p">(),</span> <span class="o">**</span><span class="n">constraint</span><span class="p">}</span>
        <span class="k">elif</span> <span class="s2">&quot;kinematic&quot;</span> <span class="ow">in</span> <span class="n">constraint</span><span class="p">:</span>
            <span class="n">ctype</span> <span class="o">=</span> <span class="s2">&quot;kinematic_MPCs&quot;</span>
            <span class="n">constraints</span><span class="p">[</span><span class="n">ctype</span><span class="p">][</span><span class="n">cname</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;nodes&quot;</span><span class="p">:</span> <span class="nb">set</span><span class="p">(),</span> <span class="s2">&quot;faces&quot;</span><span class="p">:</span> <span class="nb">set</span><span class="p">(),</span> <span class="o">**</span><span class="n">constraint</span><span class="p">}</span>

    <span class="c1"># get constraints in order to avoid over-constraining nodes where constraints overlap</span>
    <span class="n">get_constraint_starting_nodes</span><span class="p">(</span>
        <span class="n">constraints</span><span class="p">[</span><span class="s2">&quot;kinematic_MPCs&quot;</span><span class="p">]</span>
    <span class="p">)</span>  <span class="c1"># define face constraints first</span>
    <span class="n">get_constraint_starting_nodes</span><span class="p">(</span>
        <span class="n">constraints</span><span class="p">[</span><span class="s2">&quot;SPCs&quot;</span><span class="p">]</span>
    <span class="p">)</span>  <span class="c1"># exclude nodes in face constraints</span>

    <span class="k">return</span> <span class="n">constraints</span>


<span class="nd">@timeit</span>
<span class="k">def</span> <span class="nf">set_element_normals</span><span class="p">(</span><span class="n">elements</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">corner_nodes</span><span class="p">):</span>

    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">elements</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">centroid</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">nid</span> <span class="ow">in</span> <span class="n">element</span><span class="p">[</span><span class="s2">&quot;nodes&quot;</span><span class="p">]:</span>
            <span class="n">xyz</span> <span class="o">=</span> <span class="n">nodes</span><span class="p">[</span><span class="n">nid</span><span class="p">][</span><span class="s2">&quot;global_xyz&quot;</span><span class="p">]</span>
            <span class="n">centroid</span> <span class="o">=</span> <span class="p">[</span><span class="n">c1</span> <span class="o">+</span> <span class="n">c2</span> <span class="k">for</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">centroid</span><span class="p">,</span> <span class="n">xyz</span><span class="p">)]</span>
        <span class="n">centroid</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">element</span><span class="p">[</span><span class="s2">&quot;nodes&quot;</span><span class="p">])</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">centroid</span><span class="p">]</span>
        <span class="n">element</span><span class="p">[</span><span class="s2">&quot;global_xyz&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">centroid</span>

        <span class="c1">## TODO for each element normal is the average of the normals calculated at the elemnent nodes from the element edges ( sum of vectors / nb nodes)</span>
        <span class="c1"># (assume n = [0,0,1] for the flat panel)</span>
        <span class="n">element</span><span class="p">[</span><span class="s2">&quot;normal&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">element</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;S8&quot;</span><span class="p">:</span>
            <span class="n">corner_nodes</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">element</span><span class="p">[</span><span class="s2">&quot;nodes&quot;</span><span class="p">][:</span><span class="mi">4</span><span class="p">])</span>

    <span class="k">return</span> <span class="kc">None</span>


<span class="nd">@timeit</span>
<span class="k">def</span> <span class="nf">set_node_normals</span><span class="p">(</span><span class="n">nodes</span><span class="p">,</span> <span class="n">elements</span><span class="p">):</span>

    <span class="k">for</span> <span class="n">nid</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
        <span class="c1">## TODO for each node, find the connected elements and average normal at the node as sum of vectors / nb connected elements</span>
        <span class="c1"># (assume n = [0,0,1] for the flat panel)</span>
        <span class="n">nodes</span><span class="p">[</span><span class="n">nid</span><span class="p">][</span><span class="s2">&quot;normal&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]</span>

    <span class="k">return</span> <span class="kc">None</span>


<span class="k">def</span> <span class="nf">piecewise_linear_angle_interp</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">ranges</span><span class="p">,</span> <span class="n">ctrl_points</span><span class="p">):</span>
    <span class="n">f_angles</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">a0</span><span class="p">,</span> <span class="n">a1</span><span class="p">,</span> <span class="n">d0</span><span class="p">,</span> <span class="n">d1</span><span class="p">:</span> <span class="p">(</span><span class="n">a1</span> <span class="o">-</span> <span class="n">a0</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">d1</span> <span class="o">-</span> <span class="n">d0</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">d0</span><span class="p">)</span> <span class="o">+</span> <span class="n">a0</span>
    <span class="k">for</span> <span class="n">d</span><span class="p">,</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">ranges</span><span class="p">,</span> <span class="n">ctrl_points</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">x</span> <span class="o">&gt;=</span> <span class="n">d</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">d</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="k">return</span> <span class="n">f_angles</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;x value </span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s2"> is outside control point range.&quot;</span><span class="p">)</span>


<span class="nd">@timeit</span>
<span class="k">def</span> <span class="nf">get_rts_distributions</span><span class="p">(</span><span class="n">ply</span><span class="p">,</span> <span class="n">ref_thickness</span><span class="p">):</span>

    <span class="c1"># get path unit vector</span>
    <span class="n">upath</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ply</span><span class="p">[</span><span class="s2">&quot;path_end&quot;</span><span class="p">])</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ply</span><span class="p">[</span><span class="s2">&quot;path_start&quot;</span><span class="p">])</span>
    <span class="n">upath</span> <span class="o">=</span> <span class="n">upath</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">upath</span><span class="p">)</span>

    <span class="c1"># linear interpolation</span>
    <span class="n">ranges</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">ctrl_points</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">p0</span><span class="p">,</span> <span class="n">p1</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">ply</span><span class="p">[</span><span class="s2">&quot;control_pts&quot;</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">ply</span><span class="p">[</span><span class="s2">&quot;control_pts&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">:]):</span>
        <span class="n">ranges</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">p0</span><span class="p">[</span><span class="s2">&quot;d&quot;</span><span class="p">],</span> <span class="n">p1</span><span class="p">[</span><span class="s2">&quot;d&quot;</span><span class="p">]))</span>
        <span class="n">ctrl_points</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">p0</span><span class="p">[</span><span class="s2">&quot;inc_angle&quot;</span><span class="p">],</span> <span class="n">p1</span><span class="p">[</span><span class="s2">&quot;inc_angle&quot;</span><span class="p">]))</span>

    <span class="c1"># input to f_inc_angle is dot product of upath with vector from path start to node</span>
    <span class="n">f_inc_angle</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;f&quot;</span><span class="p">:</span> <span class="n">piecewise_linear_angle_interp</span><span class="p">,</span>
        <span class="s2">&quot;args&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">ranges</span><span class="p">,</span> <span class="n">ctrl_points</span><span class="p">],</span>
    <span class="p">}</span>
    <span class="n">f_thickness</span> <span class="o">=</span> <span class="p">(</span>
        <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">ply</span><span class="p">[</span><span class="s2">&quot;ply_ref_thickness_multiplier&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">ref_thickness</span> <span class="o">/</span> <span class="n">cos</span><span class="p">(</span><span class="n">radians</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">f_inc_angle</span><span class="p">,</span> <span class="n">f_thickness</span><span class="p">,</span> <span class="n">upath</span>


<span class="k">def</span> <span class="nf">project_to_point</span><span class="p">(</span><span class="n">xyz</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">upath</span><span class="p">,</span> <span class="n">f_inc_angle</span><span class="p">,</span> <span class="n">f_thickness</span><span class="p">):</span>
    <span class="n">vector2node</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">xyz</span><span class="p">)</span> <span class="o">-</span> <span class="n">start</span>
    <span class="n">projected_length</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">upath</span><span class="p">,</span> <span class="n">vector2node</span><span class="p">)</span>
    <span class="n">inc_angle</span> <span class="o">=</span> <span class="n">f_inc_angle</span><span class="p">[</span><span class="s2">&quot;f&quot;</span><span class="p">](</span><span class="n">projected_length</span><span class="p">,</span> <span class="o">*</span><span class="n">f_inc_angle</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">])</span>
    <span class="n">thickness</span> <span class="o">=</span> <span class="n">f_thickness</span><span class="p">(</span><span class="n">inc_angle</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;inc_angle&quot;</span><span class="p">:</span> <span class="n">inc_angle</span><span class="p">,</span> <span class="s2">&quot;thickness&quot;</span><span class="p">:</span> <span class="n">thickness</span><span class="p">}</span>


<span class="k">def</span> <span class="nf">offset_point_by_vector</span><span class="p">(</span><span class="n">magnitude</span><span class="p">,</span> <span class="n">vector</span><span class="p">,</span> <span class="n">pt</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">c</span> <span class="o">+</span> <span class="n">v</span> <span class="o">*</span> <span class="n">magnitude</span> <span class="k">for</span> <span class="n">v</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">vector</span><span class="p">,</span> <span class="n">pt</span><span class="p">)]</span>


<span class="nd">@timeit</span>
<span class="k">def</span> <span class="nf">offset_nodes</span><span class="p">(</span>
    <span class="n">plyid</span><span class="p">,</span>
    <span class="n">nodes</span><span class="p">,</span>
    <span class="n">constraints</span><span class="p">,</span>
    <span class="n">f_inc_angle</span><span class="p">,</span>
    <span class="n">f_thickness</span><span class="p">,</span>
    <span class="n">upath</span><span class="p">,</span>
    <span class="n">set_of_corner_nodes</span><span class="p">,</span>
    <span class="n">start</span><span class="p">,</span>
    <span class="n">nid_offset</span><span class="p">,</span>
<span class="p">):</span>
    <span class="c1">## project the shearing angle and thickness values to the model nodes and centroids in a direction normal to upath</span>
    <span class="k">for</span> <span class="n">nid</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">nodes</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
        <span class="c1"># filter nodes by ID - take only nodes at the bottom of the current layer</span>
        <span class="k">if</span> <span class="n">nid</span> <span class="o">&gt;</span> <span class="n">plyid</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">nid_offset</span> <span class="ow">and</span> <span class="n">nid</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">plyid</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">nid_offset</span><span class="p">:</span>
            <span class="n">props</span> <span class="o">=</span> <span class="n">project_to_point</span><span class="p">(</span>
                <span class="n">node</span><span class="p">[</span><span class="s2">&quot;global_xyz&quot;</span><span class="p">],</span>
                <span class="n">start</span><span class="p">,</span>
                <span class="n">upath</span><span class="p">,</span>
                <span class="n">f_inc_angle</span><span class="p">,</span>
                <span class="n">f_thickness</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">thickness</span> <span class="o">=</span> <span class="n">props</span><span class="p">[</span><span class="s2">&quot;thickness&quot;</span><span class="p">]</span>
            <span class="c1"># save offset nodes</span>
            <span class="n">new_nids</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">nid</span> <span class="o">-</span> <span class="n">plyid</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">nid_offset</span> <span class="ow">in</span> <span class="n">set_of_corner_nodes</span><span class="p">:</span>
                <span class="n">nodes</span><span class="p">[</span><span class="n">nid</span> <span class="o">+</span> <span class="n">nid_offset</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;normal&quot;</span><span class="p">:</span> <span class="n">node</span><span class="p">[</span><span class="s2">&quot;normal&quot;</span><span class="p">],</span>
                    <span class="s2">&quot;global_xyz&quot;</span><span class="p">:</span> <span class="n">offset_point_by_vector</span><span class="p">(</span>
                        <span class="n">thickness</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">node</span><span class="p">[</span><span class="s2">&quot;normal&quot;</span><span class="p">],</span> <span class="n">node</span><span class="p">[</span><span class="s2">&quot;global_xyz&quot;</span><span class="p">]</span>
                    <span class="p">),</span>
                <span class="p">}</span>  <span class="c1"># mid-height node</span>
                <span class="n">new_nids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nid</span> <span class="o">+</span> <span class="n">nid_offset</span><span class="p">)</span>
            <span class="n">nodes</span><span class="p">[</span><span class="n">nid</span> <span class="o">+</span> <span class="n">nid_offset</span> <span class="o">*</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;normal&quot;</span><span class="p">:</span> <span class="n">node</span><span class="p">[</span><span class="s2">&quot;normal&quot;</span><span class="p">],</span>
                <span class="s2">&quot;global_xyz&quot;</span><span class="p">:</span> <span class="n">offset_point_by_vector</span><span class="p">(</span>
                    <span class="n">thickness</span><span class="p">,</span> <span class="n">node</span><span class="p">[</span><span class="s2">&quot;normal&quot;</span><span class="p">],</span> <span class="n">node</span><span class="p">[</span><span class="s2">&quot;global_xyz&quot;</span><span class="p">]</span>
                <span class="p">),</span>
            <span class="p">}</span>  <span class="c1"># top node</span>
            <span class="n">new_nids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nid</span> <span class="o">+</span> <span class="n">nid_offset</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
            <span class="c1"># update the spc constraint node sets</span>
            <span class="k">for</span> <span class="n">cname</span><span class="p">,</span> <span class="n">constraint</span> <span class="ow">in</span> <span class="n">constraints</span><span class="p">[</span><span class="s2">&quot;SPCs&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">nid</span> <span class="ow">in</span> <span class="n">constraint</span><span class="p">[</span><span class="s2">&quot;nodes&quot;</span><span class="p">]:</span>
                    <span class="n">constraint</span><span class="p">[</span><span class="s2">&quot;nodes&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">new_nids</span><span class="p">)</span>

    <span class="k">return</span> <span class="kc">None</span>


<span class="nd">@timeit</span>
<span class="k">def</span> <span class="nf">offset_elements</span><span class="p">(</span>
    <span class="n">plyid</span><span class="p">,</span>
    <span class="n">elements</span><span class="p">,</span>
    <span class="n">element_sets</span><span class="p">,</span>
    <span class="n">constraints</span><span class="p">,</span>
    <span class="n">f_inc_angle</span><span class="p">,</span>
    <span class="n">f_thickness</span><span class="p">,</span>
    <span class="n">upath</span><span class="p">,</span>
    <span class="n">start</span><span class="p">,</span>
    <span class="n">eid_offset</span><span class="p">,</span>
    <span class="n">nid_offset</span><span class="p">,</span>
    <span class="n">nodes</span><span class="p">,</span>
<span class="p">):</span>

    <span class="c1"># element faces from ccx manual for C3D20/ C3D20R elements</span>
    <span class="n">faces</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;S1&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)],</span>
        <span class="s2">&quot;S2&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">6</span><span class="p">)],</span>
        <span class="s2">&quot;S3&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">2</span><span class="p">)],</span>
        <span class="s2">&quot;S4&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">3</span><span class="p">)],</span>
        <span class="s2">&quot;S5&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">4</span><span class="p">)],</span>
        <span class="s2">&quot;S6&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">)],</span>
    <span class="p">}</span>

    <span class="c1">## TODO check that the offset values at each node are small compared to the edge</span>
    <span class="c1"># lengths of the connected elements (&lt;1/5 edge?) to avoid badly shaped elements</span>
    <span class="c1">## project the shearing angle and thickness values to the model nodes and centroids in a direction normal to upath</span>
    <span class="n">element_sets</span><span class="p">[</span><span class="n">plyid</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">eid</span><span class="p">,</span> <span class="n">element</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">elements</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
        <span class="c1"># filter 2D elements - reference for the property calculation</span>
        <span class="k">if</span> <span class="n">element</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;S8&quot;</span><span class="p">:</span>
            <span class="n">props</span> <span class="o">=</span> <span class="n">project_to_point</span><span class="p">(</span>
                <span class="n">element</span><span class="p">[</span><span class="s2">&quot;global_xyz&quot;</span><span class="p">],</span>
                <span class="n">start</span><span class="p">,</span>
                <span class="n">upath</span><span class="p">,</span>
                <span class="n">f_inc_angle</span><span class="p">,</span>
                <span class="n">f_thickness</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">inc_angle</span> <span class="o">=</span> <span class="n">props</span><span class="p">[</span><span class="s2">&quot;inc_angle&quot;</span><span class="p">]</span>
            <span class="n">thickness</span> <span class="o">=</span> <span class="n">props</span><span class="p">[</span><span class="s2">&quot;thickness&quot;</span><span class="p">]</span>
            <span class="c1"># save offset element</span>
            <span class="n">new_eid</span> <span class="o">=</span> <span class="n">eid</span> <span class="o">+</span> <span class="n">eid_offset</span> <span class="o">*</span> <span class="p">(</span><span class="n">plyid</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">nids</span> <span class="o">=</span> <span class="p">[</span>
                <span class="o">*</span><span class="p">[</span>
                    <span class="n">n</span> <span class="o">+</span> <span class="n">nid_offset</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">plyid</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">element</span><span class="p">[</span><span class="s2">&quot;nodes&quot;</span><span class="p">][:</span><span class="mi">4</span><span class="p">]</span>
                <span class="p">],</span>  <span class="c1"># base corners</span>
                <span class="o">*</span><span class="p">[</span>
                    <span class="n">n</span> <span class="o">+</span> <span class="n">nid_offset</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">plyid</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">element</span><span class="p">[</span><span class="s2">&quot;nodes&quot;</span><span class="p">][:</span><span class="mi">4</span><span class="p">]</span>
                <span class="p">],</span>  <span class="c1"># top corners</span>
                <span class="o">*</span><span class="p">[</span>
                    <span class="n">n</span> <span class="o">+</span> <span class="n">nid_offset</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">plyid</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">element</span><span class="p">[</span><span class="s2">&quot;nodes&quot;</span><span class="p">][</span><span class="mi">4</span><span class="p">:]</span>
                <span class="p">],</span>  <span class="c1"># base mid-side</span>
                <span class="o">*</span><span class="p">[</span>
                    <span class="n">n</span> <span class="o">+</span> <span class="n">nid_offset</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">plyid</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">element</span><span class="p">[</span><span class="s2">&quot;nodes&quot;</span><span class="p">][</span><span class="mi">4</span><span class="p">:]</span>
                <span class="p">],</span>  <span class="c1"># top mid-side</span>
                <span class="o">*</span><span class="p">[</span>
                    <span class="n">n</span> <span class="o">+</span> <span class="n">nid_offset</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">plyid</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">element</span><span class="p">[</span><span class="s2">&quot;nodes&quot;</span><span class="p">][:</span><span class="mi">4</span><span class="p">]</span>
                <span class="p">],</span>  <span class="c1"># mid-height nodes</span>
            <span class="p">]</span>
            <span class="n">volume</span> <span class="o">=</span> <span class="n">hexahedron_volume_from_nodes</span><span class="p">(</span><span class="n">nids</span><span class="p">[:</span><span class="mi">8</span><span class="p">],</span> <span class="n">nodes</span><span class="p">)</span>
            <span class="n">elements</span><span class="p">[</span><span class="n">new_eid</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;global_xyz&quot;</span><span class="p">:</span> <span class="n">offset_point_by_vector</span><span class="p">(</span>
                    <span class="n">thickness</span> <span class="o">*</span> <span class="p">(</span><span class="n">plyid</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span>
                    <span class="n">element</span><span class="p">[</span><span class="s2">&quot;normal&quot;</span><span class="p">],</span>
                    <span class="n">element</span><span class="p">[</span><span class="s2">&quot;global_xyz&quot;</span><span class="p">],</span>
                <span class="p">),</span>
                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;C3D20R&quot;</span><span class="p">,</span>
                <span class="s2">&quot;inc_angle&quot;</span><span class="p">:</span> <span class="n">inc_angle</span><span class="p">,</span>
                <span class="s2">&quot;t&quot;</span><span class="p">:</span> <span class="n">thickness</span><span class="p">,</span>
                <span class="s2">&quot;nodes&quot;</span><span class="p">:</span> <span class="n">nids</span><span class="p">,</span>
                <span class="s2">&quot;volume&quot;</span><span class="p">:</span> <span class="n">volume</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="c1"># Create sets of elements by ply and common inc_angle.</span>
            <span class="k">if</span> <span class="n">inc_angle</span> <span class="ow">in</span> <span class="n">element_sets</span><span class="p">[</span><span class="n">plyid</span><span class="p">]:</span>
                <span class="n">element_sets</span><span class="p">[</span><span class="n">plyid</span><span class="p">][</span><span class="n">inc_angle</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_eid</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">element_sets</span><span class="p">[</span><span class="n">plyid</span><span class="p">][</span><span class="n">inc_angle</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">new_eid</span><span class="p">]</span>
            <span class="c1"># update kinematic constraints if needed</span>
            <span class="n">update_kinematic_constraints</span><span class="p">(</span><span class="n">constraints</span><span class="p">,</span> <span class="n">nids</span><span class="p">,</span> <span class="n">faces</span><span class="p">,</span> <span class="n">new_eid</span><span class="p">,</span> <span class="n">nodes</span><span class="p">)</span>

    <span class="k">return</span> <span class="kc">None</span>


<span class="k">def</span> <span class="nf">hexahedron_volume_from_nodes</span><span class="p">(</span><span class="n">nids</span><span class="p">,</span> <span class="n">nodes</span><span class="p">):</span>

    <span class="n">n</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">nodes</span><span class="p">[</span><span class="n">nids</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]][</span><span class="s2">&quot;global_xyz&quot;</span><span class="p">])</span>
    <span class="c1"># sum the volume of the 5 tetrahedrons composing the hex</span>
    <span class="n">volume</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="k">for</span> <span class="n">tet</span> <span class="ow">in</span> <span class="p">(</span>
        <span class="p">(</span><span class="n">n</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">n</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">n</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="n">n</span><span class="p">(</span><span class="mi">5</span><span class="p">)),</span>
        <span class="p">(</span><span class="n">n</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">n</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">n</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="n">n</span><span class="p">(</span><span class="mi">7</span><span class="p">)),</span>
        <span class="p">(</span><span class="n">n</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span> <span class="n">n</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span> <span class="n">n</span><span class="p">(</span><span class="mi">7</span><span class="p">),</span> <span class="n">n</span><span class="p">(</span><span class="mi">2</span><span class="p">)),</span>
        <span class="p">(</span><span class="n">n</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span> <span class="n">n</span><span class="p">(</span><span class="mi">7</span><span class="p">),</span> <span class="n">n</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span> <span class="n">n</span><span class="p">(</span><span class="mi">4</span><span class="p">)),</span>
        <span class="p">(</span><span class="n">n</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">n</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="n">n</span><span class="p">(</span><span class="mi">7</span><span class="p">),</span> <span class="n">n</span><span class="p">(</span><span class="mi">5</span><span class="p">)),</span>
    <span class="p">):</span>
        <span class="n">volume</span> <span class="o">+=</span> <span class="n">get_tetrahedron_volume</span><span class="p">(</span><span class="n">tet</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">volume</span>


<span class="k">def</span> <span class="nf">get_tetrahedron_volume</span><span class="p">(</span><span class="n">tet</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">([</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">tet</span><span class="p">])</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">tet</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;input should be list of 4 np.array(xyz) coordinates of tet corners.&quot;</span>
        <span class="p">)</span>
    <span class="n">matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="n">tet</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">tet</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
            <span class="n">tet</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">tet</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
            <span class="n">tet</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">tet</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
        <span class="p">]</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="mi">1</span> <span class="o">/</span> <span class="mi">6</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">det</span><span class="p">(</span><span class="n">matrix</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">update_kinematic_constraints</span><span class="p">(</span><span class="n">constraints</span><span class="p">,</span> <span class="n">nids</span><span class="p">,</span> <span class="n">faces</span><span class="p">,</span> <span class="n">new_eid</span><span class="p">,</span> <span class="n">nodes</span><span class="p">):</span>
    <span class="c1"># update the kinematic constraint node sets and face=(element,faceID) sets</span>

    <span class="c1"># NOTE:</span>
    <span class="c1"># the function is exited after the first constraint on an element is found,</span>
    <span class="c1"># this avoids over-constraining element nodes, which results in error messages</span>

    <span class="n">iterables</span> <span class="o">=</span> <span class="p">[</span><span class="n">constraints</span><span class="p">[</span><span class="s2">&quot;kinematic_MPCs&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="n">faces</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
    <span class="k">for</span> <span class="n">constraint</span><span class="p">,</span> <span class="p">(</span><span class="n">face</span><span class="p">,</span> <span class="n">face_node_indices</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="o">*</span><span class="n">iterables</span><span class="p">)):</span>
        <span class="n">face_nids</span> <span class="o">=</span> <span class="p">[</span><span class="n">nids</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">face_node_indices</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="n">n</span> <span class="ow">in</span> <span class="n">constraint</span><span class="p">[</span><span class="s2">&quot;nodes&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">face_nids</span><span class="p">]):</span>
            <span class="n">face_nodes</span> <span class="o">=</span> <span class="p">[</span><span class="n">nodes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">face_nids</span><span class="p">]</span>
            <span class="n">face_vector</span> <span class="o">=</span> <span class="n">get_surface_normal_from_nodes</span><span class="p">(</span><span class="n">face_nodes</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span>
                <span class="n">face_vector</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">constraint</span><span class="p">[</span><span class="s2">&quot;surface_vector&quot;</span><span class="p">])</span>
            <span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.9</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">face_vector</span><span class="p">):</span>
                <span class="c1"># update the face set</span>
                <span class="n">constraint</span><span class="p">[</span><span class="s2">&quot;faces&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">new_eid</span><span class="p">,</span> <span class="n">face</span><span class="p">))</span>
                <span class="c1"># update the node set</span>
                <span class="n">constraint</span><span class="p">[</span><span class="s2">&quot;nodes&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">face_nids</span><span class="p">)</span>
                <span class="k">return</span>


<span class="k">def</span> <span class="nf">get_volume</span><span class="p">(</span><span class="n">elements</span><span class="p">):</span>
    <span class="n">volume</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">elements</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">e</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;C3D20R&quot;</span><span class="p">:</span>
            <span class="n">volume</span> <span class="o">+=</span> <span class="n">e</span><span class="p">[</span><span class="s2">&quot;volume&quot;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">volume</span>


<span class="nd">@timeit</span>
<span class="k">def</span> <span class="nf">update_kinematic_constraints_ref_nodes</span><span class="p">(</span><span class="n">constraints</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">offset</span><span class="p">):</span>
    <span class="n">nid</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">constraint</span> <span class="ow">in</span> <span class="n">constraints</span><span class="p">[</span><span class="s2">&quot;kinematic_MPCs&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="n">face_nodes</span> <span class="o">=</span> <span class="p">[</span><span class="n">nodes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">constraint</span><span class="p">[</span><span class="s2">&quot;nodes&quot;</span><span class="p">]]</span>
        <span class="n">constraint</span><span class="p">[</span><span class="s2">&quot;ref_node&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">nid</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;global_xyz&quot;</span><span class="p">:</span> <span class="n">get_mid_point</span><span class="p">(</span><span class="n">face_nodes</span><span class="p">)}}</span>
        <span class="n">nid</span> <span class="o">+=</span> <span class="mi">1</span>


<span class="k">def</span> <span class="nf">get_surface_normal_from_nodes</span><span class="p">(</span><span class="n">nodes</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="c1"># assumes coplanar nodes on face by only using first 3 nodes</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">nodes</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Need at least 3 nodes to calculate surface normal vector.&quot;</span><span class="p">)</span>
    <span class="n">v01</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">nodes</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;global_xyz&quot;</span><span class="p">])</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;global_xyz&quot;</span><span class="p">])</span>
    <span class="n">v02</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">nodes</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="s2">&quot;global_xyz&quot;</span><span class="p">])</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;global_xyz&quot;</span><span class="p">])</span>
    <span class="c1"># TODO check angle between vectors is &gt; 10 deg for more general meshes</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">v02</span><span class="p">,</span> <span class="n">v01</span><span class="p">)</span>  <span class="c1"># order so that the norm points out of the element</span>


<span class="k">def</span> <span class="nf">get_mid_point</span><span class="p">(</span><span class="n">face_nodes</span><span class="p">):</span>
    <span class="c1"># find the average xyz position from a set of nodes</span>
    <span class="n">mid_point</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">face_nodes</span><span class="p">:</span>
        <span class="n">mid_point</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">node</span><span class="p">[</span><span class="s2">&quot;global_xyz&quot;</span><span class="p">])</span>
    <span class="n">mid_point</span> <span class="o">/=</span> <span class="nb">len</span><span class="p">(</span><span class="n">face_nodes</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">mid_point</span><span class="p">)</span>


<span class="nd">@timeit</span>
<span class="k">def</span> <span class="nf">set_materials</span><span class="p">(</span><span class="n">plyid</span><span class="p">,</span> <span class="n">materials</span><span class="p">,</span> <span class="n">set_inc_angles</span><span class="p">,</span> <span class="n">ply</span><span class="p">,</span> <span class="n">ref_material</span><span class="p">,</span> <span class="n">nformat</span><span class="p">):</span>

    <span class="c1"># get composite ply Q matrix</span>
    <span class="n">q_matrix</span> <span class="o">=</span> <span class="n">get_Qmatrix</span><span class="p">(</span><span class="n">ref_material</span><span class="p">)</span>

    <span class="c1"># calculate D from A/t, from the Q matrix and from the fibre angles</span>
    <span class="n">set_D_matrix</span><span class="p">(</span><span class="n">plyid</span><span class="p">,</span> <span class="n">materials</span><span class="p">,</span> <span class="n">q_matrix</span><span class="p">,</span> <span class="n">ply</span><span class="p">,</span> <span class="n">set_inc_angles</span><span class="p">,</span> <span class="n">ref_material</span><span class="p">,</span> <span class="n">nformat</span><span class="p">)</span>

    <span class="k">return</span> <span class="kc">None</span>


<span class="k">def</span> <span class="nf">get_Qmatrix</span><span class="p">(</span><span class="n">material</span><span class="p">):</span>

    <span class="n">modulus_E1</span> <span class="o">=</span> <span class="n">material</span><span class="p">[</span><span class="s2">&quot;E1&quot;</span><span class="p">]</span>
    <span class="n">modulus_E2</span> <span class="o">=</span> <span class="n">material</span><span class="p">[</span><span class="s2">&quot;E2&quot;</span><span class="p">]</span>
    <span class="n">pr_nu12</span> <span class="o">=</span> <span class="n">material</span><span class="p">[</span><span class="s2">&quot;nu12&quot;</span><span class="p">]</span>
    <span class="n">modulus_G12</span> <span class="o">=</span> <span class="n">material</span><span class="p">[</span><span class="s2">&quot;G12&quot;</span><span class="p">]</span>
    <span class="n">pr_nu21</span> <span class="o">=</span> <span class="n">pr_nu12</span> <span class="o">*</span> <span class="n">modulus_E2</span> <span class="o">/</span> <span class="n">modulus_E1</span>

    <span class="n">denominator</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">pr_nu12</span> <span class="o">*</span> <span class="n">pr_nu21</span>
    <span class="n">q11</span> <span class="o">=</span> <span class="n">modulus_E1</span> <span class="o">/</span> <span class="n">denominator</span>
    <span class="n">q22</span> <span class="o">=</span> <span class="n">modulus_E2</span> <span class="o">/</span> <span class="n">denominator</span>
    <span class="n">q12</span> <span class="o">=</span> <span class="n">pr_nu12</span> <span class="o">*</span> <span class="n">modulus_E2</span> <span class="o">/</span> <span class="n">denominator</span>
    <span class="n">q66</span> <span class="o">=</span> <span class="n">modulus_G12</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">q11</span><span class="p">,</span> <span class="n">q12</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span> <span class="p">[</span><span class="n">q12</span><span class="p">,</span> <span class="n">q22</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">q66</span><span class="p">]])</span>


<span class="k">def</span> <span class="nf">rotate_q_matrix</span><span class="p">(</span><span class="n">angle</span><span class="p">,</span> <span class="n">q</span><span class="p">):</span>

    <span class="n">s</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">angle</span><span class="p">:</span> <span class="n">sin</span><span class="p">(</span><span class="n">radians</span><span class="p">(</span><span class="n">angle</span><span class="p">))</span>
    <span class="n">c</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">angle</span><span class="p">:</span> <span class="n">cos</span><span class="p">(</span><span class="n">radians</span><span class="p">(</span><span class="n">angle</span><span class="p">))</span>
    <span class="n">T_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="p">[</span><span class="n">c</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">s</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">c</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span> <span class="o">*</span> <span class="n">s</span><span class="p">(</span><span class="n">angle</span><span class="p">)],</span>
            <span class="p">[</span><span class="n">s</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">c</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="n">c</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span> <span class="o">*</span> <span class="n">s</span><span class="p">(</span><span class="n">angle</span><span class="p">)],</span>
            <span class="p">[</span><span class="o">-</span><span class="n">c</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span> <span class="o">*</span> <span class="n">s</span><span class="p">(</span><span class="n">angle</span><span class="p">),</span> <span class="n">c</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span> <span class="o">*</span> <span class="n">s</span><span class="p">(</span><span class="n">angle</span><span class="p">),</span> <span class="n">c</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">s</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">],</span>
        <span class="p">]</span>
    <span class="p">)</span>
    <span class="n">R_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
        <span class="p">[[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">]]</span>
    <span class="p">)</span>  <span class="c1"># Reuter matrix</span>

    <span class="c1"># equation 2.82 from Mechanics of Composite materials</span>
    <span class="n">q_rotated</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">T_mat</span><span class="p">)</span> <span class="o">@</span> <span class="n">q</span> <span class="o">@</span> <span class="n">R_mat</span> <span class="o">@</span> <span class="n">T_mat</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">R_mat</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">q_rotated</span>


<span class="k">def</span> <span class="nf">set_D_matrix</span><span class="p">(</span>
    <span class="n">plyid</span><span class="p">,</span> <span class="n">materials</span><span class="p">,</span> <span class="n">q_matrix</span><span class="p">,</span> <span class="n">ply</span><span class="p">,</span> <span class="n">set_inc_angles</span><span class="p">,</span> <span class="n">ref_material</span><span class="p">,</span> <span class="n">nformat</span>
<span class="p">):</span>
    <span class="k">def</span> <span class="nf">is_pos_def</span><span class="p">(</span><span class="n">A</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">A</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">cholesky</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">except</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">LinAlgError</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="c1"># indices for upper triangular 6x6 matrix in column by column order</span>
    <span class="c1"># (order for calculix anisotropic material elasticity inputs)</span>
    <span class="n">indices</span> <span class="o">=</span> <span class="p">[[],</span> <span class="p">[]]</span>
    <span class="n">rows_upper_triangular</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rows_upper_triangular</span><span class="p">):</span>
            <span class="n">indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
            <span class="n">indices</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
        <span class="n">rows_upper_triangular</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="n">materials</span><span class="p">[</span><span class="n">plyid</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">inc_angle</span> <span class="ow">in</span> <span class="n">set_inc_angles</span><span class="p">:</span>

        <span class="k">if</span> <span class="n">ply</span><span class="p">[</span><span class="s2">&quot;combine_plus_minus_plies&quot;</span><span class="p">]:</span>
            <span class="n">rotations</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="n">inc_angle</span><span class="p">,</span> <span class="n">inc_angle</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rotations</span> <span class="o">=</span> <span class="p">[</span><span class="n">inc_angle</span><span class="p">]</span>

        <span class="c1"># calculate A/t matrix</span>
        <span class="n">a_matrix_by_t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">rotations</span><span class="p">:</span>
            <span class="n">a_matrix_by_t</span> <span class="o">+=</span> <span class="n">rotate_q_matrix</span><span class="p">(</span><span class="n">angle</span><span class="o">=</span><span class="n">r</span> <span class="o">+</span> <span class="n">ply</span><span class="p">[</span><span class="s2">&quot;ply_ref_angle&quot;</span><span class="p">],</span> <span class="n">q</span><span class="o">=</span><span class="n">q_matrix</span><span class="p">)</span>
        <span class="n">a_matrix_by_t</span> <span class="o">=</span> <span class="n">a_matrix_by_t</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">rotations</span><span class="p">)</span>

        <span class="c1"># derive the dimensionless D stiffness matrix in 3D, check that it is positive definite</span>
        <span class="n">d_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">])</span>
        <span class="n">d_matrix</span><span class="p">[:</span><span class="mi">2</span><span class="p">,</span> <span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">a_matrix_by_t</span><span class="p">[:</span><span class="mi">2</span><span class="p">,</span> <span class="p">:</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">d_matrix</span><span class="p">[:</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">a_matrix_by_t</span><span class="p">[:</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
        <span class="n">d_matrix</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">a_matrix_by_t</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">d_matrix</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">a_matrix_by_t</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
        <span class="n">d_matrix</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">ref_material</span><span class="p">[</span><span class="s2">&quot;E2&quot;</span><span class="p">]</span>
        <span class="n">d_matrix</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">ref_material</span><span class="p">[</span><span class="s2">&quot;G12&quot;</span><span class="p">]</span>
        <span class="n">d_matrix</span><span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">ref_material</span><span class="p">[</span><span class="s2">&quot;G12&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_pos_def</span><span class="p">(</span><span class="n">d_matrix</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Calculated stiffness matrix is not positive definite.&quot;</span><span class="p">)</span>
        <span class="n">materials</span><span class="p">[</span><span class="n">plyid</span><span class="p">][</span><span class="n">inc_angle</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">nformat</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">plyid</span><span class="p">,</span> <span class="n">inc_angle</span><span class="p">),</span>
            <span class="s2">&quot;D_matrix&quot;</span><span class="p">:</span> <span class="n">d_matrix</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">indices</span><span class="p">)]</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
            <span class="s2">&quot;density&quot;</span><span class="p">:</span> <span class="n">ref_material</span><span class="p">[</span><span class="s2">&quot;density&quot;</span><span class="p">],</span>
        <span class="p">}</span>

    <span class="k">return</span> <span class="kc">None</span>


<span class="nd">@timeit</span>
<span class="k">def</span> <span class="nf">write_solid_mesh</span><span class="p">(</span><span class="n">nodes</span><span class="p">,</span> <span class="n">elements</span><span class="p">,</span> <span class="n">run_folder</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="s2">&quot;solid_mesh.inp&quot;</span><span class="p">):</span>

    <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1">#  nodes</span>
    <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;*NODE, NSET=Nall</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">nid</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{:6d}</span><span class="s2">,</span><span class="si">{:e}</span><span class="s2">,</span><span class="si">{:e}</span><span class="s2">,</span><span class="si">{:e}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nid</span><span class="p">,</span> <span class="o">*</span><span class="n">node</span><span class="p">[</span><span class="s2">&quot;global_xyz&quot;</span><span class="p">]))</span>

    <span class="c1"># elements</span>
    <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;*ELEMENT, TYPE=C3D20R, ELSET=Eall</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">format_C3D20R</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s2">&quot;</span><span class="si">{:6d}</span><span class="s2">,&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">16</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">{:6d}</span><span class="s2">,&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">5</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="k">for</span> <span class="n">eid</span><span class="p">,</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">elements</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">element</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;C3D20R&quot;</span><span class="p">:</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">format_C3D20R</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">eid</span><span class="p">,</span> <span class="o">*</span><span class="n">element</span><span class="p">[</span><span class="s2">&quot;nodes&quot;</span><span class="p">]))</span>

    <span class="c1"># write string of input lines to file</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">run_folder</span> <span class="o">/</span> <span class="n">file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span>

    <span class="k">return</span> <span class="kc">None</span>


<span class="nd">@timeit</span>
<span class="k">def</span> <span class="nf">write_materials</span><span class="p">(</span><span class="n">materials</span><span class="p">,</span> <span class="n">run_folder</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="s2">&quot;materials.inp&quot;</span><span class="p">):</span>

    <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">format_aniso</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s2">&quot;</span><span class="si">{:e}</span><span class="s2">,&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">{:e}</span><span class="s2">,&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">{:e}</span><span class="s2">,&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">5</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="p">)</span>
    <span class="k">for</span> <span class="n">ply</span> <span class="ow">in</span> <span class="n">materials</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">material</span> <span class="ow">in</span> <span class="n">ply</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;*MATERIAL,NAME=</span><span class="si">{</span><span class="n">material</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="s2">&quot;*ELASTIC, TYPE =ANISO</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">format_aniso</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">material</span><span class="p">[</span><span class="s2">&quot;D_matrix&quot;</span><span class="p">])</span>
            <span class="p">)</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;*DENSITY</span><span class="se">\n</span><span class="si">{:e}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">material</span><span class="p">[</span><span class="s2">&quot;density&quot;</span><span class="p">])))</span>

    <span class="c1"># write string of input lines to file</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">run_folder</span> <span class="o">/</span> <span class="n">file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span>


<span class="nd">@timeit</span>
<span class="k">def</span> <span class="nf">write_element_sets</span><span class="p">(</span>
    <span class="n">element_sets</span><span class="p">,</span> <span class="n">set_name_format</span><span class="p">,</span> <span class="n">run_folder</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="s2">&quot;element_sets.inp&quot;</span>
<span class="p">):</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">plyid</span><span class="p">,</span> <span class="n">plyset</span> <span class="ow">in</span> <span class="n">element_sets</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">inc_angle</span><span class="p">,</span> <span class="n">elset</span> <span class="ow">in</span> <span class="n">plyset</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="s2">&quot;*ELSET,ELSET=E&quot;</span> <span class="o">+</span> <span class="n">set_name_format</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">plyid</span><span class="p">,</span> <span class="n">inc_angle</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">divide_chunks</span><span class="p">(</span><span class="n">elset</span><span class="p">,</span> <span class="mi">16</span><span class="p">):</span>
                <span class="c1"># note trailing comas are no a problem for ccx or abaqus</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">eid</span><span class="p">)</span><span class="si">:</span><span class="s2">d</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">eid</span> <span class="ow">in</span> <span class="n">chunk</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;,</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># write string of input lines to file</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">run_folder</span> <span class="o">/</span> <span class="n">file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span>


<span class="nd">@timeit</span>
<span class="k">def</span> <span class="nf">write_solid_sections</span><span class="p">(</span>
    <span class="n">materials</span><span class="p">,</span> <span class="n">set_name_format</span><span class="p">,</span> <span class="n">run_folder</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="s2">&quot;solid_sections.inp&quot;</span>
<span class="p">):</span>

    <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">plyid</span><span class="p">,</span> <span class="n">ply</span> <span class="ow">in</span> <span class="n">materials</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">inc_angle</span> <span class="ow">in</span> <span class="n">ply</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">set_name_format</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">plyid</span><span class="p">,</span> <span class="n">inc_angle</span><span class="p">)</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;*SOLID SECTION,MATERIAL=&quot;</span> <span class="o">+</span> <span class="n">name</span><span class="p">)</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;,ELSET=E&quot;</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># write string of input lines to file</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">run_folder</span> <span class="o">/</span> <span class="n">file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span>


<span class="nd">@timeit</span>
<span class="k">def</span> <span class="nf">write_node_sets</span><span class="p">(</span><span class="n">constraints</span><span class="p">,</span> <span class="n">run_folder</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="s2">&quot;node_sets.inp&quot;</span><span class="p">):</span>

    <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">cname</span><span class="p">,</span> <span class="n">constraint</span> <span class="ow">in</span> <span class="n">constraints</span><span class="p">[</span><span class="s2">&quot;SPCs&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;*NSET,NSET=N&quot;</span> <span class="o">+</span> <span class="n">cname</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">divide_chunks</span><span class="p">(</span><span class="n">constraint</span><span class="p">[</span><span class="s2">&quot;nodes&quot;</span><span class="p">],</span> <span class="mi">16</span><span class="p">):</span>
            <span class="c1"># note trailing comas are no a problem for ccx or abaqus</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">eid</span><span class="p">)</span><span class="si">:</span><span class="s2">d</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">eid</span> <span class="ow">in</span> <span class="n">chunk</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;,</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="c1"># write string of input lines to file</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">run_folder</span> <span class="o">/</span> <span class="n">file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">write_surface</span><span class="p">(</span><span class="n">constraints</span><span class="p">,</span> <span class="n">run_folder</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="s2">&quot;surfaces.inp&quot;</span><span class="p">):</span>

    <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">cname</span><span class="p">,</span> <span class="n">constraint</span> <span class="ow">in</span> <span class="n">constraints</span><span class="p">[</span><span class="s2">&quot;kinematic_MPCs&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;*SURFACE, NAME=S&quot;</span> <span class="o">+</span> <span class="n">cname</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">face</span> <span class="ow">in</span> <span class="n">constraint</span><span class="p">[</span><span class="s2">&quot;faces&quot;</span><span class="p">]:</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">face</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">6d</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">face</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="c1"># write string of input lines to file</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">run_folder</span> <span class="o">/</span> <span class="n">file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">write_constraints</span><span class="p">(</span><span class="n">constraints</span><span class="p">,</span> <span class="n">run_folder</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="s2">&quot;constraints.inp&quot;</span><span class="p">):</span>

    <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># spc constraints</span>
    <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;*BOUNDARY</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">cname</span><span class="p">,</span> <span class="n">constraint</span> <span class="ow">in</span> <span class="n">constraints</span><span class="p">[</span><span class="s2">&quot;SPCs&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">dof</span> <span class="ow">in</span> <span class="n">constraint</span><span class="p">[</span><span class="s2">&quot;SPC&quot;</span><span class="p">]:</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;N</span><span class="si">{</span><span class="n">cname</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">dof</span><span class="si">}</span><span class="s2">, ,</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># NSET, DOF</span>

    <span class="c1"># kinematic constraints</span>
    <span class="k">for</span> <span class="n">cname</span><span class="p">,</span> <span class="n">constraint</span> <span class="ow">in</span> <span class="n">constraints</span><span class="p">[</span><span class="s2">&quot;kinematic_MPCs&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">nid</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">constraint</span><span class="p">[</span><span class="s2">&quot;ref_node&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;*NODE, NSET=N</span><span class="si">{</span><span class="n">cname</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="s2">&quot;</span><span class="si">{:6d}</span><span class="s2">,</span><span class="si">{:e}</span><span class="s2">,</span><span class="si">{:e}</span><span class="s2">,</span><span class="si">{:e}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">nid</span><span class="p">,</span> <span class="o">*</span><span class="n">constraint</span><span class="p">[</span><span class="s2">&quot;ref_node&quot;</span><span class="p">][</span><span class="n">nid</span><span class="p">][</span><span class="s2">&quot;global_xyz&quot;</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;*COUPLING, REF NODE=</span><span class="si">{</span><span class="n">nid</span><span class="si">}</span><span class="s2">, SURFACE=S</span><span class="si">{</span><span class="n">cname</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2">, CONSTRAINT NAME=</span><span class="si">{</span><span class="n">cname</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;*KINEMATIC</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">dof</span> <span class="ow">in</span> <span class="n">constraint</span><span class="p">[</span><span class="s2">&quot;kinematic&quot;</span><span class="p">]:</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dof</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># DOF</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;*BOUNDARY</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">dof</span> <span class="ow">in</span> <span class="n">constraint</span><span class="p">[</span><span class="s2">&quot;ref_node_SPC&quot;</span><span class="p">]:</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">nid</span><span class="si">:</span><span class="s2">6d</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">dof</span><span class="si">}</span><span class="s2">, ,</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># write string of input lines to file</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">run_folder</span> <span class="o">/</span> <span class="n">file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">write_loading</span><span class="p">(</span><span class="n">constraints</span><span class="p">,</span> <span class="n">run_folder</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="s2">&quot;loads.inp&quot;</span><span class="p">):</span>

    <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">constraint</span> <span class="ow">in</span> <span class="n">constraints</span><span class="p">[</span><span class="s2">&quot;kinematic_MPCs&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="k">if</span> <span class="s2">&quot;ref_node_forces&quot;</span> <span class="ow">in</span> <span class="n">constraint</span><span class="p">:</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;*CLOAD</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">nid</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">constraint</span><span class="p">[</span><span class="s2">&quot;ref_node&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">dof</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">constraint</span><span class="p">[</span><span class="s2">&quot;ref_node_forces&quot;</span><span class="p">]):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
                    <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">nid</span><span class="si">:</span><span class="s2">6d</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">dof</span><span class="o">+</span><span class="mi">1</span><span class="si">:</span><span class="s2">d</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">value</span><span class="si">:</span><span class="s2">e</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># write string of input lines to file</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">run_folder</span> <span class="o">/</span> <span class="n">file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">get_buckling_factors</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span> <span class="n">number_modes</span><span class="p">):</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>

    <span class="n">index</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">factors</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="mi">6</span> <span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="mi">7</span> <span class="o">+</span> <span class="n">number_modes</span><span class="p">)]:</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="n">mode_no</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">output</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">factor</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">output</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">mode_no</span> <span class="o">==</span> <span class="n">index</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Mode number doesn&#39;t match expected index. Check dat file.&quot;</span>
            <span class="p">)</span>
        <span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">factors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">factor</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">factors</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">design</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">outputs</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;mass&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="s2">&quot;buckling_factors&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span>
    <span class="p">}</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="n">main</span><span class="p">(</span>
        <span class="n">inputs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;design&quot;</span><span class="p">:</span> <span class="n">design</span><span class="p">,</span> <span class="s2">&quot;implicit&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;setup&quot;</span><span class="p">:</span> <span class="p">{}},</span>
        <span class="n">outputs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;design&quot;</span><span class="p">:</span> <span class="n">outputs</span><span class="p">,</span> <span class="s2">&quot;implicit&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;setup&quot;</span><span class="p">:</span> <span class="p">{}},</span>
        <span class="n">partials</span><span class="o">=</span><span class="p">{},</span>
        <span class="n">options</span><span class="o">=</span><span class="p">{},</span>
        <span class="n">parameters</span><span class="o">=</span><span class="n">PARAMS</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="c1"># assert np.isclose(resp[&quot;outputs&quot;][&quot;mass&quot;], 8.836875, rtol=1e-6)</span>
    <span class="c1"># assert np.isclose(resp[&quot;outputs&quot;][&quot;buckling_factors&quot;][0], 1.126453, rtol=1e-6)</span>
</pre></div>
</div>
</div>
<input id="b60185c5-e7a5-4854-8259-74b07b9d34f9" name="2ae2c9aa-5009-4957-966a-cca78b0f0d81" type="radio">
</input><label class="sd-tab-label" for="b60185c5-e7a5-4854-8259-74b07b9d34f9">
requirements</label><div class="sd-tab-content docutils">
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>numpy == 1.21.5
</pre></div>
</div>
</div>
<input id="c94355d1-033e-416f-bb9c-acdff14661f1" name="2ae2c9aa-5009-4957-966a-cca78b0f0d81" type="radio">
</input><label class="sd-tab-label" for="c94355d1-033e-416f-bb9c-acdff14661f1">
ccx_compression_buckle.inp</label><div class="sd-tab-content docutils">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">*</span><span class="n">HEADING</span>
<span class="n">Model</span><span class="p">:</span> <span class="n">Unsuported</span> <span class="n">composite</span> <span class="n">box</span> <span class="n">normal</span> <span class="n">modes</span>
<span class="o">**********************</span>
<span class="o">**</span> <span class="n">NODES</span> <span class="n">AND</span> <span class="n">ELEMENTS</span>
<span class="o">*</span><span class="n">INCLUDE</span><span class="p">,</span><span class="n">INPUT</span><span class="o">=</span><span class="n">solid_mesh</span><span class="o">.</span><span class="n">inp</span>
<span class="o">**********************</span>
<span class="o">**</span> <span class="n">COMPOSITE</span> <span class="n">PROPERTIES</span>
<span class="o">*</span><span class="n">INCLUDE</span><span class="p">,</span><span class="n">INPUT</span><span class="o">=</span><span class="n">element_sets</span><span class="o">.</span><span class="n">inp</span>
<span class="o">*</span><span class="n">INCLUDE</span><span class="p">,</span><span class="n">INPUT</span><span class="o">=</span><span class="n">materials</span><span class="o">.</span><span class="n">inp</span>
<span class="o">*</span><span class="n">INCLUDE</span><span class="p">,</span><span class="n">INPUT</span><span class="o">=</span><span class="n">solid_sections</span><span class="o">.</span><span class="n">inp</span>
<span class="o">**********************</span>
<span class="o">**</span> <span class="n">CONSTRAINTS</span>
<span class="o">*</span><span class="n">INCLUDE</span><span class="p">,</span><span class="n">INPUT</span><span class="o">=</span><span class="n">node_sets</span><span class="o">.</span><span class="n">inp</span>
<span class="o">*</span><span class="n">INCLUDE</span><span class="p">,</span><span class="n">INPUT</span><span class="o">=</span><span class="n">surfaces</span><span class="o">.</span><span class="n">inp</span>
<span class="o">*</span><span class="n">INCLUDE</span><span class="p">,</span><span class="n">INPUT</span><span class="o">=</span><span class="n">constraints</span><span class="o">.</span><span class="n">inp</span>
<span class="o">*</span><span class="n">STEP</span>
<span class="o">*</span><span class="n">BUCKLE</span><span class="p">,</span> <span class="n">SOLVER</span><span class="o">=</span><span class="n">SPOOLES</span>
<span class="mi">10</span>
<span class="o">*</span><span class="n">INCLUDE</span><span class="p">,</span><span class="n">INPUT</span><span class="o">=</span><span class="n">loads</span><span class="o">.</span><span class="n">inp</span>
<span class="o">*</span><span class="n">NODE</span> <span class="n">OUTPUT</span> 
<span class="n">U</span>
<span class="o">*</span><span class="n">ELEMENT</span> <span class="n">OUTPUT</span>
<span class="n">S</span>
<span class="o">*</span><span class="n">END</span> <span class="n">STEP</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="update-the-driver-component">
<h3>Update the driver component<a class="headerlink" href="#update-the-driver-component" title="Permalink to this headline">#</a></h3>
<p>The driver component is identical to the OpenMDAO optimisation component used in the <a class="reference internal" href="Simple%20optimisation%20problem.html"><span class="doc std std-doc">Simple optimisation problem</span></a> example, except for the driver parameters, which have been adjusted for the plate optimisation problem:</p>
<ul class="simple">
<li><p>The “input_variables” and “output_variables” parameters set the optimisation variables, objective and constraint functions.</p></li>
<li><p>The calculation of total derivatives across the chained components (using finite differencing) is requested by setting <code class="docutils literal notranslate"><span class="pre">&quot;approx_totals&quot;:</span> <span class="pre">true</span></code> and <code class="docutils literal notranslate"><span class="pre">&quot;fd_step&quot;:</span> <span class="pre">0.2</span></code> in the driver parameters.</p></li>
<li><p>Optimisation iteration history plots are requested by adding the “plot_history” option into the “visualise” parameter list.</p></li>
</ul>
<p>To create the driver component:</p>
<ul class="simple">
<li><p>Select the open-mdao component to edit it.</p></li>
<li><p>Copy the contents of the <code class="docutils literal notranslate"><span class="pre">setup.py</span></code>, <code class="docutils literal notranslate"><span class="pre">compute.py</span></code>, <code class="docutils literal notranslate"><span class="pre">requirements.txt</span></code> files from below into a text editor, save them locally.
Then upload them under the <code class="docutils literal notranslate"><span class="pre">Properties</span></code> tab.</p></li>
<li><p>Copy the contents of the <code class="docutils literal notranslate"><span class="pre">om_component.py</span></code> file from below into a text editor and save it locally.
Then upload it under the <code class="docutils literal notranslate"><span class="pre">Parameters</span></code> tab by selecting <code class="docutils literal notranslate"><span class="pre">upload</span> <span class="pre">user</span> <span class="pre">input</span> <span class="pre">files</span></code>.</p></li>
<li><p>Select <code class="docutils literal notranslate"><span class="pre">Save</span> <span class="pre">data</span></code> to save and close the component.</p></li>
</ul>
<div class="sd-tab-set docutils">
<input checked="checked" id="c992d2b1-a05b-4988-bd78-f4c98ec4d532" name="3d9ad00b-065b-4e8e-a2c7-652d2e33c7dd" type="radio">
</input><label class="sd-tab-label" for="c992d2b1-a05b-4988-bd78-f4c98ec4d532">
setup</label><div class="sd-tab-content docutils">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>


<span class="k">def</span> <span class="nf">setup</span><span class="p">(</span>
    <span class="n">inputs</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;design&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;implicit&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;setup&quot;</span><span class="p">:</span> <span class="p">{}},</span>
    <span class="n">outputs</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;design&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;implicit&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;setup&quot;</span><span class="p">:</span> <span class="p">{}},</span>
    <span class="n">parameters</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;user_input_files&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s2">&quot;inputs_folder_path&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;outputs_folder_path&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="p">},</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Editable setup function.&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="s2">&quot;driver&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">parameters</span><span class="p">:</span>
        <span class="c1"># assume we want to run an optimisation with default settings</span>
        <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;driver&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;optimisation&quot;</span><span class="p">}</span>

    <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">-%H%M%S&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">: Setup completed.&quot;</span>

    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="n">message</span><span class="p">,</span> <span class="s2">&quot;parameters&quot;</span><span class="p">:</span> <span class="n">parameters</span><span class="p">}</span>
</pre></div>
</div>
</div>
<input id="371acd5b-cd0a-4c15-aed1-922db27f31a9" name="3d9ad00b-065b-4e8e-a2c7-652d2e33c7dd" type="radio">
</input><label class="sd-tab-label" for="371acd5b-cd0a-4c15-aed1-922db27f31a9">
compute</label><div class="sd-tab-content docutils">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">from</span> <span class="nn">contextlib</span> <span class="kn">import</span> <span class="n">redirect_stdout</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">openmdao.api</span> <span class="k">as</span> <span class="nn">om</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>  <span class="c1"># type: ignore</span>

<span class="kn">from</span> <span class="nn">component_api2</span> <span class="kn">import</span> <span class="n">call_compute</span>
<span class="kn">from</span> <span class="nn">om_component</span> <span class="kn">import</span> <span class="n">OMexplicitComp</span>  <span class="c1"># type: ignore</span>


<span class="k">def</span> <span class="nf">compute</span><span class="p">(</span>
    <span class="n">inputs</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;design&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;implicit&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;setup&quot;</span><span class="p">:</span> <span class="p">{}},</span>
    <span class="n">outputs</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;design&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;implicit&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;setup&quot;</span><span class="p">:</span> <span class="p">{}},</span>
    <span class="n">partials</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{},</span>
    <span class="n">options</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{},</span>
    <span class="n">parameters</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;user_input_files&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s2">&quot;inputs_folder_path&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;outputs_folder_path&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="p">},</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>

    <span class="sd">&quot;&quot;&quot;Editable compute function.&quot;&quot;&quot;</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;OpenMDAO problem setup started.&quot;</span><span class="p">)</span>

    <span class="n">workflow</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;workflow&quot;</span><span class="p">]</span>
    <span class="n">all_connections</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;all_connections&quot;</span><span class="p">]</span>
    <span class="n">run_folder</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;outputs_folder_path&quot;</span><span class="p">])</span>

    <span class="c1"># 1) define the simulation components</span>
    <span class="n">prob</span> <span class="o">=</span> <span class="n">om</span><span class="o">.</span><span class="n">Problem</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">component</span> <span class="ow">in</span> <span class="n">workflow</span><span class="p">:</span>
        <span class="k">if</span> <span class="s2">&quot;ExplicitComponents&quot;</span> <span class="ow">in</span> <span class="n">parameters</span><span class="p">:</span>
            <span class="n">kwargs</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">comp</span><span class="p">[</span><span class="s2">&quot;kwargs&quot;</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;ExplicitComponents&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">comp</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">component</span>
            <span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">prob</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add_subsystem</span><span class="p">(</span>
            <span class="n">reformat_compname</span><span class="p">(</span><span class="n">component</span><span class="p">),</span>
            <span class="n">OMexplicitComp</span><span class="p">(</span><span class="n">compname</span><span class="o">=</span><span class="n">component</span><span class="p">,</span> <span class="n">run_number</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;ExecComps&quot;</span> <span class="ow">in</span> <span class="n">parameters</span> <span class="ow">and</span> <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;ExecComps&quot;</span><span class="p">]:</span>
        <span class="k">for</span> <span class="n">component</span> <span class="ow">in</span> <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;ExecComps&quot;</span><span class="p">]:</span>
            <span class="n">prob</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add_subsystem</span><span class="p">(</span>
                <span class="n">reformat_compname</span><span class="p">(</span><span class="n">component</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]),</span>
                <span class="n">om</span><span class="o">.</span><span class="n">ExecComp</span><span class="p">(</span><span class="n">component</span><span class="p">[</span><span class="s2">&quot;exprs&quot;</span><span class="p">]),</span>
                <span class="o">**</span><span class="n">component</span><span class="p">[</span><span class="s2">&quot;kwargs&quot;</span><span class="p">],</span>
            <span class="p">)</span>

    <span class="c1"># 2) define the component connections</span>
    <span class="k">for</span> <span class="n">connection</span> <span class="ow">in</span> <span class="n">all_connections</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">connection</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;design&quot;</span><span class="p">:</span>
            <span class="n">prob</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
                <span class="n">reformat_compname</span><span class="p">(</span><span class="n">connection</span><span class="p">[</span><span class="s2">&quot;origin&quot;</span><span class="p">])</span>
                <span class="o">+</span> <span class="s2">&quot;.&quot;</span>
                <span class="o">+</span> <span class="n">connection</span><span class="p">[</span><span class="s2">&quot;name_origin&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">),</span>
                <span class="n">reformat_compname</span><span class="p">(</span><span class="n">connection</span><span class="p">[</span><span class="s2">&quot;target&quot;</span><span class="p">])</span>
                <span class="o">+</span> <span class="s2">&quot;.&quot;</span>
                <span class="o">+</span> <span class="n">connection</span><span class="p">[</span><span class="s2">&quot;name_target&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">),</span>
            <span class="p">)</span>

    <span class="k">if</span> <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;driver&quot;</span><span class="p">][</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;optimisation&quot;</span><span class="p">:</span>
        <span class="c1"># 3) setup the optimisation driver options</span>
        <span class="n">prob</span><span class="o">.</span><span class="n">driver</span> <span class="o">=</span> <span class="n">om</span><span class="o">.</span><span class="n">ScipyOptimizeDriver</span><span class="p">()</span>
        <span class="n">prob</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;optimizer&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;optimizer&quot;</span><span class="p">]</span>
        <span class="n">prob</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;maxiter&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;max_iter&quot;</span><span class="p">]</span>
        <span class="n">prob</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;tol&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;tol&quot;</span><span class="p">]</span>
        <span class="n">prob</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">opt_settings</span><span class="p">[</span><span class="s2">&quot;disp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;disp&quot;</span><span class="p">]</span>
        <span class="n">prob</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;debug_print&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;debug_print&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="s2">&quot;approx_totals&quot;</span> <span class="ow">in</span> <span class="n">parameters</span> <span class="ow">and</span> <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;approx_totals&quot;</span><span class="p">]:</span>
            <span class="c1"># ensure FD gradients are used</span>
            <span class="n">prob</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">approx_totals</span><span class="p">(</span>
                <span class="n">method</span><span class="o">=</span><span class="s2">&quot;fd&quot;</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;fd_step&quot;</span><span class="p">],</span> <span class="n">form</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">step_calc</span><span class="o">=</span><span class="kc">None</span>
            <span class="p">)</span>

    <span class="k">elif</span> <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;driver&quot;</span><span class="p">][</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;doe&quot;</span><span class="p">:</span>
        <span class="c1"># 3) alternative: setup a design of experiments</span>
        <span class="n">prob</span><span class="o">.</span><span class="n">driver</span> <span class="o">=</span> <span class="n">om</span><span class="o">.</span><span class="n">DOEDriver</span><span class="p">(</span>
            <span class="n">om</span><span class="o">.</span><span class="n">UniformGenerator</span><span class="p">(</span><span class="n">num_samples</span><span class="o">=</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;driver&quot;</span><span class="p">][</span><span class="s2">&quot;samples&quot;</span><span class="p">])</span>
        <span class="p">)</span>

    <span class="c1"># 4) add design variables</span>
    <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;input_variables&quot;</span><span class="p">]:</span>
        <span class="n">upper</span> <span class="o">=</span> <span class="n">var</span><span class="p">[</span><span class="s2">&quot;upper&quot;</span><span class="p">]</span>
        <span class="n">lower</span> <span class="o">=</span> <span class="n">var</span><span class="p">[</span><span class="s2">&quot;lower&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s2">&quot;component&quot;</span> <span class="ow">in</span> <span class="n">var</span><span class="p">:</span>
            <span class="n">comp</span> <span class="o">=</span> <span class="n">reformat_compname</span><span class="p">(</span><span class="n">var</span><span class="p">[</span><span class="s2">&quot;component&quot;</span><span class="p">])</span>
            <span class="n">prob</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add_design_var</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">comp</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">var</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">lower</span><span class="o">=</span><span class="n">lower</span><span class="p">,</span>
                <span class="n">upper</span><span class="o">=</span><span class="n">upper</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">prob</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add_design_var</span><span class="p">(</span>
                <span class="n">var</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">),</span> <span class="n">lower</span><span class="o">=</span><span class="n">lower</span><span class="p">,</span> <span class="n">upper</span><span class="o">=</span><span class="n">upper</span>
            <span class="p">)</span>
            <span class="n">prob</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">set_input_defaults</span><span class="p">(</span><span class="n">var</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">),</span> <span class="n">var</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">])</span>

    <span class="c1"># 5) add an objective and constraints</span>
    <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;output_variables&quot;</span><span class="p">]:</span>
        <span class="n">comp</span> <span class="o">=</span> <span class="n">reformat_compname</span><span class="p">(</span><span class="n">var</span><span class="p">[</span><span class="s2">&quot;component&quot;</span><span class="p">])</span>
        <span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">comp</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">var</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="c1"># set scaling from parameter input file</span>
        <span class="k">if</span> <span class="s2">&quot;scaler&quot;</span> <span class="ow">in</span> <span class="n">var</span><span class="p">:</span>
            <span class="n">scaler</span> <span class="o">=</span> <span class="n">var</span><span class="p">[</span><span class="s2">&quot;scaler&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">scaler</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="s2">&quot;adder&quot;</span> <span class="ow">in</span> <span class="p">[</span><span class="n">var</span><span class="p">]:</span>
            <span class="n">adder</span> <span class="o">=</span> <span class="n">var</span><span class="p">[</span><span class="s2">&quot;adder&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">adder</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">var</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;objective&quot;</span><span class="p">:</span>
            <span class="n">prob</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add_objective</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">scaler</span><span class="o">=</span><span class="n">scaler</span><span class="p">,</span> <span class="n">adder</span><span class="o">=</span><span class="n">adder</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">var</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;constraint&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;lower&quot;</span> <span class="ow">in</span> <span class="n">var</span><span class="p">:</span>
                <span class="n">lower</span> <span class="o">=</span> <span class="n">var</span><span class="p">[</span><span class="s2">&quot;lower&quot;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">lower</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="s2">&quot;upper&quot;</span> <span class="ow">in</span> <span class="n">var</span><span class="p">:</span>
                <span class="n">upper</span> <span class="o">=</span> <span class="n">var</span><span class="p">[</span><span class="s2">&quot;upper&quot;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">upper</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">prob</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add_constraint</span><span class="p">(</span>
                <span class="n">name</span><span class="p">,</span> <span class="n">lower</span><span class="o">=</span><span class="n">lower</span><span class="p">,</span> <span class="n">upper</span><span class="o">=</span><span class="n">upper</span><span class="p">,</span> <span class="n">scaler</span><span class="o">=</span><span class="n">scaler</span><span class="p">,</span> <span class="n">adder</span><span class="o">=</span><span class="n">adder</span>
            <span class="p">)</span>

    <span class="n">prob</span><span class="o">.</span><span class="n">setup</span><span class="p">()</span>  <span class="c1"># required to generate the n2 diagram</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;OpenMDAO problem setup completed.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="s2">&quot;visualise&quot;</span> <span class="ow">in</span> <span class="n">parameters</span> <span class="ow">and</span> <span class="s2">&quot;n2_diagram&quot;</span> <span class="ow">in</span> <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;visualise&quot;</span><span class="p">]:</span>
        <span class="c1"># save n2 diagram in html format</span>
        <span class="n">om</span><span class="o">.</span><span class="n">n2</span><span class="p">(</span>
            <span class="n">prob</span><span class="p">,</span>
            <span class="n">outfile</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">run_folder</span> <span class="o">/</span> <span class="s2">&quot;n2.html&quot;</span><span class="p">),</span>
            <span class="n">show_browser</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;driver&quot;</span><span class="p">][</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;optimisation&quot;</span><span class="p">:</span>
        <span class="n">dict_out</span> <span class="o">=</span> <span class="n">run_optimisation</span><span class="p">(</span><span class="n">prob</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">run_folder</span><span class="p">)</span>

    <span class="c1"># elif parameters[&quot;driver&quot;][&quot;type&quot;] == &quot;check_partials&quot;:</span>
    <span class="c1">#     dict_out = run_check_partials(prob, parameters)</span>

    <span class="c1"># elif parameters[&quot;driver&quot;][&quot;type&quot;] == &quot;check_totals&quot;:</span>
    <span class="c1">#     dict_out = run_check_totals(prob, parameters)</span>

    <span class="c1"># elif parameters[&quot;driver&quot;][&quot;type&quot;] == &quot;doe&quot;:</span>
    <span class="c1">#     dict_out = run_doe(prob, parameters)</span>

    <span class="c1"># elif parameters[&quot;driver&quot;][&quot;type&quot;] == &quot;post&quot;:</span>
    <span class="c1">#     dict_out = run_post(prob, parameters)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;driver </span><span class="si">{</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;driver&#39;</span><span class="p">][</span><span class="s1">&#39;type&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> is not a valid component driver type.&quot;</span>
        <span class="p">)</span>

    <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">-%H%M%S&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">: OpenMDAO compute completed.&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

    <span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;design&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dict_out</span>

    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="n">message</span><span class="p">,</span> <span class="s2">&quot;outputs&quot;</span><span class="p">:</span> <span class="n">outputs</span><span class="p">}</span>


<span class="k">def</span> <span class="nf">run_optimisation</span><span class="p">(</span><span class="n">prob</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">run_folder</span><span class="p">):</span>

    <span class="c1"># 6) add a data recorder to the optimisation problem</span>
    <span class="n">r_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span>
        <span class="n">run_folder</span>
        <span class="o">/</span> <span class="p">(</span>
            <span class="s2">&quot;om_problem_recorder_&quot;</span>
            <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">-%H%M%S&quot;</span><span class="p">)</span>
            <span class="o">+</span> <span class="s2">&quot;.sqlite&quot;</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">om</span><span class="o">.</span><span class="n">SqliteRecorder</span><span class="p">(</span><span class="n">r_name</span><span class="p">)</span>
    <span class="n">prob</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">add_recorder</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
    <span class="n">prob</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">recording_options</span><span class="p">[</span><span class="s2">&quot;record_derivatives&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1"># setup the problem again</span>
    <span class="n">prob</span><span class="o">.</span><span class="n">setup</span><span class="p">()</span>

    <span class="k">if</span> <span class="s2">&quot;visualise&quot;</span> <span class="ow">in</span> <span class="n">parameters</span> <span class="ow">and</span> <span class="s2">&quot;scaling_report&quot;</span> <span class="ow">in</span> <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;visualise&quot;</span><span class="p">]:</span>
        <span class="c1"># NOTE: running the model can generate large large amounts of stored data in orchestrator, which</span>
        <span class="c1"># can cause prob.setup() to fail if it is called again, so only execute</span>
        <span class="c1"># prob.run_model() after all setup has been completed</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">run_folder</span> <span class="o">/</span> <span class="s2">&quot;scaling_report.log&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">redirect_stdout</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
                <span class="n">prob</span><span class="o">.</span><span class="n">run_model</span><span class="p">()</span>
                <span class="n">prob</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">scaling_report</span><span class="p">(</span>
                    <span class="n">outfile</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">run_folder</span> <span class="o">/</span> <span class="s2">&quot;driver_scaling_report.html&quot;</span><span class="p">),</span>
                    <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">show_browser</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">jac</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="p">)</span>

    <span class="c1"># 7) execute the optimisation</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">run_folder</span> <span class="o">/</span> <span class="s2">&quot;run_driver.log&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">redirect_stdout</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
                <span class="n">prob</span><span class="o">.</span><span class="n">run_driver</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;run driver exited with error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">tb</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;OpenMDAO Optimisation error: &quot;</span> <span class="o">+</span> <span class="n">tb</span><span class="p">)</span>

    <span class="n">opt_output</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="c1"># print(&quot;Completed model optimisation - solution is: \n inputs= (&quot;)</span>
    <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;input_variables&quot;</span><span class="p">]:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">var</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
        <span class="c1"># print(</span>
        <span class="c1">#     f&quot;{comp}.{name}: &quot;</span>
        <span class="c1">#     + str(prob.get_val(f&quot;{comp}.{name.replace(&#39;.&#39;, &#39;-&#39;)}&quot;))</span>
        <span class="c1">#     + &quot; &quot;</span>
        <span class="c1"># )</span>
        <span class="k">if</span> <span class="s2">&quot;component&quot;</span> <span class="ow">in</span> <span class="n">var</span><span class="p">:</span>
            <span class="n">comp</span> <span class="o">=</span> <span class="n">var</span><span class="p">[</span><span class="s2">&quot;component&quot;</span><span class="p">]</span>
            <span class="n">opt_output</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">comp</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prob</span><span class="o">.</span><span class="n">get_val</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">reformat_compname</span><span class="p">(</span><span class="n">comp</span><span class="p">)</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">opt_output</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">prob</span><span class="o">.</span><span class="n">get_val</span><span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="c1"># print(&quot;), \n outputs = (&quot;)</span>
    <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;output_variables&quot;</span><span class="p">]:</span>
        <span class="n">comp</span> <span class="o">=</span> <span class="n">var</span><span class="p">[</span><span class="s2">&quot;component&quot;</span><span class="p">]</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">var</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
        <span class="c1"># print(</span>
        <span class="c1">#     f&quot;{comp}.{name}: &quot;</span>
        <span class="c1">#     + str(prob.get_val(f&quot;{comp}.{name.replace(&#39;.&#39;, &#39;-&#39;)}&quot;))</span>
        <span class="c1">#     + &quot; &quot;</span>
        <span class="c1"># )</span>
        <span class="n">opt_output</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">comp</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prob</span><span class="o">.</span><span class="n">get_val</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">reformat_compname</span><span class="p">(</span><span class="n">comp</span><span class="p">)</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="c1"># print(&quot;)&quot;)</span>

    <span class="nb">print</span><span class="p">(</span><span class="n">opt_output</span><span class="p">)</span>

    <span class="k">if</span> <span class="s2">&quot;visualise&quot;</span> <span class="ow">in</span> <span class="n">parameters</span> <span class="ow">and</span> <span class="s2">&quot;plot_history&quot;</span> <span class="ow">in</span> <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;visualise&quot;</span><span class="p">]:</span>
        <span class="n">post_process</span><span class="p">(</span><span class="n">parameters</span><span class="p">,</span> <span class="n">run_folder</span><span class="p">,</span> <span class="n">r_name</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">opt_output</span>


<span class="k">def</span> <span class="nf">reformat_compname</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="c1"># openmdao doesn&#39;t allow &quot;-&quot; character in component names</span>
    <span class="k">return</span> <span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">post_process</span><span class="p">(</span><span class="n">parameters</span><span class="p">,</span> <span class="n">run_folder</span><span class="p">,</span> <span class="n">r_name</span><span class="p">,</span> <span class="n">only_plot_major_iter</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="c1"># read database</span>
    <span class="c1"># Instantiate your CaseReader</span>
    <span class="n">cr</span> <span class="o">=</span> <span class="n">om</span><span class="o">.</span><span class="n">CaseReader</span><span class="p">(</span><span class="n">r_name</span><span class="p">)</span>
    <span class="c1"># Isolate &quot;problem&quot; as your source</span>
    <span class="n">driver_cases</span> <span class="o">=</span> <span class="n">cr</span><span class="o">.</span><span class="n">list_cases</span><span class="p">(</span><span class="s2">&quot;driver&quot;</span><span class="p">,</span> <span class="n">out_stream</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

    <span class="c1"># plot the iteration history from the recorder data</span>
    <span class="n">inputs_history</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">key</span><span class="p">:</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">reformat_compname</span><span class="p">(</span><span class="n">var</span><span class="p">[</span><span class="s1">&#39;component&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">var</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;input_variables&quot;</span><span class="p">]</span>
        <span class="p">]</span>
    <span class="p">}</span>
    <span class="n">outputs_history</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">key</span><span class="p">:</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">reformat_compname</span><span class="p">(</span><span class="n">var</span><span class="p">[</span><span class="s1">&#39;component&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">var</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;output_variables&quot;</span><span class="p">]</span>
        <span class="p">]</span>
    <span class="p">}</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">driver_cases</span><span class="p">:</span>
        <span class="n">case</span> <span class="o">=</span> <span class="n">cr</span><span class="o">.</span><span class="n">get_case</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">only_plot_major_iter</span> <span class="ow">and</span> <span class="n">case</span><span class="o">.</span><span class="n">derivatives</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">only_plot_major_iter</span><span class="p">:</span>
            <span class="c1"># get history of inputs</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">inputs_history</span><span class="p">:</span>
                <span class="n">inputs_history</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">case</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
            <span class="c1"># get history of outputs</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">outputs_history</span><span class="p">:</span>
                <span class="n">outputs_history</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">case</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>

    <span class="c1"># plot output in userfriendly fashion</span>
    <span class="n">_plot_iteration_histories</span><span class="p">(</span>
        <span class="n">inputs_history</span><span class="o">=</span><span class="n">inputs_history</span><span class="p">,</span>
        <span class="n">outputs_history</span><span class="o">=</span><span class="n">outputs_history</span><span class="p">,</span>
        <span class="n">run_folder</span><span class="o">=</span><span class="n">run_folder</span><span class="p">,</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">_plot_iteration_histories</span><span class="p">(</span>
    <span class="n">inputs_history</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">outputs_history</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">run_folder</span><span class="o">=</span><span class="kc">None</span>
<span class="p">):</span>
    <span class="c1"># plot input histories</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">inputs_history</span><span class="p">:</span>
        <span class="n">input_data</span> <span class="o">=</span> <span class="n">inputs_history</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="n">input_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">input_data</span><span class="p">)</span>
        <span class="n">iterations</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">input_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">data_series</span> <span class="ow">in</span> <span class="n">input_data</span><span class="o">.</span><span class="n">T</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">iterations</span><span class="p">,</span> <span class="n">data_series</span><span class="p">,</span> <span class="s2">&quot;-o&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">run_folder</span> <span class="o">/</span> <span class="p">(</span><span class="n">key</span> <span class="o">+</span> <span class="s2">&quot;.png&quot;</span><span class="p">)))</span>

    <span class="c1"># plot output histories</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">outputs_history</span><span class="p">:</span>
        <span class="n">output_data</span> <span class="o">=</span> <span class="n">outputs_history</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="n">output_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">output_data</span><span class="p">)</span>
        <span class="n">iterations</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">output_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">data_series</span> <span class="ow">in</span> <span class="n">output_data</span><span class="o">.</span><span class="n">T</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">iterations</span><span class="p">,</span> <span class="n">data_series</span><span class="p">,</span> <span class="s2">&quot;-o&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">run_folder</span> <span class="o">/</span> <span class="p">(</span><span class="n">key</span> <span class="o">+</span> <span class="s2">&quot;.png&quot;</span><span class="p">)))</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<input id="eef0056f-c887-43b8-91b3-70cd526ac5aa" name="3d9ad00b-065b-4e8e-a2c7-652d2e33c7dd" type="radio">
</input><label class="sd-tab-label" for="eef0056f-c887-43b8-91b3-70cd526ac5aa">
requirements</label><div class="sd-tab-content docutils">
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>numpy == 1.21.5
openmdao == 3.16.0
matplotlib == 3.5.2
</pre></div>
</div>
</div>
<input id="d585358b-6139-495f-8e93-f1a02dc12401" name="3d9ad00b-065b-4e8e-a2c7-652d2e33c7dd" type="radio">
</input><label class="sd-tab-label" for="d585358b-6139-495f-8e93-f1a02dc12401">
om_component.py</label><div class="sd-tab-content docutils">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot; Optimisation Component classes for OpenMDAO and associated utilities.&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">openmdao.api</span> <span class="k">as</span> <span class="nn">om</span>  <span class="c1"># type: ignore</span>

<span class="kn">from</span> <span class="nn">component_api2</span> <span class="kn">import</span> <span class="n">call_compute</span><span class="p">,</span> <span class="n">call_setup</span>
<span class="kn">import</span> <span class="nn">traceback</span>


<span class="k">class</span> <span class="nc">OMexplicitComp</span><span class="p">(</span><span class="n">om</span><span class="o">.</span><span class="n">ExplicitComponent</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;standard component that follows the OM conventions&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">compname</span><span class="p">,</span> <span class="n">run_number</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compname</span> <span class="o">=</span> <span class="n">compname</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run_number</span> <span class="o">=</span> <span class="n">run_number</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_grads</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">partial_dict</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;component&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">compname</span><span class="p">}</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">component_dict</span> <span class="o">=</span> <span class="n">call_setup</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="n">inputs</span> <span class="o">=</span> <span class="n">component_dict</span><span class="p">[</span><span class="s2">&quot;input_data&quot;</span><span class="p">][</span><span class="s2">&quot;design&quot;</span><span class="p">]</span>
        <span class="n">outputs</span> <span class="o">=</span> <span class="n">component_dict</span><span class="p">[</span><span class="s2">&quot;output_data&quot;</span><span class="p">][</span><span class="s2">&quot;design&quot;</span><span class="p">]</span>

        <span class="c1"># initialise the inputs</span>
        <span class="k">if</span> <span class="n">inputs</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">variable</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_input</span><span class="p">(</span><span class="n">variable</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">),</span> <span class="n">val</span><span class="o">=</span><span class="n">inputs</span><span class="p">[</span><span class="n">variable</span><span class="p">])</span>

        <span class="c1"># initialise the outputs</span>
        <span class="k">if</span> <span class="n">outputs</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">variable</span> <span class="ow">in</span> <span class="n">outputs</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_output</span><span class="p">(</span><span class="n">variable</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">),</span> <span class="n">val</span><span class="o">=</span><span class="n">outputs</span><span class="p">[</span><span class="n">variable</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">setup_partials</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Get the component partial derivative information</span>

        <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;component&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">compname</span><span class="p">}</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">component_dict</span> <span class="o">=</span> <span class="n">call_setup</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;partials&quot;</span> <span class="ow">in</span> <span class="n">component_dict</span> <span class="ow">and</span> <span class="n">component_dict</span><span class="p">[</span><span class="s2">&quot;partials&quot;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">partial_dict</span> <span class="o">=</span> <span class="n">component_dict</span><span class="p">[</span><span class="s2">&quot;partials&quot;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">resp</span><span class="p">,</span> <span class="nb">vars</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">partial_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">var</span><span class="p">,</span> <span class="n">vals</span> <span class="ow">in</span> <span class="nb">vars</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">declare_partials</span><span class="p">(</span>
                        <span class="n">resp</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">),</span> <span class="n">var</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">),</span> <span class="o">**</span><span class="n">vals</span>
                    <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># calculate all paritials using finite differencing</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">declare_partials</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;fd&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">compute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">outputs</span><span class="p">,</span> <span class="n">discrete_inputs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">discrete_outputs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Calling compute.&quot;</span><span class="p">)</span>
        <span class="c1"># calculate the outputs</span>
        <span class="c1"># Note: transform all np.ndarrays into nested lists to allow formatting to json</span>
        <span class="n">input_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;design&quot;</span><span class="p">:</span> <span class="n">reformat_inputs</span><span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">_copy_views</span><span class="p">())}</span>

        <span class="n">message</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;component&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">compname</span><span class="p">,</span>
            <span class="s2">&quot;inputs&quot;</span><span class="p">:</span> <span class="n">input_dict</span><span class="p">,</span>
            <span class="s2">&quot;get_grads&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;get_outputs&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;message: </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">message</span><span class="p">))</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">call_compute</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="s2">&quot;outputs&quot;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error: Compute output missing - output was: </span><span class="si">{</span><span class="n">data</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Compute of </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">compname</span><span class="si">}</span><span class="s2"> failed, input data was: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">message</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">tb</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">tb</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;OM Explicit component </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">compname</span><span class="si">}</span><span class="s2"> compute error: &quot;</span> <span class="o">+</span> <span class="n">tb</span>
            <span class="p">)</span>

        <span class="n">val_outputs</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;outputs&quot;</span><span class="p">][</span><span class="s2">&quot;design&quot;</span><span class="p">]</span>

        <span class="c1"># OpenMDAO doesn&#39;t like the outputs dictionary to be overwritten, so</span>
        <span class="c1"># assign individual outputs one at a time instead</span>
        <span class="k">for</span> <span class="n">output</span> <span class="ow">in</span> <span class="n">outputs</span><span class="p">:</span>
            <span class="n">outputs</span><span class="p">[</span><span class="n">output</span><span class="p">]</span> <span class="o">=</span> <span class="n">val_outputs</span><span class="p">[</span><span class="n">output</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot;.&quot;</span><span class="p">)]</span>

    <span class="k">def</span> <span class="nf">compute_partials</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">J</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Jacobian of partial derivatives.&quot;&quot;&quot;</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Calling compute_partials.&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">iter</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">input_dict</span> <span class="o">=</span> <span class="n">reformat_inputs</span><span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">_copy_views</span><span class="p">())</span>

        <span class="n">message</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;component&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">compname</span><span class="p">,</span>
            <span class="s2">&quot;inputs&quot;</span><span class="p">:</span> <span class="n">input_dict</span><span class="p">,</span>
            <span class="s2">&quot;get_grads&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;get_outputs&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;message: </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">message</span><span class="p">))</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">call_compute</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="s2">&quot;partials&quot;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Error: Compute partial derivatives missing - output was: </span><span class="si">{</span><span class="n">data</span><span class="si">}</span><span class="s2">.&quot;</span>
                <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">partial_dict</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;partials&quot;</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Compute partials of </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">compname</span><span class="si">}</span><span class="s2"> failed, input data was: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">message</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="n">tb</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">tb</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;OM Explicit component </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">compname</span><span class="si">}</span><span class="s2"> compute error: &quot;</span> <span class="o">+</span> <span class="n">tb</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">partial_dict</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">resp</span><span class="p">,</span> <span class="nb">vars</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">partial_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">var</span><span class="p">,</span> <span class="n">vals</span> <span class="ow">in</span> <span class="nb">vars</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="s2">&quot;val&quot;</span> <span class="ow">in</span> <span class="n">vals</span><span class="p">:</span>
                        <span class="n">J</span><span class="p">[</span><span class="n">resp</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">),</span> <span class="n">var</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">vals</span><span class="p">[</span><span class="s2">&quot;val&quot;</span><span class="p">]</span>
            <span class="c1"># print(dict(J))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Component </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">compname</span><span class="si">}</span><span class="s2"> has no Jacobian defined.&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">reformat_inputs</span><span class="p">(</span><span class="n">inputs</span><span class="p">):</span>
    <span class="n">input_dict</span> <span class="o">=</span> <span class="n">inputs</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="o">*</span><span class="n">input_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()]:</span>
        <span class="n">new_key</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot;.&quot;</span><span class="p">)</span>
        <span class="n">input_dict</span><span class="p">[</span><span class="n">new_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">input_dict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">input_dict</span><span class="p">[</span><span class="n">new_key</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="n">input_dict</span><span class="p">[</span><span class="n">new_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">input_dict</span><span class="p">[</span><span class="n">new_key</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">input_dict</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="execute-the-workflow">
<h3>Execute the workflow<a class="headerlink" href="#execute-the-workflow" title="Permalink to this headline">#</a></h3>
<p>We can now execute the design optimisation by selecting the play symbol ▶ in the Run controls interface.</p>
<p>The <a class="reference internal" href="../Reference/Glossary.html#term-Run"><span class="xref std std-term">Run</span></a> should complete after approximately 53 iterations of the parametric-plate-buckling component (1 iteration of the <code class="docutils literal notranslate"><span class="pre">open-mdao</span></code> component).
Since each component execution takes a minute to complete (of which ~45s are allocated to the actual CalculiX CrunchiX finite element analysis), the design optimisation task should complete within ~1 hour.</p>
</section>
<section id="inspect-results">
<h3>Inspect results<a class="headerlink" href="#inspect-results" title="Permalink to this headline">#</a></h3>
<section id="run-log">
<h4>Run log<a class="headerlink" href="#run-log" title="Permalink to this headline">#</a></h4>
<p>The <a class="reference internal" href="../Reference/Glossary.html#term-Run"><span class="xref std std-term">Run</span></a> log summarises the output of the components. Open the log by selecting <code class="docutils literal notranslate"><span class="pre">View</span> <span class="pre">Log</span></code> in the interface controls.
The “run_output” entry (at the end of the log) should state that the “OpenMDAO compute completed”.</p>
</section>
<section id="plate-component-analysis-outputs">
<h4>Plate component analysis outputs<a class="headerlink" href="#plate-component-analysis-outputs" title="Permalink to this headline">#</a></h4>
<p>Next, close the <a class="reference internal" href="../Reference/Glossary.html#term-Run"><span class="xref std std-term">Run</span></a> log and select the <code class="docutils literal notranslate"><span class="pre">parametric-plate-buckling</span></code> component.
Then select the <code class="docutils literal notranslate"><span class="pre">Log</span></code> tab and click on <code class="docutils literal notranslate"><span class="pre">download</span> <span class="pre">files</span> <span class="pre">snapshot</span></code>.</p>
<p>The zip file includes an ‘outputs’ folder that contains the outputs of the <code class="docutils literal notranslate"><span class="pre">compute.py</span></code> script and the CalculiX CrunchiX input and output files.</p>
<p>Open the ‘run.log’ file in a text editor to view the standard python command-line output. This includes any log statement output with the <code class="docutils literal notranslate"><span class="pre">print()</span></code> function, as well as function execution times captures with the <code class="docutils literal notranslate"><span class="pre">timeit()</span></code> decorator.</p>
<p>Open the ‘ccx_compression_buckle.dat’ file in a text editor to view a list of the lowest 10 buckling factors.
View the buckling mode shapes by opening the ‘ccx_compression_buckle.frd’ file in a CalculiX compatible post-processor, such as CalculiX GraphiX.
The lowest mode shape should look similar to the one shown in the figure at the top of this tutorial.</p>
<details class="sd-sphinx-override sd-dropdown sd-card sd-mb-3">
<summary class="sd-summary-title sd-card-header">
run.log<div class="sd-summary-down docutils">
<svg version="1.1" width="1.5em" height="1.5em" class="sd-octicon sd-octicon-chevron-down" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M5.22 8.72a.75.75 0 000 1.06l6.25 6.25a.75.75 0 001.06 0l6.25-6.25a.75.75 0 00-1.06-1.06L12 14.44 6.28 8.72a.75.75 0 00-1.06 0z"></path></svg></div>
<div class="sd-summary-up docutils">
<svg version="1.1" width="1.5em" height="1.5em" class="sd-octicon sd-octicon-chevron-up" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M18.78 15.28a.75.75 0 000-1.06l-6.25-6.25a.75.75 0 00-1.06 0l-6.25 6.25a.75.75 0 101.06 1.06L12 9.56l5.72 5.72a.75.75 0 001.06 0z"></path></svg></div>
</summary><div class="sd-summary-content sd-card-body docutils">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Starting</span> <span class="n">user</span> <span class="n">function</span> <span class="n">evaluation</span><span class="o">.</span>
<span class="n">Elapsed</span> <span class="n">time</span> <span class="k">for</span> <span class="n">function</span> <span class="s1">&#39;update_parameters_with_inputs&#39;</span><span class="p">:</span> <span class="mf">0.0000</span> <span class="n">seconds</span>
<span class="n">Applied</span> <span class="n">design</span> <span class="n">inputs</span><span class="o">.</span>
<span class="n">Elapsed</span> <span class="n">time</span> <span class="k">for</span> <span class="n">function</span> <span class="s1">&#39;get_commands&#39;</span><span class="p">:</span> <span class="mf">0.0003</span> <span class="n">seconds</span>
<span class="n">Elapsed</span> <span class="n">time</span> <span class="k">for</span> <span class="n">function</span> <span class="s1">&#39;get_geometry&#39;</span><span class="p">:</span> <span class="mf">0.0012</span> <span class="n">seconds</span>
<span class="n">start</span> <span class="n">reading</span> <span class="n">nodes</span><span class="o">.</span>
<span class="n">start</span> <span class="n">reading</span> <span class="n">elements</span><span class="o">.</span>
<span class="n">start</span> <span class="n">reading</span> <span class="n">node</span> <span class="nb">set</span> <span class="n">support_ymax</span><span class="o">.</span>
<span class="n">start</span> <span class="n">reading</span> <span class="n">node</span> <span class="nb">set</span> <span class="n">loaded_xmax</span><span class="o">.</span>
<span class="n">Node</span> <span class="mi">2230</span> <span class="ow">is</span> <span class="n">removed</span> <span class="kn">from</span> <span class="nn">constraint</span> <span class="n">LOADED_XMAX</span> <span class="k">as</span> <span class="n">it</span> <span class="ow">is</span> <span class="n">already</span> <span class="n">constrained</span><span class="o">.</span>
<span class="n">start</span> <span class="n">reading</span> <span class="n">node</span> <span class="nb">set</span> <span class="n">fixed_y0</span><span class="o">.</span>
<span class="n">Node</span> <span class="mi">1590</span> <span class="ow">is</span> <span class="n">removed</span> <span class="kn">from</span> <span class="nn">constraint</span> <span class="n">FIXED_Y0</span> <span class="k">as</span> <span class="n">it</span> <span class="ow">is</span> <span class="n">already</span> <span class="n">constrained</span><span class="o">.</span>
<span class="n">start</span> <span class="n">reading</span> <span class="n">node</span> <span class="nb">set</span> <span class="n">fixed_x0</span><span class="o">.</span>
<span class="n">Node</span> <span class="mi">1</span> <span class="ow">is</span> <span class="n">removed</span> <span class="kn">from</span> <span class="nn">constraint</span> <span class="n">FIXED_X0</span> <span class="k">as</span> <span class="n">it</span> <span class="ow">is</span> <span class="n">already</span> <span class="n">constrained</span><span class="o">.</span>
<span class="n">Node</span> <span class="mi">3510</span> <span class="ow">is</span> <span class="n">removed</span> <span class="kn">from</span> <span class="nn">constraint</span> <span class="n">FIXED_X0</span> <span class="k">as</span> <span class="n">it</span> <span class="ow">is</span> <span class="n">already</span> <span class="n">constrained</span><span class="o">.</span>
<span class="n">start</span> <span class="n">reading</span> <span class="n">node</span> <span class="nb">set</span> <span class="n">support_z</span><span class="o">.</span>
<span class="n">Node</span> <span class="mi">50</span> <span class="ow">is</span> <span class="n">removed</span> <span class="kn">from</span> <span class="nn">constraint</span> <span class="n">SUPPORT_Z</span> <span class="k">as</span> <span class="n">it</span> <span class="ow">is</span> <span class="n">already</span> <span class="n">constrained</span><span class="o">.</span>
<span class="n">Node</span> <span class="mi">310</span> <span class="ow">is</span> <span class="n">removed</span> <span class="kn">from</span> <span class="nn">constraint</span> <span class="n">SUPPORT_Z</span> <span class="k">as</span> <span class="n">it</span> <span class="ow">is</span> <span class="n">already</span> <span class="n">constrained</span><span class="o">.</span>
<span class="n">Node</span> <span class="mi">1270</span> <span class="ow">is</span> <span class="n">removed</span> <span class="kn">from</span> <span class="nn">constraint</span> <span class="n">SUPPORT_Z</span> <span class="k">as</span> <span class="n">it</span> <span class="ow">is</span> <span class="n">already</span> <span class="n">constrained</span><span class="o">.</span>
<span class="n">Node</span> <span class="mi">1619</span> <span class="ow">is</span> <span class="n">removed</span> <span class="kn">from</span> <span class="nn">constraint</span> <span class="n">SUPPORT_Z</span> <span class="k">as</span> <span class="n">it</span> <span class="ow">is</span> <span class="n">already</span> <span class="n">constrained</span><span class="o">.</span>
<span class="n">Node</span> <span class="mi">1910</span> <span class="ow">is</span> <span class="n">removed</span> <span class="kn">from</span> <span class="nn">constraint</span> <span class="n">SUPPORT_Z</span> <span class="k">as</span> <span class="n">it</span> <span class="ow">is</span> <span class="n">already</span> <span class="n">constrained</span><span class="o">.</span>
<span class="n">Node</span> <span class="mi">2259</span> <span class="ow">is</span> <span class="n">removed</span> <span class="kn">from</span> <span class="nn">constraint</span> <span class="n">SUPPORT_Z</span> <span class="k">as</span> <span class="n">it</span> <span class="ow">is</span> <span class="n">already</span> <span class="n">constrained</span><span class="o">.</span>
<span class="n">Node</span> <span class="mi">3190</span> <span class="ow">is</span> <span class="n">removed</span> <span class="kn">from</span> <span class="nn">constraint</span> <span class="n">SUPPORT_Z</span> <span class="k">as</span> <span class="n">it</span> <span class="ow">is</span> <span class="n">already</span> <span class="n">constrained</span><span class="o">.</span>
<span class="n">Node</span> <span class="mi">3539</span> <span class="ow">is</span> <span class="n">removed</span> <span class="kn">from</span> <span class="nn">constraint</span> <span class="n">SUPPORT_Z</span> <span class="k">as</span> <span class="n">it</span> <span class="ow">is</span> <span class="n">already</span> <span class="n">constrained</span><span class="o">.</span>
<span class="n">Elapsed</span> <span class="n">time</span> <span class="k">for</span> <span class="n">function</span> <span class="s1">&#39;get_2Dmesh&#39;</span><span class="p">:</span> <span class="mf">0.0561</span> <span class="n">seconds</span>
<span class="n">Elapsed</span> <span class="n">time</span> <span class="k">for</span> <span class="n">function</span> <span class="s1">&#39;set_element_normals&#39;</span><span class="p">:</span> <span class="mf">0.0233</span> <span class="n">seconds</span>
<span class="n">Elapsed</span> <span class="n">time</span> <span class="k">for</span> <span class="n">function</span> <span class="s1">&#39;set_node_normals&#39;</span><span class="p">:</span> <span class="mf">0.0032</span> <span class="n">seconds</span>
<span class="n">Elapsed</span> <span class="n">time</span> <span class="k">for</span> <span class="n">function</span> <span class="s1">&#39;get_rts_distributions&#39;</span><span class="p">:</span> <span class="mf">0.0003</span> <span class="n">seconds</span>
<span class="n">Elapsed</span> <span class="n">time</span> <span class="k">for</span> <span class="n">function</span> <span class="s1">&#39;offset_nodes&#39;</span><span class="p">:</span> <span class="mf">0.1472</span> <span class="n">seconds</span>
<span class="n">Elapsed</span> <span class="n">time</span> <span class="k">for</span> <span class="n">function</span> <span class="s1">&#39;offset_elements&#39;</span><span class="p">:</span> <span class="mf">0.5509</span> <span class="n">seconds</span>
<span class="n">Elapsed</span> <span class="n">time</span> <span class="k">for</span> <span class="n">function</span> <span class="s1">&#39;set_materials&#39;</span><span class="p">:</span> <span class="mf">0.0102</span> <span class="n">seconds</span>
<span class="n">Elapsed</span> <span class="n">time</span> <span class="k">for</span> <span class="n">function</span> <span class="s1">&#39;get_rts_distributions&#39;</span><span class="p">:</span> <span class="mf">0.0001</span> <span class="n">seconds</span>
<span class="n">Elapsed</span> <span class="n">time</span> <span class="k">for</span> <span class="n">function</span> <span class="s1">&#39;offset_nodes&#39;</span><span class="p">:</span> <span class="mf">0.1753</span> <span class="n">seconds</span>
<span class="n">Elapsed</span> <span class="n">time</span> <span class="k">for</span> <span class="n">function</span> <span class="s1">&#39;offset_elements&#39;</span><span class="p">:</span> <span class="mf">0.5188</span> <span class="n">seconds</span>
<span class="n">Elapsed</span> <span class="n">time</span> <span class="k">for</span> <span class="n">function</span> <span class="s1">&#39;set_materials&#39;</span><span class="p">:</span> <span class="mf">0.0011</span> <span class="n">seconds</span>
<span class="n">Elapsed</span> <span class="n">time</span> <span class="k">for</span> <span class="n">function</span> <span class="s1">&#39;get_rts_distributions&#39;</span><span class="p">:</span> <span class="mf">0.0001</span> <span class="n">seconds</span>
<span class="n">Elapsed</span> <span class="n">time</span> <span class="k">for</span> <span class="n">function</span> <span class="s1">&#39;offset_nodes&#39;</span><span class="p">:</span> <span class="mf">0.1735</span> <span class="n">seconds</span>
<span class="n">Elapsed</span> <span class="n">time</span> <span class="k">for</span> <span class="n">function</span> <span class="s1">&#39;offset_elements&#39;</span><span class="p">:</span> <span class="mf">0.4680</span> <span class="n">seconds</span>
<span class="n">Elapsed</span> <span class="n">time</span> <span class="k">for</span> <span class="n">function</span> <span class="s1">&#39;set_materials&#39;</span><span class="p">:</span> <span class="mf">0.0187</span> <span class="n">seconds</span>
<span class="n">Elapsed</span> <span class="n">time</span> <span class="k">for</span> <span class="n">function</span> <span class="s1">&#39;update_kinematic_constraints_ref_nodes&#39;</span><span class="p">:</span> <span class="mf">0.0025</span> <span class="n">seconds</span>
<span class="n">Elapsed</span> <span class="n">time</span> <span class="k">for</span> <span class="n">function</span> <span class="s1">&#39;write_solid_mesh&#39;</span><span class="p">:</span> <span class="mf">0.2240</span> <span class="n">seconds</span>
<span class="n">Elapsed</span> <span class="n">time</span> <span class="k">for</span> <span class="n">function</span> <span class="s1">&#39;write_materials&#39;</span><span class="p">:</span> <span class="mf">0.0012</span> <span class="n">seconds</span>
<span class="n">Elapsed</span> <span class="n">time</span> <span class="k">for</span> <span class="n">function</span> <span class="s1">&#39;write_element_sets&#39;</span><span class="p">:</span> <span class="mf">0.0042</span> <span class="n">seconds</span>
<span class="n">Elapsed</span> <span class="n">time</span> <span class="k">for</span> <span class="n">function</span> <span class="s1">&#39;write_solid_sections&#39;</span><span class="p">:</span> <span class="mf">0.0005</span> <span class="n">seconds</span>
<span class="n">Elapsed</span> <span class="n">time</span> <span class="k">for</span> <span class="n">function</span> <span class="s1">&#39;write_node_sets&#39;</span><span class="p">:</span> <span class="mf">0.0025</span> <span class="n">seconds</span>
<span class="n">Created</span> <span class="n">CCX</span> <span class="n">solid</span> <span class="n">mesh</span> <span class="n">files</span><span class="o">.</span>
<span class="n">Executed</span> <span class="n">CCX</span> <span class="n">FEM</span> <span class="n">analysis</span><span class="o">.</span>
<span class="mi">20230210</span><span class="o">-</span><span class="mi">204431</span><span class="p">:</span> <span class="n">Executed</span> <span class="n">Calculix</span> <span class="n">finite</span> <span class="n">element</span> <span class="n">analysis</span><span class="o">.</span>
</pre></div>
</div>
</div>
</details><details class="sd-sphinx-override sd-dropdown sd-card sd-mb-3">
<summary class="sd-summary-title sd-card-header">
ccx_compression_buckle.dat<div class="sd-summary-down docutils">
<svg version="1.1" width="1.5em" height="1.5em" class="sd-octicon sd-octicon-chevron-down" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M5.22 8.72a.75.75 0 000 1.06l6.25 6.25a.75.75 0 001.06 0l6.25-6.25a.75.75 0 00-1.06-1.06L12 14.44 6.28 8.72a.75.75 0 00-1.06 0z"></path></svg></div>
<div class="sd-summary-up docutils">
<svg version="1.1" width="1.5em" height="1.5em" class="sd-octicon sd-octicon-chevron-up" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M18.78 15.28a.75.75 0 000-1.06l-6.25-6.25a.75.75 0 00-1.06 0l-6.25 6.25a.75.75 0 101.06 1.06L12 9.56l5.72 5.72a.75.75 0 001.06 0z"></path></svg></div>
</summary><div class="sd-summary-content sd-card-body docutils">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>
     <span class="n">B</span> <span class="n">U</span> <span class="n">C</span> <span class="n">K</span> <span class="n">L</span> <span class="n">I</span> <span class="n">N</span> <span class="n">G</span>   <span class="n">F</span> <span class="n">A</span> <span class="n">C</span> <span class="n">T</span> <span class="n">O</span> <span class="n">R</span>   <span class="n">O</span> <span class="n">U</span> <span class="n">T</span> <span class="n">P</span> <span class="n">U</span> <span class="n">T</span>

 <span class="n">MODE</span> <span class="n">NO</span>       <span class="n">BUCKLING</span>
                <span class="n">FACTOR</span>

      <span class="mi">1</span>   <span class="mf">0.7500002E+02</span>
      <span class="mi">2</span>   <span class="mf">0.7578045E+02</span>
      <span class="mi">3</span>   <span class="mf">0.7621724E+02</span>
      <span class="mi">4</span>   <span class="mf">0.7747507E+02</span>
      <span class="mi">5</span>   <span class="mf">0.7914259E+02</span>
      <span class="mi">6</span>   <span class="mf">0.7968051E+02</span>
      <span class="mi">7</span>   <span class="mf">0.8120669E+02</span>
      <span class="mi">8</span>   <span class="mf">0.8273321E+02</span>
      <span class="mi">9</span>   <span class="mf">0.8365634E+02</span>
     <span class="mi">10</span>   <span class="mf">0.8548586E+02</span>
</pre></div>
</div>
</div>
</details></section>
<section id="optimisation-driver-outputs">
<h4>Optimisation driver outputs<a class="headerlink" href="#optimisation-driver-outputs" title="Permalink to this headline">#</a></h4>
<p>Next, close the plate component and select the <code class="docutils literal notranslate"><span class="pre">open-mdao</span></code> component.
Then select the <code class="docutils literal notranslate"><span class="pre">Log</span></code> tab and click on <code class="docutils literal notranslate"><span class="pre">download</span> <span class="pre">files</span> <span class="pre">snapshot</span></code>.</p>
<p>The optimisation study outputs are summarised at the end of the ‘run_driver.log’ file in the ‘outputs’ folder, as shown below.
We can also inspect the convergence history plots of the design variables, objective and constraint functions in the same folder.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Driver</span> <span class="n">debug</span> <span class="nb">print</span> <span class="k">for</span> <span class="nb">iter</span> <span class="n">coord</span><span class="p">:</span> <span class="n">rank0</span><span class="p">:</span><span class="n">ScipyOptimize_SLSQP</span><span class="o">|</span><span class="mi">19</span>
<span class="o">---------------------------------------------------------------</span>
<span class="n">Design</span> <span class="n">Vars</span>
<span class="p">{</span><span class="s1">&#39;parametric_plate_buckling.T0&#39;</span><span class="p">:</span> <span class="n">array</span><span class="p">([</span><span class="mf">4.90288545</span><span class="p">]),</span>
 <span class="s1">&#39;parametric_plate_buckling.T1&#39;</span><span class="p">:</span> <span class="n">array</span><span class="p">([</span><span class="mf">68.19927386</span><span class="p">])}</span>

<span class="n">Calling</span> <span class="n">compute</span><span class="o">.</span>
<span class="n">message</span><span class="p">:</span> 
 <span class="p">{</span><span class="s1">&#39;component&#39;</span><span class="p">:</span> <span class="s1">&#39;parametric-plate-buckling&#39;</span><span class="p">,</span> <span class="s1">&#39;inputs&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;design&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;T1&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">68.19927385891286</span><span class="p">],</span> <span class="s1">&#39;T0&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">4.9028854501079655</span><span class="p">]}},</span> <span class="s1">&#39;get_grads&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;get_outputs&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
<span class="n">Nonlinear</span> <span class="n">constraints</span>
<span class="p">{</span><span class="s1">&#39;parametric_plate_buckling.buckling_factors&#39;</span><span class="p">:</span> <span class="n">array</span><span class="p">([</span><span class="mf">75.00002</span><span class="p">])}</span>

<span class="n">Linear</span> <span class="n">constraints</span>
<span class="kc">None</span>

<span class="n">Objectives</span>
<span class="p">{</span><span class="s1">&#39;parametric_plate_buckling.mass&#39;</span><span class="p">:</span> <span class="n">array</span><span class="p">([</span><span class="mf">6.76487929</span><span class="p">])}</span>

<span class="n">Optimization</span> <span class="n">terminated</span> <span class="n">successfully</span>    <span class="p">(</span><span class="n">Exit</span> <span class="n">mode</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">Current</span> <span class="n">function</span> <span class="n">value</span><span class="p">:</span> <span class="mf">6.7648792895827246</span>
            <span class="n">Iterations</span><span class="p">:</span> <span class="mi">17</span>
            <span class="n">Function</span> <span class="n">evaluations</span><span class="p">:</span> <span class="mi">19</span>
            <span class="n">Gradient</span> <span class="n">evaluations</span><span class="p">:</span> <span class="mi">17</span>
<span class="n">Optimization</span> <span class="n">Complete</span>
<span class="o">-----------------------------------</span>
</pre></div>
</div>
<a class="bg-primary mb-1 reference internal image-reference" href="../_images/parametric-plate-buckling-rts_6.png"><img alt="parametric_plate_buckling.T0" class="bg-primary mb-1 align-left" src="../_images/parametric-plate-buckling-rts_6.png" style="width: 350px;" /></a>
<a class="bg-primary mb-1 reference internal image-reference" href="../_images/parametric-plate-buckling-rts_7.png"><img alt="parametric_plate_buckling.T1" class="bg-primary mb-1 align-right" src="../_images/parametric-plate-buckling-rts_7.png" style="width: 350px;" /></a>
<a class="bg-primary mb-1 reference internal image-reference" href="../_images/parametric-plate-buckling-rts_8.png"><img alt="parametric_plate_buckling.mass" class="bg-primary mb-1 align-left" src="../_images/parametric-plate-buckling-rts_8.png" style="width: 350px;" /></a>
<a class="bg-primary mb-1 reference internal image-reference" href="../_images/parametric-plate-buckling-rts_9.png"><img alt="parametric_plate_buckling.buckling_factor" class="bg-primary mb-1 align-right" src="../_images/parametric-plate-buckling-rts_9.png" style="width: 350px;" /></a>
<p>The control point fibre shearing angles converge after 17 SLSQP algorithm iterations to T0=5 and T1=68 degrees.</p>
<p>The mass and buckling load results are compared with the optimal design from Reference 1 below, showing a good correlation.</p>
<table class="table">
<colgroup>
<col style="width: 25%" />
<col style="width: 25%" />
<col style="width: 25%" />
<col style="width: 25%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Value</p></th>
<th class="head"><p>Reference 1</p></th>
<th class="head"><p>Present study</p></th>
<th class="head"><p>Relative Error</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Mass (g)</p></td>
<td><p>1321</p></td>
<td><p>1353</p></td>
<td><p>2 %</p></td>
</tr>
<tr class="row-odd"><td><p>Buckling load (kN)</p></td>
<td><p>750</p></td>
<td><p>750</p></td>
<td><p>0 %</p></td>
</tr>
</tbody>
</table>
</section>
</section>
</section>
<section id="clean-up">
<h2>Clean-up<a class="headerlink" href="#clean-up" title="Permalink to this headline">#</a></h2>
<p>Delete your session by selecting <code class="docutils literal notranslate"><span class="pre">New</span></code> in the interface.
It may take a minute or so for the Cloud session to be reset.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>You should see a warning message whenever you are about to delete a <a class="reference internal" href="../Reference/Glossary.html#term-Run"><span class="xref std std-term">Run</span></a>. If you select to continue, then all the <a class="reference internal" href="../Reference/Glossary.html#term-Run"><span class="xref std std-term">Run</span></a> data (session data, inputs and outputs) will be permanently deleted.</p>
</div>
</section>
<section id="references">
<span id="tutorials-modelling-variable-stiffness-composite-plates-references"></span><h2>References<a class="headerlink" href="#references" title="Permalink to this headline">#</a></h2>
<ol class="simple">
<li><p>Rainer M. Groh and Paul Weaver. “Mass Optimisation of Variable Angle Tow, Variable Thickness Panels with Static Failure and Buckling Constraints,” AIAA 2015-0452. 56th AIAA/ASCE/AHS/ASC Structures, Structural Dynamics, and Materials Conference. January 2015, url: <a class="reference external" href="https://doi.org/10.2514/6.2015-0452">https://doi.org/10.2514/6.2015-0452</a></p></li>
<li><p>C.S. Lopes, Z. Gürdal, P.P. Camanho, “Tailoring for strength of composite steered-fibre panels with cutouts”, Composites Part A: Applied Science and Manufacturing, Volume 41, Issue 12, 2010, Pages 1760-176, url: <a class="reference external" href="https://doi.org/10.1016/j.compositesa.2010.08.011">https://doi.org/10.1016/j.compositesa.2010.08.011</a></p></li>
<li><p>Guido Dhondt, “CalculiX CrunchiX USER’S MANUAL version 2.20”, July 31, 2022, url: <a class="reference external" href="http://www.dhondt.de/ccx_2.20.pdf">http://www.dhondt.de/ccx_2.20.pdf</a></p></li>
</ol>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./Tutorials"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
            </main>
            <footer class="footer-article noprint">
                
    <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="Working%20with%20spreadsheets.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Working with spreadsheets</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="../Reference/The%20dashboard.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">The dashboard</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            </footer>
        </div>
    </div>
    <div class="footer-content row">
        <footer class="col footer"><p>
  
    By Dapta Ltd<br/>
  
      &copy; Copyright 2023.<br/>
</p>
        </footer>
    </div>
    
</div>


      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>


  </body>
</html>